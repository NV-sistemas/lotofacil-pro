<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Lotof√°cil Prime Analytics</title>

<style>
  :root{
    --bg1:#050b1a; --bg2:#0b1636;
    --card:#07122a; --text:#f8fafc; --muted:#cbd5e1; --muted2:#94a3b8;

    --green:#22c55e; --green2:#16a34a;
    --blue:#38bdf8; --blue2:#0ea5e9;
    --purple:#a78bfa; --purple2:#7c3aed;
    --yellow:#facc15; --orange:#fb923c;
    --red:#fb7185; --red2:#ef4444;

    --stroke: rgba(255,255,255,.10);
    --stroke2: rgba(255,255,255,.16);
    --shadow: 0 22px 70px rgba(0,0,0,.45);
    --glowBlue: 0 0 0 1px rgba(56,189,248,.18), 0 12px 40px rgba(56,189,248,.10);
    --glowGreen: 0 0 0 1px rgba(34,197,94,.18), 0 12px 40px rgba(34,197,94,.10);
    --glowGold: 0 0 0 1px rgba(250,204,21,.22), 0 18px 60px rgba(250,204,21,.18);
  }
  *{box-sizing:border-box;font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
  html,body{height:100%}
  body{
    margin:0;color:var(--text);
    background:
      radial-gradient(900px 650px at 10% 10%, rgba(56,189,248,.16), transparent 55%),
      radial-gradient(900px 650px at 90% 10%, rgba(34,197,94,.14), transparent 55%),
      radial-gradient(900px 650px at 50% 90%, rgba(167,139,250,.14), transparent 55%),
      linear-gradient(135deg,var(--bg1),var(--bg2));
    min-height:100dvh;
    overflow-x:hidden; /* ‚úÖ evita "torto" no mobile */
  }
  .center{display:flex;align-items:center;justify-content:center;min-height:100dvh;padding:16px;}
  .wrap{max-width:1180px;margin:0 auto;padding:18px}

  .header{display:flex;justify-content:center;align-items:center;margin-bottom:14px}
  .title{
    font-size: clamp(20px, 5.6vw, 28px);
    font-weight:1000;margin:0;letter-spacing:.2px;text-align:center;line-height:1.15;
  }

  .chip{
    display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:999px;
    background:rgba(255,255,255,.06);
    border:1px solid var(--stroke);
    color:var(--text);font-size:12px;font-weight:900;
    box-shadow:0 10px 30px rgba(0,0,0,.25);
    white-space:nowrap;
  }
  .chip .dot{width:7px;height:7px;border-radius:999px;background:rgba(34,197,94,.85);display:inline-block}

  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px solid var(--stroke);
    border-radius:20px;padding:16px;
    box-shadow:var(--shadow);
    margin-bottom:14px;
    backdrop-filter: blur(10px);
    width:100%;
    max-width:520px; /* ‚úÖ login alinhado no celular */
    margin-left:auto;margin-right:auto;
  }
  #app .card{max-width:none}

  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin-top:12px}
  .box{
    background:rgba(255,255,255,.045);
    border:1px solid rgba(255,255,255,.10);
    border-radius:16px;padding:12px;
  }
  .box p{margin:0;color:var(--text);font-size:13px;line-height:1.5}
  .mini{color:var(--muted);font-size:12px;margin-top:8px;line-height:1.45}
  .mini strong{color:var(--text)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:stretch}
  .col{flex:1 1 240px;min-width:0}

  label{display:block;font-size:12px;color:var(--muted);font-weight:950;margin-bottom:6px;text-align:left}
  input, select{
    width:100%;max-width:100%;
    padding:13px 12px;border-radius:14px;border:1px solid var(--stroke2);
    background:rgba(2,6,23,.65);
    color:var(--text);outline:none;
  }
  input::placeholder{color:rgba(203,213,225,.65)}
  select{cursor:pointer}

  .btn{
    padding:12px 14px;border:none;border-radius:14px;
    color:#07131a;font-weight:1000;cursor:pointer;
    transition:.15s;
    box-shadow:0 18px 45px rgba(0,0,0,.35);
    width:100%;
  }
  .btn:hover{filter:brightness(1.05);transform:translateY(-1px)}
  .btn:active{transform:translateY(0px);filter:brightness(.98)}
  .btn:disabled{opacity:.55;cursor:not-allowed;transform:none;box-shadow:none}
  .btnPrimary{background:linear-gradient(135deg,var(--green),var(--green2));box-shadow: var(--glowGreen)}
  .btnBlue{background:linear-gradient(135deg,var(--blue),var(--blue2));box-shadow: var(--glowBlue);color:#041018}
  .btnPurple{background:linear-gradient(135deg,var(--purple),var(--purple2));color:#0b0720;box-shadow: 0 0 0 1px rgba(167,139,250,.18), 0 12px 40px rgba(167,139,250,.12)}
  .btnDanger{background:linear-gradient(135deg,var(--red),var(--red2));color:#2b0b0b;box-shadow: 0 0 0 1px rgba(251,113,133,.18), 0 12px 40px rgba(251,113,133,.12)}
  .btnGhost{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.14);color:var(--text);box-shadow:none;width:auto;}

  .status{display:none;margin-top:10px;padding:12px;border-radius:14px;background:rgba(56,189,248,.10); border:1px solid rgba(56,189,248,.22);color:#e6f8ff;font-size:13px;font-weight:950;}
  .bar{height:10px;border-radius:999px;overflow:hidden;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.08);margin-top:10px}
  .bar>div{height:100%;width:0%;background:linear-gradient(90deg,var(--blue),var(--green));transition:width .2s ease}
  .view{display:none}
  .view.on{display:block}

  .topNav{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:10px;}
  .topNav .left{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .topNav .right{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

  .actionGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:14px;margin-top:12px}
  .actionCard{
    text-align:left;border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.055);
    border-radius:20px;padding:18px 18px;
    cursor:pointer;transition:.15s;position:relative;min-height:126px;
    box-shadow:0 18px 55px rgba(0,0,0,.38);
  }
  .actionCard:hover{transform:translateY(-2px);background:rgba(255,255,255,.07)}
  .actionCard:active{transform:translateY(0px)}
  .actionCard.disabled{opacity:.55;cursor:not-allowed;transform:none;box-shadow:none}
  .actionTitle{font-weight:1000;font-size:16px;margin:0 0 8px}
  .actionDesc{margin:0;color:var(--muted);font-size:13px;line-height:1.55}
  .badge{
    position:absolute;top:14px;right:14px;
    font-size:11px;font-weight:1000;padding:6px 10px;border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.06);color:var(--text);
  }
  .badge.premium{border-color:rgba(56,189,248,.30);background:rgba(56,189,248,.14);color:#e6f8ff}
  .badge.free{border-color:rgba(34,197,94,.30);background:rgba(34,197,94,.14);color:#eafff4}

  .extraCard{
    border:1px solid rgba(250,204,21,.30);
    background:
      radial-gradient(900px 240px at 30% 20%, rgba(250,204,21,.18), transparent 60%),
      radial-gradient(900px 240px at 70% 20%, rgba(251,146,60,.18), transparent 60%),
      rgba(255,255,255,.055);
    box-shadow: var(--glowGold), 0 22px 70px rgba(0,0,0,.40);
    transform: translateZ(0);
  }
  .extraBadge{
    position:absolute;top:14px;right:14px;
    font-size:11px;font-weight:1000;padding:6px 10px;border-radius:999px;
    border:1px solid rgba(250,204,21,.35);
    background:rgba(250,204,21,.18);color:#fff2b0;
  }
  .extraHeadline{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:6px}
  .extraHighlight{
    display:inline-flex;align-items:center;gap:8px;
    padding:6px 10px;border-radius:999px;
    border:1px solid rgba(250,204,21,.35);
    background:rgba(250,204,21,.14);
    color:#fff2b0;font-weight:1000;font-size:12px;
  }

  .cartaoWrap{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
  @media (max-width: 520px){
    .actionGrid{grid-template-columns:1fr;}
    .header{margin-bottom:10px;}
  }
  .cartao{display:grid;grid-template-columns:repeat(5,44px);gap:8px;justify-content:center;margin:10px 0 0;}
  .cel{
    width:44px;height:44px;border-radius:12px;
    display:flex;align-items:center;justify-content:center;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.05);
    color:var(--text);font-weight:1000;
  }
  .cel.on{background:rgba(34,197,94,.14);border:1px solid rgba(34,197,94,.30);color:#eafff4;box-shadow:0 12px 30px rgba(0,0,0,.25)}
  .cel.inv{background:rgba(56,189,248,.14);border:1px solid rgba(56,189,248,.30);color:#e6f8ff;box-shadow:0 12px 30px rgba(0,0,0,.25)}
  .cel.tech{background:rgba(250,204,21,.14);border:1px solid rgba(250,204,21,.30);color:#fff2b0;box-shadow:0 12px 30px rgba(0,0,0,.25)}

  .numbers{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:10px 0 6px}
  .ball{
    width:44px;height:44px;border-radius:999px;display:flex;align-items:center;justify-content:center;
    background:rgba(34,197,94,.14);
    border:1px solid rgba(34,197,94,.28);
    color:#eafff4;font-weight:1000;letter-spacing:.4px;
    box-shadow:0 14px 34px rgba(0,0,0,.35);
  }
  .hr{height:1px;background:rgba(255,255,255,.10);margin:12px 0;border-radius:999px}

  .panelCheck{
    margin-top:12px;
    border:1px dashed rgba(56,189,248,.30);
    background: rgba(56,189,248,.08);
    border-radius:18px;padding:14px;
  }
  .panelCheck b{font-size:13px}

  .modalBack{
    display:none;position:fixed;inset:0;background:rgba(0,0,0,.62);
    backdrop-filter: blur(7px);
    align-items:center;justify-content:center;padding:16px;z-index:999
  }
  .modal{width:100%;max-width:980px;background:linear-gradient(180deg,var(--card),rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.12);border-radius:20px;box-shadow:0 40px 120px rgba(0,0,0,.70); overflow:hidden}
  .modalHeader{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.10)}
  .modalHeader b{font-size:14px}
  .closeBtn{padding:9px 11px;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.14); color:var(--text);cursor:pointer;font-weight:900}
  .modalBody{padding:14px 16px}

  .table{width:100%;border-collapse:collapse;font-size:13px}
  .table th,.table td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.10);text-align:left;vertical-align:top}
  .table th{color:var(--muted);font-weight:1000;font-size:12px}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

  .footerNote{text-align:center;color:var(--muted2);font-size:11px;margin-top:10px}
  .appFooter{margin-top:8px;display:flex;justify-content:center;}
  .tinyFoot{margin-top:12px;text-align:center;color:rgba(203,213,225,.75);font-size:11px;}

  .tip{
    position:relative;display:inline-flex;align-items:center;gap:6px;cursor:help;
    border-bottom:1px dashed rgba(203,213,225,.45);
  }
  .tip::after{
    content: attr(data-tip);
    position:absolute;left:0;top: calc(100% + 8px);
    min-width: 220px;max-width: 360px;
    padding:10px 12px;border-radius:12px;
    background:rgba(2,6,23,.92);
    border:1px solid rgba(255,255,255,.14);
    color:rgba(248,250,252,.95);
    box-shadow: 0 18px 55px rgba(0,0,0,.55);
    opacity:0;pointer-events:none;
    transform: translateY(-4px);
    transition:.12s ease;
    z-index:9999;
    font-size:12px;line-height:1.35;white-space:normal;
  }
  .tip:hover::after{opacity:1;transform: translateY(0);}
  .tip .q{opacity:.8}

  @media (max-width: 520px){
    #loginWrap .row{flex-direction:column;gap:10px;}
    #loginWrap .col{flex:1 1 auto !important;}
  }

  .pickGrid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;max-width:460px;margin-top:10px}
  .pickCell{
    height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.05);
    font-weight:1000;cursor:pointer;user-select:none;
  }
  .pickCell.sel{background:rgba(34,197,94,.16);border-color:rgba(34,197,94,.35);color:#eafff4;box-shadow:0 12px 30px rgba(0,0,0,.25)}
  .pickCell.lock{opacity:.35;cursor:not-allowed}

  .lineTabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .lineBtn{
    padding:8px 10px;border-radius:12px;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.05);
    color:var(--text);font-weight:1000;cursor:pointer
  }
  .lineBtn.on{border-color:rgba(56,189,248,.35);background:rgba(56,189,248,.12);color:#e6f8ff}
  .slotRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .slot{min-width:52px;padding:8px 10px;border-radius:12px;border:1px dashed rgba(255,255,255,.18);background:rgba(255,255,255,.04);font-weight:1000;}
</style>
</head>

<body>

<!-- ================= FIREBASE SDKs (HTML PURO) ================= -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-functions-compat.js"></script>

<script>
/* ========================= CONFIG ========================= */
const APP_NAME = "LOTOF√ÅCIL PRIME ANALYTICS";
const BUY_LINK = "https://pay.hotmart.com/O104148865Y?off=c4m0nezi";
const BUY_LINK_15P = "https://pay.hotmart.com/Y104149008G?off=eehchnv4";
const ADMIN_EMAIL = "admin@lotofacilprime.com";

/* ‚úÖ Limite Free (1x) por usu√°rio */
function freeKey(uid){
  return `lf_free_used_v1_${uid || "anon"}`;
}
</script>

<script>
/* ================= FIREBASE CONFIG (SEU) ================= */
const firebaseConfig = {
  apiKey: "AIzaSyCodYgkQG0TUaqCk1i-0QcSB8GIt0iWp8c",
  authDomain: "lotofacil-prime.firebaseapp.com",
  projectId: "lotofacil-prime",
  storageBucket: "lotofacil-prime.firebasestorage.app",
  messagingSenderId: "385524602679",
  appId: "1:385524602679:web:9760aeb30dcb835a962cb2"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const functions = firebase.app().functions("us-central1");
</script>

<!-- LOGIN -->
<div class="center" id="loginWrap">
  <div class="card">
    <div style="text-align:center">
      <div class="title" style="margin:0">üéØ <span id="appName1"></span></div>
      <div class="mini" style="margin-top:6px">
        Entre para acessar o painel. Premium libera as ferramentas principais.
      </div>
    </div>

    <div style="margin-top:12px" class="row">
      <div class="col">
        <label>Email</label>
        <input id="email" type="email" placeholder="seuemail@gmail.com" />
      </div>
      <div class="col">
        <label>Senha</label>
        <input id="senha" type="password" placeholder="sua senha" />
      </div>
    </div>

    <button id="btnEntrar" class="btn btnPrimary" type="button">Entrar / Criar conta</button>
    <button id="btnForgot" class="btn" type="button" style="margin-top:10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.14);color:var(--text);box-shadow:none">
      Esqueci minha senha
    </button>

    <div id="msgOk" class="status" style="display:none"></div>
    <div id="msgErr" class="status" style="display:none;background:rgba(251,113,133,.12);border:1px solid rgba(251,113,133,.28);color:#ffe7ec"></div>

    <div class="footerNote">Dica: use o mesmo email utilizado na compra Hotmart.</div>
  </div>
</div>

<!-- APP -->
<div class="wrap" id="app" style="display:none">
  <div class="header">
    <div class="title">üéØ <span id="appName2"></span></div>
  </div>

  <!-- PREMIUM GATE -->
  <div class="card" id="premiumGate" style="display:none">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div>
        <div style="font-weight:1000;font-size:16px">üîí √Årea Premium</div>
        <div class="mini">
          No modo Free voc√™ pode gerar <b>1 vez</b> apenas no <b>Jogo Principal</b>.
          Para liberar <b>An√°lise</b>, <b>Invertida</b> e <b>T√©cnica Premiada</b>, ative o Premium.
        </div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn btnDanger" id="btnComprar" type="button">Comprar Premium</button>
        <button class="btn btnGhost" id="btnJaComprei" type="button">J√° comprei</button>
        <button class="btn btnGhost" id="btnSair" type="button">Sair</button>
      </div>
    </div>
  </div>

  <!-- EXTRA 15P UPSELL -->
  <div class="card" id="addon15Card" style="display:none">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div>
        <div style="font-weight:1000;font-size:16px">‚ú® Recurso Extra: 15 pontos garantido</div>
        <div class="mini">Esse recurso √© um <b>EXTRA comprado separadamente</b> e abre uma tela pr√≥pria.</div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <button class="btn btnDanger" id="btnComprar15p" type="button">Comprar 15 pontos</button>
        <button class="btn btnGhost" id="btnAtivar15p" type="button">J√° comprei</button>
      </div>
    </div>
  </div>

  <!-- ===== TELAS ===== -->
  <div class="view on" id="viewHome">
    <div class="card">
      <div class="row">
        <div class="col">
          <label>Quantidade de concursos para an√°lise</label>
          <select id="qtdConcursos">
            <option value="5">√öltimos 5 concursos</option>
            <option value="10" selected>√öltimos 10 concursos</option>
            <option value="15">√öltimos 15 concursos</option>
            <option value="20">√öltimos 20 concursos</option>
            <option value="25">√öltimos 25 concursos</option>
            <option value="50">√öltimos 50 concursos</option>
            <option value="75">√öltimos 75 concursos</option>
            <option value="100">√öltimos 100 concursos</option>
          </select>
          <div class="mini" style="margin-top:10px">
            Dica: quanto maior o per√≠odo, mais ‚Äúrobusta‚Äù fica a estat√≠stica.
            Se APIs bloquearem, o app entra em modo demonstra√ß√£o automaticamente.
          </div>
        </div>
        <div class="col" id="progressCol">
          <label>Progresso</label>
          <div id="status" class="status">
            <div id="statusText">Carregando‚Ä¶</div>
            <div class="bar"><div id="barFill"></div></div>
          </div>
          <div class="mini">
            Premium: An√°lise, Invertida e T√©cnica Premiada.<br/>
            Free: Jogo Principal (1 gera√ß√£o).<br/>
            Extra: 15P (comprado separadamente).
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <label>Op√ß√µes</label>
      <div class="actionGrid">
        <!-- FREE -->
        <div class="actionCard" id="btnHomePrincipal" role="button" tabindex="0">
          <span class="badge free">FREE 1x</span>
          <p class="actionTitle">üéØ Jogo principal</p>
          <p class="actionDesc">Gera 15 dezenas + resumo PRIME. Voc√™ tamb√©m pode montar o seu jogo manualmente.</p>
        </div>

        <!-- PREMIUM -->
        <div class="actionCard" id="btnHomeAnalise" role="button" tabindex="0">
          <span class="badge premium">PREMIUM</span>
          <p class="actionTitle">üìà Gerar an√°lise</p>
          <p class="actionDesc">Resumo PRIME do per√≠odo selecionado (sem jogo) com tend√™ncias e probabilidades.</p>
        </div>

        <div class="actionCard" id="btnHomeInvertida" role="button" tabindex="0">
          <span class="badge premium">PREMIUM</span>
          <p class="actionTitle">üîÑ Gerar invertida</p>
          <p class="actionDesc">Usa o Jogo Principal (autom√°tico ou manual) e inverte por blocos no cart√£o 5√ó5.</p>
        </div>

        <div class="actionCard" id="btnHomeTecnica" role="button" tabindex="0">
          <span class="badge premium">PREMIUM</span>
          <p class="actionTitle">üèÜ T√©cnica premiada</p>
          <p class="actionDesc">Gera 2 jogos extras a partir do Principal (reordena√ß√£o por blocos).</p>
        </div>

        <!-- EXTRA -->
        <div class="actionCard extraCard" id="btnHome15p" role="button" tabindex="0">
          <span class="extraBadge">EXTRA</span>
          <div class="extraHeadline">
            <p class="actionTitle" style="margin:0">‚úÖ 15 pontos garantido</p>
            <span class="extraHighlight">ESTRAT√âGIA (10 JOGOS)</span>
          </div>
          <p class="actionDesc">Tela separada: 5 linhas com ‚Äúmais juntas‚Äù x ‚Äúmenos juntas‚Äù e 10 jogos. Voc√™ tamb√©m pode criar suas pr√≥prias linhas.</p>
        </div>
      </div>
    </div>

    <div class="card" id="resultadoHome">
      <div class="footerNote">Selecione a janela e escolha uma op√ß√£o acima.</div>
    </div>

    <div class="appFooter">
      <div class="chip" id="chipUser">
        <span class="dot"></span>
        <span id="chipText">‚Äî</span>
      </div>
    </div>
  </div>

  <!-- TELA: AN√ÅLISE -->
  <div class="view" id="viewAnalise">
    <div class="topNav">
      <div class="left">
        <button class="btn btnGhost" type="button" onclick="goView('viewHome')">‚¨Ö Voltar</button>
      </div>
      <div class="right">
        <button class="btn btnGhost" type="button" onclick="verConcursos()">üìÖ Ver concursos</button>
      </div>
    </div>
    <div class="card" id="analiseArea">
      <div class="footerNote">Clique em ‚ÄúGerar an√°lise‚Äù na tela principal.</div>
    </div>
  </div>

  <!-- TELA: JOGO PRINCIPAL -->
  <div class="view" id="viewPrincipal">
    <div class="topNav">
      <div class="left">
        <button class="btn btnGhost" type="button" onclick="goView('viewHome')">‚¨Ö Voltar</button>
      </div>
      <div class="right">
        <button class="btn btnBlue" type="button" onclick="goView('viewInvertida'); gerarInvertida()">üîÑ Invertida</button>
        <button class="btn btnPurple" type="button" onclick="goView('viewTecnica'); gerarTecnicaPremiada()">üèÜ T√©cnica</button>
        <button class="btn btnGhost" id="btnVerificarGeradosFromPrincipal" type="button" style="display:none" onclick="goView('viewCheck')">‚úÖ Verificar jogos gerados</button>
      </div>
    </div>
    <div class="card" id="principalArea">
      <div class="footerNote">Clique em ‚ÄúJogo Principal‚Äù na tela principal.</div>
    </div>
  </div>

  <!-- TELA: INVERTIDA -->
  <div class="view" id="viewInvertida">
    <div class="topNav">
      <div class="left">
        <button class="btn btnGhost" type="button" onclick="goView('viewPrincipal')">‚¨Ö Voltar</button>
      </div>
      <div class="right">
        <button class="btn btnPurple" type="button" onclick="goView('viewTecnica'); gerarTecnicaPremiada()">üèÜ Ir para T√©cnica</button>
      </div>
    </div>
    <div class="card" id="invertidaArea">
      <div class="footerNote">Gere um Jogo Principal primeiro.</div>
    </div>
  </div>

  <!-- TELA: T√âCNICA PREMIADA -->
  <div class="view" id="viewTecnica">
    <div class="topNav">
      <div class="left">
        <button class="btn btnGhost" type="button" onclick="goView('viewPrincipal')">‚¨Ö Voltar</button>
      </div>
      <div class="right">
        <button class="btn btnBlue" type="button" onclick="goView('viewInvertida'); gerarInvertida()">üîÑ Ir para Invertida</button>
      </div>
    </div>
    <div class="card" id="tecnicaArea">
      <div class="footerNote">Gere um Jogo Principal primeiro.</div>
    </div>
  </div>

  <!-- TELA: CHECK -->
  <div class="view" id="viewCheck">
    <div class="topNav">
      <div class="left">
        <button class="btn btnGhost" type="button" onclick="goView('viewPrincipal')">‚¨Ö Voltar</button>
      </div>
      <div class="right">
        <button class="btn btnGhost" type="button" onclick="conferirGerados()">Conferir com √∫ltimo concurso</button>
      </div>
    </div>
    <div class="card" id="checkArea">
      <div class="footerNote">Gere Principal + Invertida + T√©cnica para liberar esta tela.</div>
    </div>
  </div>

  <!-- TELA: 15 PONTOS -->
  <div class="view" id="view15p">
    <div class="topNav">
      <div class="left">
        <button class="btn btnGhost" type="button" onclick="goView('viewHome')">‚¨Ö Voltar</button>
      </div>
      <div class="right">
        <button class="btn btnPrimary" type="button" onclick="gerar15P()">Gerar an√°lise 15P</button>
      </div>
    </div>
    <div class="card" id="p15Area">
      <div class="footerNote">Clique em ‚ÄúGerar an√°lise 15P‚Äù. Essa tela exige o EXTRA ativado (via claims).</div>
    </div>
  </div>

  <div class="footerNote">Aviso: an√°lise estat√≠stica n√£o garante premia√ß√£o. Jogo respons√°vel ‚úÖ</div>
</div>

<!-- MODAL LISTA CONCURSOS -->
<div id="modalBack" class="modalBack">
  <div class="modal">
    <div class="modalHeader">
      <b>üìå Concursos analisados (datas + dezenas)</b>
      <button class="closeBtn" onclick="fecharModal()">Fechar</button>
    </div>
    <div class="modalBody">
      <div id="listaConcursos"></div>
    </div>
  </div>
</div>

<!-- MODAL GRAFICO BLOCOS -->
<div id="modalBlocosBack" class="modalBack">
  <div class="modal" style="max-width:560px">
    <div class="modalHeader">
      <b>üìä Gr√°fico de Blocos A‚ÄìE</b>
      <button class="closeBtn" onclick="fecharGraficoBlocos()">Fechar</button>
    </div>
    <div class="modalBody">
      <div id="graficoBlocosArea"></div>
      <div class="mini" style="margin-top:10px">
        Blocos: A(01‚Äì05), B(06‚Äì10), C(11‚Äì15), D(16‚Äì20), E(21‚Äì25).
      </div>
    </div>
  </div>
</div>

<script>
/* ========================= UI Helpers ========================= */
document.getElementById("appName1").textContent = APP_NAME;
document.getElementById("appName2").textContent = APP_NAME;

function bindCardKey(el){
  el.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" || e.key === " "){
      e.preventDefault();
      el.click();
    }
  });
}
function showOk(t){
  const a=document.getElementById("msgOk");
  a.style.display="block";
  a.textContent=t;
  document.getElementById("msgErr").style.display="none";
}
function showErr(t){
  const a=document.getElementById("msgErr");
  a.style.display="block";
  a.textContent=t;
  document.getElementById("msgOk").style.display="none";
}
function setStatus(on, text){
  const st=document.getElementById("status");
  document.getElementById("statusText").textContent = text || "";
  st.style.display = on ? "block" : "none";
  toggleProgressCol();
}
function toggleProgressCol(){
  const st = document.getElementById("status");
  const col = document.getElementById("progressCol");
  if(!st || !col) return;
  const isMobile = window.innerWidth <= 520;
  const statusVisible = (getComputedStyle(st).display !== "none");
  if(isMobile && !statusVisible){
    col.style.display = "none";
  }else{
    col.style.display = "block";
  }
}
window.addEventListener("resize", toggleProgressCol);
document.addEventListener("DOMContentLoaded", toggleProgressCol);

function setProgress(p){
  document.getElementById("barFill").style.width = Math.max(0, Math.min(100, p)) + "%";
}
function abrirModal(){ document.getElementById("modalBack").style.display="flex"; }
function fecharModal(){ document.getElementById("modalBack").style.display="none"; }
function fecharGraficoBlocos(){ document.getElementById("modalBlocosBack").style.display="none"; }

function goView(id){
  document.querySelectorAll(".view").forEach(v=>v.classList.remove("on"));
  const el=document.getElementById(id);
  if(el) el.classList.add("on");
  window.scrollTo({top:0, behavior:"smooth"});
}
</script>

<script>
/* ========================= AUTH + CLAIMS (Premium/15P) ========================= */
let access = { email: "", uid: "", premium: false, addon15: false, isAdmin: false };

async function refreshClaims(force=false){
  const u = auth.currentUser;
  if(!u) return access;
  const token = await u.getIdTokenResult(!!force);
  const email = (u.email || "").toLowerCase();
  const isAdmin = email === String(ADMIN_EMAIL).toLowerCase();
  const premium = !!token.claims.premium || isAdmin;
  const addon15 = !!token.claims.addon15 || isAdmin;
  access = { email, uid: u.uid, premium, addon15, isAdmin };
  updateChip();
  aplicarAcessos();
  return access;
}
function updateChip(){
  const plan = access.isAdmin ? "üõ°Ô∏è Admin" : (access.premium ? "üëë Premium" : "üë§ Free");
  const extra = (access.addon15 || access.isAdmin) ? " ‚Ä¢ ‚úÖ 15P" : "";
  const chipTextEl = document.getElementById("chipText");
  if(chipTextEl) chipTextEl.textContent = `${plan} ‚Ä¢ ${access.email || "‚Äî"}${extra}`;
}

function isFreeUsed(){
  if(!access.uid) return false;
  return localStorage.getItem(freeKey(access.uid)) === "1";
}
function markFreeUsed(){
  if(!access.uid) return;
  localStorage.setItem(freeKey(access.uid), "1");
}

function setCardEnabled(el, enabled, onClick, msg){
  if(!el) return;
  el.classList.toggle("disabled", !enabled);
  el.onclick = enabled ? onClick : ()=>alert(msg);
}

function aplicarAcessos(){
  const can15p = ((access.premium && access.addon15) || access.isAdmin);

  const premiumGate = document.getElementById("premiumGate");
  if(premiumGate) premiumGate.style.display = access.premium ? "none" : "block";

  const addon15Card = document.getElementById("addon15Card");
  if(addon15Card) addon15Card.style.display = (!access.isAdmin && !can15p) ? "block" : "none";

  const btnAnalise = document.getElementById("btnHomeAnalise");
  const btnPrincipal= document.getElementById("btnHomePrincipal");
  const btnInvertida= document.getElementById("btnHomeInvertida");
  const btnTecnica = document.getElementById("btnHomeTecnica");
  const btn15 = document.getElementById("btnHome15p");

  setCardEnabled(btnAnalise, access.premium, acaoAnalise, "üîí Gerar an√°lise exige Premium.");
  setCardEnabled(btnInvertida, access.premium, ()=>{
    if(!lastPrincipalGame) return alert("Gere primeiro um Jogo Principal.");
    goView("viewInvertida"); gerarInvertida();
  }, "üîí Invertida exige Premium.");
  setCardEnabled(btnTecnica, access.premium, ()=>{
    if(!lastPrincipalGame) return alert("Gere primeiro um Jogo Principal.");
    goView("viewTecnica"); gerarTecnicaPremiada();
  }, "üîí T√©cnica premiada exige Premium.");

  if(!access.premium && isFreeUsed()){
    btnPrincipal?.classList.add("disabled");
    if(btnPrincipal) btnPrincipal.onclick = ()=>alert("üîí Voc√™ j√° usou a gera√ß√£o gr√°tis. Para liberar, ative o Premium.");
  }else{
    btnPrincipal?.classList.remove("disabled");
    if(btnPrincipal) btnPrincipal.onclick = ()=>acaoPrincipal();
  }

  if(!can15p){
    btn15?.classList.add("disabled");
    if(btn15) btn15.onclick = ()=>alert("üîí O recurso '15 pontos garantido' √© um EXTRA comprado separadamente (libera via claims).");
  }else{
    btn15?.classList.remove("disabled");
    if(btn15) btn15.onclick = ()=>{ goView("view15p"); };
  }
}

function abrirApp(){
  document.getElementById("loginWrap").style.display="none";
  document.getElementById("app").style.display="block";
  goView("viewHome");
}
function fecharApp(){
  document.getElementById("loginWrap").style.display="flex";
  document.getElementById("app").style.display="none";
}

async function entrar(){
  const e=(document.getElementById("email").value||"").trim().toLowerCase();
  const s=(document.getElementById("senha").value||"");
  if(!e || !s){ showErr("Digite email e senha."); return; }
  const btn = document.getElementById("btnEntrar");
  btn.disabled = true;
  try{
    await auth.signInWithEmailAndPassword(e,s);
    showOk("Bem-vindo! Carregando seu acesso‚Ä¶");
  }catch(err){
    try{
      await auth.createUserWithEmailAndPassword(e,s);
      showOk("Conta criada ‚úÖ Carregando seu acesso‚Ä¶");
    }catch(e2){
      showErr(e2?.message || "Falha no login.");
    }
  }finally{
    btn.disabled = false;
  }
}
async function forgotPassword(){
  const e=(document.getElementById("email").value||"").trim().toLowerCase();
  if(!e) return showErr("Digite seu email para recuperar a senha.");
  try{
    await auth.sendPasswordResetEmail(e);
    showOk("‚úÖ Email de recupera√ß√£o enviado. Verifique sua caixa de entrada.");
  }catch(err){
    showErr(err?.message || "N√£o foi poss√≠vel enviar o email de recupera√ß√£o.");
  }
}
function sair(){ auth.signOut(); }
function comprarPremium(){ window.open(BUY_LINK, "_blank"); }
function comprar15p(){ window.open(BUY_LINK_15P, "_blank"); }

async function ativarComCodigo(){
  try{
    if(!auth.currentUser){ alert("Voc√™ precisa estar logado."); return; }
    const code = prompt("Cole aqui seu C√ìDIGO de ativa√ß√£o (ex: PRIME-0001):");
    if(!code) return;
    showOk("Ativando c√≥digo‚Ä¶");
    const redeemCode = functions.httpsCallable("redeemCode");
    await redeemCode({ code: code.trim() });
    await refreshClaims(true);
    if(access.premium || access.addon15 || access.isAdmin){
      showOk("‚úÖ C√≥digo ativado! Seus acessos foram atualizados.");
    }else{
      showOk("‚úÖ C√≥digo enviado! Se n√£o liberar na hora, saia e entre novamente.");
    }
  }catch(err){
    console.log(err);
    showErr("‚ùå Erro ao ativar: " + (err?.message || err));
  }
}
async function jaComprei(){ await ativarComCodigo(); }
async function jaComprei15p(){ await ativarComCodigo(); }

auth.onAuthStateChanged(async (user)=>{
  if(!user){
    access = { email:"", uid:"", premium:false, addon15:false, isAdmin:false };
    fecharApp();
    return;
  }
  abrirApp();
  await refreshClaims(true);
});
</script>

<script>
/* ========================= MOTOR BASE ========================= */
function format2(n){ return String(n).padStart(2,"0"); }
function toNum(d){ return Number(String(d).replace(/^0+/,"")) || Number(d); }
function sortNum(arr){ return arr.slice().sort((a,b)=>a-b); }

function calcularFrequencias(concursos){
  const freq={};
  for(let i=1;i<=25;i++) freq[i]=0;
  concursos.forEach(c=>{
    (c.dezenas||[]).forEach(d=>{
      const n=toNum(d);
      if(n>=1 && n<=25) freq[n]+=1;
    });
  });
  return freq;
}
function ordenarPorFreq(freq){
  return Object.entries(freq).map(([k,v])=>({dez:Number(k), f:v})).sort((a,b)=>b.f-a.f);
}
function contarParesImpares(jogo){
  const pares = jogo.filter(n=>n%2===0).length;
  return {pares, impares: jogo.length - pares};
}
function somaDezenas(jogo){ return jogo.reduce((a,b)=>a+b,0); }
function contarSequencias(jogo){
  let maxLen=1, curLen=0, prev=null;
  const sorted = sortNum(jogo);
  for(const n of sorted){
    if(prev!==null && n===prev+1) curLen++;
    else curLen=1;
    if(curLen>maxLen) maxLen=curLen;
    prev=n;
  }
  return { temSequencia: maxLen>=2, maxLen };
}
function distribuicaoBlocos(jogo){
  const b={A:0,B:0,C:0,D:0,E:0};
  jogo.forEach(n=>{
    if(n>=1 && n<=5) b.A++;
    else if(n<=10) b.B++;
    else if(n<=15) b.C++;
    else if(n<=20) b.D++;
    else b.E++;
  });
  return b;
}
function repetidasDoUltimo(jogo, ultimoDezenas){
  const setUlt = new Set((ultimoDezenas||[]).map(toNum));
  return sortNum(jogo.filter(n=>setUlt.has(n)));
}

/* ===== m√©tricas modernas ===== */
function calcModernMetrics(concursos){
  const n = concursos.length;
  const freq = Array(26).fill(0);
  const decay = Array(26).fill(0);
  const recent10 = Array(26).fill(0);
  const lastSeen = Array(26).fill(-1);
  const DECAY = 0.92;
  for(let i=0;i<n;i++){
    const nums=(concursos[i].dezenas||[]).map(toNum).filter(x=>x>=1 && x<=25);
    const w = Math.pow(DECAY, (n-1-i));
    nums.forEach(x=>{
      freq[x] += 1;
      decay[x] += w;
      lastSeen[x] = i;
      if(i >= n-10) recent10[x] += 1;
    });
  }
  const gap = Array(26).fill(999);
  for(let x=1;x<=25;x++){
    gap[x] = (lastSeen[x]===-1) ? n : (n-1-lastSeen[x]);
  }
  const trend = Array(26).fill(0);
  for(let x=1;x<=25;x++){
    const baseRate = freq[x] / Math.max(1,n);
    const recRate = recent10[x] / Math.max(1, Math.min(10,n));
    trend[x] = (recRate - baseRate);
  }
  return { n, freq, decay, recent10, gap, trend };
}

function renderModernInsights(metrics){
  const {n,freq,decay,gap,trend} = metrics;
  const topTrend = [];
  const topOverdue = [];
  const topDecay = [];
  for(let x=1;x<=25;x++){
    topTrend.push({x, v: trend[x]});
    topOverdue.push({x, v: gap[x]});
    topDecay.push({x, v: decay[x]});
  }
  topTrend.sort((a,b)=>b.v-a.v);
  topOverdue.sort((a,b)=>b.v-a.v);
  topDecay.sort((a,b)=>b.v-a.v);

  const trendList = topTrend.slice(0,8).filter(t=>t.v>0).map(t=>format2(t.x)).join(" - ") || "‚Äî";
  const overdueList = topOverdue.slice(0,8).map(t=>`${format2(t.x)} (${t.v})`).join(" ‚Ä¢ ") || "‚Äî";
  const recencyList = topDecay.slice(0,8).map(t=>format2(t.x)).join(" - ") || "‚Äî";

  return `
    <div class="box" style="margin-top:12px">
      <b>üß† Insights modernos (rec√™ncia + tend√™ncia + atraso)</b>
      <div class="mini" style="margin-top:8px">
        <b>üìà Em tend√™ncia (√∫ltimos 10 vs janela):</b> <span class="mono">${trendList}</span><br/>
        <b>‚è≥ Mais ‚Äúatrasadas‚Äù (gap em concursos):</b> <span class="mono">${overdueList}</span><br/>
        <b>‚ö° Mais fortes na rec√™ncia (peso exponencial):</b> <span class="mono">${recencyList}</span>
      </div>
      <div class="mini">Use isso como estrat√©gia (mix de frequ√™ncias + rec√™ncia). N√£o √© garantia de acerto.</div>
    </div>
  `;
}

/* ===== coocorr√™ncia (pares) para melhorar principal e mostrar ‚Äújuntas‚Äù ===== */
function calcCoocPairs(concursos){
  const co = Array.from({length:26}, ()=>Array(26).fill(0));
  concursos.forEach(c=>{
    const nums=(c.dezenas||[]).map(toNum).filter(n=>n>=1 && n<=25).sort((a,b)=>a-b);
    for(let i=0;i<nums.length;i++){
      for(let j=i+1;j<nums.length;j++){
        const a=nums[i], b=nums[j];
        co[a][b]++; co[b][a]++;
      }
    }
  });
  return co;
}
function topPairsFromCooc(co, topN=12){
  const arr=[];
  for(let a=1;a<=25;a++){
    for(let b=a+1;b<=25;b++){
      arr.push({a,b,count:co[a][b]});
    }
  }
  arr.sort((x,y)=>y.count-x.count);
  return arr.slice(0, topN);
}
</script>

<script>
/* ========================= DADOS ONLINE / DEMO ========================= */
const SOURCES = [
  {
    name: "loteriascaixa-api (p√∫blico)",
    latest: "https://loteriascaixa-api.herokuapp.com/api/lotofacil/latest",
    byId: (n)=>`https://loteriascaixa-api.herokuapp.com/api/lotofacil/${n}`,
    adapt: (j)=>({ concurso:Number(j.concurso), data:j.data||"", dezenas:(j.dezenas||[]).map(String) })
  },
  {
    name: "api.guidi.dev.br (fallback)",
    latest: "https://api.guidi.dev.br/loteria/lotofacil/ultimo",
    byId: (n)=>`https://api.guidi.dev.br/loteria/lotofacil/${n}`,
    adapt: (j)=>({ concurso:Number(j.numero), data:j.dataApuracao||"", dezenas:(j.listaDezenas||[]).map(String) })
  }
];

async function tryFetchJson(url){
  const r = await fetch(url, { cache:"no-store" });
  if(!r.ok) throw new Error("HTTP "+r.status);
  return await r.json();
}

async function getOnlineConcursos(qtd){
  let lastErr=null;
  for(const src of SOURCES){
    try{
      const latestRaw = await tryFetchJson(src.latest);
      const latest = src.adapt(latestRaw);
      if(!latest.concurso || !latest.dezenas?.length) throw new Error("Resposta inv√°lida");
      const ultimo = latest.concurso;
      const inicio = Math.max(1, ultimo - qtd + 1);
      const concursos=[];
      for(let c=inicio;c<=ultimo;c++){
        const raw = await tryFetchJson(src.byId(c));
        concursos.push(src.adapt(raw));
      }
      return { mode:"online", source:src.name, latest, concursos, inicio, ultimo };
    }catch(e){
      lastErr=e;
    }
  }
  throw lastErr || new Error("Falha online");
}

function buildDemo(qtd){
  const ultimo = 3600;
  const inicio = ultimo - qtd + 1;
  const concursos=[];
  for(let c=inicio;c<=ultimo;c++){
    const dezenas=new Set();
    while(dezenas.size<15) dezenas.add(Math.floor(Math.random()*25)+1);
    concursos.push({ concurso:c, data:"‚Äî", dezenas:[...dezenas].map(n=>format2(n)) });
  }
  const latest = concursos[concursos.length-1];
  return { mode:"demo", source:"Demonstra√ß√£o (offline)", latest, concursos, inicio, ultimo };
}

async function fetchUltimoResultado(){
  let lastErr=null;
  for(const src of SOURCES){
    try{
      const latestRaw = await tryFetchJson(src.latest);
      const latest = src.adapt(latestRaw);
      return { ...latest, source: src.name, mode: "online" };
    }catch(e){
      lastErr=e;
    }
  }
  const demo = buildDemo(1);
  return { ...demo.latest, source:"DEMO", mode:"demo" };
}
</script>

<script>
/* ========================= Estado global ========================= */
let lastPayload=null;
let lastCtx=null; // { freq, modern, coPairs }
let lastPrincipalGame=null;
let lastPrincipalMeta=null;
let lastInvertidaGame=null;
let lastTecnicaGames=null;

/* ‚úÖ MANUAL (Principal) */
let manualPrincipalSet = new Set();

/* ‚úÖ 15P manual editor */
let linesSystem15 = null;
let linesUser15 = null;
let activeLine15 = 4; // linha 5 em branco
</script>

<script>
/* ========================= Base: preparar contexto ========================= */
function qtdSelecionada(){ return Number(document.getElementById("qtdConcursos").value); }

async function prepararContextoBase(qtd){
  setStatus(true,"Carregando concursos‚Ä¶");
  setProgress(12);

  let payload;
  try{
    setStatus(true,"Buscando concursos reais‚Ä¶");
    setProgress(25);
    payload = await getOnlineConcursos(qtd);
  }catch(e){
    payload = buildDemo(qtd);
  }

  payload.concursos = payload.concursos.slice().sort((a,b)=>a.concurso-b.concurso);

  setStatus(true,"Calculando an√°lises do per√≠odo‚Ä¶");
  setProgress(62);

  const freq = calcularFrequencias(payload.concursos);
  const modern = calcModernMetrics(payload.concursos);
  const coPairs = calcCoocPairs(payload.concursos);

  lastPayload = payload;
  lastCtx = { freq, modern, coPairs };

  setStatus(false,"");
  setProgress(0);

  return { payload, freq, modern, coPairs };
}

function renderListaConcursos(concursos){
  const rows = concursos.map(c=>{
    const dezenas = (c.dezenas||[]).map(d=>format2(toNum(d))).join(" - ");
    const data = c.data ? String(c.data) : "‚Äî";
    return `
      <tr>
        <td><b>${c.concurso}</b></td>
        <td>${data}</td>
        <td class="mono">${dezenas}</td>
      </tr>
    `;
  }).join("");
  return `
    <table class="table">
      <thead><tr><th>Concurso</th><th>Data</th><th>Dezenas</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}
function verConcursos(){
  if(!lastPayload){
    alert("Gere primeiro uma an√°lise ou jogo para carregar concursos.");
    return;
  }
  document.getElementById("listaConcursos").innerHTML = renderListaConcursos(lastPayload.concursos);
  abrirModal();
}
</script>

<script>
/* ========================= RENDERS ========================= */
function renderTop10(freq, totalConcursos){
  const ord = ordenarPorFreq(freq).slice(0,10);
  const max = ord[0]?.f || 1;
  const bars = ord.map(x=>{
    const pct = Math.round((x.f/max)*100);
    return `
      <div style="display:flex;align-items:center;gap:10px;margin:10px 0">
        <div style="width:90px;color:var(--text);font-weight:950">Dezena ${format2(x.dez)}</div>
        <div style="flex:1;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.12);border-radius:999px;overflow:hidden;height:16px">
          <div style="height:100%;width:${pct}%;background:linear-gradient(90deg,var(--blue),var(--green))"></div>
        </div>
        <div style="width:56px;text-align:right;color:var(--text);font-weight:950">${x.f}x</div>
      </div>
    `;
  }).join("");

  return `
    <div class="box" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
        <b>üìä Top 10 dezenas mais frequentes</b>
        <span class="mini" style="margin:0">Base: <b>${totalConcursos}</b> concursos</span>
      </div>
      <div class="mini">Barras maiores = dezenas que mais apareceram no per√≠odo analisado.</div>
      <div style="margin-top:10px">${bars}</div>
    </div>
  `;
}

function renderTopPairsBars(coPairs, totalConcursos){
  const pairs = topPairsFromCooc(coPairs, 10);
  const max = pairs[0]?.count || 1;
  const rows = pairs.map(p=>{
    const pct = Math.round((p.count/max)*100);
    const pct2 = Math.round((p.count/Math.max(1,totalConcursos))*100);
    return `
      <div style="display:flex;align-items:center;gap:10px;margin:10px 0">
        <div style="width:110px;color:var(--text);font-weight:950">${format2(p.a)}-${format2(p.b)}</div>
        <div style="flex:1;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.12);border-radius:999px;overflow:hidden;height:16px">
          <div style="height:100%;width:${pct}%;background:linear-gradient(90deg,var(--blue),var(--green))"></div>
        </div>
        <div style="width:60px;text-align:right;color:var(--text);font-weight:950">${p.count}x</div>
        <div class="mini" style="margin:0;width:46px;text-align:right">${pct2}%</div>
      </div>
    `;
  }).join("");

  return `
    <div class="box" style="margin-top:12px">
      <b>üîó Pares que mais saem juntos (na janela)</b>
      <div class="mini" style="margin-top:6px">Isso √© ‚Äújuntas de verdade‚Äù (coocorr√™ncia nos concursos analisados).</div>
      <div style="margin-top:10px">${rows || `<div class="mini">‚Äî</div>`}</div>
    </div>
  `;
}

function abrirGraficoBlocos(blocos){
  const max = Math.max(blocos.A,blocos.B,blocos.C,blocos.D,blocos.E,1);
  function row(label, val){
    const pct = Math.round((val/max)*100);
    return `
      <div style="display:flex;align-items:center;gap:10px;margin:10px 0">
        <div style="width:90px;color:var(--text);font-weight:950">${label}</div>
        <div style="flex:1;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.12);border-radius:999px;overflow:hidden;height:16px">
          <div style="height:100%;width:${pct}%;background:linear-gradient(90deg,var(--blue),var(--green))"></div>
        </div>
        <div style="width:56px;text-align:right;color:var(--text);font-weight:950">${val}</div>
      </div>
    `;
  }
  document.getElementById("graficoBlocosArea").innerHTML =
    row("A (01‚Äì05)", blocos.A) +
    row("B (06‚Äì10)", blocos.B) +
    row("C (11‚Äì15)", blocos.C) +
    row("D (16‚Äì20)", blocos.D) +
    row("E (21‚Äì25)", blocos.E);

  document.getElementById("modalBlocosBack").style.display="flex";
}
</script>

<script>
/* ========================= AN√ÅLISE PRIME (resumo forte + pares juntos) ========================= */
function acaoAnalise(){
  if(!access.premium){
    alert("üîí Gerar an√°lise exige Premium.");
    return;
  }
  (async ()=>{
    const qtd = qtdSelecionada();
    try{
      await prepararContextoBase(qtd);
      const payload = lastPayload;
      const {freq, modern, coPairs} = lastCtx;

      setStatus(true,"Montando resumo PRIME‚Ä¶");
      setProgress(82);

      setStatus(false,"");
      setProgress(0);

      document.getElementById("analiseArea").innerHTML = `
        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap">
          <div>
            <div style="font-weight:1000;font-size:16px">üìà An√°lise PRIME do per√≠odo selecionado</div>
            <div class="mini">Janela: <b>${payload.inicio}</b> a <b>${payload.ultimo}</b> (${payload.concursos.length} concursos)</div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn btnGhost" type="button" onclick="verConcursos()">üìÖ Ver concursos</button>
          </div>
        </div>

        ${renderModernInsights(modern)}
        ${renderTop10(freq, payload.concursos.length)}
        ${renderTopPairsBars(coPairs, payload.concursos.length)}

        <div class="box" style="margin-top:12px">
          <b>üìå Nota PRIME</b>
          <div class="mini" style="margin-top:8px">
            Este painel usa estat√≠stica (frequ√™ncia, rec√™ncia, atraso e ‚Äúpares juntos‚Äù). Ajuda a montar estrat√©gias,
            mas <b>n√£o existe garantia de premia√ß√£o</b>.
          </div>
        </div>
      `;

      goView("viewAnalise");
    }catch(e){
      setStatus(false,""); setProgress(0);
      document.getElementById("analiseArea").innerHTML = `
        <div class="box">
          <b>‚ö†Ô∏è Erro</b>
          <div class="mini" style="margin-top:8px">${String(e?.message || e)}</div>
        </div>
      `;
      goView("viewAnalise");
    }
  })();
}
</script>

<script>
/* ========================= MANUAL PICK (JOGO PRINCIPAL) ========================= */
function renderPickGrid(selectedSet, lockedSet){
  let html = `<div class="pickGrid" id="pickGridPrincipal">`;
  for(let n=1;n<=25;n++){
    const sel = selectedSet.has(n) ? " sel" : "";
    const lock = (lockedSet && lockedSet.has(n)) ? " lock" : "";
    html += `<div class="pickCell${sel}${lock}" data-n="${n}">${format2(n)}</div>`;
  }
  html += `</div>`;
  return html;
}
function bindPickGrid(containerId, onClick){
  const root = document.getElementById(containerId);
  if(!root) return;
  root.querySelectorAll(".pickCell").forEach(cell=>{
    cell.addEventListener("click", ()=>{
      if(cell.classList.contains("lock")) return;
      const n = Number(cell.getAttribute("data-n"));
      onClick(n);
    });
  });
}
function renderManualPrincipalUI(){
  const area = document.getElementById("manualPrincipalArea");
  if(!area) return;

  const selected = [...manualPrincipalSet].sort((a,b)=>a-b);
  area.innerHTML = `
    <div class="box" style="margin-top:12px">
      <b>üß© Monte seu jogo manual (vira o Jogo Principal)</b>
      <div class="mini" style="margin-top:6px">
        Marque <b>15 dezenas</b>. Ao confirmar, a Invertida e a T√©cnica usar√£o o seu jogo.
      </div>

      <div class="numbers" style="justify-content:flex-start;margin-top:10px">
        ${selected.length ? selected.map(n=>`<div class="ball">${format2(n)}</div>`).join("") : `<div class="mini">‚Äî</div>`}
      </div>

      <div class="mini" style="margin-top:8px">Selecionadas: <b>${selected.length}/15</b></div>
      ${renderPickGrid(manualPrincipalSet)}

      <div class="row" style="margin-top:12px">
        <div class="col">
          <button class="btn btnGhost" type="button" onclick="manualPrincipalSet=new Set();renderManualPrincipalUI()">Limpar</button>
        </div>
        <div class="col">
          <button class="btn btnPrimary" type="button" onclick="usarManualComoPrincipal()">Usar meu jogo</button>
        </div>
      </div>

      <div class="mini" style="margin-top:10px">
        Dica PRIME: misture <b>quentes + frias</b> e tente manter <b>7/8 pares</b>.
      </div>
    </div>
  `;

  bindPickGrid("pickGridPrincipal", (n)=>{
    if(manualPrincipalSet.has(n)) manualPrincipalSet.delete(n);
    else{
      if(manualPrincipalSet.size>=15) return alert("Voc√™ j√° marcou 15 dezenas.");
      manualPrincipalSet.add(n);
    }
    renderManualPrincipalUI();
  });
}
function usarManualComoPrincipal(){
  if(manualPrincipalSet.size !== 15){
    return alert("Marque exatamente 15 dezenas.");
  }
  const jogo = [...manualPrincipalSet].sort((a,b)=>a-b);
  lastPrincipalGame = jogo.slice();
  lastInvertidaGame = null;
  lastTecnicaGames = null;

  if(lastPayload && lastCtx?.freq){
    const freq = lastCtx.freq;
    const pi = contarParesImpares(jogo);
    const soma = somaDezenas(jogo);
    const seq = contarSequencias(jogo);
    const blocos = distribuicaoBlocos(jogo);
    const reps = repetidasDoUltimo(jogo, lastPayload.latest.dezenas);
    lastPrincipalMeta = { pi, soma, seq, blocos, reps };
  }
  alert("‚úÖ Seu jogo foi definido como Jogo Principal!");
  updateCheckButtons();
}
</script>

<script>
/* ========================= JOGO PRINCIPAL (MELHORADO: JUNTAS + ATRASADAS) ========================= */
function gerarJogoForte(freq, modern, coPairs){
  // score individual: frequ√™ncia + rec√™ncia + leve atraso
  function scoreNum(n){
    const f = (freq[n]||0);
    const d = (modern?.decay?.[n]||0);
    const g = (modern?.gap?.[n]||0);
    return (f*1.0) + (d*3.0) + Math.min(6, g*0.35);
  }

  // pega um ‚Äún√∫cleo‚Äù baseado em pares mais fortes (coocorr√™ncia real)
  const topPairs = topPairsFromCooc(coPairs, 24).filter(p=>p.count>0);
  const coreSet = new Set();

  // tenta montar n√∫cleo com n√∫meros que aparecem nos pares mais fortes
  for(const p of topPairs){
    coreSet.add(p.a); coreSet.add(p.b);
    if(coreSet.size >= 10) break;
  }

  // ordena candidatos por score
  const order = [];
  for(let i=1;i<=25;i++) order.push({i, s: scoreNum(i)});
  order.sort((a,b)=>b.s-a.s);

  // lista de atrasadas
  const overdue = [];
  for(let i=1;i<=25;i++) overdue.push({i, g: modern?.gap?.[i] ?? 0});
  overdue.sort((a,b)=>b.g-a.g);
  const overduePick = overdue.slice(0,10).map(x=>x.i);

  // tenta muitas vezes, escolhe melhor por crit√©rios do jogo
  let best=null;

  for(let t=0;t<1400;t++){
    const set=new Set();

    // 1) entra com n√∫cleo ‚Äúmais juntas‚Äù
    [...coreSet].sort(()=>Math.random()-0.5).forEach(n=>{
      if(set.size<8) set.add(n);
    });

    // 2) adiciona 2‚Äì3 atrasadas (gap alto)
    overduePick.sort(()=>Math.random()-0.5).forEach(n=>{
      if(set.size<11) set.add(n);
    });

    // 3) completa com top score (evita ficar fraco)
    for(const it of order){
      if(set.size>=15) break;
      set.add(it.i);
    }

    // seguran√ßa
    while(set.size<15) set.add(1+Math.floor(Math.random()*25));

    const jogo = sortNum([...set]);

    const pi = contarParesImpares(jogo);
    const soma = somaDezenas(jogo);
    const blocos = distribuicaoBlocos(jogo);
    const seq = contarSequencias(jogo);
    const maxBlock = Math.max(blocos.A,blocos.B,blocos.C,blocos.D,blocos.E);

    // score do jogo
    let score=0;

    // pares/√≠mpares
    score += (pi.pares===7 || pi.pares===8) ? 25 : (pi.pares===6 || pi.pares===9) ? 12 : 0;
    // soma
    score += (soma>=170 && soma<=230) ? 20 : (soma>=160 && soma<=240) ? 10 : 0;
    // blocos
    score += (maxBlock<=5) ? 20 : (maxBlock===6) ? 10 : 0;
    // sequ√™ncias
    score += (seq.maxLen<=4) ? 12 : (seq.maxLen===5) ? 6 : 0;

    // for√ßa individual somada
    const indiv = jogo.reduce((a,n)=>a+scoreNum(n),0);
    score += Math.min(45, indiv);

    // b√¥nus: muitos pares fortes presentes
    const bonusTogether = topPairs.slice(0,12).reduce((acc,p)=>{
      const ok = jogo.includes(p.a) && jogo.includes(p.b);
      return acc + (ok ? Math.min(3, p.count) : 0);
    },0);
    score += bonusTogether;

    if(!best || score>best.score) best={jogo, score};
  }

  return best.jogo;
}

async function acaoPrincipal(){
  const qtd = qtdSelecionada();

  if(!access.premium && isFreeUsed()){
    alert("üîí Voc√™ j√° usou a gera√ß√£o gr√°tis. Para liberar, ative o Premium.");
    return;
  }

  try{
    await prepararContextoBase(qtd);

    const payload = lastPayload;
    const {freq, modern, coPairs} = lastCtx;

    setStatus(true,"Gerando jogo principal (15 dezenas)‚Ä¶");
    setProgress(80);

    const jogo = gerarJogoForte(freq, modern, coPairs);

    lastPrincipalGame = jogo.slice();
    lastInvertidaGame = null;
    lastTecnicaGames = null;

    const pi = contarParesImpares(jogo);
    const soma = somaDezenas(jogo);
    const seq = contarSequencias(jogo);
    const blocos = distribuicaoBlocos(jogo);
    const reps = repetidasDoUltimo(jogo, payload.latest.dezenas);

    lastPrincipalMeta = { pi, soma, seq, blocos, reps };

    setStatus(false,"");
    setProgress(0);

    if(!access.premium) markFreeUsed();
    aplicarAcessos();

    const balls = jogo.map(n=>`<div class="ball">${format2(n)}</div>`).join("");

    const resumoPares = (pi.pares===7||pi.pares===8)
      ? `Distribui√ß√£o ideal (${pi.pares} pares / ${pi.impares} √≠mpares).`
      : `Distribui√ß√£o fora do ideal (melhor: 7/8).`;

    const resumoSoma = (soma>=170 && soma<=230)
      ? `Soma ${soma} dentro da faixa estat√≠stica mais comum (evita extremos).`
      : `Soma ${soma} fora da faixa mais comum ‚Äî combina√ß√£o mais ‚Äúarriscada‚Äù.`;

    const resumoSeq = seq.temSequencia
      ? `Possui sequ√™ncia, m√°ximo de ${seq.maxLen} n√∫meros seguidos.`
      : `Sem sequ√™ncia (padr√£o mais ‚Äúquebrado‚Äù).`;

    const maxBlock = Math.max(blocos.A,blocos.B,blocos.C,blocos.D,blocos.E);
    const resumoBlocos = (maxBlock<=5)
      ? `Blocos equilibrados (m√°x ${maxBlock} em um bloco).`
      : `Concentra√ß√£o alta em blocos (m√°x ${maxBlock}).`;

    const resumoRep = reps.length
      ? `${reps.length} repetidas do √∫ltimo concurso (${payload.latest.concurso}).`
      : `Sem repetidas do √∫ltimo concurso (${payload.latest.concurso}).`;

    document.getElementById("principalArea").innerHTML = `
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <div style="font-weight:1000;font-size:16px">üéØ Jogo Principal gerado (15 dezenas)</div>
          <div class="mini">Janela: <b>${payload.inicio}</b> a <b>${payload.ultimo}</b> (${payload.concursos.length} concursos)</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btnGhost" type="button" onclick="verConcursos()">üìÖ Ver concursos</button>
          <button class="btn btnGhost" type="button" onclick="abrirGraficoBlocos(lastPrincipalMeta.blocos)">üìä Blocos A‚ÄìE</button>
        </div>
      </div>

      <div class="numbers">${balls}</div>

      <div class="box" style="margin-top:12px">
        <b>üßæ Resumo PRIME (objetivo)</b>
        <div class="grid" style="margin-top:12px">
          <div class="box">
            <b>‚öñÔ∏è Pares x √çmpares</b>
            <div class="mini" style="margin-top:8px"><b>${pi.pares}</b> pares ‚Ä¢ <b>${pi.impares}</b> √≠mpares</div>
            <div class="mini">${resumoPares}</div>
          </div>
          <div class="box">
            <b>‚ûï Soma</b>
            <div class="mini" style="margin-top:8px"><b>${soma}</b></div>
            <div class="mini">${resumoSoma}</div>
          </div>
          <div class="box">
            <b>üß© Blocos A‚ÄìE</b>
            <div class="mini" style="margin-top:8px">A: <b>${blocos.A}</b> ‚Ä¢ B: <b>${blocos.B}</b> ‚Ä¢ C: <b>${blocos.C}</b> ‚Ä¢ D: <b>${blocos.D}</b> ‚Ä¢ E: <b>${blocos.E}</b></div>
            <div class="mini">${resumoBlocos}</div>
          </div>
          <div class="box">
            <b>üîó Sequ√™ncias</b>
            <div class="mini" style="margin-top:8px"><b>${seq.temSequencia ? "Sim" : "N√£o"}</b> ‚Ä¢ M√°x: <b>${seq.maxLen}</b></div>
            <div class="mini">${resumoSeq}</div>
          </div>
          <div class="box">
            <b>üîÅ Repetidas do √∫ltimo</b>
            <div class="mini" style="margin-top:8px"><b>${reps.length ? reps.map(format2).join(", ") : "Nenhuma"}</b></div>
            <div class="mini">${resumoRep}</div>
          </div>
          <div class="box">
            <b>üéØ Objetivo</b>
            <div class="mini" style="margin-top:8px">
              Este jogo prioriza <b>dezenas que saem juntas</b> (pares fortes) + <b>atrasadas</b> (gap alto).
              Buscamos melhorar consist√™ncia de <b>12/13/14</b> e evoluir.
            </div>
          </div>
        </div>
      </div>

      ${renderModernInsights(modern)}
      ${renderTop10(freq, payload.concursos.length)}
      ${renderTopPairsBars(coPairs, payload.concursos.length)}

      <div class="grid" style="margin-top:12px">
        <div class="box">
          <b>ü§ñ Jogo do Sistema (atual)</b>
          <div class="numbers" style="justify-content:flex-start;margin-top:10px">${balls}</div>
          <div class="mini">Voc√™ pode usar este ou montar o seu jogo manual e substituir o principal.</div>
        </div>
        <div class="box"><div id="manualPrincipalArea"></div></div>
      </div>

      <div class="panelCheck" id="panelGerados">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <b>‚úÖ Verificar jogos gerados (base: Jogo Principal)</b>
          <button class="btn btnGhost" type="button" id="btnVerificarGeradosInline" style="display:none" onclick="goView('viewCheck')">Abrir verifica√ß√£o</button>
        </div>
        <div class="mini" style="margin-top:8px">
          Gere tamb√©m a <b>Invertida</b> e a <b>T√©cnica</b> para liberar a verifica√ß√£o autom√°tica de acertos.
        </div>
      </div>

      <div class="box" style="margin-top:12px">
        <b>üìå Aviso</b>
        <div class="mini" style="margin-top:8px">Estat√≠stica ajuda a montar estrat√©gia, mas <b>n√£o garante premia√ß√£o</b>.</div>
      </div>
    `;

    goView("viewPrincipal");

    manualPrincipalSet = new Set();
    renderManualPrincipalUI();
    updateCheckButtons();

  }catch(e){
    setStatus(false,""); setProgress(0);
    document.getElementById("principalArea").innerHTML = `
      <div class="box">
        <b>‚ö†Ô∏è Erro</b>
        <div class="mini" style="margin-top:8px">${String(e?.message || e)}</div>
      </div>
    `;
    goView("viewPrincipal");
  }
}
</script>

<script>
/* ========================= INVERTIDA + T√âCNICA ========================= */
function blocoIndex(n){ return Math.floor((n-1)/5)+1; }
function offsetNoBloco(n){ return ((n-1)%5)+1; }
function mapParaBloco(destBloco, offset){ return (destBloco-1)*5 + offset; }
function remapPorPermutacao(n, perm){
  const b = blocoIndex(n);
  const off = offsetNoBloco(n);
  const destB = perm[b-1];
  return mapParaBloco(destB, off);
}
function inverterJogoPorPerm(jogo, perm){
  return jogo.map(n=>remapPorPermutacao(Number(n), perm)).sort((a,b)=>a-b);
}
function renderCartao(jogo, clsName){
  const set = new Set(jogo.map(Number));
  let html = `<div class="cartao">`;
  for(let n=1;n<=25;n++){
    const active = set.has(n) ? ` ${clsName}` : "";
    html += `<div class="cel${active}">${String(n).padStart(2,"0")}</div>`;
  }
  html += `</div>`;
  return html;
}

function gerarInvertida(){
  if(!access.premium){ alert("üîí Invertida exige Premium."); return; }
  if(!lastPrincipalGame){ alert("Gere primeiro um Jogo Principal."); return; }
  const permInvertida = [5,4,3,2,1];
  const inv = inverterJogoPorPerm(lastPrincipalGame, permInvertida);
  lastInvertidaGame = inv.slice();
  document.getElementById("invertidaArea").innerHTML = `
    <div class="cartaoWrap">
      <div class="box">
        <b>üéØ Principal (atual)</b>
        <div class="numbers" style="justify-content:flex-start">${lastPrincipalGame.map(n=>`<div class="ball">${format2(n)}</div>`).join("")}</div>
        ${renderCartao(lastPrincipalGame, "on")}
      </div>
      <div class="box">
        <b>üîÑ Invertida</b>
        <div class="numbers" style="justify-content:flex-start">${inv.map(n=>`<div class="ball">${format2(n)}</div>`).join("")}</div>
        ${renderCartao(inv, "inv")}
      </div>
    </div>
  `;
  updateCheckButtons();
}
function gerarTecnicaPremiada(){
  if(!access.premium){ alert("üîí T√©cnica premiada exige Premium."); return; }
  if(!lastPrincipalGame){ alert("Gere primeiro um Jogo Principal."); return; }
  const permTec1 = [3,4,5,1,2];
  const permTec2 = [3,1,5,2,4];
  const g1 = inverterJogoPorPerm(lastPrincipalGame, permTec1);
  const g2 = inverterJogoPorPerm(lastPrincipalGame, permTec2);
  lastTecnicaGames = { g1, g2 };
  document.getElementById("tecnicaArea").innerHTML = `
    <div class="grid">
      <div class="box">
        <b>üèÜ Jogo 1</b>
        <div class="numbers" style="justify-content:flex-start;margin-top:10px">${g1.map(n=>`<div class="ball">${format2(n)}</div>`).join("")}</div>
        ${renderCartao(g1, "tech")}
      </div>
      <div class="box">
        <b>üèÜ Jogo 2</b>
        <div class="numbers" style="justify-content:flex-start;margin-top:10px">${g2.map(n=>`<div class="ball">${format2(n)}</div>`).join("")}</div>
        ${renderCartao(g2, "tech")}
      </div>
    </div>
  `;
  updateCheckButtons();
}

function updateCheckButtons(){
  const ready = !!(lastPrincipalGame && lastInvertidaGame && lastTecnicaGames?.g1 && lastTecnicaGames?.g2);
  const btnTop = document.getElementById("btnVerificarGeradosFromPrincipal");
  const btnInline = document.getElementById("btnVerificarGeradosInline");
  if(btnTop) btnTop.style.display = ready ? "inline-flex" : "none";
  if(btnInline) btnInline.style.display = ready ? "inline-flex" : "none";

  const panel = document.getElementById("panelGerados");
  if(panel){
    const msg = ready
      ? `Pronto ‚úÖ Agora voc√™ pode conferir automaticamente os <b>4 jogos gerados</b> (Principal, Invertida, T√©cnica 1 e T√©cnica 2) com base no resultado do concurso.`
      : `Gere tamb√©m a <b>Invertida</b> e a <b>T√©cnica</b> para liberar a verifica√ß√£o autom√°tica de acertos.`;
    const mini = panel.querySelector(".mini");
    if(mini) mini.innerHTML = msg;
  }
  if(ready) montarTelaCheck();
}

async function conferirGerados(){
  if(!(lastPrincipalGame && lastInvertidaGame && lastTecnicaGames?.g1 && lastTecnicaGames?.g2)){
    alert("Gere Principal + Invertida + T√©cnica primeiro.");
    return;
  }
  let res;
  try{ res = await fetchUltimoResultado(); }
  catch(e){ alert("Falha ao buscar o √∫ltimo resultado."); return; }

  const resultNums = (res.dezenas||[]).map(toNum);
  function hits(gameNums){
    const setR=new Set(resultNums);
    const h = sortNum(gameNums.filter(n=>setR.has(Number(n))).map(Number));
    return {count:h.length, hits:h};
  }
  const hP = hits(lastPrincipalGame);
  const hI = hits(lastInvertidaGame);
  const hT1 = hits(lastTecnicaGames.g1);
  const hT2 = hits(lastTecnicaGames.g2);

  document.getElementById("checkArea").innerHTML = `
    <div class="box">
      <b>üìå Resultado usado para confer√™ncia</b>
      <div class="mini" style="margin-top:8px">
        Concurso <b>${res.concurso}</b> ‚Ä¢ Data: <b>${res.data || "‚Äî"}</b> ‚Ä¢ Dezenas:
        <span class="mono">${resultNums.map(format2).join(" - ")}</span>
      </div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div class="box">
        <b>üéØ Principal ‚Ä¢ Acertos: ${hP.count}</b>
        <div class="mini" style="margin-top:8px">Acertou: <b>${hP.hits.map(format2).join(", ") || "‚Äî"}</b></div>
        <div class="numbers" style="justify-content:flex-start;margin-top:10px">${lastPrincipalGame.map(n=>`<div class="ball">${format2(n)}</div>`).join("")}</div>
      </div>
      <div class="box">
        <b>üîÑ Invertida ‚Ä¢ Acertos: ${hI.count}</b>
        <div class="mini" style="margin-top:8px">Acertou: <b>${hI.hits.map(format2).join(", ") || "‚Äî"}</b></div>
        <div class="numbers" style="justify-content:flex-start;margin-top:10px">${lastInvertidaGame.map(n=>`<div class="ball">${format2(n)}</div>`).join("")}</div>
      </div>
      <div class="box">
        <b>üèÜ T√©cnica 1 ‚Ä¢ Acertos: ${hT1.count}</b>
        <div class="mini" style="margin-top:8px">Acertou: <b>${hT1.hits.map(format2).join(", ") || "‚Äî"}</b></div>
        <div class="numbers" style="justify-content:flex-start;margin-top:10px">${lastTecnicaGames.g1.map(n=>`<div class="ball">${format2(n)}</div>`).join("")}</div>
      </div>
      <div class="box">
        <b>üèÜ T√©cnica 2 ‚Ä¢ Acertos: ${hT2.count}</b>
        <div class="mini" style="margin-top:8px">Acertou: <b>${hT2.hits.map(format2).join(", ") || "‚Äî"}</b></div>
        <div class="numbers" style="justify-content:flex-start;margin-top:10px">${lastTecnicaGames.g2.map(n=>`<div class="ball">${format2(n)}</div>`).join("")}</div>
      </div>
    </div>

    <div class="tinyFoot">Fonte: ${res.source || "‚Äî"} ‚Ä¢ Modo: ${String(res.mode||"‚Äî").toUpperCase()}</div>
  `;
}

function montarTelaCheck(){
  document.getElementById("checkArea").innerHTML = `
    <div class="box">
      <b>‚úÖ Seus 4 jogos gerados (base: Jogo Principal)</b>
      <div class="mini" style="margin-top:8px">
        Clique em <b>‚ÄúConferir com √∫ltimo concurso‚Äù</b> para ver quantos n√∫meros cada jogo acertou.
      </div>
    </div>
    <div class="grid" style="margin-top:12px">
      <div class="box">
        <b>üéØ Principal</b>
        <div class="numbers" style="justify-content:flex-start;margin-top:10px">${lastPrincipalGame.map(n=>`<div class="ball">${format2(n)}</div>`).join("")}</div>
      </div>
      <div class="box">
        <b>üîÑ Invertida</b>
        <div class="numbers" style="justify-content:flex-start;margin-top:10px">${lastInvertidaGame.map(n=>`<div class="ball">${format2(n)}</div>`).join("")}</div>
      </div>
      <div class="box">
        <b>üèÜ T√©cnica 1</b>
        <div class="numbers" style="justify-content:flex-start;margin-top:10px">${lastTecnicaGames.g1.map(n=>`<div class="ball">${format2(n)}</div>`).join("")}</div>
      </div>
      <div class="box">
        <b>üèÜ T√©cnica 2</b>
        <div class="numbers" style="justify-content:flex-start;margin-top:10px">${lastTecnicaGames.g2.map(n=>`<div class="ball">${format2(n)}</div>`).join("")}</div>
      </div>
    </div>
  `;
}
</script>

<script>
/* ========================= 15P (MAIS JUNTAS x MENOS JUNTAS + EXPLICA√á√ÉO) ========================= */
function combKey(arr){ return arr.slice().sort((a,b)=>a-b).map(n=>format2(n)).join("-"); }
function parseKey(key){ return key.split("-").map(s=>Number(s)); }

function genCombos(nums, k){
  const res=[];
  const n=nums.length;
  if(k>n) return res;
  const idx = Array.from({length:k}, (_,i)=>i);
  function pushCur(){ res.push(idx.map(i=>nums[i])); }
  function next(){
    let i=k-1;
    while(i>=0 && idx[i]===i+n-k) i--;
    if(i<0) return false;
    idx[i]++;
    for(let j=i+1;j<k;j++) idx[j]=idx[j-1]+1;
    return true;
  }
  pushCur();
  while(next()) pushCur();
  return res;
}

function countItemsets(concursos){
  const maps={3:new Map(), 4:new Map(), 5:new Map()};
  concursos.forEach(c=>{
    const nums=(c.dezenas||[]).map(toNum).filter(x=>x>=1 && x<=25).sort((a,b)=>a-b);
    [3,4,5].forEach(k=>{
      const combos = genCombos(nums,k);
      const m = maps[k];
      for(const arr of combos){
        const key=combKey(arr);
        m.set(key,(m.get(key)||0)+1);
      }
    });
  });
  return maps;
}
function pickTopAndBottom(map, topN, bottomN){
  const arr = Array.from(map.entries()).map(([key,count])=>({key,count, nums:parseKey(key)}));
  arr.sort((a,b)=>b.count-a.count);
  const top = arr.slice(0, topN);
  const bottom = arr.slice().reverse().slice(0, bottomN);
  return {top,bottom};
}

// stats 15p (cooc + freq + rec√™ncia + gap)
function calcStats15P(concursos){
  const n=concursos.length;
  const freq=Array(26).fill(0);
  const co=Array.from({length:26},()=>Array(26).fill(0));
  const decay=Array(26).fill(0);
  const lastSeen=Array(26).fill(-1);
  const DECAY=0.92;

  concursos.forEach((c,idx)=>{
    const nums=(c.dezenas||[]).map(toNum).filter(x=>x>=1 && x<=25);
    const w=Math.pow(DECAY,(n-1-idx));
    nums.forEach(a=>{freq[a]++; decay[a]+=w; lastSeen[a]=idx;});
    nums.sort((a,b)=>a-b);
    for(let i=0;i<nums.length;i++){
      for(let j=i+1;j<nums.length;j++){
        const a=nums[i], b=nums[j];
        co[a][b]++; co[b][a]++;
      }
    }
  });
  const gap=Array(26).fill(999);
  for(let i=1;i<=25;i++){
    gap[i]=(lastSeen[i]===-1)?n:(n-1-lastSeen[i]);
  }
  return {n,freq,co,decay,gap};
}

function buildLinesStrongWeak(itemsets, stats){
  const kChoice = (itemsets[5].size>0 ? 5 : (itemsets[4].size>0 ? 4 : 3));
  const {top,bottom} = pickTopAndBottom(itemsets[kChoice], 80, 160);

  const used=new Set();

  function scoreNum(n){
    return (stats.freq[n]*1.0) + (stats.decay[n]*3.0) + Math.min(6, stats.gap[n]*0.35);
  }

  function addStrongFromSeed(seedNums){
    const line=[];
    for(const n of seedNums){
      if(!used.has(n) && line.length<5){ line.push(n); used.add(n); }
    }
    // completa por score alto (rec√™ncia+freq+gap)
    const order=[];
    for(let i=1;i<=25;i++){
      if(used.has(i)) continue;
      order.push({i,s:scoreNum(i)});
    }
    order.sort((a,b)=>b.s-a.s);
    for(const it of order){
      if(line.length>=5) break;
      line.push(it.i); used.add(it.i);
    }
    line.sort((a,b)=>a-b);
    return line;
  }

  // 3 fortes
  const strong=[];
  for(const it of top){
    if(strong.length>=3) break;
    strong.push(addStrongFromSeed(it.nums));
  }
  while(strong.length<3) strong.push(addStrongFromSeed([]));

  // 2 fracas: baixa cooc com fortes + baixa for√ßa individual
  function coWithStrong(n){
    let sum=0;
    strong.flat().forEach(s=>{ sum += (stats.co[n]?.[s] || 0); });
    return sum;
  }
  const cand=[];
  for(let i=1;i<=25;i++){
    if(used.has(i)) continue;
    const lowTogether = coWithStrong(i); // queremos baixo
    const coldness = (stats.freq[i]*0.7 + stats.decay[i]*1.2); // queremos baixo
    const score = (lowTogether*1.4) + (coldness*1.0); // menor = melhor (pra errar)
    cand.push({i,score});
  }
  cand.sort((a,b)=>a.score-b.score);

  function makeWeakLine(){
    const line=[];
    for(const it of cand){
      if(line.length>=5) break;
      if(used.has(it.i)) continue;
      line.push(it.i); used.add(it.i);
    }
    while(line.length<5){
      const r=1+Math.floor(Math.random()*25);
      if(used.has(r)) continue;
      line.push(r); used.add(r);
    }
    line.sort((a,b)=>a-b);
    return line;
  }

  const weak1 = makeWeakLine();
  const weak2 = makeWeakLine();

  return { lines:[...strong, weak1, weak2], kChoice, topCombos:top, bottomCombos:bottom };
}

function combos3de5(){
  const r=[];
  for(let a=1;a<=3;a++){
    for(let b=a+1;b<=4;b++){
      for(let c=b+1;c<=5;c++){
        r.push([a,b,c]);
      }
    }
  }
  return r;
}
function gerarJogos15P(linhas){
  const comb=combos3de5();
  return comb.map((idxs)=>{
    const set=new Set();
    idxs.forEach(i=>linhas[i-1].forEach(n=>set.add(n)));
    return sortNum([...set]);
  });
}

function explainLineCombos(line, built, kind){
  const k = Math.min(built.kChoice, line.length);
  const combos = genCombos(line.slice().sort((a,b)=>a-b), k).map(combKey);
  const comboSet = new Set(combos);

  const bestTop = built.topCombos.filter(it=>comboSet.has(it.key)).slice(0,3);
  const bestBottom = built.bottomCombos.filter(it=>comboSet.has(it.key)).slice(0,3);

  const topHtml = bestTop.length
    ? bestTop.map(it=>`<span class="chip" style="padding:7px 10px;font-size:12px">‚úÖ ${it.key} ‚Ä¢ <b>${it.count}</b>x</span>`).join(" ")
    : `<span class="mini">‚Äî (sem combo exato, mas a linha foi montada pela l√≥gica de cooc/freq/rec√™ncia)</span>`;

  const bottomHtml = bestBottom.length
    ? bestBottom.map(it=>`<span class="chip" style="padding:7px 10px;font-size:12px">‚ùå ${it.key} ‚Ä¢ <b>${it.count}</b>x</span>`).join(" ")
    : `<span class="mini">‚Äî</span>`;

  const resumo = (kind==="forte")
    ? `Linha montada para <b>ACERTAR</b>: prioriza combos que mais saem juntos (k=${built.kChoice}), completando com rec√™ncia/frequ√™ncia e atraso.`
    : `Linha montada para <b>ERRAR</b>: usa dezenas com <b>baixa coocorr√™ncia</b> com as fortes e baixa ‚Äúfor√ßa‚Äù na janela, buscando 2 linhas erradas completas (10 pts).`;

  return `
    <div class="mini" style="margin-top:8px">
      <b>Resumo:</b> ${resumo}<br/>
      <b>Mais saem juntas (dentro desta linha):</b>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">${topHtml}</div>
      <div style="margin-top:10px"></div>
      <b>Menos saem juntas (dentro desta linha):</b>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">${bottomHtml}</div>
    </div>
  `;
}

/* ===== EDITOR MANUAL 15P (mant√©m) ===== */
function initUserLines15FromSystem(lines){
  linesSystem15 = lines.map(l=>l.slice());
  linesUser15 = lines.map(l=>l.slice());
  linesUser15[4] = []; // Linha 5 em branco
  activeLine15 = 4;
}
function setActiveLine15(i){ activeLine15=i; render15Editor(); }
function usedNumbersExceptLine(lineIdx){
  const used=new Set();
  for(let i=0;i<5;i++){
    if(i===lineIdx) continue;
    (linesUser15?.[i]||[]).forEach(n=>used.add(n));
  }
  return used;
}
function render15Editor(){
  const root = document.getElementById("editor15Area");
  if(!root || !linesUser15) return;

  const lineBtns = [1,2,3,4,5].map(i=>{
    return `<button class="lineBtn ${activeLine15===i-1?"on":""}" type="button" onclick="setActiveLine15(${i-1})">Linha ${i}</button>`;
  }).join("");

  const current = linesUser15[activeLine15] || [];
  const used = usedNumbersExceptLine(activeLine15);

  root.innerHTML = `
    <div class="box" style="margin-top:12px">
      <b>üß© Monte suas linhas (15P) ‚Äî manual</b>
      <div class="mini" style="margin-top:6px">
        Selecione uma linha e complete com <b>5 dezenas</b>. N√£o permitimos repeti√ß√£o entre linhas (mant√©m a l√≥gica dos 10 jogos).
      </div>

      <div class="lineTabs">${lineBtns}</div>

      <div class="mini" style="margin-top:10px"><b>Linha ${activeLine15+1}:</b></div>
      <div class="slotRow">
        ${[0,1,2,3,4].map(i=>`<div class="slot">${current[i] ? format2(current[i]) : "‚Äî"}</div>`).join("")}
      </div>

      <div class="pickGrid" id="pickGrid15">
        ${[...Array(25)].map((_,i)=>{
          const n=i+1;
          const sel = current.includes(n) ? " sel" : "";
          const lock = used.has(n) ? " lock" : "";
          return `<div class="pickCell${sel}${lock}" data-n="${n}">${format2(n)}</div>`;
        }).join("")}
      </div>

      <div class="row" style="margin-top:12px">
        <div class="col">
          <button class="btn btnGhost" type="button" onclick="linesUser15[activeLine15]=[];render15Editor()">Limpar linha</button>
        </div>
        <div class="col">
          <button class="btn btnPrimary" type="button" onclick="gerar15PComMinhasLinhas()">Gerar 10 jogos (minhas linhas)</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="col">
          <button class="btn btnGhost" type="button" onclick="initUserLines15FromSystem(linesSystem15);render15Editor();document.getElementById('user15Output').innerHTML=''">Resetar para linhas do sistema</button>
        </div>
        <div class="col">
          <button class="btn btnGhost" type="button" onclick="goView('view15p')">Ok</button>
        </div>
      </div>

      <div class="mini" style="margin-top:10px">
        Dica PRIME: em cada linha, tente manter <b>2/3 pares</b>, mix de frequ√™ncia e evitar 4+ no mesmo bloco.
      </div>
    </div>
  `;

  bindPickGrid("pickGrid15", (n)=>{
    if(used.has(n)) return;
    const line = linesUser15[activeLine15];
    const idx = line.indexOf(n);
    if(idx>=0) line.splice(idx,1);
    else{
      if(line.length>=5) return alert("Essa linha j√° tem 5 dezenas.");
      line.push(n);
      line.sort((a,b)=>a-b);
    }
    render15Editor();
  });
}
function allLinesComplete(lines){
  return lines && lines.length===5 && lines.every(l=>Array.isArray(l) && l.length===5);
}
function gerar15PComMinhasLinhas(){
  if(!allLinesComplete(linesUser15)) return alert("Complete as 5 linhas com 5 dezenas cada.");
  const jogos = gerarJogos15P(linesUser15);

  const jogosHtml = jogos.map((j, idx)=>`
    <div class="box">
      <b>Jogo ${idx+1}</b>
      <div class="numbers" style="justify-content:flex-start;margin-top:10px">
        ${j.map(n=>`<div class="ball">${format2(n)}</div>`).join("")}
      </div>
    </div>
  `).join("");

  const linesTable = linesUser15.map((l,idx)=>`
    <tr><td><b>${idx+1}</b></td><td class="mono">${l.map(format2).join(" - ")}</td></tr>
  `).join("");

  document.getElementById("user15Output").innerHTML = `
    <div class="box" style="margin-top:12px">
      <b>üìå Suas linhas (manual)</b>
      <div style="margin-top:10px;overflow:auto">
        <table class="table">
          <thead><tr><th>Linha</th><th>Dezenas</th></tr></thead>
          <tbody>${linesTable}</tbody>
        </table>
      </div>
    </div>

    <div class="box" style="margin-top:12px">
      <b>üéØ Seus 10 jogos (com suas linhas)</b>
      <div class="grid" style="margin-top:12px">${jogosHtml}</div>
      <div class="mini" style="margin-top:10px">
        Este m√©todo cobre todas as combina√ß√µes de 3 linhas entre 5 (10 jogos). <b>N√£o √© garantia de pr√™mio</b>.
      </div>
    </div>
  `;
  alert("‚úÖ 10 jogos gerados com suas linhas!");
}

/* ===== GERAR 15P (SISTEMA) ===== */
async function gerar15P(){
  const can15p = ((access.premium && access.addon15) || access.isAdmin);
  if(!can15p) return alert("üîí O recurso '15 pontos garantido' √© um EXTRA comprado separadamente (libera via claims).");

  const qtd = qtdSelecionada();
  try{
    await prepararContextoBase(qtd);
    const payload = lastPayload;

    setStatus(true,"15P: analisando combos (mais juntas x menos juntas)‚Ä¶");
    setProgress(82);

    const stats = calcStats15P(payload.concursos);
    const itemsets = countItemsets(payload.concursos);
    const built = buildLinesStrongWeak(itemsets, stats);

    const lines = built.lines;
    const jogos = gerarJogos15P(lines);

    setStatus(false,""); setProgress(0);

    initUserLines15FromSystem(lines);

    const lineMeta = lines.map((l,idx)=>({
      idx: idx+1,
      kind: (idx<3) ? "forte" : "fraca",
      line: l
    }));

    const linesTable = lineMeta.map(m=>`
      <tr>
        <td><b>${m.idx}</b></td>
        <td>${m.kind==="forte" ? "FORTE (acertar)" : "FRACA (errar)"}</td>
        <td class="mono">${m.line.map(format2).join(" - ")}</td>
      </tr>
    `).join("");

    const explainBlocks = lineMeta.map(m=>`
      <div class="box">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <b>${m.kind==="forte" ? "üî• Linha " + m.idx + " (ACERTAR)" : "üßä Linha " + m.idx + " (ERRAR)"}</b>
        </div>
        <div class="numbers" style="justify-content:flex-start;margin-top:10px">
          ${m.line.map(n=>`<div class="ball">${format2(n)}</div>`).join("")}
        </div>
        ${explainLineCombos(m.line, built, (m.kind==="forte"?"forte":"fraca"))}
      </div>
    `).join("");

    const jogosHtml = jogos.map((j, idx)=>`
      <div class="box">
        <b>Jogo ${idx+1}</b>
        <div class="numbers" style="justify-content:flex-start;margin-top:10px">
          ${j.map(n=>`<div class="ball">${format2(n)}</div>`).join("")}
        </div>
      </div>
    `).join("");

    document.getElementById("p15Area").innerHTML = `
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <div style="font-weight:1000;font-size:16px">‚úÖ 15 Pontos (Estrat√©gia) ‚Ä¢ 10 jogos</div>
          <div class="mini">Janela: <b>${payload.inicio}</b> a <b>${payload.ultimo}</b> (${payload.concursos.length} concursos)</div>
          <div class="mini" style="margin-top:8px">
            üéØ Objetivo: <b>ACERTAR 3 linhas</b> (fortes) e <b>ERRAR 2 linhas</b> (fracas) para maximizar o fechamento.
            <br/>‚ö†Ô∏è Estat√≠stica ajuda, mas <b>n√£o garante premia√ß√£o</b>.
          </div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btnGhost" type="button" onclick="verConcursos()">üìÖ Ver concursos</button>
        </div>
      </div>

      <div class="box" style="margin-top:12px">
        <b>üìå Linhas 1 a 5 (sistema)</b>
        <div class="mini" style="margin-top:6px">
          M√©todo: busca <b>quintetos</b> (se poss√≠vel), sen√£o <b>quadras</b>, sen√£o <b>ternos</b> que <b>mais saem juntos</b> na janela.
          Tamb√©m cria 2 linhas com <b>menos saem juntas</b> (para errar 2 linhas = 10 pts).
        </div>
        <div style="margin-top:12px;overflow:auto">
          <table class="table">
            <thead><tr><th>Linha</th><th>Tipo</th><th>Dezenas</th></tr></thead>
            <tbody>${linesTable}</tbody>
          </table>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="col">
            <button class="btn btnBlue" type="button" onclick="render15Editor()">‚úçÔ∏è Criar minhas linhas (manual)</button>
          </div>
          <div class="col">
            <button class="btn btnGhost" type="button" onclick="document.getElementById('user15Output').innerHTML=''">Limpar resultado manual</button>
          </div>
        </div>
      </div>

      <div id="editor15Area"></div>
      <div id="user15Output"></div>

      <div class="box" style="margin-top:12px">
        <b>üîç Explica√ß√£o detalhada das linhas</b>
        <div class="grid" style="margin-top:12px">${explainBlocks}</div>
      </div>

      <div class="box" style="margin-top:12px">
        <b>üéØ 10 jogos do sistema</b>
        <div class="grid" style="margin-top:12px">${jogosHtml}</div>
        <div class="mini" style="margin-top:10px">
          Fechamento: 10 jogos = combina√ß√µes de 3 linhas entre 5. <b>N√£o h√° garantia de acerto</b>.
        </div>
      </div>

      <div class="tinyFoot">Fonte: ${payload.source || "‚Äî"} ‚Ä¢ Modo: ${String(payload.mode||"‚Äî").toUpperCase()}</div>
    `;

    goView("view15p");
  }catch(e){
    setStatus(false,""); setProgress(0);
    document.getElementById("p15Area").innerHTML = `
      <div class="box">
        <b>‚ö†Ô∏è Erro</b>
        <div class="mini" style="margin-top:8px">${String(e?.message || e)}</div>
      </div>
    `;
    goView("view15p");
  }
}
</script>

<script>
/* ========================= Eventos ========================= */
document.getElementById("btnEntrar").addEventListener("click", entrar);
document.getElementById("btnForgot").addEventListener("click", forgotPassword);
document.getElementById("btnComprar").addEventListener("click", comprarPremium);
document.getElementById("btnJaComprei").addEventListener("click", jaComprei);
document.getElementById("btnSair").addEventListener("click", sair);
document.getElementById("btnComprar15p").addEventListener("click", comprar15p);
document.getElementById("btnAtivar15p").addEventListener("click", jaComprei15p);

["btnHomePrincipal","btnHomeAnalise","btnHomeInvertida","btnHomeTecnica","btnHome15p"].forEach(id=>{
  const el = document.getElementById(id);
  if(el) bindCardKey(el);
});
</script>

</body>
</html>
