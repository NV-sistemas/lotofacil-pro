
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Lotof√°cil Prime Analytics</title>

<style>
  :root{

    --bg1:#0b0c10;
    --bg2:#050608;

    --card: rgba(26,26,28,.72);
    --surface: rgba(255,255,255,.045);
    --surface2: rgba(255,255,255,.07);

    --text:#f3f4f6;
    --muted: rgba(243,244,246,.84);
    --muted2: rgba(243,244,246,.62);


    --accent:#eab308;
    --accent2:#f5d67b;

    --yellow:var(--accent);
    --yellow2:var(--accent2);


    --orange:#caa34a;
    --red:#3f3f46; --red2:#52525b;

    --stroke: rgba(255,255,255,.12);
    --stroke2: rgba(255,255,255,.08);

    --shadow: 0 18px 60px rgba(0,0,0,.65);

    --glowGold: 0 0 0 1px rgba(234,179,8,.20), 0 18px 60px rgba(234,179,8,.12);
    --glowSoft: 0 0 0 1px rgba(255,255,255,.06), 0 18px 60px rgba(0,0,0,.55);


    --green:var(--accent); --green2:var(--accent2);
    --blue:var(--accent); --blue2:var(--accent2);
    --purple:var(--accent); --purple2:var(--accent2);
  }


  *{ -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
  body{
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif !important;
    font-size: 15.5px;
    line-height: 1.35;
  }
  h1,h2,h3{ letter-spacing:.2px; }
  .title{
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif !important;
    font-weight: 1000;
    letter-spacing: .6px;
  }
  .sub, .subtitle, .mini, .hint{ color: var(--muted2); }


  button, .btn, .btnGhost, .btnPrimary, .btnBlue, .btnGreen, .btnRed, .btnYellow, .btnOrange{
    border-radius:18px !important;
    font-weight:1000;
    letter-spacing:.2px;
    transition:.15s;
  }
  button:hover, .btn:hover, .btnGhost:hover, .btnPrimary:hover, .btnBlue:hover, .btnGreen:hover, .btnRed:hover, .btnYellow:hover, .btnOrange:hover{
    transform: translateY(-1px);
    filter: brightness(1.05);
  }
  button:active, .btn:active, .btnGhost:active, .btnPrimary:active, .btnBlue:active, .btnGreen:active, .btnRed:active, .btnYellow:active, .btnOrange:active{
    transform: translateY(0px);
    filter: brightness(.98);
  }

  .btnPrimary, .btnYellow{
    background: linear-gradient(180deg, rgba(250,204,21,.98), rgba(250,204,21,.78)) !important;
    color:#111 !important;
    border:1px solid rgba(250,204,21,.35) !important;
    box-shadow: 0 18px 55px rgba(250,204,21,.18);
  }
  .btnPrimary:hover, .btnYellow:hover{ box-shadow: 0 18px 70px rgba(250,204,21,.22); }

  .btnGhost, .btn, .btnBlue, .btnGreen, .btnOrange{
    background: rgba(0,0,0,.55) !important;
    border:1px solid rgba(255,255,255,.12) !important;
    color: var(--text) !important;
    box-shadow: 0 14px 40px rgba(0,0,0,.28);
  }

  .btnSmall{ padding:10px 14px !important; border-radius:16px !important; width:auto !important; }
  .btnWide{ width:100% !important; }

*{box-sizing:border-box;font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
  html,body{height:100%}
  body{
    margin:0;
    color:var(--text);
    background:
      radial-gradient(900px 620px at 18% 8%, rgba(255,255,255,.06), transparent 60%),
      radial-gradient(900px 620px at 82% 12%, rgba(255,255,255,.04), transparent 62%),
      radial-gradient(1100px 700px at 50% 0%, rgba(255,255,255,.05), transparent 58%),
      linear-gradient(180deg,var(--bg1),var(--bg2));
    min-height:100dvh;
    overflow-x:hidden;
  }

  .center{
    display:flex;align-items:center;justify-content:center;
    min-height:100dvh;padding:16px;
  }
  .wrap{max-width:1180px;margin:0 auto;padding:18px}


  .header{display:flex;justify-content:center;align-items:center;margin-bottom:14px}
  .title{
    font-size: clamp(22px, 5.8vw, 34px);
    font-weight:1000;
    margin:0;
    letter-spacing:.3px;
    text-align:center;
    line-height:1.12;
    color: var(--accent);
    text-transform: uppercase;
  }


  .chip{
    display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:999px;
    background: rgba(0,0,0,.72);
    border:1px solid var(--stroke);
    color:var(--text);
    font-size:12px;font-weight:900;
    box-shadow: 0 10px 30px rgba(0,0,0,.25);
    white-space:nowrap;
  }
  .chip .dot{width:7px;height:7px;border-radius:999px;background:rgba(250,204,21,.95);display:inline-block}
  .card{
    background: linear-gradient(180deg, rgba(38,38,42,.75), rgba(20,20,22,.55));
    border:1px solid var(--stroke);
    border-radius:26px;
    padding:18px;
    box-shadow:var(--shadow);
    margin-bottom:14px;
    backdrop-filter: blur(10px);
    width:100%;
    max-width: none;
    margin-left:auto;margin-right:auto;
  }

  #loginWrap .card{max-width:520px}


  #app .card{max-width:none}

  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin-top:12px}
  .box{
    background: linear-gradient(180deg, rgba(55,55,60,.28), rgba(20,20,22,.18));
    border:1px solid rgba(255,255,255,.11);
    border-radius:20px;
    padding:14px;
    box-shadow: var(--glowSoft);
  }


  .savedPack.on{
    background: rgba(255,255,255,.06) !important;
    border-color: rgba(250,204,21,.75) !important;
    color:#0b0b0b !important;
  }
  .savedPack.on b{ color:#0b0b0b !important; }
  .savedPack.on .mini{ color: rgba(0,0,0,.72) !important; }

.box p{margin:0;color:var(--text);font-size:13px;line-height:1.5}
  .mini{color:var(--muted);font-size:12px;margin-top:8px;line-height:1.45}
  .mini strong{color:var(--text)}

  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:stretch}
  .col{flex:1 1 240px;min-width:0}

  label{display:block;font-size:12px;color:var(--accent);font-weight:950;margin-bottom:6px;text-align:left}
  input, select{
    width:100%;
    max-width:100%;
    padding:14px 14px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.70);
    color:var(--text);
    outline:none;
  }
  input:focus, select:focus{
    border-color: rgba(250,204,21,.28);
    box-shadow: 0 0 0 3px rgba(255,255,255,.06);
  }
  input::placeholder{color:rgba(203,213,225,.65)}
  select{cursor:pointer}
  .btn{
    padding:12px 16px;
    border:3px solid #000;
    border-radius:18px;
    background: rgba(0,0,0,.52);
    color: var(--text);
    font-weight:1000;
    cursor:pointer;
    transition:.15s;
    box-shadow: 0 14px 40px rgba(0,0,0,.35);
    width:100%;
  }
  .btn:hover{filter:brightness(1.05);transform:translateY(-1px)}
  .btn:active{transform:translateY(0px);filter:brightness(.98)}
  .btn:disabled{opacity:.55;cursor:not-allowed;transform:none;box-shadow:none}
  .btnPrimary{background:linear-gradient(135deg,var(--yellow),var(--yellow2));box-shadow: var(--glowGold);color:#111111;border:1px solid rgba(250,204,21,.55)}
  .btnBlue{background:linear-gradient(135deg,var(--accent),var(--accent2));box-shadow: var(--glowGold);color:#111111;border:1px solid rgba(255,255,255,.28)}
  .btnPurple{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#111111;box-shadow: var(--glowGold);border:1px solid rgba(255,255,255,.28)}
  .btnDanger{background: linear-gradient(180deg, rgba(64,64,70,.45), rgba(20,20,22,.55)) !important;border: 1px solid rgba(255,255,255,.14) !important;color: var(--text) !important;box-shadow: 0 10px 26px rgba(0,0,0,.45) !important;}
  .btnGhost{
    background: rgba(255,255,255,.06) !important;
    border:1px solid rgba(255,255,255,.14) !important;
    color: rgba(255,255,255,.92) !important;
    box-shadow: 0 14px 40px rgba(0,0,0,.26);
    width:auto;
  }

  .status{display:none;margin-top:10px;padding:12px;border-radius:14px;background:rgba(56,189,248,.10);
          border:1px solid rgba(56,189,248,.22);color:#e6f8ff;font-size:13px;font-weight:950;}
  .bar{height:10px;border-radius:999px;overflow:hidden;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.08);margin-top:10px}
  .bar>div{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .2s ease}


  .view{display:none}
  .view.on{display:block}
  .topNav{
    display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
    margin-bottom:10px;
  }
  .topNav .left{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .topNav .right{display:flex;gap:10px;flex-wrap:wrap;align-items:center}


  .actionGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:14px;margin-top:12px}
  .actionCard{
    text-align:left;
    border:3px solid #000; /* BLACK PIANO */
    background:
      radial-gradient(700px 260px at 22% 0%, rgba(255,255,255,.06), transparent 60%),
      radial-gradient(700px 260px at 78% 0%, rgba(255,255,255,.05), transparent 62%),
      linear-gradient(180deg, rgba(38,38,42,.72), rgba(20,20,22,.52));
    border-radius:26px;
    padding:20px 22px;
    cursor:pointer;
    transition:.15s;
    position:relative;
    min-height:150px;
    box-shadow: 0 18px 55px rgba(0,0,0,.42);
    overflow:hidden;
  }
  .actionCard:hover{transform:translateY(-2px);background: var(--surface2);}
  .actionTitle{
    font-weight:1000;
    font-size:18px;
    margin:0 0 10px;
    color: var(--accent);
    letter-spacing:.25px;
  }
  .badge.premium{border-color:rgba(56,189,248,.30);background:rgba(56,189,248,.14);color:#e6f8ff}
  .badge.free{border-color:rgba(250,204,21,.35);background:rgba(255,255,255,.06);color:#fff2b0}


  .extraCard{
    border:3px solid rgba(250,204,21,.75);
    background: radial-gradient(900px 240px at 30% 20%, rgba(255,255,255,.06), transparent 60%),
                radial-gradient(900px 240px at 70% 20%, rgba(255,255,255,.05), transparent 60%),
                rgba(0,0,0,.82);
    box-shadow: var(--glowGold), 0 22px 70px rgba(0,0,0,.45);
    transform: translateZ(0);
  }
  .extraBadge{
    position:absolute;top:14px;right:14px;
    font-size:11px;font-weight:1000;
    padding:6px 10px;border-radius:999px;
    border:3px solid rgba(250,204,21,.75);
    background:rgba(255,255,255,.06);
    color:#fff2b0;
  }
  .extraHeadline{
    display:flex;align-items:center;gap:10px;flex-wrap:wrap;
    margin-bottom:6px
  }
  .extraHighlight{
    display:inline-flex;align-items:center;gap:8px;
    padding:6px 10px;border-radius:999px;
    border:3px solid rgba(250,204,21,.75);
    background:rgba(255,255,255,.06);
    color:#fff2b0;
    font-weight:1000;font-size:12px;
  }
  /* ====== ELITE (COMBO) ====== */
  .eliteCard{
    border:3px solid rgba(234,179,8,.55);
    background: radial-gradient(900px 240px at 30% 20%, rgba(255,255,255,.06), transparent 60%),
                radial-gradient(900px 240px at 70% 20%, rgba(255,255,255,.05), transparent 60%),
                rgba(0,0,0,.74);
    box-shadow: var(--glowGold), 0 22px 70px rgba(0,0,0,.40);
  }
  .eliteBadge{
    position:absolute;top:14px;right:14px;
    font-size:11px;font-weight:1000;
    padding:6px 10px;border-radius:999px;
    border:3px solid rgba(234,179,8,.55);
    background:rgba(255,255,255,.06);
    color:#fff2b0;
    letter-spacing:.35px;
  }



  .cartaoWrap{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}

@media (max-width: 520px){
  .actionGrid{ grid-template-columns: 1fr; }
  .header{ margin-bottom: 10px; }
}

  .cartao{
    display:grid;grid-template-columns: repeat(5, 44px);
    gap:8px;justify-content:center;margin:10px 0 0;
  }
  .cel{
    width:44px;height:44px;border-radius:12px;
    display:flex;align-items:center;justify-content:center;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.70);
    color:var(--text);font-weight:1000;
  }
  .cel.on{background:rgba(0,0,0,.72);border:1px solid rgba(250,204,21,.38);color:var(--accent);box-shadow:0 12px 30px rgba(0,0,0,.25)}
  .cel.inv{background:rgba(0,0,0,.72);border:1px solid rgba(250,204,21,.28);color:var(--accent2);box-shadow:0 12px 30px rgba(0,0,0,.25)}
  .cel.tech{background:rgba(255,255,255,.06);border:1px solid rgba(250,204,21,.30);color:#fff2b0;box-shadow:0 12px 30px rgba(0,0,0,.25)}

  .numbers{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:10px 0 6px}
  .ball{
    width:44px;height:44px;border-radius:999px;display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,.72);
    border:1px solid rgba(250,204,21,.28);
    color:var(--accent);font-weight:1000;letter-spacing:.4px;
    box-shadow:0 14px 34px rgba(0,0,0,.35);
  }
  .balls{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}

  .hr{height:1px;background:rgba(255,255,255,.10);margin:12px 0;border-radius:999px}


  .panelCheck{
    margin-top:12px;
    border:1px solid var(--stroke);
    background: var(--surface);
    border-radius:18px;
    padding:14px;
  }
  .panelCheck b{font-size:13px}


  .modalBack{display:none;position:fixed;inset:0;background:rgba(0,0,0,.62);backdrop-filter: blur(7px);
             align-items:center;justify-content:center;padding:16px;z-index:999}
  .modal{
    width:100%;
    max-width:980px;
    background: linear-gradient(180deg, rgba(12,10,7,.86), rgba(12,10,7,.62));
    border:3px solid #000;
    border-radius:20px;
    box-shadow:0 40px 120px rgba(0,0,0,.70);
    overflow:hidden;
  }
  .tip::after{
    content: attr(data-tip);
    position:absolute;
    left:0;
    top: calc(100% + 8px);
    min-width: 220px;
    max-width: 360px;
    padding:10px 12px;
    border-radius:12px;
    background:rgba(2,6,23,.92);
    border:1px solid rgba(255,255,255,.14);
    color:rgba(248,250,252,.95);
    box-shadow: 0 18px 55px rgba(0,0,0,.55);
    opacity:0;
    pointer-events:none;
    transform: translateY(-4px);
    transition: .12s ease;
    z-index: 9999;
    font-size: 12px;
    line-height: 1.35;
    white-space: normal;
  }
  .tip:hover::after{ opacity:1; transform: translateY(0); }
  .tip .q{opacity:.8}



@media (max-width: 520px){
  #loginWrap .row{
    flex-direction: column;
    gap: 10px;
  }
  #loginWrap .col{
    flex: 1 1 auto !important;
  }
}

.pickGrid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;max-width:460px;margin-top:10px}
.pickCell{
  height:44px;border-radius:12px;
  display:flex;align-items:center;justify-content:center;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.70);
  font-weight:1000;cursor:pointer;user-select:none;
}
.pickCell.sel{background:rgba(0,0,0,.72);border-color:rgba(250,204,21,.40);color:var(--accent);box-shadow:0 12px 30px rgba(0,0,0,.25)}
.pickCell.lock{opacity:.35;cursor:not-allowed}

.hit-11{ color:#38bdf8; font-weight:900; }
.hit-12{ color:#a78bfa; font-weight:900; }
.hit-13{ color:#facc15; font-weight:1000; }
.hit-14{ color:#fb923c; font-weight:1000; }
.hit-15{ color:#facc15; font-weight:1000; }

.lineTabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.lineBtn{
  padding:8px 10px;border-radius:12px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.70);
  color:var(--text);font-weight:1000;cursor:pointer
}
.lineBtn.on{border-color:rgba(56,189,248,.35);background:rgba(56,189,248,.12);color:#e6f8ff}
.slotRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.slot{
  min-width:52px;
  padding:8px 10px;border-radius:12px;
  border:1px dashed rgba(255,255,255,.18);
  background: rgba(0,0,0,.66);
  font-weight:1000;
}


  .btnPrimary{
    background: var(--yellow) !important;
    color:#111111 !important;
    border:1px solid rgba(250,204,21,.80) !important;
    box-shadow: var(--glowGold) !important;
  }


  @media (max-width:420px){
    .ball{ width:38px; height:38px; font-size:13px; }
    .numbers{ gap:6px; }
  }


  .swapCard{ margin-top: 10px; }
  .swapImgs{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap:12px;
    margin-top:12px;
    align-items:start;
  }
  .swapImgWrap{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.66);
    border-radius:16px;
    padding:12px;
    text-align:center;
    overflow:visible;
  }
  .swapImgWrap b{ color: var(--yellow); display:block; margin-bottom:8px; }
  .swapImg{
    display:block;
    width:100%;
    max-width: 520px;
    height:auto;
    aspect-ratio: 5 / 6;
    object-fit: contain;
    margin: 0 auto;
    border-radius:14px;
    border:1px solid rgba(250,204,21,.22);
    background: rgba(0,0,0,.70);
    box-shadow: 0 18px 55px rgba(0,0,0,.38);
  }
  .swapRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
  .swapMini{
    flex: 1 1 260px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.66);
    border-radius:16px;
    padding:12px;
  }
  .swapMini b{ color: var(--yellow); }
  .swapGamesRow{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
    margin-top:12px;
    align-items:start;
  }
  @media (max-width: 900px){
    .swapGamesRow{ grid-template-columns: 1fr; }
  }

.p15-card{
  background: linear-gradient(180deg, rgba(0,0,0,.92), rgba(0,0,0,.78));
  border:3px solid rgba(250,204,21,.75);
  border-radius:18px;
  padding:14px;
  margin:16px auto;
  max-width:380px;
  box-shadow:
    0 0 0 1px rgba(250,204,21,.15),
    0 0 25px rgba(250,204,21,.08),
    0 18px 55px rgba(0,0,0,.65);
}

.p15CardsGrid{
  display:grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap:14px;
  align-items:start;
  margin-top:12px;
}
.p15CardsGrid .p15-card{
  max-width:none;
  width:100%;
  margin:0;
}
@media (max-width: 1100px){
  .p15CardsGrid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
}
@media (max-width: 720px){
  .p15CardsGrid{ grid-template-columns: 1fr; }
  .p15CardsGrid .p15-card{ max-width: 420px; margin: 0 auto; }
}

.p15-title{
  font-weight:1000;
  font-size:14px;
  color:var(--accent);
  margin-bottom:10px;
  text-align:center;
  letter-spacing:.3px;
}

.p15-metrics{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
  margin-bottom:12px;
}

.p15-chip{
  background:rgba(0,0,0,.85);
  border:1px solid rgba(250,204,21,.25);
  padding:6px 8px;
  border-radius:14px;
  font-size:11px;
  font-weight:900;
  text-align:center;
  box-shadow: 0 0 12px rgba(250,204,21,.05);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.p15-numbers{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  justify-content:center;
  margin:8px 0 12px 0;
}

.p15-ball{
  width:32px;
  height:32px;
  border-radius:999px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,.95);
  border:1px solid rgba(250,204,21,.55);
  color:var(--accent);
  font-weight:1000;
  font-size:11px;
  box-shadow: 0 0 10px rgba(250,204,21,.15);
}

.p15-section{
  font-size:12px;
  line-height:1.45;
  margin-bottom:10px;
  color:rgba(255,255,255,.92);
}

.p15-warning{
  background:rgba(0,0,0,.75);
  border:1px solid rgba(250,204,21,.25);
  padding:10px;
  border-radius:14px;
  font-size:11.5px;
  line-height:1.4;
  box-shadow: inset 0 0 12px rgba(250,204,21,.05);
}

@media (max-width:420px){
  .p15-card{ max-width:92vw; padding:12px; }
  .p15-ball{ width:28px; height:28px; font-size:10px; }
  .p15-chip{ font-size:10px; padding:6px; }
}


  .badge, .pill, .tag, .chip{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:7px 12px;
    border-radius:999px;
    font-size:12px;
    font-weight:1000;
    letter-spacing:.3px;
    border:3px solid #000;
    background: rgba(0,0,0,.55);
    color: rgba(255,255,255,.92);
  }
  .badge.yellow, .pill.yellow, .tag.yellow, .chip.yellow{
    background: rgba(255,255,255,.06);
    border-color: rgba(250,204,21,.35);
    color: var(--accent2);
  }
  .badge.premium, .pill.premium{
    background: rgba(255,255,255,.06);
    border-color: rgba(255,255,255,.14);
    color: rgba(255,255,255,.86);
  }
  .badge.extra, .pill.extra{
    background: rgba(251,146,60,.12);
    border-color: rgba(251,146,60,.30);
    color: rgba(255,255,255,.92);
  }


  .iconBox, .iconWrap{
    width:34px;height:34px;
    border-radius:12px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    background: rgba(255,255,255,.06);
    border:1px solid rgba(250,204,21,.22);
    box-shadow: 0 12px 30px rgba(0,0,0,.25);
  }
  .iconBox svg, .iconWrap svg{ filter: drop-shadow(0 6px 12px rgba(0,0,0,.35)); }


  .badge{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:7px 12px;
    border-radius:999px;
    font-size:12px;
    font-weight:1000;
    letter-spacing:.35px;
    border:3px solid #000;
    background: rgba(0,0,0,.48);
    color: rgba(255,255,255,.92);
    backdrop-filter: blur(8px);
  }
  .badge.free{
    background: rgba(255,255,255,.06);
    border-color: rgba(250,204,21,.32);
    color: var(--accent2);
  }
  .badge.premium{
    background: rgba(255,255,255,.06);
    border-color: rgba(255,255,255,.14);
    color: rgba(255,255,255,.88);
  }
  .extraBadge{
    display:inline-flex;
    align-items:center;
    padding:7px 12px;
    border-radius:999px;
    font-size:12px;
    font-weight:1000;
    letter-spacing:.35px;
    background: rgba(251,146,60,.14);
    border:1px solid rgba(251,146,60,.30);
    color: rgba(255,255,255,.92);
  }

  .actionDesc{
    color: rgba(255,255,255,.80);
    font-size:14.5px;
    line-height:1.35;
  }


  .mini{line-height:1.4; letter-spacing:.15px}
  b{letter-spacing:.15px}
  .topNav button{min-height:44px}


  .btnGhost, .btn, .btnRed, .btnOrange, .btnBlue, .btnGreen, .btnYellow{
    background: linear-gradient(180deg, rgba(64,64,70,.45), rgba(20,20,22,.55)) !important;
    border: 1px solid rgba(255,255,255,.14) !important;
    color: var(--text) !important;
    box-shadow: 0 10px 26px rgba(0,0,0,.45);
  }
  .btnPrimary{
    background: linear-gradient(180deg, rgba(234,179,8,.95), rgba(202,163,74,.92)) !important;
    border: 1px solid rgba(0,0,0,.35) !important;
    color:#111827 !important;
    box-shadow: 0 14px 30px rgba(234,179,8,.18);
  }


  .table{width:100%; border-collapse:separate; border-spacing:0 10px}
  .table thead th{
    font-weight:950; letter-spacing:.35px;
    padding:10px 12px; text-transform:uppercase;
    color: rgba(243,244,246,.92);
  }
  .table tbody tr{
    background: linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.35));
    border:1px solid rgba(255,255,255,.10);
    box-shadow: 0 10px 22px rgba(0,0,0,.35);
  }
  .table tbody td{padding:12px 12px; font-weight:650; color: rgba(243,244,246,.92)}
  .table tbody tr td:first-child{border-top-left-radius:14px;border-bottom-left-radius:14px}
  .table tbody tr td:last-child{border-top-right-radius:14px;border-bottom-right-radius:14px}


  #p15Area .box{padding:18px}
  #p15Area .mini{font-size:14px}


  .primeStepHdr{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
  .primePill{
    display:inline-flex;align-items:center;gap:8px;
    padding:6px 12px;border-radius:999px;
    border:1px solid rgba(234,179,8,.55);
    background: rgba(0,0,0,.30);
    font-weight:950;color:rgba(243,244,246,.92)
  }
  .primeGrid2{display:grid;grid-template-columns:1.1fr .9fr;gap:14px}
  @media(max-width:920px){.primeGrid2{grid-template-columns:1fr}}
  .primePanel{
    background: linear-gradient(180deg, rgba(0,0,0,.28), rgba(0,0,0,.40));
    border:1px solid rgba(255,255,255,.10);
    border-radius:22px;
    padding:14px;
  }
  .primePanelTitle{font-weight:950;letter-spacing:.25px;margin-bottom:10px}
  .primeDonutWrap{display:grid;grid-template-columns:220px 1fr;gap:14px;align-items:center}
  @media(max-width:720px){.primeDonutWrap{grid-template-columns:1fr}}
  .primeRowCard{
    background: linear-gradient(180deg, rgba(0,0,0,.26), rgba(0,0,0,.42));
    border:1px solid rgba(255,255,255,.10);
    border-radius:18px;
    padding:12px;
    margin:10px 0;
  

  }


  /* === ELITE MOTIVOS (PADR√ÉO ELITE AJUSTADO MOBILE) === */
.eliteMotives{
  margin-top:14px;
  background: linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.45));
  border:1px solid rgba(255,255,255,.10);
  border-radius:20px;
  padding:14px;
}

.eliteMotivesHdr{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:12px;
}

.eliteMotivesHdr b{
  color: var(--accent);
  font-size:13.5px;
  letter-spacing:.4px;
}

.eliteMotivesHdr span{
  color: rgba(255,255,255,.55);
  font-size:11px;
  font-weight:800;
}

.eliteMotivesGrid{
  display:flex;
  flex-direction:column;
  gap:10px;
}

.eliteMotivesRow{
  display:flex;
  flex-direction:column;
  gap:8px;
  padding:12px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.55);
}

.eliteMotivesTag{
  font-size:11.5px;
  font-weight:950;
  color: rgba(255,255,255,.85);
  background: rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.12);
  border-radius:999px;
  padding:6px 10px;
  align-self:flex-start;
}

.eliteMotivesNums{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}

.eliteMotivesNum{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  min-width:34px;
  height:30px;
  padding:0 10px;
  border-radius:999px;
  background: rgba(0,0,0,.85);
  border:1px solid rgba(234,179,8,.40);
  color: var(--accent);
  font-weight:1000;
  font-size:12px;
  letter-spacing:.3px;
}

/* ===== Desktop ajustado ===== */
@media (min-width: 721px){

  .eliteMotivesRow{
    flex-direction:row;
    align-items:center;
    justify-content:space-between;
  }

  .eliteMotivesNums{
    justify-content:flex-end;
  }

}

/* ===== Mobile refinado ===== */
@media (max-width: 720px){

  .eliteMotivesHdr span{
    display:none;
  }

  .eliteMotivesRow{
    padding:10px 12px;
  }

  .eliteMotivesNum{
    min-width:30px;
    height:26px;
    font-size:11px;
  }

}
  .primeBar{
    height:10px;border-radius:999px;overflow:hidden;
    background: rgba(255,255,255,.10);
    border:1px solid rgba(255,255,255,.10);
  }
  .primeBar > div{
    height:100%;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    border-radius:999px;
  }

</style>
</head>

<body>

<!-- ================= FIREBASE SDKs (HTML PURO) ================= -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-functions-compat.js"></script>

<script>

const APP_NAME = "LOTOF√ÅCIL PRIME ANALYTICS";
const BUY_LINK = "https://pay.hotmart.com/O104148865Y?off=c4m0nezi";
const BUY_LINK_15P = "https://pay.hotmart.com/Y104149008G?off=eehchnv4";

const ADMIN_EMAIL = "admin@lotofacilprime.com";

function freeKey(uid){ return `lf_free_used_v1_${uid||"anon"}`; }


// (removido) sequ√™ncia antiga do motor do JOGO PRINCIPAL
</script>

<script>

const firebaseConfig = {
  apiKey: "AIzaSyCodYgkQG0TUaqCk1i-0QcSB8GIt0iWp8c",
  authDomain: "lotofacil-prime.firebaseapp.com",
  projectId: "lotofacil-prime",
  storageBucket: "lotofacil-prime.firebasestorage.app",
  messagingSenderId: "385524602679",
  appId: "1:385524602679:web:9760aeb30dcb835a962cb2"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const functions = firebase.app().functions("us-central1");
</script>

<!-- LOGIN -->
<div class="center" id="loginWrap">
  <div class="card">
    <div style="text-align:center">
      <div class="title" style="margin:0">üéØ <span id="appName1"></span></div>
      <div class="mini" style="margin-top:6px">
        Entre para acessar o painel. Premium libera as ferramentas principais.
      </div>
    </div>

    <div style="margin-top:12px" class="row">
      <div class="col">
        <label>Email</label>
        <input id="email" type="email" placeholder="seuemail@gmail.com" />
      </div>
      <div class="col">
        <label>Senha</label>
        <input id="senha" type="password" placeholder="sua senha" />
      </div>
    </div>

    <button id="btnEntrar" class="btn btnPrimary" type="button">Entrar / Criar conta</button>

    <button id="btnForgot" class="btn" type="button" style="margin-top:10px;background: rgba(0,0,0,.72);border:1px solid rgba(255,255,255,.14);color:var(--text);box-shadow:none">
      Esqueci minha senha
    </button>

    <div id="msgOk" class="status" style="display:none"></div>
    <div id="msgErr" class="status" style="display:none;background:rgba(251,113,133,.12);border:1px solid rgba(251,113,133,.28);color:#ffe7ec"></div>

    <div class="footerNote">Dica: use o mesmo email utilizado na compra Hotmart.</div>
  </div>
</div>

<!-- APP -->
<div class="wrap" id="app" style="display:none">
  <div class="header">
    <div class="title">üéØ <span id="appName2"></span></div>
  </div>

  <!-- PREMIUM GATE -->
  <div class="card" id="premiumGate" style="display:none">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div>
        <div style="font-weight:1000;font-size:16px">üîí √Årea Premium</div>
        <div class="mini">
          No modo Free voc√™ pode gerar <b>1 vez</b> apenas no <b>Jogo Principal</b>.
          Para liberar <b>An√°lise</b>, <b>Invertida</b> e <b>T√©cnica Premiada</b>, ative o Premium.
        </div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn btnDanger" id="btnComprar" type="button">Comprar Premium</button>
        <button class="btn btnGhost" id="btnJaComprei" type="button">J√° comprei</button>
        <button class="btn btnGhost" id="btnSair" type="button">Sair</button>
      </div>
    </div>
  </div>

  <!-- EXTRA 15P UPSELL -->
  <div class="card" id="addon15Card" style="display:none">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div>
        <div style="font-weight:1000;font-size:16px">‚ú® Recurso Extra: 15 pontos garantido</div>
        <div class="mini">
          Esse recurso √© um <b>EXTRA comprado separadamente</b> e abre uma tela pr√≥pria.
        </div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <button class="btn btnDanger" id="btnComprar15p" type="button">Comprar 15 pontos</button>
        <button class="btn btnGhost" id="btnAtivar15p" type="button">J√° comprei</button>
      </div>
    </div>
  </div>

      <!-- ===== TELAS ===== -->
  <div class="view on" id="viewHome">
    <div class="card">

      <!-- Linha superior: seletor + progresso -->
      <div class="row">
        <div class="col">
          <label>Quantidade de concursos para analisar</label>
          <select id="qtdConcursos">
            <option value="3">3 concursos(recomendado para 15P)</option>
            <option value="4">4 concursos(recomendado para PRINCIPAL)</option>
            <option value="5">5 concursos</option>
            <option value="6">6 concursos</option>
            <option value="7">7 concursos</option>
            <option value="12">12 concursos</option>
            <option value="15">15 concursos</option>
            <option value="20">20 concursos</option>
            <option value="30">30 concursos</option>
            <option value="50">50 concursos</option>
            <option value="75">75 concursos</option>
            <option value="100">100 concursos</option>
            </select>
          <div class="mini" style="margin-top:8px">
            Escolha a janela e depois selecione uma das op√ß√µes abaixo.
          </div>
        </div>

        <div class="col">
          <label>Progresso</label>

          <div id="status" class="status">
            <div id="statusText">Carregando‚Ä¶</div>
            <div class="bar"><div id="barFill"></div></div>
          </div>

          <div class="mini">
            Se a an√°lise estiver pesada, use 10 ou 20 concursos.
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <!-- Cards de a√ß√µes -->
      <div class="actionGrid">
<div class="actionCard" id="btnHomePrincipal" role="button" tabindex="0">
          <span class="badge free">FREE 1x</span>
          <p class="actionTitle">üéØ Jogo principal</p>
          <p class="actionDesc">JOGO PRINCIPAL/INVERTIDA/TECNICAS 1 E 2 (4JOGOS) . Voc√™ tamb√©m pode montar o seu jogo manualmente.</p>
        </div>

<div class="actionCard" id="btnHomeAnalise" role="button" tabindex="0">
          <span class="badge premium">PREMIUM</span>
          <p class="actionTitle">üìà Gerar an√°lise</p>
          <p class="actionDesc">Resumo PRIME do "SISTEMA PREDITIVO" do per√≠odo selecionado (sem jogo).</p>
        </div>


<div class="actionCard" id="btnHomeCreate" role="button" tabindex="0">
          <span class="badge premium">PREMIUM</span>
          <p class="actionTitle">üß© Criar seus jogos</p>
          <p class="actionDesc">Escolha suas dezenas e gere automaticamente: PRINCIPAL (4), ELITE (6) ou 15P (10). Sem explica√ß√µes ‚Ä¢ com bot√£o Salvar.</p>
        </div>

<div class="actionCard" id="btnHomeSaved" role="button" tabindex="0">
          <span class="badge premium">PREMIUM</span>
          <p class="actionTitle">üíæ Jogos salvos</p>
          <p class="actionDesc">
            Confira seus jogos salvos e veja quantos pontos faria.
          </p>
        </div>

<div class="actionCard eliteCard" id="btnHomeElite" role="button" tabindex="0">
          <span class="eliteBadge">COMBO</span>
          <p class="actionTitle">üíé JOGO ELITE</p>
          <p class="actionDesc">Gera 6 jogos exclusivos (padr√µes ELITE fixos).</p>
        </div>

<div class="actionCard extraCard" id="btnHome15p" role="button" tabindex="0">
          <span class="extraBadge">EXTRA</span>
          <div class="extraHeadline">
            <p class="actionTitle" style="margin:0">‚úÖ 15 pontos garantido</p>
            <span class="extraHighlight">ESTRAT√âGIA (10 JOGOS)</span>
          </div>
          <p class="actionDesc">5 LINHAS geram 10 jogos "EXCLUSIVOS".</p>
        </div>
</div>
    </div>

    <div class="card" id="resultadoHome">
      <div class="footerNote">Selecione a janela e escolha uma op√ß√£o acima.</div>
    </div>

    <div class="appFooter">
      <div class="chip" id="chipUser">
        <span class="dot"></span>
        <span id="chipText">‚Äî</span>
      </div>
    </div>
  </div>

  <!-- TELA: AN√ÅLISE -->
  <div class="view" id="viewAnalise">
    <div class="topNav">
      <div class="left">
        <button class="btn btnGhost" type="button" onclick="goView('viewHome')">‚¨Ö Voltar</button>
      </div>
      <div class="right">
        <button class="btn btnGhost" type="button" onclick="verConcursos()">üìÖ Ver concursos</button>
      </div>
    </div>

    <div class="card" id="analiseArea">
      <div class="footerNote">Clique em ‚ÄúGerar an√°lise‚Äù na tela principal.</div>
    </div>
  </div>

  
  <!-- TELA: CRIAR SEUS JOGOS (PREMIUM) -->
  <div class="view" id="viewCreateGames">
    <div class="topNav">
      <div class="left">
        <button class="btn btnGhost" type="button" onclick="goView('viewHome')">‚¨Ö Voltar</button>
      </div>
    </div>

    <div class="card">
      <div class="box">
        <b>üß© CRIAR SEUS JOGOS (PREMIUM)</b>
        <div class="mini" style="margin-top:8px">
          Escolha suas dezenas e gere automaticamente os jogos do m√≥dulo ‚Äî <b>sem explica√ß√µes</b>. Depois, clique em <b>Salvar</b>.
        </div>

        <div class="row" style="margin-top:12px">
          <div class="col">
            <button class="btn btnGhost btnWide" type="button" onclick="openCreateMode('principal')">üéØ Principal (4 jogos)</button>
          </div>
          <div class="col">
            <button class="btn btnPrimary btnWide" type="button" onclick="openCreateMode('elite')">üíé ELITE (6 jogos)</button>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="col">
            <button class="btn btnGhost btnWide" type="button" onclick="openCreateMode('p15')">‚úÖ 15P (10 jogos)</button>
          </div>
          <div class="col">
            <button class="btn btnGhost btnWide" type="button" onclick="clearCreate()">üßπ Limpar sele√ß√£o</button>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div id="createArea">
        <div class="footerNote">Escolha uma op√ß√£o acima.</div>
      </div>
    </div>
  </div>

<!-- TELA: JOGO PRINCIPAL -->
  <div class="view" id="viewPrincipal">
    <div class="topNav">
      <div class="left">
        <button class="btn btnGhost" type="button" onclick="goView('viewHome')">‚¨Ö Voltar</button>
      </div>
      <div class="right">
        <button class="btn btnBlue" type="button" onclick="goView('viewInvertida'); gerarInvertida()">üîÑ Invertida</button>
        <button class="btn btnPurple" type="button" onclick="goView('viewTecnica'); gerarTecnicaPremiada()">üèÜ T√©cnica</button>
        <button class="btn btnGhost" id="btnVerificarGeradosFromPrincipal" type="button" style="display:none" onclick="goView('viewCheck')">‚úÖ Verificar jogos gerados</button>
      </div>
    </div>

    <div class="card" id="principalArea">
      <div class="footerNote">Clique em ‚ÄúJogo Principal‚Äù na tela principal.</div>
    </div>
  </div>

  <!-- TELA: INVERTIDA -->
  <div class="view" id="viewInvertida">
    <div class="topNav">
      <div class="left">
        <button class="btn btnGhost" type="button" onclick="goView('viewPrincipal')">‚¨Ö Voltar</button>
      </div>
      <div class="right">
        <button class="btn btnPurple" type="button" onclick="goView('viewTecnica'); gerarTecnicaPremiada()">üèÜ Ir para T√©cnica</button>
      </div>
    </div>

    <div class="card" id="invertidaArea">
      <div class="footerNote">Gere um Jogo Principal primeiro.</div>
    </div>
  </div>

  <!-- TELA: T√âCNICA PREMIADA -->
  <div class="view" id="viewTecnica">
    <div class="topNav">
      <div class="left">
        <button class="btn btnGhost" type="button" onclick="goView('viewPrincipal')">‚¨Ö Voltar</button>
      </div>
      <div class="right">
        <button class="btn btnBlue" type="button" onclick="goView('viewInvertida'); gerarInvertida()">üîÑ Ir para Invertida</button>
      </div>
    </div>

    <div class="card" id="tecnicaArea">
      <div class="footerNote">Gere um Jogo Principal primeiro.</div>
    </div>
  </div>

  <!-- TELA: CHECK -->
  <div class="view" id="viewCheck">
    <div class="topNav">
      <div class="left">
        <button class="btn btnGhost" type="button" onclick="goView('viewPrincipal')">‚¨Ö Voltar</button>
      </div>
      <div class="right">
        <button class="btn btnGhost" type="button" onclick="conferirGerados()">Conferir com √∫ltimo concurso</button>
      </div>
    </div>

    <div class="card" id="checkArea">
      <div class="footerNote">Gere Principal + Invertida + T√©cnica para liberar esta tela.</div>
    </div>
  </div>

  <!-- TELA: 15 PONTOS -->
  
  <!-- TELA: JOGO ELITE -->
  <div class="view" id="viewElite">
    <div class="topNav">
      <div class="left">
        <button class="btn btnGhost" type="button" onclick="goView('viewHome')">‚¨Ö Voltar</button>
      </div>
      <div class="right">
        <button class="btn btnGhost" type="button" onclick="verConcursos()">üìÖ Ver concursos</button>
      </div>
    </div>

    <div class="card">
      <div class="box">
        <b>üíé JOGO ELITE (6 jogos)</b>
        <div class="mini" style="margin-top:8px">
          Este m√≥dulo <b>sempre</b> usa os <b>√∫ltimos 4 concursos</b> para an√°lise/encaixe (padr√µes aprendidos no treino ELITE).
        </div>

        <div class="row" style="margin-top:12px">
          <div class="col">
            <button class="btn btnPrimary btnWide" type="button" onclick="gerarElite()">üöÄ Gerar ELITE (6 jogos)</button>
          </div>
          <div class="col">
            <button class="btn btnGhost btnWide" type="button" onclick="salvarElite()">üíæ Salvar ELITE</button>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div id="eliteArea">
        <div class="footerNote">Clique em ‚ÄúGerar ELITE‚Äù para montar os 6 jogos.</div>
      </div>
    </div>
  </div>

<div class="view" id="view15p">
    <div class="topNav">
      <div class="left">
        <button class="btn btnGhost" type="button" onclick="goView('viewHome')">‚¨Ö Voltar</button>
      </div>
      <div class="right">
        <button class="btn btnPrimary" type="button" onclick="gerar15P()">Gerar an√°lise 15P</button>
      </div>
    </div>

    <div class="card" id="p15Area">
      <div class="footerNote">Clique em ‚ÄúGerar an√°lise 15P‚Äù. Essa tela exige o EXTRA ativado (via claims).</div>
    </div>
  </div>
<!-- =========================
   TELA: JOGOS SALVOS
========================= -->
<div class="view" id="viewSavedGames" onshow="renderJogosSalvosAoAbrir()">
  <div class="topNav">
    <div class="left">
      <button class="btn btnGhost" type="button" onclick="goView('viewHome')">‚¨Ö Voltar</button>
    </div>
  </div>

  <div class="card">
    <label>Conferir √∫ltimos concursos</label>
    <select id="savedCheckQtd">
  <option value="3">√öltimos 3</option>
  <option value="6">√öltimos 6</option>
  <option value="12" selected>√öltimos 12</option>
  <option value="20">√öltimos 20</option>
  <option value="30">√öltimos 30</option>
  <option value="50">√öltimos 50</option>
  <option value="75">√öltimos 75</option>
  <option value="100">√öltimos 100</option>
  </select>

<div id="savedPacksList" style="margin-top:14px"></div>

<button class="btn btnPrimary" style="margin-top:10px" onclick="checkSavedGames()">
  Conferir jogos
</button>

<div id="savedGamesResult" style="margin-top:14px"></div>
  </div>
</div>

  <div class="footerNote">Aviso: an√°lise estat√≠stica n√£o garante premia√ß√£o. Jogo respons√°vel ‚úÖ</div>
</div>

<!-- MODAL LISTA CONCURSOS -->
<div id="modalBack" class="modalBack">
  <div class="modal">
    <div class="modalHeader">
      <b>üìå Concursos analisados (datas + dezenas)</b>
      <button class="closeBtn" onclick="fecharModal()">Fechar</button>
    </div>
    <div class="modalBody">
      <div id="listaConcursos"></div>
    </div>
  </div>
</div>

<!-- MODAL GRAFICO BLOCOS -->
<div id="modalBlocosBack" class="modalBack">
  <div class="modal" style="max-width:560px">
    <div class="modalHeader">
      <b>üìä Gr√°fico de Blocos A‚ÄìE</b>
      <button class="closeBtn" onclick="fecharGraficoBlocos()">Fechar</button>
    </div>
    <div class="modalBody">
      <div id="graficoBlocosArea"></div>
      <div class="mini" style="margin-top:10px">
        Blocos: A(01‚Äì05), B(06‚Äì10), C(11‚Äì15), D(16‚Äì20), E(21‚Äì25).
      </div>
    </div>
  </div>
</div>

<script>

document.getElementById("appName1").textContent = APP_NAME;
document.getElementById("appName2").textContent = APP_NAME;

function bindCardKey(el){
  el.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" || e.key === " "){
      e.preventDefault();
      el.click();
    }
  });
}

function showOk(t){
  const a=document.getElementById("msgOk");
  a.style.display="block";
  a.textContent=t;
  document.getElementById("msgErr").style.display="none";
}
function showErr(t){
  const a=document.getElementById("msgErr");
  a.style.display="block";
  a.textContent=t;
  document.getElementById("msgOk").style.display="none";
}

function setStatus(on, text){
  const st=document.getElementById("status");
  document.getElementById("statusText").textContent = text || "";
  st.style.display = on ? "block" : "none";
  toggleProgressCol(); // ‚úÖ garante alinhamento no mobile
}
function toggleProgressCol(){
  const st = document.getElementById("status");
  if(!st) return;

  const col = st.closest(".col");
  if(!col) return;

  const isMobile = window.innerWidth <= 520;
  const statusVisible = (getComputedStyle(st).display !== "none");

  if(isMobile && !statusVisible){
    col.style.display = "none";
  }else{
    col.style.display = "block";
  }
}

window.addEventListener("resize", toggleProgressCol);
document.addEventListener("DOMContentLoaded", toggleProgressCol);

function setProgress(p){
  document.getElementById("barFill").style.width = Math.max(0, Math.min(100, p)) + "%";
}

function abrirModal(){ document.getElementById("modalBack").style.display="flex"; }
function fecharModal(){ document.getElementById("modalBack").style.display="none"; }
function fecharGraficoBlocos(){ document.getElementById("modalBlocosBack").style.display="none"; }


/* ===================== CRIAR SEUS JOGOS (PREMIUM) ===================== */

let createMode = "principal";
let createPick15 = new Set();
let createResult = null; // {tipo, principal?, invertida?, tecnica1?, tecnica2?, eliteGames?, p15Lines?, p15Games?}

function openCreateMode(mode){
  if(!access?.premium){
    alert("üîí Este recurso exige PREMIUM.");
    return;
  }
  createMode = mode || "principal";
  createResult = null;

  // para 15P, usamos as mesmas vars do m√≥dulo 15P
  if(createMode === "p15"){
    if(!linesUser15 || !Array.isArray(linesUser15) || linesUser15.length !== 5){
      linesUser15 = [[],[],[],[],[]];
      activeLine15 = 4;
    }
  }
  renderCreate();
  goView("viewCreateGames");
}

function clearCreate(){
  createPick15 = new Set();
  createResult = null;
  if(createMode === "p15"){
    linesUser15 = [[],[],[],[],[]];
    linesSystem15 = null;
    activeLine15 = 4;
  }
  renderCreate();
}

function _setFromPickToArray(){
  const arr = Array.from(createPick15).map(Number).filter(n=>n>=1 && n<=25);
  arr.sort((a,b)=>a-b);
  return arr;
}

function _ensure15(arr){
  // garante 15 √∫nicas dentro de 1..25 (fallback determin√≠stico)
  const used = new Set((arr||[]).map(Number).filter(n=>n>=1 && n<=25));
  const out = Array.from(used).slice(0,15);
  for(let n=1;n<=25 && out.length<15;n++){
    if(!used.has(n)){ used.add(n); out.push(n); }
  }
  out.sort((a,b)=>a-b);
  return out.slice(0,15);
}

function _remapGame(game, perm){
  const mapped = (game||[]).map(n=>remapPorPermutacao(n, perm));
  return _ensure15(mapped);
}

function renderPickGridAny(id, selectedSet, lockedSet){
  let html = `<div class="pickGrid" id="${id}">`;
  for(let n=1;n<=25;n++){
    const sel = selectedSet && selectedSet.has(n) ? " sel" : "";
    const lock = lockedSet && lockedSet.has(n) ? " lock" : "";
    html += `<div class="pickCell${sel}${lock}" data-n="${n}">${format2(n)}</div>`;
  }
  html += `</div>`;
  return html;
}


function _blockCounts(nums){
  const c = [0,0,0,0,0,0]; // 1..5
  (nums||[]).forEach(n=>{
    const b = blocoIndex(n);
    c[b] = (c[b]||0)+1;
  });
  return c;
}
function _complementOf(base){
  const s = new Set(base||[]);
  const out = [];
  for(let n=1;n<=25;n++) if(!s.has(n)) out.push(n);
  return out;
}
function _pickFromBlock(list, block, preferHigh=false){
  const items = list.filter(n=>blocoIndex(n)===block).sort((a,b)=>a-b);
  return preferHigh ? (items[items.length-1]||null) : (items[0]||null);
}
function _mutateFromBase(base, swaps, seed){
  // swaps = quantas dezenas ser√£o trocadas (remove/add)
  const b0 = _ensure15(base);
  if(swaps<=0) return b0.slice();

  const comp = _complementOf(b0);
  const out = b0.slice();

  for(let k=0;k<swaps;k++){
    // Recalcula contagens a cada troca para ficar est√°vel e diferente
    const counts = _blockCounts(out);

    // bloco mais cheio (remove) e mais vazio (add)
    const blocks = [1,2,3,4,5];
    const sortedByFull = blocks.slice().sort((a,b)=> (counts[b]-counts[a]) || (a-b));
    const sortedByEmpty = blocks.slice().sort((a,b)=> (counts[a]-counts[b]) || (a-b));

    // seed alterna quais blocos escolhemos primeiro para diversificar jogos
    const removeBlock = sortedByFull[(seed + k) % sortedByFull.length];
    const addBlock    = sortedByEmpty[(seed + 2*k) % sortedByEmpty.length];

    // remove: pega uma dezena do bloco mais cheio (preferindo alta para ser determin√≠stico)
    const toRemove = _pickFromBlock(out, removeBlock, true);
    if(toRemove!=null){
      const ix = out.indexOf(toRemove);
      if(ix>=0) out.splice(ix,1);
    }

    // add: pega uma dezena do complemento no bloco mais vazio (preferindo baixa)
    let toAdd = _pickFromBlock(comp, addBlock, false);
    if(toAdd==null){
      // fallback: menor do complemento que ainda n√£o est√° no jogo
      toAdd = comp.find(n=>!out.includes(n)) || null;
    }
    if(toAdd!=null && !out.includes(toAdd)) out.push(toAdd);

    // garante 15 e ordena
    while(out.length>15) out.pop();
    while(out.length<15){
      const fill = comp.find(n=>!out.includes(n));
      if(fill==null) break;
      out.push(fill);
    }
    out.sort((a,b)=>a-b);
  }
  return _ensure15(out);
}

function gerarCreatePrincipal(){
  const base = _setFromPickToArray();
  if(base.length !== 15) return alert("Selecione exatamente 15 dezenas.");

  // ‚úÖ Regra: manual cria o 1¬∫ jogo igual ao escolhido e os pr√≥ximos com ajustes
  const principal = _ensure15(base);
  let invertida = _mutateFromBase(principal, 1, 1);
  let tecnica1  = _mutateFromBase(principal, 2, 2);
  let tecnica2  = _mutateFromBase(principal, 2, 3);

  // Garantia: n√£o repetir (somente no manual)
  const seen = new Set([_uniqueKey(principal)]);
  function uniq(g, swaps, seed){
    let gg = g.slice();
    let key = _uniqueKey(gg);
    let tries = 0;
    while(seen.has(key) && tries<6){
      gg = _mutateFromBase(principal, swaps + tries, seed + tries);
      key = _uniqueKey(gg);
      tries++;
    }
    seen.add(key);
    return gg;
  }
  invertida = uniq(invertida, 1, 1);
  tecnica1  = uniq(tecnica1, 2, 2);
  tecnica2  = uniq(tecnica2, 2, 3);

  createResult = { tipo:"principal4", principal, invertida, tecnica1, tecnica2 };
  renderCreate();
}

function _uniqueKey(nums){ return (nums||[]).slice().sort((a,b)=>a-b).join("-"); }

function gerarCreateElite(){
  const base = _setFromPickToArray();
  if(base.length !== 15) return alert("Selecione exatamente 15 dezenas.");

  const principal = _ensure15(base);
  const games = [];
  const seen = new Set();

  // ‚úÖ 6 jogos com varia√ß√£o determin√≠stica (somente manual)
  const swapPlan = [0,1,1,2,2,3];
  for(let i=0;i<6;i++){
    let g = _mutateFromBase(principal, swapPlan[i], i+1);
    let key = _uniqueKey(g);
    let tries = 0;
    while(seen.has(key) && tries<8){
      g = _mutateFromBase(principal, swapPlan[i] + 1 + tries, (i+1) + tries);
      key = _uniqueKey(g);
      tries++;
    }
    seen.add(key);
    games.push({ nome:`ELITE ${i+1}`, dezenas:g });
  }

  createResult = { tipo:"elite6", games };
  renderCreate();
}

function gerarCreate15P(){
  if(!allLinesComplete(linesUser15)){
    return alert("Complete as 5 linhas com 5 dezenas cada.");
  }
  linesSystem15 = linesUser15.map(l=>l.slice()); // base do 15P manual
  const jogos = gerarJogos15P(linesSystem15);
  createResult = { tipo:"p15", lines: linesSystem15, jogos };
  renderCreate();
}

function salvarCreate(){
  if(!createResult) return alert("Gere os jogos primeiro.");

  if(createResult.tipo === "principal4"){
    lastPrincipalGame = createResult.principal.slice();
    lastInvertidaGame = createResult.invertida.slice();
    lastTecnicaGames = { g1: createResult.tecnica1.slice(), g2: createResult.tecnica2.slice() };
    salvarPacotePrincipal();
    return;
  }

  if(createResult.tipo === "elite6"){
    lastEliteGames = { ok:true, games: (createResult.games||[]).map(g=>({ nome:g.nome, dezenas:g.dezenas })) };
    salvarElite();
    return;
  }

  if(createResult.tipo === "p15"){
    // usa salvar15P existente (salva em jogos salvos)
    salvar15P();
    return;
  }
}

function renderCreate(){
  const area = document.getElementById("createArea");
  if(!area) return;

  const mode = createMode;

  const header = `
    <div class="box">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <b>${mode==="principal" ? "üéØ Criar PRINCIPAL (4 jogos)" : mode==="elite" ? "üíé Criar ELITE (6 jogos)" : "‚úÖ Criar 15P (10 jogos)"}</b>
        <span class="badge premium">PREMIUM</span>
      </div>
      <div class="mini" style="margin-top:8px">
        ${mode==="p15" ? "Monte 5 linhas de 5 dezenas. Depois clique em <b>Gerar 10 jogos</b>." : "Selecione <b>15 dezenas</b> no grid. Depois clique em <b>Gerar</b>."}
      </div>
    </div>
  `;

  if(mode === "p15"){
    // reusa o editor 15P dentro do create
    area.innerHTML = header + `
      <div class="box" style="margin-top:12px">
        <div id="editor15Area"></div>
        <div class="row" style="margin-top:10px">
          <div class="col">
            <button class="btn btnPrimary btnWide" type="button" onclick="gerarCreate15P()">üöÄ Gerar 10 jogos (minhas linhas)</button>
          </div>
          <div class="col">
            <button class="btn btnGhost btnWide" type="button" onclick="salvarCreate()">üíæ Salvar</button>
          </div>
        </div>
        <div id="create15Output" style="margin-top:12px"></div>
      </div>
    `;
    render15Editor(); // usa linesUser15 / activeLine15
    if(createResult?.tipo==="p15"){
      const jogosHtml = (createResult.jogos||[]).map((j, idx)=>`
        <div class="box">
          <b>Jogo ${idx+1}</b>
          <div class="numbers" style="justify-content:flex-start;margin-top:10px">${renderBallsInline(j)}</div>
        </div>
      `).join("");
      const out = document.getElementById("create15Output");
      if(out) out.innerHTML = `<b>üéØ 10 jogos (MANUAL)</b><div class="grid" style="margin-top:12px">${jogosHtml}</div>`;
    }
    return;
  }

  // principal / elite: grid 1..25
  const selected = _setFromPickToArray();
  area.innerHTML = header + `
    <div class="box" style="margin-top:12px">
      <div class="mini">
        Selecionadas: <b>${selected.length}</b>/15 ‚Ä¢ ${selected.length ? selected.map(format2).join(" - ") : "‚Äî"}
      </div>

      ${renderPickGridAny("pickGridCreate", createPick15, null)}

      <div class="row" style="margin-top:12px">
        <div class="col">
          <button class="btn btnPrimary btnWide" type="button" onclick="${mode==="principal" ? "gerarCreatePrincipal()" : "gerarCreateElite()"}">üöÄ Gerar ${mode==="principal" ? "4 jogos" : "ELITE (6 jogos)"} </button>
        </div>
        <div class="col">
          <button class="btn btnGhost btnWide" type="button" onclick="salvarCreate()">üíæ Salvar</button>
        </div>
      </div>
    </div>
    <div id="createOut" style="margin-top:12px"></div>
  `;

  // bind grid
  bindPickGrid("pickGridCreate", (n)=>{
    if(createPick15.has(n)) createPick15.delete(n);
    else{
      if(createPick15.size>=15) return alert("Voc√™ j√° selecionou 15 dezenas.");
      createPick15.add(n);
    }
    renderCreate(); // re-render para atualizar sele√ß√£o
  });

  // output
  const out = document.getElementById("createOut");
  if(!out) return;

  if(createResult?.tipo==="principal4"){
    const pack = createResult;
    const box4 = (label, nums)=>`
      <div class="box" style="margin-top:12px">
        <b>${label}</b>
        <div class="numbers" style="justify-content:flex-start;margin-top:10px">${renderBallsInline(nums)}</div>
      </div>
    `;
    out.innerHTML =
      box4("üéØ Principal", pack.principal) +
      box4("üîÑ Invertida", pack.invertida) +
      box4("üèÜ T√©cnica 1", pack.tecnica1) +
      box4("üèÜ T√©cnica 2", pack.tecnica2);
    return;
  }

  if(createResult?.tipo==="elite6"){
    const games = createResult.games || [];
    out.innerHTML = games.map((g, idx)=>`
      <div class="box" style="margin-top:12px">
        <b>üíé ${g.nome}</b>
        <div class="numbers" style="justify-content:flex-start;margin-top:10px">${renderBallsInline(g.dezenas)}</div>
      </div>
    `).join("");
    return;
  }

  out.innerHTML = `<div class="footerNote">Selecione e clique em ‚ÄúGerar‚Äù.</div>`;
}

/* ===================== /CRIAR SEUS JOGOS ===================== */


function goView(id){
  document.querySelectorAll('.view').forEach(v => v.style.display='none');
  document.getElementById(id).style.display='block';

  if(id === 'viewSavedGames'){
    renderJogosSalvosAoAbrir();
    return;
  }

  if(id === 'viewPrincipal'){
    const el = document.getElementById("principalArea");
    const temMsg = el && /Gere um Jogo Principal/i.test(el.textContent||"");

    if(!lastPrincipalGame){
      if(!window.__autoGenLock){
        window.__autoGenLock = true;
        Promise.resolve().then(()=>acaoPrincipal()).finally(()=>{ window.__autoGenLock = false; });
      }
      return;
    }

    if(temMsg){
      const balls = lastPrincipalGame.map(n=>`<div class="ball">${format2(n)}</div>`).join("");
      el.innerHTML = `
        <div class="box">
          <b>üéØ Jogo Principal</b>
          <div class="numbers" style="justify-content:flex-start">${balls}</div>
        </div>
      `;
    }
    return;
  }

  if(id === 'viewInvertida'){
    if(access?.premium && lastPrincipalGame){
      gerarInvertida(true);
    }
    return;
  }

  if(id === 'viewTecnica'){
    if(access?.premium && lastPrincipalGame){
      gerarTecnicaPremiada(true);
    }
    return;
  }
}
</script>

<script>

let access = {
  email: "",
  uid: "",
  premium: false,
  addon15: false,
  addonElite: false,
  isAdmin: false
};

async function refreshClaims(force=false){
  const u = auth.currentUser;
  if(!u) return access;

  const token = await u.getIdTokenResult(!!force);
  const email = (u.email || "").toLowerCase();
  const isAdmin = email === String(ADMIN_EMAIL).toLowerCase();

  const premium = !!token.claims.premium || isAdmin;
  const addon15 = !!token.claims.addon15 || isAdmin;
  const addonElite = !!token.claims.addonElite || !!token.claims.elite || !!token.claims.combo || isAdmin;

  access = { email, uid: u.uid, premium, addon15, addonElite, isAdmin };
  updateChip();
  aplicarAcessos();
  return access;
}

function updateChip(){
  const plan = access.isAdmin ? "üõ°Ô∏è Admin" : (access.premium ? "üëë Premium" : "üë§ Free");
  const extra = (access.addon15 || access.isAdmin) ? " ‚Ä¢ ‚úÖ 15P" : "";
  const extraElite = (access.addonElite || access.isAdmin) ? " ‚Ä¢ üíé ELITE" : "";
  const chipTextEl = document.getElementById("chipText");
  if(chipTextEl) chipTextEl.textContent = `${plan} ‚Ä¢ ${access.email || "‚Äî"}${extra}${extraElite}`;
}

function isFreeUsed(){
  if(!access.uid) return false;
  return localStorage.getItem(freeKey(access.uid)) === "1";
}
function markFreeUsed(){
  if(!access.uid) return;
  localStorage.setItem(freeKey(access.uid), "1");
}

function setCardEnabled(el, enabled, onClick, msg){
  if(!el) return;
  el.classList.toggle("disabled", !enabled);
  el.onclick = enabled ? onClick : ()=>alert(msg);
}

function aplicarAcessos(){
  const can15p = ((access.premium && access.addon15) || access.isAdmin);
  const canElite = ((access.premium && access.addonElite) || access.isAdmin);

  const premiumGate = document.getElementById("premiumGate");
  if(premiumGate) premiumGate.style.display = access.premium ? "none" : "block";

  const addon15Card = document.getElementById("addon15Card");
  if(addon15Card) addon15Card.style.display = (!access.isAdmin && !can15p) ? "block" : "none";

  const btnAnalise  = document.getElementById("btnHomeAnalise");
  const btnPrincipal= document.getElementById("btnHomePrincipal");
  const btnInvertida= document.getElementById("btnHomeInvertida");
  const btnTecnica  = document.getElementById("btnHomeTecnica");
  const btn15       = document.getElementById("btnHome15p");
  const btnElite    = document.getElementById("btnHomeElite");
  const btnCreate  = document.getElementById("btnHomeCreate");

setCardEnabled(btnAnalise, access.premium, acaoAnalise, "üîí Gerar an√°lise exige Premium.");

  setCardEnabled(btnCreate, access.premium, ()=>openCreateMode("principal"), "üîí Criar seus jogos exige Premium.");

  setCardEnabled(btnInvertida, access.premium, ()=>{
    goView("viewInvertida"); gerarInvertida();
  }, "üîí Invertida exige Premium.");

  setCardEnabled(btnTecnica, access.premium, ()=>{
    goView("viewTecnica"); gerarTecnicaPremiada();
  }, "üîí T√©cnica premiada exige Premium.");

  // üíé ELITE (somente COMBO)
  setCardEnabled(btnElite, canElite, ()=>{ goView("viewElite"); }, "üîí O recurso 'JOGO ELITE' est√° dispon√≠vel somente no pacote COMBO.");

  if(!access.premium && isFreeUsed()){
    btnPrincipal?.classList.add("disabled");
    if(btnPrincipal) btnPrincipal.onclick = ()=>alert("üîí Voc√™ j√° usou a gera√ß√£o gr√°tis. Para liberar, ative o Premium.");
  }else{
    btnPrincipal?.classList.remove("disabled");
    if(btnPrincipal) btnPrincipal.onclick = ()=>acaoPrincipal();
  }

  if(!can15p){
    btn15?.classList.add("disabled");
    if(btn15) btn15.onclick = ()=>alert("üîí O recurso '15 pontos garantido' √© um EXTRA comprado separadamente (libera via claims).");
  }else{
    btn15?.classList.remove("disabled");
    if(btn15) btn15.onclick = ()=>{ goView("view15p"); };
  }
}

function abrirApp(){
  document.getElementById("loginWrap").style.display="none";
  document.getElementById("app").style.display="block";
  goView("viewHome");
}

function fecharApp(){
  document.getElementById("loginWrap").style.display="flex";
  document.getElementById("app").style.display="none";
}

async function entrar(){
  const e=(document.getElementById("email").value||"").trim().toLowerCase();
  const s=(document.getElementById("senha").value||"");
  if(!e || !s){ showErr("Digite email e senha."); return; }

  const btn = document.getElementById("btnEntrar");
  btn.disabled = true;

  try{
    await auth.signInWithEmailAndPassword(e,s);
    showOk("Bem-vindo! Carregando seu acesso‚Ä¶");
  }catch(err){
    try{
      await auth.createUserWithEmailAndPassword(e,s);
      showOk("Conta criada ‚úÖ Carregando seu acesso‚Ä¶");
    }catch(e2){
      showErr(e2?.message || "Falha no login.");
    }
  }finally{
    btn.disabled = false;
  }
}

async function forgotPassword(){
  const e=(document.getElementById("email").value||"").trim().toLowerCase();
  if(!e) return showErr("Digite seu email para recuperar a senha.");
  try{
    await auth.sendPasswordResetEmail(e);
    showOk("‚úÖ Email de recupera√ß√£o enviado. Verifique sua caixa de entrada.");
  }catch(err){
    showErr(err?.message || "N√£o foi poss√≠vel enviar o email de recupera√ß√£o.");
  }
}

function sair(){ auth.signOut(); }

function comprarPremium(){ window.open(BUY_LINK, "_blank"); }
function comprar15p(){ window.open(BUY_LINK_15P, "_blank"); }

async function ativarComCodigo(){
  try{
    if(!auth.currentUser){
      alert("Voc√™ precisa estar logado.");
      return;
    }
    const code = prompt("Cole aqui seu C√ìDIGO de ativa√ß√£o (ex: PRIME-0001):");
    if(!code) return;

    showOk("Ativando c√≥digo‚Ä¶");
    const redeemCode = functions.httpsCallable("redeemCode");
    await redeemCode({ code: code.trim() });

    await refreshClaims(true);

    if(access.premium || access.addon15 || access.isAdmin){
      showOk("‚úÖ C√≥digo ativado! Seus acessos foram atualizados.");
    }else{
      showOk("‚úÖ C√≥digo enviado! Se n√£o liberar na hora, saia e entre novamente.");
    }
  }catch(err){
    console.log(err);
    showErr("‚ùå Erro ao ativar: " + (err?.message || err));
  }
}

async function jaComprei(){ await ativarComCodigo(); }
async function jaComprei15p(){ await ativarComCodigo(); }

auth.onAuthStateChanged(async (user)=>{
  if(!user){
    access = { email:"", uid:"", premium:false, addon15:false, addonElite:false, isAdmin:false };
    fecharApp();
    return;
  }
  abrirApp();
  await refreshClaims(true);
});
</script>

<script>

function format2(n){ return String(n).padStart(2,"0"); }

function toNum(d){ return Number(String(d).replace(/^0+/,"")) || Number(d); }
function sortNum(arr){ return arr.slice().sort((a,b)=>a-b); }

function getDezenas(c){
  const arr = (c && (c.dezenas || c.numeros || c.dezenasSorteadas)) || [];
  return (arr || []).map(toNum).filter(n=>n>=1 && n<=25);
}

function calcularFrequencias(concursos){
  const freq={}; for(let i=1;i<=25;i++) freq[i]=0;
  concursos.forEach(c=>{
    (c.dezenas||[]).forEach(d=>{
      const n=toNum(d);
      if(n>=1 && n<=25) freq[n]+=1;
    });
  });
  return freq;
}
function ordenarPorFreq(freq){
  return Object.entries(freq).map(([k,v])=>({dez:Number(k), f:v})).sort((a,b)=>b.f-a.f);
}
function contarParesImpares(jogo){
  const pares = jogo.filter(n=>n%2===0).length;
  return {pares, impares: jogo.length - pares};
}
function somaDezenas(jogo){ return jogo.reduce((a,b)=>a+b,0); }
function contarSequencias(jogo){
  let maxLen=1, curLen=0, prev=null;
  const sorted = sortNum(jogo);
  for(const n of sorted){
    if(prev!==null && n===prev+1){ curLen++; }
    else { curLen=1; }
    if(curLen>maxLen) maxLen=curLen;
    prev=n;
  }
  return { temSequencia: maxLen>=2, maxLen };
}
function distribuicaoBlocos(jogo){
  const b={A:0,B:0,C:0,D:0,E:0};
  jogo.forEach(n=>{
    if(n>=1 && n<=5) b.A++;
    else if(n>=6 && n<=10) b.B++;
    else if(n>=11 && n<=15) b.C++;
    else if(n>=16 && n<=20) b.D++;
    else if(n>=21 && n<=25) b.E++;
  });
  return b;
}
function repetidasDoUltimo(jogo, ultimoDezenas){
  const setUlt = new Set((ultimoDezenas||[]).map(toNum));
  return sortNum(jogo.filter(n=>setUlt.has(n)));
}

function classificarDezenas(freq, jogo){
  const ord = ordenarPorFreq(freq);
  const rank={}; ord.forEach((x,i)=>rank[x.dez]=i+1);
  const hot=[], warm=[], cold=[];
  jogo.forEach(n=>{
    const r=rank[n]||999;
    if(r<=8) hot.push(n);
    else if(r<=17) warm.push(n);
    else cold.push(n);
  });
  return {hot:sortNum(hot), warm:sortNum(warm), cold:sortNum(cold), rank};
}

function countGroupTogetherInWindow(group, concursos){
  const gset = new Set(group.map(Number));
  let count = 0;
  for(const c of (concursos || [])){
    const setC = new Set((c.dezenas||[]).map(toNum));
    let ok = true;
    for(const n of gset){
      if(!setC.has(n)){ ok=false; break; }
    }
    if(ok) count++;
  }
  return count;
}

function combosK(arr, k){
  const res = [];
  function rec(start, path){
    if(path.length === k){ res.push(path.slice()); return; }
    for(let i=start;i<arr.length;i++){
      path.push(arr[i]);
      rec(i+1, path);
      path.pop();
    }
  }
  rec(0, []);
  return res;
}

function getTop10FreqList(freq){
  return ordenarPorFreq(freq).slice(0,10).map(x=>x.dez);
}

function getTop10AtrasadasList(modern){
  const arr = [];
  for(let d=1; d<=25; d++){
    arr.push({ dez:d, gap:Number(modern?.gap?.[d] ?? 0) });
  }
  arr.sort((a,b)=>b.gap-a.gap);
  return arr.slice(0,10).map(x=>x.dez);
}

function calcModernMetrics(concursos){
  const n = concursos.length;
  const freq = Array(26).fill(0);
  const decay = Array(26).fill(0);
  const recent10 = Array(26).fill(0);
  const lastSeen = Array(26).fill(-1);

  const DECAY = 0.92; // peso para rec√™ncia (mais novo = mais peso)
  for(let i=0;i<n;i++){
    const nums=(concursos[i].dezenas||[]).map(toNum).filter(x=>x>=1 && x<=25);
    const w = Math.pow(DECAY, (n-1-i)); // √∫ltimo concurso = w=1
    nums.forEach(x=>{
      freq[x] += 1;
      decay[x] += w;
      lastSeen[x] = i;
      if(i >= n-10) recent10[x] += 1;
    });
  }

  const gap = Array(26).fill(999);
  for(let x=1;x<=25;x++){
    gap[x] = (lastSeen[x]===-1) ? n : (n-1-lastSeen[x]);
  }

  const trend = Array(26).fill(0);
  for(let x=1;x<=25;x++){
    const baseRate = freq[x] / Math.max(1,n);
    const recRate = recent10[x] / Math.max(1, Math.min(10,n));
    trend[x] = (recRate - baseRate);
  }

  return { n, freq, decay, recent10, gap, trend };
}

</script>

<script>

const TRAIN_FIXED = [
  { concurso:3592, dezenas:[1,4,5,6,7,9,12,13,17,18,20,21,22,23,25] },
  { concurso:3593, dezenas:[1,3,4,6,7,8,9,10,12,15,18,19,23,24,25] },
  { concurso:3594, dezenas:[1,2,4,5,7,8,9,11,14,15,18,20,21,23,24] },
  { concurso:3595, dezenas:[1,2,4,5,6,8,10,12,13,15,16,20,21,22,25] },
  { concurso:3596, dezenas:[1,2,3,4,5,6,7,8,14,15,16,18,20,21,22] },
  { concurso:3597, dezenas:[1,4,5,7,10,11,13,14,15,16,19,20,21,23,25] },
  { concurso:3598, dezenas:[1,3,4,5,6,7,8,9,11,16,18,21,22,23,24] },
  { concurso:3599, dezenas:[1,4,6,7,8,9,11,12,13,16,19,20,21,23,24] },
  { concurso:3600, dezenas:[3,4,5,6,7,8,9,11,12,16,17,20,21,22,25] },
  { concurso:3601, dezenas:[2,3,4,6,7,8,9,11,16,17,20,21,23,24,25] },
  { concurso:3602, dezenas:[1,2,3,4,5,6,8,9,15,18,19,20,22,23,24] },
  { concurso:3603, dezenas:[2,4,5,9,10,11,12,14,15,17,19,20,21,22,24] },
  { concurso:3604, dezenas:[1,2,3,6,7,8,11,13,15,16,19,21,22,23,24] },
  { concurso:3605, dezenas:[1,3,4,7,10,12,13,14,19,20,21,22,23,24,25] },
  { concurso:3606, dezenas:[2,3,6,7,9,11,12,14,15,17,19,20,21,23,24] },
  { concurso:3607, dezenas:[1,2,4,5,6,8,9,13,14,15,16,18,19,20,23] },
  { concurso:3608, dezenas:[2,5,6,8,9,11,14,16,17,18,19,20,22,23,25] },
  { concurso:3609, dezenas:[2,5,6,8,9,10,11,12,13,17,19,20,22,24,25] },
  { concurso:3610, dezenas:[1,3,5,7,8,10,13,14,17,20,21,22,23,24,25] },
  { concurso:3611, dezenas:[1,2,3,4,5,6,10,11,12,14,15,17,18,19,25] },
  { concurso:3612, dezenas:[4,6,8,9,11,14,15,16,17,18,19,20,21,22,25] },
  { concurso:3613, dezenas:[1,3,4,7,9,10,11,12,15,16,18,20,21,22,23] },
].map(x=>({ ...x, dezenas: x.dezenas.slice().sort((a,b)=>a-b) }));

const ALL_25 = Array.from({length:25}, (_,i)=>i+1);
const LETTERS_DRAWN = "ABCDEFGHIJKLMNO".split("");
const LETTERS_OUT   = "PQRSTUVWXYZ".split(""); // P..Y (10 letras)

function _isPrime(n){
  return n===2||n===3||n===5||n===7||n===11||n===13||n===17||n===19||n===23;
}
function _blockAE(n){
  if(n<=5) return "A";
  if(n<=10) return "B";
  if(n<=15) return "C";
  if(n<=20) return "D";
  return "E";
}
function _row(n){ return Math.floor((n-1)/5)+1; }     // 1..5
function _col(n){ return ((n-1)%5)+1; }               // 1..5
function _set(arr){ return new Set((arr||[]).map(Number)); }

function _gapClassInPrev4(num, prev4Draws){
  const s1=_set(prev4Draws[0]), s2=_set(prev4Draws[1]), s3=_set(prev4Draws[2]), s4=_set(prev4Draws[3]);
  if(s1.has(num)) return "R";
  if(s2.has(num)) return "G2";
  if(s3.has(num)) return "G3";
  if(s4.has(num)) return "G4";
  return "G4";
}
function _countInPrev4(num, prev4Draws){
  let c=0;
  for(const d of prev4Draws) if(_set(d).has(num)) c++;
  return c;
}

function _mode(arr){
  const m=new Map();
  for(const x of arr) m.set(x,(m.get(x)||0)+1);
  let best=null, bestc=-1;
  for(const [k,v] of m.entries()){
    if(v>bestc || (v===bestc && String(k)<String(best))){ best=k; bestc=v; }
  }
  return best;
}

let __TRAIN_PROFILES = null;

function trainFixedProfiles(){
  if(__TRAIN_PROFILES) return __TRAIN_PROFILES;

  const usable = [];
  for(let i=4;i<TRAIN_FIXED.length;i++){
    const cur = TRAIN_FIXED[i];
    const prev4 = [
      TRAIN_FIXED[i-1].dezenas,
      TRAIN_FIXED[i-2].dezenas,
      TRAIN_FIXED[i-3].dezenas,
      TRAIN_FIXED[i-4].dezenas
    ];
    usable.push({ cur, prev4 });
  }

  function buildLetterProfile(isDrawn, idx){ // idx = 0..14 (A..O) ou 0..9 (P..Y)
    const gapC=[], par=[], prime=[], bloco=[], r=[], c=[], occ=[];
    for(const u of usable){
      const setCur = _set(u.cur.dezenas);
      const drawn = u.cur.dezenas.slice(); // j√° ordenadas
      const out = ALL_25.filter(n=>!setCur.has(n));
      const n = isDrawn ? drawn[idx] : out[idx];

      gapC.push(_gapClassInPrev4(n, u.prev4));
      par.push(n%2===0 ? "PAR" : "IMPAR");
      prime.push(_isPrime(n) ? "PRIMO" : "NAO_PRIMO");
      bloco.push(_blockAE(n));
      r.push(_row(n));
      c.push(_col(n));
      occ.push(_countInPrev4(n, u.prev4)); // 0..4
    }

    return {
      gapClass: _mode(gapC),
      parity: _mode(par),
      prime: _mode(prime),
      block: _mode(bloco),
      row: Number(_mode(r)),
      col: Number(_mode(c)),
      occ: Number(_mode(occ))
    };
  }

  const drawnProfiles = {};
  LETTERS_DRAWN.forEach((L,idx)=> drawnProfiles[L] = buildLetterProfile(true, idx));

  const outProfiles = {};
  LETTERS_OUT.forEach((L,idx)=> outProfiles[L] = buildLetterProfile(false, idx));

  __TRAIN_PROFILES = { drawn: drawnProfiles, out: outProfiles };
  return __TRAIN_PROFILES;
}

function _featuresNow(num, prev4Draws){
  return {
    gapClass: _gapClassInPrev4(num, prev4Draws),
    parity: num%2===0 ? "PAR" : "IMPAR",
    prime: _isPrime(num) ? "PRIMO" : "NAO_PRIMO",
    block: _blockAE(num),
    row: _row(num),
    col: _col(num),
    occ: _countInPrev4(num, prev4Draws)
  };
}

function _scoreMatch(feat, prof){
  let s=0;
  if(feat.gapClass === prof.gapClass) s+=6;
  if(feat.parity   === prof.parity)   s+=2;
  if(feat.prime    === prof.prime)    s+=1;
  if(feat.block    === prof.block)    s+=2;
  if(feat.row      === prof.row)      s+=1;
  if(feat.col      === prof.col)      s+=1;
  s += Math.max(0, 2 - Math.abs((feat.occ||0) - (prof.occ||0)));
  return s;
}

function _rankCandidatesForProfile(candidates, usedSet, prev4Draws, prof, avoidCounts, penalty=0.9, tpl=null, cur=null){
  const pen = (typeof penalty === "number") ? penalty : 0.9;
  const scored = [];
  for(const n of candidates){
    if(usedSet.has(n)) continue;
    const feat = _featuresNow(n, prev4Draws);
    let sc = _scoreMatch(feat, prof);

    // ‚úÖ b√¥nus de conjunto (blocos/paridade) aprendido no treino
    sc += _templateBonus(n, tpl, cur);

    const usedTimes = avoidCounts && avoidCounts[n] ? avoidCounts[n] : 0;
    sc = sc - usedTimes * pen;

    scored.push({ n, sc, usedTimes });
  }
  scored.sort((a,b)=>{
    if(b.sc !== a.sc) return b.sc - a.sc;
    return a.n - b.n; // determin√≠stico
  });
  return scored;
}


function _pickVariantForProfile(candidates, usedSet, prev4Draws, prof, variantIndex, avoidCounts, penalty=0.9, tpl=null, cur=null){
  const ranked = _rankCandidatesForProfile(candidates, usedSet, prev4Draws, prof, avoidCounts, penalty, tpl, cur);
  if(!ranked.length) return null;

  const v = Math.max(0, Number(variantIndex)||0);

  // ‚úÖ Altern√¢ncia determin√≠stica:
  // - tenta usar a op√ß√£o "v" (0..3) da letra
  // - mas evita reutilizar dezenas j√° muito usadas nos jogos anteriores (avoidCounts)
  // - e respeita o template de conjunto (blocos/paridade) daquele jogo
  let chosen = null;

  // 1) procura a partir do √≠ndice v uma dezena com reutiliza√ß√£o <= v
  for(let i=v; i<ranked.length; i++){
    const it = ranked[i];
    if((it.usedTimes||0) <= v){
      chosen = it;
      break;
    }
  }

  // 2) se n√£o achou, cai para o √≠ndice v (se existir)
  if(!chosen){
    const idx = Math.min(v, ranked.length-1);
    chosen = ranked[idx];
  }

  // 3) fallback final: melhor (0)
  if(!chosen) chosen = ranked[0];

  const pick = chosen.n;
  usedSet.add(pick);
  if(cur) _applyToCur(pick, cur);
  return pick;
}


function _variantIndexByKind(kind){
  // 0..3 = varia√ß√µes do MESMO treino (sem inverter regras do perfil)
  // principal=0, invertida=1, tecnica1=2, tecnica2=3
  if(kind === "invertida") return 1;
  if(kind === "tecnica1") return 2;
  if(kind === "tecnica2") return 3;
  return 0;
}


// ===============================
// ‚úÖ Templates de CONJUNTO (aprendido no treino)
// - captura padr√µes recorrentes do TREINO (distribui√ß√£o de blocos e paridade)
// - usado para variar os 4 jogos sem sair do que foi aprendido
// ===============================
function _sigFromJogo(nums){
  const b = {A:0,B:0,C:0,D:0,E:0};
  let pares=0, impares=0;
  for(const n of (nums||[])){
    const x = Number(n);
    if(x>=1 && x<=5) b.A++; else if(x<=10) b.B++; else if(x<=15) b.C++; else if(x<=20) b.D++; else if(x<=25) b.E++;
    if(x%2===0) pares++; else impares++;
  }
  return { b, pares, impares };
}

function _topKTemplatesFromTrain(trainDraws, k=4){
  const map = Object.create(null);
  for(const a of (trainDraws||[])){
    if(!Array.isArray(a) || a.length!==15) continue;
    const sig = _sigFromJogo(a);
    const key = `A${sig.b.A}B${sig.b.B}C${sig.b.C}D${sig.b.D}E${sig.b.E}_P${sig.pares}I${sig.impares}`;
    map[key] = (map[key]||0) + 1;
  }
  const arr = Object.entries(map).map(([key,c])=>({key,c}));
  arr.sort((x,y)=> y.c - x.c || (x.key<y.key?-1:1));
  const out = [];
  for(const it of arr.slice(0, Math.max(1, k))){
    // parse key
    const m = /A(\d+)B(\d+)C(\d+)D(\d+)E(\d+)_P(\d+)I(\d+)/.exec(it.key);
    if(!m) continue;
    out.push({
      count: it.c,
      blocks: {A:+m[1],B:+m[2],C:+m[3],D:+m[4],E:+m[5]},
      pares: +m[6],
      impares: +m[7]
    });
  }
  return out.length ? out : [{count:1, blocks:{A:3,B:3,C:3,D:3,E:3}, pares:7, impares:8}];
}

function _templateBonus(num, tpl, cur){
  if(!tpl || !cur) return 0;
  const n = Number(num);
  let blk = "E";
  if(n>=1 && n<=5) blk="A"; else if(n<=10) blk="B"; else if(n<=15) blk="C"; else if(n<=20) blk="D";

  let bonus = 0;
  // bloco: se ainda estamos abaixo do alvo daquele bloco, bonifica
  const needB = (tpl.blocks?.[blk] ?? 0) - (cur.blocks?.[blk] ?? 0);
  if(needB > 0) bonus += 1.75;

  // paridade: se ainda falta pares/impares, bonifica
  const isPar = (n%2===0);
  const needP = (tpl.pares - (cur.pares||0));
  const needI = (tpl.impares - (cur.impares||0));
  if(isPar && needP > 0) bonus += 1.15;
  if(!isPar && needI > 0) bonus += 1.15;

  return bonus;
}

function _initTemplateCur(){
  return { blocks:{A:0,B:0,C:0,D:0,E:0}, pares:0, impares:0 };
}

function _applyToCur(num, cur){
  const n = Number(num);
  if(n>=1 && n<=5) cur.blocks.A++; else if(n<=10) cur.blocks.B++; else if(n<=15) cur.blocks.C++; else if(n<=20) cur.blocks.D++; else if(n<=25) cur.blocks.E++;
  if(n%2===0) cur.pares++; else cur.impares++;
}



function buildPack4JogosPreditivo(payload){
  // =========================================================
  // ‚úÖ NOVO MOTOR (36 concursos de treino / base: prev4)
  // - O usu√°rio escolhe a janela (qtd concursos) para an√°lise/score
  // - A classifica√ß√£o comportamental √© SEMPRE baseada nos √∫ltimos 4 concursos (prev4)
  // - Gera 4 jogos FIXOS (padr√µes) e DIFERENTES:
  //   P1 Dominante      (9R,4G2,2G3,0G4,0F)
  //   P2 Agressivo 10R  (10R,3G2,2G3,0G4,0F)
  //   P3 Profundidade   (9R,3G2,2G3,1G4,0F)
  //   P4 Risco control. (9R,4G2,1G3,0G4,1F)  // 1 fora do prev4
  // =========================================================

  const concursos = payload?.concursos || [];
  const draws = concursos
    .map(c=> getDezenas(c).slice().sort((a,b)=>a-b))
    .filter(a=>a.length===15);

  if(draws.length < 1){
    return {
      ok:false,
      err:"Sem concursos v√°lidos.",
      principal:[], invertida:[], tecnica1:[], tecnica2:[],
      motivos:{principal:[], invertida:[], tecnica1:[], tecnica2:[]},
      meta:{}
    };
  }

  // Base: sempre √∫ltimos 4 sorteios (prev4). Se a janela tiver <4, fazemos padding repetindo o mais recente.
  const last = draws[draws.length-1];
  const prev4 = [last, last, last, last];
  for(let k=1; k<4 && (draws.length-1-k)>=0; k++){
    prev4[k] = draws[draws.length-1-k];
  }

  const s1 = new Set(prev4[0]);
  const s2 = new Set(prev4[1]);
  const s3 = new Set(prev4[2]);
  const s4 = new Set(prev4[3]);

  function cat(n){
    if(s1.has(n)) return "R";
    if(s2.has(n)) return "G2";
    if(s3.has(n)) return "G3";
    if(s4.has(n)) return "G4";
    return "F"; // fora do prev4
  }

  // Frequ√™ncia na janela selecionada (quanto mais concursos o usu√°rio escolher, mais est√°vel o score)
  const freq = Array(26).fill(0);
  for(const d of draws){
    for(const n of d) freq[n] = (freq[n]||0)+1;
  }

  function _score(n){
    // Score determin√≠stico: freq + b√¥nus leve por categoria (agressivo p/ R/G2)
    const c = cat(n);
    let b = 0;
    if(c==="R") b = 0.80;
    else if(c==="G2") b = 0.55;
    else if(c==="G3") b = 0.35;
    else if(c==="G4") b = 0.20;
    else b = 0.05;
    return (freq[n]||0) + b;
  }

  function _rank(categoria){
    const out = [];
    for(let n=1;n<=25;n++){
      if(cat(n)!==categoria) continue;
      out.push({n, sc:_score(n)});
    }
    out.sort((a,b)=> (b.sc-a.sc) || (a.n-b.n));
    return out.map(x=>x.n);
  }

  const pool = {
    R: _rank("R"),
    G2:_rank("G2"),
    G3:_rank("G3"),
    G4:_rank("G4"),
    F: _rank("F")
  };
  // --- Diversifica√ß√£o entre jogos (evita ficar tudo parecido) ---
  // A lista por categoria √© a mesma, mas cada padr√£o pega "fatias" diferentes (determin√≠stico)
  // e reduz reuso dos mesmos n√∫meros como repetidas (R) entre Principal/Invertida/T√©cnicas.
  const globalUse = {
    R: Array(26).fill(0),
    G2: Array(26).fill(0),
    G3: Array(26).fill(0),
    G4: Array(26).fill(0),
    F: Array(26).fill(0)
  };

  function _rot(list, shift){
    if(!list || !list.length) return [];
    const s = ((shift%list.length)+list.length)%list.length;
    return list.slice(s).concat(list.slice(0,s));
  }

  function _pickDiversified(catKey, used, patIdx){
    const base = pool[catKey] || [];
    if(!base.length) return null;

    // shifts diferentes por padr√£o e por categoria
    const catShift =
      (catKey==="R")  ? 0 :
      (catKey==="G2") ? 3 :
      (catKey==="G3") ? 5 :
      (catKey==="G4") ? 7 : 11;

    const shift = (patIdx*7 + catShift) % base.length;
    const list = _rot(base, shift);

    // escolhe o candidato com MENOR reuso global nesta categoria (nos primeiros candidatos)
    let best = null;
    let bestUse = 1e9;

    const scan = Math.min(18, list.length);
    for(let i=0;i<scan;i++){
      const n = list[i];
      if(used.has(n)) continue;
      const u = globalUse[catKey]?.[n] ?? 0;

      if(u < bestUse){
        bestUse = u;
        best = n;
        if(bestUse===0) break; // j√° √© o ideal
      }
    }

    // fallback: primeira dispon√≠vel na rota√ß√£o
    if(best==null){
      for(const n of list){
        if(!used.has(n)){ best = n; break; }
      }
    }

    if(best!=null){
      used.add(best);
      globalUse[catKey][best] = (globalUse[catKey][best]||0) + 1;
      return best;
    }
    return null;
  }


  function _pickFrom(list, used){
    for(const n of list){
      if(!used.has(n)){
        used.add(n);
        return n;
      }
    }
    return null;
  }

  function _uniqSort15(arr){
    const s = new Set();
    const out=[];
    for(const n of (arr||[])){
      const x = Number(n);
      if(!Number.isFinite(x)) continue;
      if(x<1||x>25) continue;
      if(s.has(x)) continue;
      s.add(x); out.push(x);
      if(out.length===15) break;
    }
    out.sort((a,b)=>a-b);
    return out;
  }

  function _buildMotivos(gameNums){
    const motivos = [];
    for(const n of gameNums){
      const c = cat(n);
      const label = (c==="R") ? "R (repetida do √∫ltimo concurso)"
                  : (c==="G2") ? "G2 (veio de 2 concursos atr√°s)"
                  : (c==="G3") ? "G3 (veio de 3 concursos atr√°s)"
                  : (c==="G4") ? "G4 (veio de 4 concursos atr√°s)"
                  : "F (fora do prev4 ‚Äî risco controlado)";
      motivos.push({dezena:n, texto:label});
    }
    return motivos;
  }

  function _fillRemaining(game, used){
    // completa determin√≠stico com melhor score geral, priorizando ainda dentro do prev4
    const all = [];
    for(let n=1;n<=25;n++) all.push(n);
    all.sort((a,b)=> (_score(b)-_score(a)) || (a-b));
    while(game.length<15){
      const n = _pickFrom(all, used);
      if(n==null) break;
      game.push(n);
    }
  }

  function _applyPattern(patternName, quota, globalAvoidSet, patIdx){
    // quota: {R,G2,G3,G4,F}
    const used = new Set();
    const game = [];
    const motivos = [];

    function take(catKey, k){
      let taken=0;
      while(taken<k){
        const n = _pickDiversified(catKey, used, patIdx);
        if(n==null) break;
        game.push(n);
        motivos.push({dezena:n, texto:`${catKey} ‚Ä¢ Padr√£o ${patternName}`});
        taken++;
      }
      // fallback dentro do prev4 se faltar naquela categoria
      while(taken<k){
        const fallbackCats = (catKey==="R") ? ["R","G2","G3","G4","F"] : ["G2","G3","G4","F"];
        let got=null;
        for(const fc of fallbackCats){
          got = _pickDiversified(fc, used, patIdx);
          if(got!=null){ 
            game.push(got);
            motivos.push({dezena:got, texto:`Fallback (${catKey}‚Üí${fc}) ‚Ä¢ Padr√£o ${patternName}`});
            taken++;
            break;
          }
        }
        if(got==null) break;
      }
    }

    take("R",  quota.R||0);
    take("G2", quota.G2||0);
    take("G3", quota.G3||0);
    take("G4", quota.G4||0);
    take("F",  quota.F||0);

    _fillRemaining(game, used);

    const finalGame = _uniqSort15(game);

    // Anti-igualdade (m√≠nimo 1 n√∫mero diferente do j√° gerado)
    // Se for id√™ntico a outro jogo, troca o √∫ltimo por melhor fora.
    if(globalAvoidSet && typeof globalAvoidSet === "object"){
      const key = finalGame.join("-");
      if(globalAvoidSet.has(key)){
        const used2 = new Set(finalGame);
        const all = [];
        for(let n=1;n<=25;n++) if(!used2.has(n)) all.push(n);
        all.sort((a,b)=> (_score(b)-_score(a)) || (a-b));
        const inN = all[0];
        if(inN!=null){
          const alt = finalGame.slice();
          alt[alt.length-1] = inN;
          const alt2 = _uniqSort15(alt);
          globalAvoidSet.add(alt2.join("-"));
          return { jogo: alt2, motivos: motivos.concat([{dezena:inN, texto:`Ajuste anti-igualdade ‚Ä¢ Padr√£o ${patternName}` }]) };
        }
      }
      globalAvoidSet.add(key);
    }

    return { jogo: finalGame, motivos };
  }

  const patterns = [
    { id:"principal", name:"1 (Dominante)",     q:{R:9,G2:4,G3:2,G4:0,F:0} },
    { id:"invertida", name:"2 (Agressivo 10R)", q:{R:10,G2:3,G3:2,G4:0,F:0} },
    { id:"tecnica1",  name:"3 (Profundidade)",  q:{R:9,G2:3,G3:2,G4:1,F:0} },
    { id:"tecnica2",  name:"4 (Risco control.)",q:{R:9,G2:4,G3:1,G4:0,F:1} }
  ];

  const avoid = new Set();
  const outGames = {};
  const outMotivos = { principal:[], invertida:[], tecnica1:[], tecnica2:[] };

  for(let i=0;i<patterns.length;i++){
    const p = patterns[i];
    const built = _applyPattern(p.name, p.q, avoid, i);
    outGames[p.id] = built.jogo;
    outMotivos[p.id] = built.motivos;
  }

  return {
    ok:true,
    principal: outGames.principal,
    invertida: outGames.invertida,
    tecnica1: outGames.tecnica1,
    tecnica2: outGames.tecnica2,
    motivos: outMotivos,
    meta:{
      window:{ qtd: draws.length, inicio: payload?.inicio, ultimo: payload?.ultimo },
      quotas: patterns.reduce((acc,p)=>{ acc[p.id]=p.q; return acc; }, {})
    }
  };
}

function buildMotivos(jogo, dezenasUltimoNums, freq, metrics){
  const setUlt = new Set((dezenasUltimoNums||[]).map(toNum));
  const ord = ordenarPorFreq(freq);
  const rank = {};
  ord.forEach((x,i)=>rank[x.dez]=i+1);

  return jogo.map(n=>{
    const isRep = setUlt.has(n);
    const r = rank[n] || 999;

    const gap = metrics?.gap?.[n];
    const trend = metrics?.trend?.[n];

    const motivos = [];

    if(isRep) motivos.push("üîÅ veio do √∫ltimo concurso (tende a repetir bastante)");
    else motivos.push("üÜï n√£o saiu no √∫ltimo (normal entrar 4 a 10 dessas no pr√≥ximo)");

    if(typeof gap === "number"){
      if(gap>=8) motivos.push(`‚è≥ est√° h√° ${gap} concursos sem aparecer (pode ‚Äòpintar‚Äô)`);
      else if(gap<=2) motivos.push("‚ö° apareceu recentemente (rec√™ncia forte)");
    }

    if(typeof trend === "number"){
      if(trend>0.03) motivos.push("üìà est√° ‚Äòsubindo‚Äô agora (√∫ltimos concursos)");
    }

    return { dezena:n, texto: motivos.join(" ‚Ä¢ ") };
  });
}
</script>

<script>

function renderTop10(freq, totalConcursos){
  const ord = ordenarPorFreq(freq).slice(0,10);
  const max = ord[0]?.f || 1;
  const bars = ord.map(x=>{
    const pct = Math.round((x.f/max)*100);
    return `
      <div style="display:flex;align-items:center;gap:10px;margin:10px 0">
        <div style="width:90px;color:var(--text);font-weight:950">Dezena ${format2(x.dez)}</div>
        <div style="flex:1;background:rgba(255,255,255,.10);border:3px solid #000;border-radius:999px;overflow:hidden;height:16px">
          <div style="height:100%;width:${pct}%;background:linear-gradient(90deg,var(--accent),var(--accent2))"></div>
        </div>
        <div style="width:56px;text-align:right;color:var(--text);font-weight:950">${x.f}x</div>
      </div>
    `;
  }).join("");

  return `
    <div class="box" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
        <b>üìä Top 10 dezenas mais frequentes</b>
        <span class="mini" style="margin:0">Base: <b>${totalConcursos}</b> concursos</span>
      </div>
      <div class="mini">Barras maiores = dezenas que mais apareceram no per√≠odo analisado.</div>
      <div style="margin-top:10px">${bars}</div>
    </div>
  `;
}
function renderTop10Atrasadas(modern, totalConcursos){
  if(!modern || !modern.gap) return "";

  const arr = [];
  for(let d=1; d<=25; d++){
    arr.push({ dez: d, gap: Number(modern.gap[d] ?? 0) });
  }

  arr.sort((a,b)=>b.gap-a.gap);

  const top = arr.slice(0,10);
  const max = top[0]?.gap || 1;

  const bars = top.map(x=>{
    const pct = Math.round((x.gap / max) * 100);
    return `
      <div style="display:flex;align-items:center;gap:10px;margin:10px 0">
        <div style="width:90px;color:var(--text);font-weight:950">Dezena ${format2(x.dez)}</div>
        <div style="flex:1;background:rgba(255,255,255,.10);border:3px solid #000;border-radius:999px;overflow:hidden;height:16px">
          <div style="height:100%;width:${pct}%;background:linear-gradient(90deg,var(--accent),var(--accent2))"></div>
        </div>
        <div style="width:90px;text-align:right;color:var(--text);font-weight:950">${x.gap} atrasos</div>
      </div>
    `;
  }).join("");

  const lista = top.map(x=>{
    return `<div class="mini" style="margin:6px 0"><b>Dezena ${format2(x.dez)}</b> ‚Äî <b>${x.gap}</b> concurso(s) sem sair</div>`;
  }).join("");

  return `
  <div class="box" style="margin-top:12px">
    <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
      <b>‚è≥ TOP 10 DE DEZENAS ATRASADAS</b>
      <span class="mini" style="margin:0">Base: <b>${totalConcursos}</b> concursos</span>
    </div>

    <div class="mini" style="margin-top:6px">
      Barra maior = dezena h√° mais concursos sem aparecer (atraso).
    </div>

    <div style="margin-top:10px">
      ${bars}
    </div>
  </div>
`;
}

function renderListaConcursos(concursos){
  const rows = concursos.map(c=>{
    const dezenas = (c.dezenas||[]).map(d=>format2(toNum(d))).join(" - ");
    const data = c.data ? String(c.data) : "‚Äî";
    return `<tr>
      <td><b>${c.concurso}</b></td>
      <td>${data}</td>
      <td class="mono">${dezenas}</td>
    </tr>`;
  }).join("");
  return `
    <table class="table">
      <thead><tr><th>Concurso</th><th>Data</th><th>Dezenas</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
        <div style="margin-top:14px">
          <div style="font-weight:900;margin-bottom:6px">üî§ Mapa fixo (treino) de letras ‚Üí dezenas (A‚ÄìO = IN / P‚ÄìY = OUT)</div>
          <div class="mini" style="margin-bottom:8px">O padr√£o √© FIXO (treinado). Aqui o sistema s√≥ encaixa as dezenas do seu recorte (qtd concursos) nas posi√ß√µes por comportamento.</div>
          <div style="overflow:auto">
            <table class="table">
              <thead><tr><th>Letra</th><th>Dezena</th><th>Grupo</th><th>Perfil</th></tr></thead>
              <tbody>${letterHtml}</tbody>
            </table>
          </div>
        </div>

  `;
}

function abrirGraficoBlocos(blocos){
  const max = Math.max(blocos.A,blocos.B,blocos.C,blocos.D,blocos.E,1);
  function row(label, val){
    const pct = Math.round((val/max)*100);
    return `
      <div style="display:flex;align-items:center;gap:10px;margin:10px 0">
        <div style="width:90px;color:var(--text);font-weight:950">${label}</div>
        <div style="flex:1;background:rgba(255,255,255,.10);border:3px solid #000;border-radius:999px;overflow:hidden;height:16px">
          <div style="height:100%;width:${pct}%;background:linear-gradient(90deg,var(--accent),var(--accent2))"></div>
        </div>
        <div style="width:56px;text-align:right;color:var(--text);font-weight:950">${val}</div>
      </div>`;
  }
  document.getElementById("graficoBlocosArea").innerHTML =
    row("A (01‚Äì05)", blocos.A) +
    row("B (06‚Äì10)", blocos.B) +
    row("C (11‚Äì15)", blocos.C) +
    row("D (16‚Äì20)", blocos.D) +
    row("E (21‚Äì25)", blocos.E);

  document.getElementById("modalBlocosBack").style.display="flex";
}
</script>

<script>

function calcEvenOddDistribution(concursos){
  const map = {};
  concursos.forEach(c=>{
    const nums = (c.dezenas||[]).map(toNum).filter(n=>n>=1 && n<=25);
    const pares = nums.filter(n=>n%2===0).length;
    const impares = nums.length - pares;
    const key = `${pares}-${impares}`;
    map[key] = (map[key]||0)+1;
  });
  const n = Math.max(1, concursos.length);
  return Object.entries(map)
    .map(([k,v])=>{
      const [p,i] = k.split("-").map(Number);
      return { pares:p, impares:i, count:v, pct: Math.round((v/n)*100) };
    })
    .sort((a,b)=>b.count-a.count || b.pares-a.pares);
}

function calcSumDistribution(concursos){
  const map = {};
  concursos.forEach(c=>{
    const nums=(c.dezenas||[]).map(toNum).filter(n=>n>=1 && n<=25);
    const s = nums.reduce((a,b)=>a+b,0);
    map[s] = (map[s]||0)+1;
  });
  return Object.entries(map)
    .map(([k,v])=>({ soma:Number(k), count:v }))
    .sort((a,b)=>b.count-a.count);
}

function calcBlockPatternDistribution(concursos){
  const map = {};
  concursos.forEach(c=>{
    const nums=(c.dezenas||[]).map(toNum).filter(n=>n>=1 && n<=25);
    const b = distribuicaoBlocos(nums);
    const key = `${b.A}-${b.B}-${b.C}-${b.D}-${b.E}`;
    map[key]=(map[key]||0)+1;
  });
  return Object.entries(map)
    .map(([k,v])=>{
      const [A,B,C,D,E] = k.split("-").map(Number);
      return { A,B,C,D,E, key:k, count:v };
    })
    .sort((a,b)=>b.count-a.count);
}

function calcPrimeCountDistribution(concursos){
  const primes = new Set([2,3,5,7,11,13,17,19,23]);
  const dist = {};
  concursos.forEach(c=>{
    const nums = (c.dezenas||[]).map(d=>Number(String(d).replace(/^0+/,""))).filter(x=>x>=1 && x<=25);
    const pc = nums.reduce((acc,n)=>acc+(primes.has(n)?1:0),0);
    dist[pc] = (dist[pc]||0)+1;
  });
  const n = Math.max(1, concursos.length);
  return Object.keys(dist).map(k=>({
    k: Number(k),
    count: dist[k],
    pct: Math.round((dist[k]/n)*100)
  })).sort((a,b)=>b.count-a.count || b.k-a.k);
}

function calcLinesPatternDistribution(concursos){
  const dist = {};
  concursos.forEach(c=>{
    const nums = (c.dezenas||[]).map(d=>Number(String(d).replace(/^0+/,""))).filter(x=>x>=1 && x<=25);
    const rows = [0,0,0,0,0];
    nums.forEach(n=>{
      const r = Math.floor((n-1)/5); // 0..4
      rows[r] += 1;
    });
    const key = rows.join("-");
    dist[key] = (dist[key]||0)+1;
  });
  const n = Math.max(1, concursos.length);
  return Object.keys(dist).map(k=>({
    pattern: k,
    count: dist[k],
    pct: Math.round((dist[k]/n)*100)
  })).sort((a,b)=>b.count-a.count);
}

function calcColsPatternDistribution(concursos){
  const dist = {};
  concursos.forEach(c=>{
    const nums = (c.dezenas||[]).map(d=>Number(String(d).replace(/^0+/,""))).filter(x=>x>=1 && x<=25);
    const cols = [0,0,0,0,0];
    nums.forEach(n=>{
      const col = (n-1) % 5; // 0..4
      cols[col] += 1;
    });
    const key = cols.join("-");
    dist[key] = (dist[key]||0)+1;
  });
  const n = Math.max(1, concursos.length);
  return Object.keys(dist).map(k=>({
    pattern: k,
    count: dist[k],
    pct: Math.round((dist[k]/n)*100)
  })).sort((a,b)=>b.count-a.count);
}

function calcBlockTotals(concursos){
  const tot = {A:0,B:0,C:0,D:0,E:0};
  concursos.forEach(c=>{
    const nums=(c.dezenas||[]).map(toNum).filter(n=>n>=1 && n<=25);
    const b=distribuicaoBlocos(nums);
    tot.A+=b.A; tot.B+=b.B; tot.C+=b.C; tot.D+=b.D; tot.E+=b.E;
  });
  return tot;
}

function calcTopPairsCooc(concursos, topN=12){
  const co = Array.from({length:26}, ()=>Array(26).fill(0));
  concursos.forEach(c=>{
    const nums=(c.dezenas||[]).map(toNum).filter(n=>n>=1 && n<=25).sort((a,b)=>a-b);
    for(let i=0;i<nums.length;i++){
      for(let j=i+1;j<nums.length;j++){
        const a=nums[i], b=nums[j];
        co[a][b]++; co[b][a]++;
      }
    }
  });
  const arr=[];
  for(let a=1;a<=25;a++){
    for(let b=a+1;b<=25;b++){
      arr.push({a,b,count:co[a][b]});
    }
  }
  arr.sort((x,y)=>y.count-x.count);
  return arr.slice(0, topN);
}

function renderEvenOddDist(evenOdd, total){
  const top = (evenOdd||[]).slice(0,3);
  const dom = top[0] || null;

  const donutLabel = dom ? `${dom.pares}P / ${dom.impares}I` : "‚Äî";
  const domText = dom ? `${dom.pares} pares / ${dom.impares} √≠mpares` : "‚Äî";
  const domPct = dom ? (dom.pct ?? Math.round((dom.count/Math.max(1,total))*100)) : 0;

  const maxCount = top[0]?.count || 1;

  const rows = top.map(x=>{
    const pctBar = Math.round((x.count/maxCount)*100);
    const pctJanela = (x.pct ?? Math.round((x.count/Math.max(1,total))*100));
    return `
      <div class="primeRowCard">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px">
          <div>
            <div style="font-weight:950">${x.pares} pares / ${x.impares} √≠mpares</div>
            <div class="mini" style="margin-top:4px">${pctJanela}% na janela</div>
          </div>
          <div style="font-weight:1000;opacity:.92">${x.count}x</div>
        </div>
        <div class="primeBar" style="margin-top:10px"><div style="width:${pctBar}%"></div></div>
      </div>
    `;
  }).join("");

  return `
    <div class="box" style="margin-top:12px">
      <div class="primeStepHdr">
        <div>
          <b>üß© Padr√µes de distribui√ß√£o (equil√≠brio)</b>
          <div class="mini" style="margin-top:6px">Mostra as distribui√ß√µes (pares/√≠mpares) mais recorrentes na janela.</div>
          ${dom ? `<div class="mini" style="margin-top:8px">Dominante: <b>${domText}</b> ‚Ä¢ ${domPct}% (${dom.count}x)</div>` : ``}
        </div>
        <div class="primePill">1/7</div>
      </div>

      <div class="primeGrid2" style="margin-top:14px">
        <div class="primePanel">
          <div class="primePanelTitle">Paridade (visual)</div>
          <div style="display:flex;align-items:center;justify-content:center;min-height:220px">
            <div style="
              width:200px;height:200px;border-radius:999px;
              background: conic-gradient(var(--accent) 0 ${domPct}%, rgba(255,255,255,.16) ${domPct}% 100%);
              display:flex;align-items:center;justify-content:center;
              border:3px solid #000;
              box-shadow: 0 18px 38px rgba(0,0,0,.45);
            ">
              <div style="
                width:128px;height:128px;border-radius:999px;
                background: rgba(0,0,0,.42);
                border:1px solid rgba(255,255,255,.10);
                display:flex;align-items:center;justify-content:center;
                font-weight:1000;letter-spacing:.6px
              ">${donutLabel}</div>
            </div>
          </div>
          <div class="mini" style="margin-top:10px;opacity:.9">
            <span style="display:inline-flex;align-items:center;gap:8px;margin-right:14px">
              <span style="width:10px;height:10px;border-radius:3px;background:var(--accent)"></span> pares
            </span>
            <span style="display:inline-flex;align-items:center;gap:8px">
              <span style="width:10px;height:10px;border-radius:3px;background:rgba(255,255,255,.16)"></span> √≠mpares
            </span>
          </div>
        </div>

        <div class="primePanel">
          <div class="primePanelTitle">Distribui√ß√µes na janela</div>
          ${rows || `<div class="mini">‚Äî</div>`}
        </div>
      </div>

      <div class="mini" style="margin-top:12px">
        ‚úÖ Uso pr√°tico: monte seu jogo manual dentro do dominante para reduzir ‚Äújogo fora do padr√£o‚Äù.
      </div>
    </div>
  `;
}

function _primePct(n, total){
  return total ? Math.round((n/Math.max(1,total))*100) : 0;
}
function _primeMaxCount(list){
  return Math.max(1, ...(list||[]).map(x => (x?.count||0)));
}
function _primeDonut({ pct=0, label="‚Äî", legendHtml="" }){
  const safe = Math.max(0, Math.min(100, Number(pct)||0));
  return `
    <div style="display:flex;align-items:center;justify-content:center;margin-top:8px">
      <div style="
        width:170px;height:170px;border-radius:999px;
        background: conic-gradient(var(--accent) 0 ${safe}%, rgba(255,255,255,16) ${safe}% 100%);
        display:flex;align-items:center;justify-content:center;
        border:1px solid rgba(255,255,255,12);
        box-shadow: 0 18px 38px rgba(0,0,0,45);
      ">
        <div style="
          width:128px;height:128px;border-radius:999px;
          background: rgba(0,0,0,42);
          border:1px solid rgba(255,255,255,10);
          display:flex;align-items:center;justify-content:center;
          font-weight:1000;letter-spacing:.6px;text-align:center;padding:10px
        ">${label}</div>
      </div>
    </div>
    ${legendHtml ? `<div class="mini" style="margin-top:10px;opacity:.9">${legendHtml}</div>` : ``}
  `;
}
function _primeRow({ labelLeft="", subLeft="", pctBar=0, countRight="", pctRight="" }){
  const w = Math.max(0, Math.min(100, Number(pctBar)||0));
  return `
    <div style="display:flex;align-items:center;justify-content:space-between;gap:14px;margin:14px 0">
      <div style="min-width:220px">
        <div style="font-weight:1000">${labelLeft}</div>
        ${subLeft ? `<div class="mini" style="margin-top:2px">${subLeft}</div>` : ``}
      </div>
      <div style="flex:1">
        <div class="primeBar"><div style="width:${w}%"></div></div>
      </div>
      <div style="min-width:58px;text-align:right;font-weight:1000">${countRight}</div>
    </div>
  `;
}
function _primeSectionBox({ title="", subtitle="", dominantLine="", pill="1/7", leftTitle="Visual", donutHtml="", rightTitle="Distribui√ß√µes na janela", rowsHtml="", footerHtml="" }){
  return `
    <div class="box" style="margin-top:12px">
      <div class="primeStepHdr">
        <div>
          <b>${title}</b>
          ${subtitle ? `<div class="mini" style="margin-top:6px">${subtitle}</div>` : ``}
          ${dominantLine ? `<div class="mini" style="margin-top:10px">${dominantLine}</div>` : ``}
        </div>
        <div class="primePill">${pill}</div>
      </div>

      <div class="primeGrid2" style="margin-top:14px">
        <div class="primePanel">
          <div class="primePanelTitle">${leftTitle}</div>
          ${donutHtml}
        </div>

        <div class="primePanel">
          <div class="primePanelTitle">${rightTitle}</div>
          ${rowsHtml || `<div class="mini">‚Äî</div>`}
        </div>
      </div>

      ${footerHtml ? `<div class="mini" style="margin-top:12px">${footerHtml}</div>` : ``}
    </div>
  `;
}

function renderSumsTop(sums, total){
  const top = (sums||[]).slice(0, 7);
  const dom = top[0] || null;
  const max = _primeMaxCount(top);

  const rows = top.map(x=>{
    const pctJanela = _primePct(x?.count||0, total);
    return _primeRow({
      labelLeft: `Soma ${x.soma}`,
      subLeft: `${pctJanela}% na janela`,
      pctBar: Math.round(((x.count||0)/max)*100),
      countRight: `${x.count||0}x`
    });
  }).join("");

  const donutPct = dom ? _primePct(dom.count||0, total) : 0;
  const donutHtml = _primeDonut({
    pct: donutPct,
    label: dom ? `Soma ${dom.soma}` : "‚Äî",
    legendHtml: `
      <span style="display:inline-flex;align-items:center;gap:8px;margin-right:14px">
        <span style="width:10px;height:10px;border-radius:3px;background:var(--accent)"></span> dominante
      </span>
      <span style="display:inline-flex;align-items:center;gap:8px">
        <span style="width:10px;height:10px;border-radius:3px;background:rgba(255,255,255,16)"></span> outros
      </span>
    `
  });

  const dominantLine = dom
    ? `Dominante: <b>Soma ${dom.soma}</b> ‚Ä¢ ${donutPct}% na janela (${dom.count||0}x)`
    : `Dominante: ‚Äî`;

  return _primeSectionBox({
    title: "‚ûï Padr√µes de soma (equil√≠brio)",
    subtitle: "Mostra quais somas mais se repetiram na janela (ajuda a evitar combina√ß√µes muito fora do padr√£o).",
    dominantLine,
    pill: "5/7",
    leftTitle: "Soma (visual)",
    donutHtml,
    rightTitle: "Distribui√ß√µes na janela",
    rowsHtml: rows,
    footerHtml: "‚úÖ Uso pr√°tico: se a soma sair muito diferente das dominantes, o jogo tende a ficar ‚Äúestranho‚Äù."
  });
}

function renderPrimeCountDist(primeDist, totalConcursos){
  const top = (primeDist||[]).slice(0, 6);
  const dom = top[0] || null;
  const max = _primeMaxCount(top);

  const rows = top.map(x=>{
    const pctJanela = x?.pct ?? _primePct(x?.count||0, totalConcursos);
    return _primeRow({
      labelLeft: `${x.k} primos`,
      subLeft: `${pctJanela}% na janela`,
      pctBar: Math.round(((x.count||0)/max)*100),
      countRight: `${x.count||0}x`
    });
  }).join("");

  const donutPct = dom ? (dom.pct ?? _primePct(dom.count||0, totalConcursos)) : 0;
  const donutHtml = _primeDonut({
    pct: donutPct,
    label: dom ? `${dom.k} primos` : "‚Äî",
    legendHtml: `
      <span style="display:inline-flex;align-items:center;gap:8px;margin-right:14px">
        <span style="width:10px;height:10px;border-radius:3px;background:var(--accent)"></span> dominante
      </span>
      <span style="display:inline-flex;align-items:center;gap:8px">
        <span style="width:10px;height:10px;border-radius:3px;background:rgba(255,255,255,16)"></span> outros
      </span>
    `
  });

  const dominantLine = dom
    ? `Dominante: <b>${dom.k} primos</b> ‚Ä¢ ${donutPct}% na janela (${dom.count||0}x)`
    : `Dominante: ‚Äî`;

  return _primeSectionBox({
    title: "üßÆ Padr√µes de primos (equil√≠brio)",
    subtitle: "Mostra quantos n√∫meros primos costumam aparecer por concurso na janela.",
    dominantLine,
    pill: "2/7",
    leftTitle: "Primos (visual)",
    donutHtml,
    rightTitle: "Distribui√ß√µes na janela",
    rowsHtml: rows,
    footerHtml: "‚úÖ Uso pr√°tico: manter seu jogo dentro do dominante reduz combina√ß√µes ‚Äúfora do padr√£o‚Äù."
  });
}

function renderLinesPatterns(linesDist, totalConcursos){
  const top = (linesDist||[]).slice(0, 6);
  const dom = top[0] || null;
  const max = _primeMaxCount(top);

  const rows = top.map(x=>{
    const pctJanela = x?.pct ?? _primePct(x?.count||0, totalConcursos);
    return _primeRow({
      labelLeft: `${x.pattern}`,
      subLeft: `${pctJanela}% na janela`,
      pctBar: Math.round(((x.count||0)/max)*100),
      countRight: `${x.count||0}x`
    });
  }).join("");

  const donutPct = dom ? (dom.pct ?? _primePct(dom.count||0, totalConcursos)) : 0;
  const donutHtml = _primeDonut({
    pct: donutPct,
    label: dom ? `${dom.pattern}` : "‚Äî",
    legendHtml: `
      <span style="display:inline-flex;align-items:center;gap:8px;margin-right:14px">
        <span style="width:10px;height:10px;border-radius:3px;background:var(--accent)"></span> dominante
      </span>
      <span style="display:inline-flex;align-items:center;gap:8px">
        <span style="width:10px;height:10px;border-radius:3px;background:rgba(255,255,255,16)"></span> outros
      </span>
    `
  });

  const dominantLine = dom
    ? `Dominante: <b>${dom.pattern}</b> ‚Ä¢ ${donutPct}% na janela (${dom.count||0}x)`
    : `Dominante: ‚Äî`;

  return _primeSectionBox({
    title: "üìè Padr√µes de linhas (equil√≠brio)",
    subtitle: "Distribui√ß√£o de dezenas por linha do volante (5 linhas). Ex: 3-3-3-3-3.",
    dominantLine,
    pill: "3/7",
    leftTitle: "Linhas (visual)",
    donutHtml,
    rightTitle: "Distribui√ß√µes na janela",
    rowsHtml: rows,
    footerHtml: "‚úÖ Uso pr√°tico: linhas equilibradas ajudam a evitar concentra√ß√£o exagerada em uma faixa do volante."
  });
}

function renderColsPatterns(colsDist, totalConcursos){
  const top = (colsDist||[]).slice(0, 6);
  const dom = top[0] || null;
  const max = _primeMaxCount(top);

  const rows = top.map(x=>{
    const pctJanela = x?.pct ?? _primePct(x?.count||0, totalConcursos);
    return _primeRow({
      labelLeft: `${x.pattern}`,
      subLeft: `${pctJanela}% na janela`,
      pctBar: Math.round(((x.count||0)/max)*100),
      countRight: `${x.count||0}x`
    });
  }).join("");

  const donutPct = dom ? (dom.pct ?? _primePct(dom.count||0, totalConcursos)) : 0;
  const donutHtml = _primeDonut({
    pct: donutPct,
    label: dom ? `${dom.pattern}` : "‚Äî",
    legendHtml: `
      <span style="display:inline-flex;align-items:center;gap:8px;margin-right:14px">
        <span style="width:10px;height:10px;border-radius:3px;background:var(--accent)"></span> dominante
      </span>
      <span style="display:inline-flex;align-items:center;gap:8px">
        <span style="width:10px;height:10px;border-radius:3px;background:rgba(255,255,255,16)"></span> outros
      </span>
    `
  });

  const dominantLine = dom
    ? `Dominante: <b>${dom.pattern}</b> ‚Ä¢ ${donutPct}% na janela (${dom.count||0}x)`
    : `Dominante: ‚Äî`;

  return _primeSectionBox({
    title: "üìê Padr√µes de colunas (equil√≠brio)",
    subtitle: "Distribui√ß√£o de dezenas por coluna do volante (5 colunas). Ex: 4-2-3-3-3.",
    dominantLine,
    pill: "4/7",
    leftTitle: "Colunas (visual)",
    donutHtml,
    rightTitle: "Distribui√ß√µes na janela",
    rowsHtml: rows,
    footerHtml: "‚úÖ Uso pr√°tico: colunas muito concentradas tendem a gerar cart√µes ‚Äúfora do padr√£o‚Äù da janela."
  });
}

function renderPrimeKpis(payload, evenOdd, primeDist, linesDist, colsDist, blockPatterns){
  const eoDom = Array.isArray(evenOdd) ? (evenOdd[0]||null) : ((evenOdd && evenOdd.dist && evenOdd.dist.length) ? evenOdd.dist[0] : null);
  const primeDom = primeDist && primeDist.length ? primeDist[0] : null;
  const linesDom = linesDist && linesDist.length ? linesDist[0] : null;
  const colsDom = colsDist && colsDist.length ? colsDist[0] : null;
  const blockDom = blockPatterns && blockPatterns.length ? blockPatterns[0] : null;

  return `
  <div class="box" style="margin-top:12px">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
      <div>
        <div style="font-weight:1000;color:var(--accent);letter-spacing:.3px">AN√ÅLISE PRIME ‚Ä¢ 7 PONTOS ‚Ä¢ SISTEMA PREDITIVO</div>
        <div class="mini">Janela: <b>${payload.inicio}</b> a <b>${payload.ultimo}</b> (${payload.concursos.length} concursos)</div>
        <div class="mini" style="margin-top:6px">Use estes <b>7 pontos</b> para montar seu <b>Jogo Manual</b> com clareza (padr√µes reais da janela).</div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn btnGhost" type="button" onclick="verConcursos()">üìÖ Ver concursos</button>
      </div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div class="box">
        <div class="mini" style="margin:0">Paridade dominante</div>
        <div style="font-size:18px;font-weight:1000;margin-top:6px">${eoDom ? (eoDom.label || eoDom.pattern || ((eoDom.pares!=null && eoDom.impares!=null) ? (`${eoDom.pares} pares / ${eoDom.impares} √≠mpares`) : "‚Äî")) : "‚Äî"}</div>
        <div class="mini" style="margin-top:6px">${eoDom ? ((eoDom.pct ?? Math.round((eoDom.count/Math.max(1,payload.concursos.length))*100)) + "% na janela") : ""}</div>
      </div>
      <div class="box">
        <div class="mini" style="margin:0">Primos dominantes</div>
        <div style="font-size:18px;font-weight:1000;margin-top:6px">${primeDom ? (primeDom.k+" primos") : "‚Äî"}</div>
        <div class="mini" style="margin-top:6px">${primeDom ? (primeDom.pct + "% na janela") : ""}</div>
      </div>
      <div class="box">
        <div class="mini" style="margin:0">Padr√£o de linhas</div>
        <div style="font-size:18px;font-weight:1000;margin-top:6px">${linesDom ? linesDom.pattern : "‚Äî"}</div>
        <div class="mini" style="margin-top:6px">${linesDom ? (linesDom.pct + "% na janela") : ""}</div>
      </div>
      <div class="box">
        <div class="mini" style="margin:0">Padr√£o de colunas</div>
        <div style="font-size:18px;font-weight:1000;margin-top:6px">${colsDom ? colsDom.pattern : "‚Äî"}</div>
        <div class="mini" style="margin-top:6px">${colsDom ? (colsDom.pct + "% na janela") : ""}</div>
      </div>
    </div>

    ${blockDom ? `<div class="mini" style="margin-top:10px">üì¶ Blocos A‚ÄìE dominante: <b>${(blockDom.key || `${blockDom.A}-${blockDom.B}-${blockDom.C}-${blockDom.D}-${blockDom.E}`)}</b> (${Math.round(((blockDom.count||0)/Math.max(1,payload.concursos.length))*100)}% na janela)</div>` : ``}
  </div>
  `;
}

function renderBlocksPrime(totals, patterns, total){
  const toplist = (patterns || []).slice(0, 10);
  const dom = toplist[0] || null;
  const max = _primeMaxCount(toplist);

  const rows = toplist.map(p=>{
    const key = (p.key || `${p.A}-${p.B}-${p.C}-${p.D}-${p.E}`);
    const pctJanela = _primePct(p?.count||0, total);
    return _primeRow({
      labelLeft: `${key}`,
      subLeft: `${pctJanela}% na janela`,
      pctBar: Math.round(((p.count||0)/max)*100),
      countRight: `${p.count||0}x`
    });
  }).join("");

  const domKey = dom ? (dom.key || `${dom.A}-${dom.B}-${dom.C}-${dom.D}-${dom.E}`) : "‚Äî";
  const donutPct = dom ? _primePct(dom.count||0, total) : 0;

  const donutHtml = _primeDonut({
    pct: donutPct,
    label: dom ? domKey : "‚Äî",
    legendHtml: `
      <span style="display:inline-flex;align-items:center;gap:8px;margin-right:14px">
        <span style="width:10px;height:10px;border-radius:3px;background:var(--accent)"></span> dominante
      </span>
      <span style="display:inline-flex;align-items:center;gap:8px">
        <span style="width:10px;height:10px;border-radius:3px;background:rgba(255,255,255,16)"></span> outros
      </span>
    `
  });

  const dominantLine = dom
    ? `Dominante: <b>${domKey}</b> ‚Ä¢ ${donutPct}% na janela (${dom.count||0}x)`
    : `Dominante: ‚Äî`;

  return _primeSectionBox({
    title: "üì¶ Padr√µes de blocos A‚ÄìE (equil√≠brio)",
    subtitle: "Cada padr√£o representa quantas dezenas ca√≠ram em cada bloco: A(01‚Äì05), B(06‚Äì10), C(11‚Äì15), D(16‚Äì20), E(21‚Äì25).",
    dominantLine,
    pill: "6/7",
    leftTitle: "Blocos (visual)",
    donutHtml,
    rightTitle: "Distribui√ß√µes na janela",
    rowsHtml: rows,
    footerHtml: "‚úÖ Uso pr√°tico: blocos ajudam a montar um cart√£o equilibrado no volante (sem concentrar tudo em um lado)."
  });
}

function combosKFromSorted(arr, k){
  const res = [];
  const n = arr.length;
  function rec(start, path){
    if(path.length === k){ res.push(path.slice()); return; }
    for(let i=start;i<n;i++){
      path.push(arr[i]);
      rec(i+1, path);
      path.pop();
    }
  }
  rec(0, []);
  return res;
}

function calcTopSetsCooc(concursos, opts={}){
  const {
    minK = 3,
    maxK = 6,
    minCount = 2,
    limit = 12
  } = opts;

  const total = (concursos || []).length;
  const map = new Map(); // key => count

  for(const c of (concursos || [])){
    const nums = (c.dezenas || [])
      .map(toNum)
      .filter(n=>n>=1 && n<=25)
      .sort((a,b)=>a-b);

    if(nums.length < minK) continue;

    const upper = Math.min(maxK, nums.length);
    for(let k=minK;k<=upper;k++){
      const combs = combosKFromSorted(nums, k);
      for(const comb of combs){
        const key = comb.map(format2).join("-");
        map.set(key, (map.get(key) || 0) + 1);
      }
    }
  }

  const list = [];
  for(const [key, count] of map.entries()){
    if(count >= minCount){
      const size = key.split("-").length;
      list.push({ key, count, size });
    }
  }

  list.sort((a,b)=>(b.count-a.count) || (b.size-a.size) || a.key.localeCompare(b.key));

  return { total, list: list.slice(0, limit) };
}

function renderTopSets(setsInfo){
  const total = setsInfo?.total || 0;
  const list = (setsInfo?.list || []).slice(0, 10);
  const dom = list[0] || null;
  const max = _primeMaxCount(list);

  const rows = list.map(s=>{
    const pctJanela = _primePct(s?.count||0, total);
    const label = (s.key || "").replaceAll("-", ", ");
    return _primeRow({
      labelLeft: label ? `<span class="mono"><b>${label}</b></span>` : "‚Äî",
      subLeft: `Tamanho ${s.size} ‚Ä¢ ${pctJanela}% na janela`,
      pctBar: Math.round(((s.count||0)/max)*100),
      countRight: `${s.count||0}x`
    });
  }).join("");

  const domLabel = dom ? dom.key.replaceAll("-", ", ") : "‚Äî";
  const donutPct = dom ? _primePct(dom.count||0, total) : 0;

  const donutHtml = _primeDonut({
    pct: donutPct,
    label: dom ? domLabel : "‚Äî",
    legendHtml: `
      <span style="display:inline-flex;align-items:center;gap:8px;margin-right:14px">
        <span style="width:10px;height:10px;border-radius:3px;background:var(--accent)"></span> dominante
      </span>
      <span style="display:inline-flex;align-items:center;gap:8px">
        <span style="width:10px;height:10px;border-radius:3px;background:rgba(255,255,255,16)"></span> outros
      </span>
    `
  });

  const dominantLine = dom
    ? `Dominante: <b class="mono">${domLabel}</b> ‚Ä¢ ${donutPct}% na janela (${dom.count||0}x)`
    : `Dominante: ‚Äî`;

  return _primeSectionBox({
    title: "üîó Conjuntos que mais saem juntos (equil√≠brio)",
    subtitle: "Aqui o sistema busca ternos, quadras, quintetos‚Ä¶ que se repetem na janela (n√£o √© s√≥ par).",
    dominantLine,
    pill: "7/7",
    leftTitle: "Conjunto (visual)",
    donutHtml,
    rightTitle: "Distribui√ß√µes na janela",
    rowsHtml: rows,
    footerHtml: "‚úÖ Dica PRIME: use o conjunto dominante como ‚Äún√∫cleo‚Äù e complete com dezenas compat√≠veis com os demais padr√µes (paridade, linhas, colunas, blocos)."
  });
}

</script>

<script>

const RESULT_SOURCES = [
  {
    name: "GUIDI",
    latest: () => "https://api.guidi.dev.br/loteria/lotofacil/ultimo",
    byId:   (n)=>`https://api.guidi.dev.br/loteria/lotofacil/${n}`,
    getNumero: (j)=> Number(j?.concurso ?? j?.numero ?? j?.numeroDoConcurso),
    getDezenas:(j)=> (j?.dezenas ?? j?.listaDezenas ?? j?.dezenasSorteadasOrdemSorteio ?? [])
  },
  {
    name: "LOTTOLOOKUP",
    latest: () => "https://lottolookup.com.br/api/lotofacil/latest",
    byId:   (n)=>`https://lottolookup.com.br/api/lotofacil/${n}`,
    getNumero: (j)=> Number(j?.numero ?? j?.concurso ?? j?.numeroDoConcurso),
    getDezenas:(j)=> (j?.listaDezenas ?? j?.dezenasSorteadasOrdemSorteio ?? j?.dezenas ?? [])
  },
  {
    name: "HEROKU",
    latest: () => "https://loteriascaixa-api.herokuapp.com/api/lotofacil/latest",
    byId:   (n)=>`https://loteriascaixa-api.herokuapp.com/api/lotofacil/${n}`,
    getNumero: (j)=> Number(j?.concurso ?? j?.numero ?? j?.numeroDoConcurso),
    getDezenas:(j)=> (j?.dezenas ?? j?.listaDezenas ?? j?.dezenasSorteadasOrdemSorteio ?? [])
  }
];

// ‚úÖ Evita fonte que d√° CORS no GitHub Pages
const RESULT_SOURCES_ACTIVE = (() => {
  try {
    const isGh = /github\.io$/i.test(location.hostname);
    return RESULT_SOURCES.filter(s => !(isGh && s.name === "LOTTOLOOKUP"));
  } catch (_) {
    return RESULT_SOURCES;
  }
})();
async function fetchJsonTimeout(url, ms=6500){
  const ac = new AbortController();
  const t = setTimeout(()=>ac.abort(), ms);
  try{
    const r = await fetch(url, { cache:"no-store", signal: ac.signal });
    if(!r.ok) throw new Error("HTTP "+r.status);
    return await r.json();
  }finally{
    clearTimeout(t);
  }
}

function isValidResult(src, j){
  const num = src.getNumero(j);
  const dz  = src.getDezenas(j);
  return Number.isFinite(num) && num > 0 && Array.isArray(dz) && dz.length >= 15;
}

function normalizeResult(raw){
  const concurso = Number(raw?.concurso ?? raw?.numero ?? raw?.numeroDoConcurso);
  const data = raw?.data ?? raw?.dataApuracao ?? raw?.dataApuracaoStr ?? raw?.dataSorteio ?? "";
  const dezenas = (raw?.dezenas ?? raw?.listaDezenas ?? raw?.dezenasSorteadasOrdemSorteio ?? [])
    .map(x => String(x).padStart(2,"0"));
  return { concurso, data, dezenas, raw };
}

async function getLatestFromAll(){
  const checks = await Promise.allSettled(
    RESULT_SOURCES_ACTIVE.map(async (src)=>{
      const t0 = performance.now();
      const j = await fetchJsonTimeout(src.latest(), 6500);
      const ok = isValidResult(src, j);
      return { src, ok, numero: ok ? src.getNumero(j) : -1, ms: Math.round(performance.now()-t0) };
    })
  );

  const valid = checks
    .filter(x=>x.status==="fulfilled")
    .map(x=>x.value)
    .filter(x=>x.ok)
    .sort((a,b)=> b.numero - a.numero);

  if(!valid.length) throw new Error("Nenhuma API retornou um 'latest' v√°lido agora.");
  return valid[0]; // ‚úÖ maior concurso
}

async function getConcursoByNumberBest(n){
  for(const src of RESULT_SOURCES_ACTIVE){
    try{
      const j = await fetchJsonTimeout(src.byId(n), 6500);
      if(isValidResult(src, j)) return j;
    }catch(e){}
  }
  throw new Error("Falha ao buscar concurso "+n+" em todas as fontes.");
}

async function getOnlineConcursos(qtd){
  const latestMeta = await getLatestFromAll();
  const ultimo = latestMeta.numero;
  const inicio = Math.max(1, ultimo - qtd + 1);

  // ‚úÖ mant√©m ordem cronol√≥gica (do mais antigo ao mais novo)
  const nums = [];
  for(let n=inicio; n<=ultimo; n++) nums.push(n);

  const raws = await Promise.all(nums.map(n=>getConcursoByNumberBest(n)));
  const concursos = raws.map(r=>normalizeResult(r)).sort((a,b)=>a.concurso-b.concurso);

  const latest = concursos[concursos.length-1];
  return { mode:"online", source: latestMeta.src.name, latest, concursos, inicio, ultimo };
}

function buildDemo(qtd){
  const ultimo = 3600;
  const inicio = ultimo - qtd + 1;
  const concursos=[];
  for(let c=inicio;c<=ultimo;c++){
    const dezenas=new Set();
    while(dezenas.size<15) dezenas.add(Math.floor(Math.random()*25)+1);
    concursos.push({ concurso:c, data:"‚Äî", dezenas:[...dezenas].map(n=>format2(n)) });
  }
  const latest = concursos[concursos.length-1];
  return { mode:"demo", source:"Demonstra√ß√£o (offline)", latest, concursos, inicio, ultimo };
}

async function fetchUltimoResultado(){
  try{
    const latestMeta = await getLatestFromAll();
    const raw = await getConcursoByNumberBest(latestMeta.numero);
    const latest = normalizeResult(raw);
    return { ...latest, source: latestMeta.src.name, mode: "online" };
  }catch(e){
    const demo = buildDemo(1);
    return { ...demo.latest, source:"DEMO", mode:"demo" };
  }
}

async function diagnosticoApisLotofacil(){
  const r = await Promise.allSettled(RESULT_SOURCES_ACTIVE.map(async (s)=>{
    const t0 = performance.now();
    const j = await fetchJsonTimeout(s.latest(), 6500);
    return { fonte:s.name, numero:s.getNumero(j), dezenas:(s.getDezenas(j)||[]).length, ms: Math.round(performance.now()-t0) };
  }));
  console.table(r.map(x=> x.status==="fulfilled" ? x.value : ({ erro:true })));
}
</script>

<script>

let lastPayload=null;
function labelJanela(){
  try{
    if(lastPayload && lastPayload.inicio && lastPayload.ultimo){
      const n = (lastPayload.concursos && lastPayload.concursos.length) ? lastPayload.concursos.length : (lastPayload.draws ? lastPayload.draws.length : "");
      return `${lastPayload.inicio} a ${lastPayload.ultimo}${n!==""?` (${n} concursos)`:``}`;
    }
  }catch(e){}
  return "-";
}

let cacheBase = { qtd: null, at: 0, payload: null, freq: null, modern: null };
let lastCtx=null;

let lastPrincipalGame=null;
let lastPrincipalMeta=null;

let lastInvertidaGame=null;
let lastTecnicaGames=null;

let lastPredPack=null;

let manualPrincipalSet = new Set();

let linesSystem15 = null;
let linesUser15 = null;
let activeLine15 = 4; // come√ßa na linha 5 (em branco)

const SAVE_PACK_KEY = "lf_save_pack_v1";
const SAVE_15P_KEY  = "lf_save_15p_v1";

function saveLocal(key, data){
  localStorage.setItem(key, JSON.stringify({
    at: Date.now(),
    data
  }));
}

function loadLocal(key){
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){
    return null;
  }
}

function timeBR(ms){
  try{
    const d = new Date(ms);
    return d.toLocaleString("pt-BR");
  }catch(e){
    return "‚Äî";
  }
}

</script>

<script>

function qtdSelecionada(){ return Number(document.getElementById("qtdConcursos").value); }

async function prepararContextoBase(qtd){
  setStatus(true,"Carregando concursos‚Ä¶");
const now = Date.now();
if (cacheBase.payload && cacheBase.qtd === qtd && (now - cacheBase.at) < 120000) {
  lastPayload = cacheBase.payload;
  lastCtx = { freq: cacheBase.freq, modern: cacheBase.modern };
  setStatus(false,"");
  setProgress(0);
  return { payload: lastPayload, freq: lastCtx.freq, modern: lastCtx.modern };
}
  setProgress(12);

  let payload;
  try{
    setStatus(true,"Buscando concursos reais‚Ä¶");
    setProgress(25);
    payload = await getOnlineConcursos(qtd);
  }catch(e){
    payload = buildDemo(qtd);
  }

  payload.concursos = payload.concursos.slice().sort((a,b)=>a.concurso-b.concurso);

  setStatus(true,"Calculando an√°lises do per√≠odo‚Ä¶");
  setProgress(62);

  const freq = calcularFrequencias(payload.concursos);
  const modern = calcModernMetrics(payload.concursos);

  lastPayload = payload;
  lastCtx = { freq, modern };

  setStatus(false,"");
  setProgress(0);

  cacheBase = { qtd, at: Date.now(), payload, freq, modern };

  return { payload, freq, modern };
}

function verConcursos(){
  if(!lastPayload){ alert("Gere primeiro uma an√°lise ou jogo para carregar concursos."); return; }
  document.getElementById("listaConcursos").innerHTML = renderListaConcursos(lastPayload.concursos);
  abrirModal();
}
</script>

<script>

async function acaoAnalise(){
  if(!access.premium){ alert("üîí Gerar an√°lise exige Premium."); return; }

  const qtd = qtdSelecionada();
  try{
    await prepararContextoBase(qtd);
    const payload = lastPayload;

    window._p15ExplainCtx = buildP15ExplainCtx(payload);
    const {freq, modern} = lastCtx;

    setStatus(true,"Montando An√°lise PRIME (7 pontos)‚Ä¶");
    setProgress(82);

    const evenOdd = calcEvenOddDistribution(payload.concursos);                 // 1) pares/√≠mpares
    const primeDist = calcPrimeCountDistribution(payload.concursos);            // 2) primos
    const linesDist = calcLinesPatternDistribution(payload.concursos);          // 3) linhas
    const colsDist  = calcColsPatternDistribution(payload.concursos);           // 4) colunas
    const sums = calcSumDistribution(payload.concursos);                        // 5) soma
    const blockTotals = calcBlockTotals(payload.concursos);                     // 6) blocos (A‚ÄìE)
    const blockPatterns = calcBlockPatternDistribution(payload.concursos);      //    padr√£o A‚ÄìE
    const topSetsInfo = calcTopSetsCooc(payload.concursos, {                    // 7) conjuntos
      minK: 3,
      maxK: 9,
      minCount: 2,
      limit: 12
    });

    setStatus(false,""); setProgress(0);

    document.getElementById("analiseArea").innerHTML = `
      ${renderPrimeKpis(payload, evenOdd, primeDist, linesDist, colsDist, blockPatterns)}

      ${renderEvenOddDist(evenOdd, payload.concursos.length)}
      ${renderPrimeCountDist(primeDist, payload.concursos.length)}
      ${renderLinesPatterns(linesDist, payload.concursos.length)}
      ${renderColsPatterns(colsDist, payload.concursos.length)}
      ${renderSumsTop(sums, payload.concursos.length)}
      ${renderBlocksPrime(blockTotals, blockPatterns, payload.concursos.length)}
      ${renderTopSets(topSetsInfo)}

      <div class="box" style="margin-top:12px">
        <b>üìå Nota PRIME</b>
        <div class="mini" style="margin-top:8px">
          Estes 7 pontos mostram <b>padr√µes reais da janela</b> (paridade, primos, linhas, colunas, soma, blocos e conjuntos).
          Use como guia para montar o jogo manual. <b>N√£o existe garantia de premia√ß√£o</b>.
        </div>
      </div>
    `;

    goView("viewAnalise");
  }catch(e){
    setStatus(false,""); setProgress(0);
    document.getElementById("analiseArea").innerHTML = `
      <div class="box">
        <b>‚ö†Ô∏è Erro</b>
        <div class="mini" style="margin-top:8px">${String(e?.message || e)}</div>
      </div>
    `;
    goView("viewAnalise");
  }
}
</script>

<script>

function renderPickGrid(selectedSet, lockedSet){
  let html = `<div class="pickGrid" id="pickGridPrincipal">`;
  for(let n=1;n<=25;n++){
    const sel = selectedSet.has(n) ? " sel" : "";
    const lock = lockedSet && lockedSet.has(n) ? " lock" : "";
    html += `<div class="pickCell${sel}${lock}" data-n="${n}">${format2(n)}</div>`;
  }
  html += `</div>`;
  return html;
}

function bindPickGrid(containerId, onClick){
  const root = document.getElementById(containerId);
  if(!root) return;
  root.querySelectorAll(".pickCell").forEach(cell=>{
    cell.addEventListener("click", ()=>{
      if(cell.classList.contains("lock")) return;
      const n = Number(cell.getAttribute("data-n"));
      onClick(n);
    });
  });
}

function renderManualPrincipalUI(){
  const area = document.getElementById("manualPrincipalArea");
  if(!area) return;

  const selected = [...manualPrincipalSet].sort((a,b)=>a-b);

  area.innerHTML = `
    <div class="box" style="margin-top:12px">
      <b>üß© Monte seu jogo manual (vira o Jogo Principal)</b>
      <div class="mini" style="margin-top:6px">
        Marque <b>15 dezenas</b>. Ao confirmar, a Invertida e a T√©cnica usar√£o o seu jogo.
      </div>

      <div class="numbers" style="justify-content:flex-start;margin-top:10px">
        ${selected.length ? selected.map(n=>`<div class="ball">${format2(n)}</div>`).join("") : `<div class="mini">‚Äî</div>`}
      </div>

      <div class="mini" style="margin-top:8px">
        Selecionadas: <b>${selected.length}/15</b>
      </div>

      ${renderPickGrid(manualPrincipalSet)}

      <div class="row" style="margin-top:12px">
        <div class="col">
          <button class="btn btnGhost" type="button" onclick="manualPrincipalSet=new Set();renderManualPrincipalUI()">Limpar</button>
        </div>
        <div class="col">
          <button class="btn btnPrimary" type="button" onclick="usarManualComoPrincipal()">Usar meu jogo</button>
        </div>
      </div>

      <div class="mini" style="margin-top:10px">
        Dica PRIME: tente manter equil√≠brio de distribui√ß√£o (pares/√≠mpares) e evitar concentra√ß√£o em um √∫nico bloco.
      </div>
    </div>
  `;

  bindPickGrid("pickGridPrincipal", (n)=>{
    if(manualPrincipalSet.has(n)) manualPrincipalSet.delete(n);
    else{
      if(manualPrincipalSet.size>=15) return alert("Voc√™ j√° marcou 15 dezenas.");
      manualPrincipalSet.add(n);
    }
    renderManualPrincipalUI();
  });
}

function usarManualComoPrincipal(){
  if(manualPrincipalSet.size !== 15){
    return alert("Marque exatamente 15 dezenas.");
  }
  const jogo = [...manualPrincipalSet].sort((a,b)=>a-b);

  lastPrincipalGame = jogo.slice();
  lastInvertidaGame = null;
  lastTecnicaGames = null;

  if(lastPayload && lastCtx?.freq){
    const freq = lastCtx.freq;
    const cls = classificarDezenas(freq, jogo);
    const pi = contarParesImpares(jogo);
    const soma = somaDezenas(jogo);
    const seq = contarSequencias(jogo);
    const blocos = distribuicaoBlocos(jogo);
    const reps = repetidasDoUltimo(jogo, lastPayload.latest.dezenas);
    lastPrincipalMeta = { cls, pi, soma, seq, blocos, reps };
  }

  alert("‚úÖ Seu jogo foi definido como Jogo Principal!");
  updateCheckButtons();
}
</script>

<script>

async function acaoPrincipal(){
  const qtd = qtdSelecionada();

  if(!access.premium && isFreeUsed()){
    alert("üîí Voc√™ j√° usou a gera√ß√£o gr√°tis. Para liberar, ative o Premium.");
    return;
  }

  try{
    await prepararContextoBase(qtd);
    const payload = lastPayload;

    window._p15ExplainCtx = buildP15ExplainCtx(payload);
    const {freq, modern} = lastCtx;

    setStatus(true,"Gerando jogo principal (15 dezenas)‚Ä¶");
    setProgress(80);

    const pack = buildPack4JogosPreditivo(payload);
    if(!pack || !Array.isArray(pack.principal) || pack.principal.length!==15){
      throw new Error('Pacote do Jogo Principal inv√°lido (principal)');
    }

    // ‚úÖ Diversifica√ß√£o por usu√°rio (mant√©m motor, s√≥ remapeia dezenas determin√≠stico por usu√°rio)
    const __scopeKey = __diversifyScopeKey("PACK4", qtd, payload);
    const __permUser = __getUserPerm(__scopeKey);

    // remapeia principal + motivos (sem alterar a l√≥gica do motor)
    pack.principal = __applyPermNums(pack.principal, __permUser);
    if(pack?.motivos?.principal) pack.motivos.principal = __applyPermMotivos(pack.motivos.principal, __permUser);
    if(pack?.meta) pack.meta = __applyPermMeta(pack.meta, __permUser);

    const result = { jogo: pack.principal, motivos: (pack.motivos?.principal || []), meta: (pack.meta||{}) };
    const jogo = result.jogo;

    lastPredPack = pack;

    lastPrincipalGame = jogo.slice();
    lastInvertidaGame = null;
    lastTecnicaGames = null;

    const cls = classificarDezenas(freq, jogo);
    const pi = contarParesImpares(jogo);
    const soma = somaDezenas(jogo);
    const seq = contarSequencias(jogo);
    const blocos = distribuicaoBlocos(jogo);
    const reps = repetidasDoUltimo(jogo, payload.latest.dezenas);

    lastPrincipalMeta = { cls, pi, soma, seq, blocos, reps };

    setStatus(false,""); setProgress(0);

    if(!access.premium) markFreeUsed();
    aplicarAcessos();

    const balls = jogo.map(n=>`<div class="ball">${format2(n)}</div>`).join("");
const motivosAgrupados = {};
(result?.motivos || []).forEach(m=>{
  const key = (m.texto || "").trim();
  if(!motivosAgrupados[key]) motivosAgrupados[key] = [];
  if(Number.isFinite(Number(m.dezena))) motivosAgrupados[key].push(Number(m.dezena));
});

const motivosHtml = `
  <div class="eliteMotives">
    <div class="eliteMotivesHdr">
      <b>üß† Explica√ß√£o comportamental</b>
      <span>Padr√£o fixo ‚Ä¢ Sistema Preditivo</span>
    </div>
    <div class="eliteMotivesGrid">
      ${
        Object.entries(motivosAgrupados)
          .sort((a,b)=>a[1][0]-b[1][0])
          .map(([texto, dezenas])=>{
            const ordenadas = dezenas.sort((x,y)=>x-y);
            const numsHtml = ordenadas
              .map(n=>`<div class="eliteMotivesNum">${format2(n)}</div>`)
              .join("");

            return `
              <div class="eliteMotivesRow">
                <div class="eliteMotivesTag">${texto}</div>
                <div class="eliteMotivesNums">
                  ${numsHtml}
                </div>
              </div>
            `;
          }).join("")
      }
    </div>
  </div>
`;

    const resumoPares = (pi.pares===7||pi.pares===8)
      ? `Distribui√ß√£o ideal (${pi.pares} pares / ${pi.impares} √≠mpares).`
      : `Distribui√ß√£o fora do ideal (melhor: 7/8).`;
    const resumoSoma = (soma>=170 && soma<=230)
      ? `Soma ${soma} dentro da faixa estat√≠stica mais comum (evita extremos).`
      : `Soma ${soma} fora da faixa mais comum ‚Äî combina√ß√£o mais ‚Äúarriscada‚Äù.`;
    const resumoSeq = seq.temSequencia
      ? `Possui sequ√™ncia, m√°ximo de ${seq.maxLen} n√∫meros seguidos.`
      : `Sem sequ√™ncia (padr√£o mais ‚Äúquebrado‚Äù).`;
    const maxBlock = Math.max(blocos.A,blocos.B,blocos.C,blocos.D,blocos.E);
    const resumoBlocos = (maxBlock<=5)
      ? `Blocos equilibrados (m√°x ${maxBlock} em um bloco).`
      : `Concentra√ß√£o alta em blocos (m√°x ${maxBlock}).`;
    const resumoRep = reps.length
      ? `${reps.length} repetidas do √∫ltimo concurso (${payload.latest.concurso}).`
      : `Sem repetidas do √∫ltimo concurso (${payload.latest.concurso}).`;

    document.getElementById("principalArea").innerHTML = `
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <div style="font-weight:1000;font-size:16px">üéØ Jogo Principal gerado (15 dezenas)</div>
          <div class="mini">Janela: <b>${payload.inicio}</b> a <b>${payload.ultimo}</b> (${payload.concursos.length} concursos)</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
  <button class="btn btnGhost" type="button" onclick="verConcursos()">üìÖ Ver concursos</button>
  <button class="btn btnGhost" type="button" onclick="abrirGraficoBlocos(lastPrincipalMeta.blocos)">üìä Blocos A‚ÄìE</button>

  <button class="btn btnBlue" type="button" onclick="salvarPacotePrincipal()">üíæ Salvar pacote</button>
  <button class="btn btnGhost" type="button" onclick="carregarPacotePrincipal()">üìÇ Carregar salvo</button>
</div>
      </div>

      <div class="numbers">${balls}</div>
<div class="box" style="margin-top:12px">
  <b>üßæ Por que essas dezenas foram escolhidas?</b>
  <div class="mini" style="margin-top:8px">
    Explica√ß√£o preditiva (comportamento nos √∫ltimos 5 concursos + est√°gios 3‚Äì6 antes ‚Ä¢ IN/OUT).
  </div>
  <div style="margin-top:10px;border:1px solid rgba(255,255,255,.10);border-radius:14px;overflow:hidden">
    ${motivosHtml}
  </div>
</div>

      <div class="box" style="margin-top:12px">
        <b>üßæ Resumo PRIME (detalhado)</b>
        <div class="grid" style="margin-top:12px">

          <div class="box">
            <b>üîÅ Repetidas do √∫ltimo</b>
            <div class="mini" style="margin-top:8px"><b>${reps.length ? reps.map(format2).join(", ") : "Nenhuma"}</b></div>
            <div class="mini">${resumoRep}</div>
          </div>

          <div class="box">
            <b>‚öñÔ∏è Pares x √çmpares</b>
            <div class="mini" style="margin-top:8px"><b>${pi.pares}</b> pares ‚Ä¢ <b>${pi.impares}</b> √≠mpares</div>
            <div class="mini">${resumoPares}</div>
          </div>

          <div class="box">
            <b>‚ûï Soma</b>
            <div class="mini" style="margin-top:8px"><b>${soma}</b></div>
            <div class="mini">${resumoSoma}</div>
          </div>

          <div class="box">
            <b>üß© Blocos A‚ÄìE</b>
            <div class="mini" style="margin-top:8px">A: <b>${blocos.A}</b> ‚Ä¢ B: <b>${blocos.B}</b> ‚Ä¢ C: <b>${blocos.C}</b> ‚Ä¢ D: <b>${blocos.D}</b> ‚Ä¢ E: <b>${blocos.E}</b></div>
            <div class="mini">${resumoBlocos}</div>
          </div>

          <div class="box">
            <b>üîó Sequ√™ncias</b>
            <div class="mini" style="margin-top:8px"><b>${seq.temSequencia ? "Sim" : "N√£o"}</b> ‚Ä¢ M√°x: <b>${seq.maxLen}</b></div>
            <div class="mini">${resumoSeq}</div>
          </div>
        </div>
      </div>

      <div class="grid" style="margin-top:12px">
        <div class="box">
          <b>ü§ñ Jogo do Sistema (atual)</b>
          <div class="numbers" style="justify-content:flex-start;margin-top:10px">${jogo.map(n=>`<div class="ball">${format2(n)}</div>`).join("")}</div>
          <div class="mini">Voc√™ pode usar este ou montar o seu jogo manual e substituir o principal.</div>
        </div>
        <div class="box">
          <div id="manualPrincipalArea"></div>
        </div>
      </div>

      <div class="panelCheck" id="panelGerados">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <b>‚úÖ Verificar jogos gerados (base: Jogo Principal)</b>
          <button class="btn btnGhost" type="button" id="btnVerificarGeradosInline" style="display:none" onclick="goView('viewCheck')">Abrir verifica√ß√£o</button>
        </div>
        <div class="mini" style="margin-top:8px">
          Gere tamb√©m a <b>Invertida</b> e a <b>T√©cnica</b> para liberar a verifica√ß√£o autom√°tica de acertos.
        </div>
      </div>

      <div class="box" style="margin-top:12px">
        <b>üìå Aviso</b>
        <div class="mini" style="margin-top:8px">
          Estat√≠stica ajuda a montar estrat√©gia, mas <b>n√£o garante premia√ß√£o</b>.
        </div>
      </div>
    `;

    goView("viewPrincipal");

    manualPrincipalSet = new Set();
    renderManualPrincipalUI();

    updateCheckButtons();
  }catch(e){
    setStatus(false,""); setProgress(0);
    document.getElementById("principalArea").innerHTML = `
      <div class="box">
        <b>‚ö†Ô∏è Erro</b>
        <div class="mini" style="margin-top:8px">${String(e?.message || e)}</div>
      </div>
    `;
    goView("viewPrincipal");
  }
}
</script>

<script>

function salvarPacotePrincipal(){
  if(!lastPrincipalGame){
    alert("Gere um Jogo Principal primeiro.");
    return;
  }

  const pack = {
    principal: lastPrincipalGame || null,
    invertida: lastInvertidaGame || null,
    tecnica1: lastTecnicaGames?.g1 || null,
    tecnica2: lastTecnicaGames?.g2 || null,
    window: lastPayload ? { inicio:lastPayload.inicio, ultimo:lastPayload.ultimo, qtd:lastPayload.concursos?.length || null } : null
  };

  saveLocal(SAVE_PACK_KEY, pack);
salvarJogoNoStorage({
  slot: "Principal+Invertida+Tecnica",
  tipo: "pack",
  nome: "Principal+Invertida+Tecnica",
  pack: pack,
  at: Date.now()
});

alert("‚úÖ Pacote salvo em JOGOS SALVOS: Principal+Invertida+Tecnica (sobrescreve ao salvar de novo)");
}

function carregarPacotePrincipal(){
  const saved = loadLocal(SAVE_PACK_KEY);
  if(!saved?.data){
    alert("N√£o existe pacote salvo ainda.");
    return;
  }

  const p = saved.data;

  lastPrincipalGame = Array.isArray(p.principal) ? p.principal.slice() : null;
  lastInvertidaGame = Array.isArray(p.invertida) ? p.invertida.slice() : null;

  if(p.tecnica1 && p.tecnica2){
    lastTecnicaGames = { g1: p.tecnica1.slice(), g2: p.tecnica2.slice() };
  }else{
    lastTecnicaGames = null;
  }

  updateCheckButtons();

  alert("‚úÖ Pacote carregado! Salvo em: " + timeBR(saved.at));
}

function blocoIndex(n){ return ((n-1)%5)+1; }
function offsetNoBloco(n){ return Math.floor((n-1)/5)+1; }
function mapParaBloco(destBloco, offset){ return (offset-1)*5 + destBloco; }

function remapPorPermutacao(n, perm){
  const b = blocoIndex(n);
  const off = offsetNoBloco(n);
  const destB = perm[b-1];
  return mapParaBloco(destB, off);
}

/* =========================
   DIVERSIFICA√á√ÉO POR USU√ÅRIO (SEM MEXER NOS MOTORES)
   - Mant√©m o padr√£o do motor, mas "embaralha" as colunas (Blocos 1..5) de forma determin√≠stica por usu√°rio.
   - Resultado: usu√°rios diferentes recebem jogos diferentes mesmo na mesma janela (qtd + concurso).
   ========================= */

const __DIVERSIFY_SALT = "lfpa_user_div_v1";

// hash simples e determin√≠stico (32-bit)
function __hash32(str){
  str = String(str||"");
  let h = 2166136261 >>> 0; // FNV-1a base
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}

// PRNG determin√≠stico
function __mulberry32(a){
  return function(){
    let t = (a += 0x6D2B79F5);
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}

function __uidSafe(){
  try{
    // auth √© do Firebase Auth (j√° existe no projeto)
    return (auth && auth.currentUser && auth.currentUser.uid) ? auth.currentUser.uid : "anon";
  }catch(e){
    return "anon";
  }
}

function __diversifyScopeKey(mod, qtd, payload){
  const latest = payload?.latest?.concurso || payload?.ultimo || "";
  // qtd entra pois voc√™ disse "mesma quantidade de an√°lise" gera igual
  return `${String(mod||"mod")}::q${Number(qtd||0)}::c${String(latest)}`;
}

function __getUserPerm(scopeKey){
  window.__divPermCache = window.__divPermCache || {};
  const uid = __uidSafe();
  const k = `${__DIVERSIFY_SALT}|${uid}|${String(scopeKey||"")}`;
  if(window.__divPermCache[k]) return window.__divPermCache[k].slice();

  const seed = __hash32(k);
  const rng = __mulberry32(seed);

  const arr = [1,2,3,4,5];
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(rng() * (i+1));
    const tmp = arr[i]; arr[i]=arr[j]; arr[j]=tmp;
  }

  window.__divPermCache[k] = arr.slice();
  return arr;
}

function __applyPermNums(nums, perm){
  return (nums||[])
    .map(n=> remapPorPermutacao(Number(n), perm))
    .sort((a,b)=>a-b);
}

function __applyPermMotivos(motivos, perm){
  return (motivos||[]).map(m=>{
    const dez = Number(m?.dezena);
    const dez2 = Number.isFinite(dez) ? remapPorPermutacao(dez, perm) : m?.dezena;
    return Object.assign({}, m, { dezena: dez2 });
  });
}

function __applyPermMeta(meta, perm){
  const out = Object.assign({}, meta||{});
  const keys = ["R","G2","G3","G4","OUT1","OUT4","hot","cold"];
  keys.forEach(k=>{
    if(Array.isArray(out[k])){
      out[k] = out[k].map(n=> remapPorPermutacao(Number(n), perm)).sort((a,b)=>a-b);
    }
  });

  // se existir mapa por dezena (obj com chaves num√©ricas), remapeia as chaves
  if(out.map && typeof out.map === "object"){
    const nm = {};
    Object.keys(out.map).forEach(k=>{
      const nk = remapPorPermutacao(Number(k), perm);
      nm[nk] = out.map[k];
    });
    out.map = nm;
  }

  return out;
}



async function gerarInvertida(silent=false){
  if(!access.premium){
    if(!silent) alert("üîí Invertida exige Premium.");
    return;
  }

  const area = document.getElementById("invertidaArea");

  try{
    const qtd = qtdSelecionada();
    await prepararContextoBase(qtd);

    const payload = lastPayload;

    window._p15ExplainCtx = buildP15ExplainCtx(payload);
    const pack = buildPack4JogosPreditivo(payload);
    lastPredPack = pack;

    if(!pack || pack.ok !== true || !Array.isArray(pack.invertida) || pack.invertida.length !== 15){
      if(area) area.innerHTML = `<div class="box"><b>‚ö†Ô∏è</b><div class="mini" style="margin-top:8px">N√£o foi poss√≠vel montar a Invertida (15 dezenas). ${(pack&&pack.err)?pack.err:""}</div></div>`;
      return;
    }

    const __scopeKey = __diversifyScopeKey("PACK4", qtd, payload);
    const __permUser = __getUserPerm(__scopeKey);

    const inv = __applyPermNums(pack.invertida, __permUser);
    lastInvertidaGame = inv.slice();

    const motivos = __applyPermMotivos((pack?.motivos?.invertida || []), __permUser);
    const balls = inv.map(n=>`<div class="ball">${format2(n)}</div>`).join("");

    const motivosAgrupados = {};
    (motivos||[]).forEach(m=>{
      const key = (m.texto||"").trim();
      if(!motivosAgrupados[key]) motivosAgrupados[key]=[];
      if(Number.isFinite(Number(m.dezena))) motivosAgrupados[key].push(Number(m.dezena));
    });
    const motivosHtml = `
  <div class="eliteMotives">
    <div class="eliteMotivesHdr">
      <b>üß† Explica√ß√£o comportamental</b>
      <span>Padr√£o fixo ‚Ä¢ T√©cnica</span>
    </div>
    <div class="eliteMotivesGrid">
      ${
        Object.entries(motivosAgrupados)
          .map(([texto, dezenas])=>{
            const ordenadas = dezenas.sort((a,b)=>a-b);
            const numsHtml = ordenadas
              .map(n=>`<div class="eliteMotivesNum">${format2(n)}</div>`)
              .join("");

            return `
              <div class="eliteMotivesRow">
                <div class="eliteMotivesTag">${texto}</div>
                <div class="eliteMotivesNums">
                  ${numsHtml}
                </div>
              </div>
            `;
          }).join("")
      }
    </div>
  </div>
`;

    if(area){
      area.innerHTML = `
        <div class="box">
          <div class="titleRow">
            <div class="title">üîÑ Invertida gerada (15 dezenas)</div>
            <div class="mini">Janela: ${labelJanela()}</div>
          </div>

          <div class="balls">${balls}</div>

          <div class="sep"></div>
          ${motivosHtml || "‚Äî"}
        </div>
      `;
    }

    updateCheckButtons();
  }catch(err){
    console.error(err);
    if(area) area.innerHTML = `<div class="box"><b>‚ö†Ô∏è</b><div class="mini" style="margin-top:8px">Erro ao gerar Invertida.</div></div>`;
  }
}

async function gerarTecnicaPremiada(silent=false){
  if(!access.premium){
    if(!silent) alert("üîí T√©cnica exige Premium.");
    return;
  }

  const area = document.getElementById("tecnicaArea");

  try{
    const qtd = qtdSelecionada();
    await prepararContextoBase(qtd);

    const payload = lastPayload;

    window._p15ExplainCtx = buildP15ExplainCtx(payload);
    const pack = buildPack4JogosPreditivo(payload);
    lastPredPack = pack;

    const t1ok = pack && pack.ok===true && Array.isArray(pack.tecnica1) && pack.tecnica1.length===15;
    const t2ok = pack && pack.ok===true && Array.isArray(pack.tecnica2) && pack.tecnica2.length===15;

    if(!t1ok || !t2ok){
      if(area) area.innerHTML = `<div class="box"><b>‚ö†Ô∏è</b><div class="mini" style="margin-top:8px">N√£o foi poss√≠vel montar a T√©cnica (2 jogos de 15 dezenas). ${(pack&&pack.err)?pack.err:""}</div></div>`;
      return;
    }

    const __scopeKey = __diversifyScopeKey("PACK4", qtd, payload);
    const __permUser = __getUserPerm(__scopeKey);

    const t1 = __applyPermNums(pack.tecnica1, __permUser);
    const t2 = __applyPermNums(pack.tecnica2, __permUser);
    lastTecnicaGames = { g1: t1.slice(), g2: t2.slice() };

    function renderCard(title, nums, motivos){
      const balls = nums.map(n=>`<div class="ball">${format2(n)}</div>`).join("");
      const motivosAgrupados = {};
      (motivos||[]).forEach(m=>{
        const key = (m.texto||"").trim();
        if(!motivosAgrupados[key]) motivosAgrupados[key]=[];
        if(Number.isFinite(Number(m.dezena))) motivosAgrupados[key].push(Number(m.dezena));
      });
      const motivosHtml = `
  <div class="eliteMotives">
    <div class="eliteMotivesHdr">
      <b>üß† Explica√ß√£o comportamental</b>
      <span>Padr√£o fixo ‚Ä¢ Sistema Preditivo</span>
    </div>
    <div class="eliteMotivesGrid">
      ${
        Object.entries(motivosAgrupados)
          .map(([texto, dezenas])=>{
            const ordenadas = (dezenas||[]).slice().sort((x,y)=>x-y);
            const numsHtml = ordenadas.map(n=>`<div class="eliteMotivesNum">${format2(n)}</div>`).join("");
            return `
              <div class="eliteMotivesRow">
                <div class="eliteMotivesTag">${texto}</div>
                <div class="eliteMotivesNums">
                  ${numsHtml}
                </div>
              </div>
            `;
          }).join("")
      }
    </div>
  </div>
`;

      return `
        <div class="box" style="margin-bottom:12px">
          <div class="titleRow">
            <div class="title">${title}</div>
            <div class="mini">Janela: ${labelJanela()}</div>
          </div>
          <div class="balls">${balls}</div>
          <div class="sep"></div>
          ${motivosHtml || "‚Äî"}
        </div>
      `;
    }

    const html = `
      ${renderCard("üèÜ T√©cnica 1 gerada (15 dezenas)", t1, __applyPermMotivos((pack?.motivos?.tecnica1 || []), __permUser))}
      ${renderCard("üèÜ T√©cnica 2 gerada (15 dezenas)", t2, __applyPermMotivos((pack?.motivos?.tecnica2 || []), __permUser))}
    `;

    if(area) area.innerHTML = html;

    updateCheckButtons();
  }catch(err){
    console.error(err);
    if(area) area.innerHTML = `<div class="box"><b>‚ö†Ô∏è</b><div class="mini" style="margin-top:8px">Erro ao gerar T√©cnica.</div></div>`;
  }
}

function updateCheckButtons(){
  const ready = !!(lastPrincipalGame && lastInvertidaGame && lastTecnicaGames && lastTecnicaGames.g1 && lastTecnicaGames.g2);

  const btnTop = document.getElementById("btnVerificarGeradosFromPrincipal");
  const btnInline = document.getElementById("btnVerificarGeradosInline");

  if(btnTop) btnTop.style.display = ready ? "inline-flex" : "none";
  if(btnInline) btnInline.style.display = ready ? "inline-flex" : "none";

  const panel = document.getElementById("panelGerados");
  if(panel){
    panel.querySelector(".mini").innerHTML = ready
      ? `Pronto ‚úÖ Agora voc√™ pode conferir automaticamente os <b>4 jogos gerados</b> (Principal, Invertida, T√©cnica 1 e T√©cnica 2) com base no resultado do concurso.`
      : `Gere tamb√©m a <b>Invertida</b> e a <b>T√©cnica</b> para liberar a verifica√ß√£o autom√°tica de acertos.`;
  }

  if(ready){
    montarTelaCheck();
  }
}

async function conferirGerados(){
  if(!(lastPrincipalGame && lastInvertidaGame && lastTecnicaGames && lastTecnicaGames.g1 && lastTecnicaGames.g2)){
    alert("Gere Principal + Invertida + T√©cnica primeiro.");
    return;
  }

  let res;
  try{
    res = await fetchUltimoResultado();
  }catch(e){
    alert("Falha ao buscar o √∫ltimo resultado.");
    return;
  }
  const resultNums = (res.dezenas||[]).map(toNum);

  function hits(gameNums){
    const setR=new Set(resultNums);
    const h = sortNum(gameNums.filter(n=>setR.has(Number(n))).map(Number));
    return {count:h.length, hits:h};
  }

  const hP = hits(lastPrincipalGame);
  const hI = hits(lastInvertidaGame);
  const hT1 = hits(lastTecnicaGames.g1);
  const hT2 = hits(lastTecnicaGames.g2);

  document.getElementById("checkArea").innerHTML = `
    <div class="box">
      <b>üìå Resultado usado para confer√™ncia</b>
      <div class="mini" style="margin-top:8px">
        Concurso <b>${res.concurso}</b> ‚Ä¢ Data: <b>${res.data || "‚Äî"}</b> ‚Ä¢ Dezenas:
        <span class="mono">${resultNums.map(format2).join(" - ")}</span>
      </div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div class="box">
        <b>üéØ Principal ‚Ä¢ Acertos: ${hP.count}</b>
        <div class="mini" style="margin-top:8px">Acertou: <b>${hP.hits.map(format2).join(", ") || "‚Äî"}</b></div>
        <div class="numbers" style="justify-content:flex-start;margin-top:10px">${lastPrincipalGame.map(n=>`<div class="ball">${format2(n)}</div>`).join("")}</div>
      </div>

      <div class="box">
        <b>üîÑ Invertida ‚Ä¢ Acertos: ${hI.count}</b>
        <div class="mini" style="margin-top:8px">Acertou: <b>${hI.hits.map(format2).join(", ") || "‚Äî"}</b></div>
        <div class="numbers" style="justify-content:flex-start;margin-top:10px">${lastInvertidaGame.map(n=>`<div class="ball">${format2(n)}</div>`).join("")}</div>
      </div>

      <div class="box">
        <b>üèÜ T√©cnica 1 ‚Ä¢ Acertos: ${hT1.count}</b>
        <div class="mini" style="margin-top:8px">Acertou: <b>${hT1.hits.map(format2).join(", ") || "‚Äî"}</b></div>
        <div class="numbers" style="justify-content:flex-start;margin-top:10px">${lastTecnicaGames.g1.map(n=>`<div class="ball">${format2(n)}</div>`).join("")}</div>
      </div>

      <div class="box">
        <b>üèÜ T√©cnica 2 ‚Ä¢ Acertos: ${hT2.count}</b>
        <div class="mini" style="margin-top:8px">Acertou: <b>${hT2.hits.map(format2).join(", ") || "‚Äî"}</b></div>
        <div class="numbers" style="justify-content:flex-start;margin-top:10px">${lastTecnicaGames.g2.map(n=>`<div class="ball">${format2(n)}</div>`).join("")}</div>
      </div>
    </div>

    <div class="tinyFoot">Fonte: ${res.source || "‚Äî"} ‚Ä¢ Modo: ${String(res.mode||"‚Äî").toUpperCase()}</div>
  `;
}

function montarTelaCheck(){
  document.getElementById("checkArea").innerHTML = `
    <div class="box">
      <b>‚úÖ Seus 4 jogos gerados (base: Jogo Principal)</b>
      <div class="mini" style="margin-top:8px">
        Clique em <b>‚ÄúConferir com √∫ltimo concurso‚Äù</b> para ver quantos n√∫meros cada jogo acertou.
      </div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div class="box">
        <b>üéØ Principal</b>
        <div class="numbers" style="justify-content:flex-start;margin-top:10px">${lastPrincipalGame.map(n=>`<div class="ball">${format2(n)}</div>`).join("")}</div>
      </div>
      <div class="box">
        <b>üîÑ Invertida</b>
        <div class="numbers" style="justify-content:flex-start;margin-top:10px">${lastInvertidaGame.map(n=>`<div class="ball">${format2(n)}</div>`).join("")}</div>
      </div>
      <div class="box">
        <b>üèÜ T√©cnica 1</b>
        <div class="numbers" style="justify-content:flex-start;margin-top:10px">${lastTecnicaGames.g1.map(n=>`<div class="ball">${format2(n)}</div>`).join("")}</div>
      </div>
      <div class="box">
        <b>üèÜ T√©cnica 2</b>
        <div class="numbers" style="justify-content:flex-start;margin-top:10px">${lastTecnicaGames.g2.map(n=>`<div class="ball">${format2(n)}</div>`).join("")}</div>
      </div>
    </div>
  `;
}
</script>

<script>

function salvar15P(){
  if(!linesSystem15 || !Array.isArray(linesSystem15) || linesSystem15.length !== 5){
    alert("Gere o 15P primeiro.");
    return;
  }

  const data = {
    linesUser15,
    linesSystem15,
    activeLine15
  };
  saveLocal(SAVE_15P_KEY, data);

  const jogosSystem = gerarJogos15P(linesSystem15);

  const jogosUser = (typeof allLinesComplete === "function" && allLinesComplete(linesUser15))
    ? gerarJogos15P(linesUser15)
    : null;

  salvarJogoNoStorage({
    slot: "15 pontos garantidos",
    tipo: "15p",
    nome: "15 pontos garantidos",
    at: Date.now(),
    payload: {
      linesSystem15,
      linesUser15,
      jogosSystem,
      jogosUser
    }
  });

  alert("‚úÖ 15P salvo em JOGOS SALVOS: 15 pontos garantidos (sobrescreve ao salvar de novo)");
}

function carregar15P(){
  const saved = loadLocal(SAVE_15P_KEY);
  if(!saved?.data){
    alert("N√£o existe 15P salvo ainda.");
    return;
  }
  const d = saved.data;

  linesUser15 = (d.linesUser15 || null);
  linesSystem15 = (d.linesSystem15 || null);
  activeLine15 = (typeof d.activeLine15 === "number") ? d.activeLine15 : 4;

  if(document.getElementById("editor15Area")){
    render15Editor();
  }
  alert("‚úÖ 15P carregado! Salvo em: " + timeBR(saved.at));
}
function calcCoocAndStats(concursos){
  const n = concursos.length;
  const freq = Array(26).fill(0);
  const co = Array.from({length:26}, ()=>Array(26).fill(0));

  const decay = Array(26).fill(0);
  const lastSeen = Array(26).fill(-1);
  const DECAY = 0.92;

  concursos.forEach((c,idx)=>{
    const nums = (c.dezenas||[])
      .map(d=>Number(String(d).replace(/^0+/,"")))
      .filter(x=>x>=1 && x<=25);
    const w = Math.pow(DECAY, (n-1-idx));

    nums.forEach(a=>{
      freq[a]++; decay[a]+=w; lastSeen[a]=idx;
    });

    for(let i=0;i<nums.length;i++){
      for(let j=i+1;j<nums.length;j++){
        const a=nums[i], b=nums[j];
        co[a][b]++; co[b][a]++;
      }
    }
  });

  const p = Array(26).fill(0);
  for(let i=1;i<=25;i++) p[i] = freq[i] / Math.max(1,n);

  const gap = Array(26).fill(999);
  for(let i=1;i<=25;i++){
    gap[i] = (lastSeen[i]===-1) ? n : (n-1-lastSeen[i]);
  }

  const lift = Array.from({length:26}, ()=>Array(26).fill(0));
  for(let a=1;a<=25;a++){
    for(let b=1;b<=25;b++){
      if(a===b) continue;
      const pab = co[a][b] / Math.max(1,n);
      const denom = (p[a] * p[b]);
      lift[a][b] = denom>0 ? (pab/denom) : 0;
    }
  }
  return { n, freq, co, p, lift, decay, gap };
}

function pairStrength(a,b, stats){
  const {co, lift, decay} = stats;
  const base = (co[a][b] * 1.0) + (lift[a][b] * 2.2);
  const rec = (decay[a] + decay[b]) * 0.55;
  return base + rec;
}

function groupStrength(group, stats){
  let sum=0, pairs=0;
  for(let i=0;i<group.length;i++){
    for(let j=i+1;j<group.length;j++){
      sum += pairStrength(group[i], group[j], stats);
      pairs++;
    }
  }
  return { sum, avg: pairs? (sum/pairs):0 };
}

function groupCoSum(group, stats){
  const {co} = stats;
  let sum=0, pairs=0;
  for(let i=0;i<group.length;i++){
    for(let j=i+1;j<group.length;j++){
      sum += co[group[i]][group[j]];
      pairs++;
    }
  }
  return { sum, avg: pairs? (sum/pairs):0 };
}

function groupLiftAvg(group, stats){
  const {lift} = stats;
  let sum=0, pairs=0;
  for(let i=0;i<group.length;i++){
    for(let j=i+1;j<group.length;j++){
      sum += lift[group[i]][group[j]];
      pairs++;
    }
  }
  return { sum, avg: pairs? (sum/pairs):0 };
}

function groupFreqSum(group, stats){
  const {freq} = stats;
  return group.reduce((a,n)=>a+freq[n],0);
}

function topPairsInGroup(group, stats, topN=3){
  const arr=[];
  for(let i=0;i<group.length;i++){
    for(let j=i+1;j<group.length;j++){
      const a=group[i], b=group[j];
      arr.push({ a,b, co: stats.co[a][b], lift: stats.lift[a][b], score: pairStrength(a,b,stats) });
    }
  }
  arr.sort((x,y)=>y.score-x.score);
  return arr.slice(0, topN);
}
function worstPairsInGroup(group, stats, topN=3){
  const arr=[];
  for(let i=0;i<group.length;i++){
    for(let j=i+1;j<group.length;j++){
      const a=group[i], b=group[j];
      arr.push({ a,b, co: stats.co[a][b], lift: stats.lift[a][b], score: pairStrength(a,b,stats) });
    }
  }
  arr.sort((x,y)=>x.score-y.score);
  return arr.slice(0, topN);
}

function objective(lines, stats){
  const scoredLines = lines.map(l=>{
    const st = groupStrength(l, stats).sum;
    const pares = l.filter(n=>n%2===0).length;
    const imp = 5 - pares;
    const blocos = distribuicaoBlocos(l);
    const maxBlock = Math.max(blocos.A,blocos.B,blocos.C,blocos.D,blocos.E);

    const fvals = l.map(n=>stats.freq[n]).sort((a,b)=>a-b);
    const spread = (fvals[4]-fvals[0]);

    let penalty=0;
    if(!(pares===2 || pares===3)) penalty += 6;

    if(maxBlock>=4) penalty += (maxBlock-3)*10;

    if(spread<=1) penalty += 6;

    return { st, penalty };
  });

  const sorted = scoredLines.slice().sort((a,b)=> (b.st-b.penalty) - (a.st-a.penalty));
  const strong = sorted.slice(0,3).reduce((a,x)=>a+(x.st - x.penalty),0);
  const diverse = sorted.slice(3).reduce((a,x)=>a+(x.st - x.penalty),0);

  return (strong * 1.0) + (diverse * 0.55);
}

function mixPairStrength(a,b, sShort, sMed, wShort, wMed){
  const ps = pairStrength(a,b, sShort);
  const pm = (sMed ? pairStrength(a,b, sMed) : ps);
  return (ps*wShort) + (pm*wMed);
}

function mixGroupStrength(group, sShort, sMed, wShort=0.7, wMed=0.3){
  let sum=0, pairs=0;
  for(let i=0;i<group.length;i++){
    for(let j=i+1;j<group.length;j++){
      sum += mixPairStrength(group[i], group[j], sShort, sMed, wShort, wMed);
      pairs++;
    }
  }
  return { sum, avg: pairs? sum/pairs : 0 };
}

function parityPenalty(line){
  const pares = line.filter(n=>n%2===0).length;
  return (pares===2 || pares===3) ? 0 : 6;
}

function blockPenalty(line){
  const b = distribuicaoBlocos(line);
  const maxBlock = Math.max(b.A,b.B,b.C,b.D,b.E);
  return (maxBlock>=4) ? (maxBlock-3)*10 : 0;
}

function colPenalty(line){
  const cols=[0,0,0,0,0];
  for(const n of line){
    const c = Math.min(4, Math.floor((n-1)/5));
    cols[c]++;
  }
  const maxCol = Math.max(...cols);
  return (maxCol>=4) ? (maxCol-3)*8 : 0;
}

function lineQualityScore(line, sShort, sMed){
  const st = mixGroupStrength(line, sShort, sMed).sum;
  const pen = parityPenalty(line) + blockPenalty(line) + colPenalty(line);
  return st - pen;
}

function isPrime(n){
  return [2,3,5,7,11,13,17,19,23].includes(n);
}

function rowOf(n){ return Math.floor((n-1)/5)+1; }   // 1..5
function colOf(n){ return ((n-1)%5)+1; }            // 1..5
function blockOf(n){
  if(n<=5) return "A";
  if(n<=10) return "B";
  if(n<=15) return "C";
  if(n<=20) return "D";
  return "E";
}

function countInSet(arr, set){
  let k=0; for(const x of arr) if(set.has(x)) k++;
  return k;
}

function buildLines15PFixedPattern(payloadShort, qtdShort){
  // ============================================================
  // ‚úÖ 15P ‚Ä¢ PADR√ïES FIXOS (TREINO ULTRA FINO) ‚Ä¢ AGRESSIVO FORTE
  // Objetivo: N√ÉO "espelhar" o passado. Detectar CONVERG√äNCIA LATENTE
  // (pr√©-encontro) para tentar capturar 14/15 quando o ciclo encaixa.
  //
  // Regras:
  // - Gera√ß√£o sempre com os √öLTIMOS 4 concursos (igual ELITE)
  // - 5 linhas de 5 dezenas (25 √∫nicas)
  // - 3 linhas IN = converg√™ncia latente (sair)
  // - 2 linhas OUT = diverg√™ncia/anti-converg√™ncia (n√£o sair)
  // - Determin√≠stico (sem aleat√≥rio)
  // ============================================================

  // ---------- Treino fixo (base estat√≠stica) ----------
  // Inclui 3574‚Äì3577 como "pr√©-janela" para treinar o caso 3578.
  const TRAIN_SERIES = [
    {c:3574, d:[1,3,4,5,6,8,12,13,15,16,17,18,20,21,25]},
    {c:3575, d:[2,4,5,7,8,9,10,12,13,14,15,17,21,22,25]},
    {c:3576, d:[1,2,3,5,7,8,10,13,16,18,19,21,22,23,25]},
    {c:3577, d:[1,2,4,5,6,8,9,10,12,16,18,20,23,24,25]},
    {c:3578, d:[2,3,4,5,6,7,9,10,14,17,19,20,22,23,24]},
    {c:3579, d:[1,2,3,4,8,10,11,13,15,17,19,20,21,23,25]},
    {c:3580, d:[1,4,5,6,8,9,12,13,15,16,19,20,21,23,25]},
    {c:3581, d:[2,3,4,5,6,7,8,10,12,15,16,17,20,22,24]},
    {c:3582, d:[2,5,6,7,8,9,10,11,12,13,16,18,23,24,25]},
    {c:3583, d:[2,3,4,6,9,10,12,13,14,15,21,22,23,24,25]},
    {c:3584, d:[1,2,4,7,8,9,13,15,16,17,18,20,21,23,25]},
    {c:3585, d:[1,2,4,8,9,10,13,16,17,19,20,21,22,23,25]},
    {c:3586, d:[1,2,6,10,11,12,13,14,15,17,18,21,22,24,25]},
    {c:3587, d:[1,2,4,8,9,10,11,12,13,16,17,18,19,20,22]},
    {c:3588, d:[3,5,7,8,9,11,14,15,16,17,19,21,22,23,24]},
    {c:3589, d:[1,2,3,4,8,10,11,12,15,18,19,21,22,24,25]},
    {c:3590, d:[4,6,8,10,11,12,13,15,16,17,19,20,21,22,23]},
    {c:3591, d:[1,2,3,4,6,7,10,11,13,14,15,17,18,19,20]},
    {c:3592, d:[1,4,5,6,7,9,12,13,17,18,20,21,22,23,25]},
    {c:3593, d:[1,3,4,6,7,8,9,10,12,15,18,19,23,24,25]},
    {c:3594, d:[1,2,4,5,7,8,9,11,14,15,18,20,21,23,24]},
    {c:3595, d:[1,2,4,5,6,8,10,12,13,15,16,20,21,22,25]},
    {c:3596, d:[1,2,3,4,5,6,7,8,14,15,16,18,20,21,22]},
    {c:3597, d:[1,4,5,7,10,11,13,14,15,16,19,20,21,23,25]},
    {c:3598, d:[1,3,4,5,6,7,8,9,11,16,18,21,22,23,24]},
    {c:3599, d:[1,4,6,7,8,9,11,12,13,16,19,20,21,23,24]},
    {c:3600, d:[3,4,5,6,7,8,9,11,12,16,17,20,21,22,25]},
    {c:3601, d:[2,3,4,6,7,8,9,11,16,17,20,21,23,24,25]},
    {c:3602, d:[1,2,3,4,5,6,8,9,15,18,19,20,22,23,24]},
    {c:3603, d:[2,4,5,9,10,11,12,14,15,17,19,20,21,22,24]},
    {c:3604, d:[1,2,3,6,7,8,11,13,15,16,19,21,22,23,24]},
    {c:3605, d:[1,3,4,7,10,12,13,14,19,20,21,22,23,24,25]},
    {c:3606, d:[2,3,6,7,9,11,12,14,15,17,19,20,21,23,24]},
    {c:3607, d:[1,2,4,5,6,8,9,13,14,15,16,18,19,20,23]},
    {c:3608, d:[2,5,6,8,9,11,14,16,17,18,19,20,22,23,25]},
    {c:3609, d:[2,5,6,8,9,10,11,12,13,17,19,20,22,24,25]},
    {c:3610, d:[1,3,5,7,8,10,13,14,17,20,21,22,23,24,25]},
    {c:3611, d:[1,2,3,4,5,6,10,11,12,14,15,17,18,19,25]},
    {c:3612, d:[4,6,8,9,11,14,15,16,17,18,19,20,21,22,25]},
    {c:3613, d:[1,3,4,7,9,10,11,12,15,16,18,20,21,22,23]},
    {c:3614, d:[2,4,5,6,9,10,11,12,14,15,16,17,20,23,25]}
  ];

  // ---------- Calibra√ß√£o do "vem do nada" (comeback) ----------
  // comebackScore[n] alto => quando n estava AUSENTE nos 4 anteriores, mesmo assim costuma entrar no alvo.
  const comebackScore = Array(26).fill(0);
  const absentCt = Array(26).fill(0);
  const comebackCt = Array(26).fill(0);

  const byIndex = TRAIN_SERIES.slice().sort((a,b)=>a.c-b.c);
  const idxMap = new Map(byIndex.map((o,i)=>[o.c,i]));

  for(let i=0;i<byIndex.length;i++){
    const target = byIndex[i];
    if(target.c < 3578) continue;
    const prev = byIndex.slice(Math.max(0,i-4), i);
    if(prev.length !== 4) continue;

    const prevUnion = new Set();
    prev.forEach(p=>p.d.forEach(n=>prevUnion.add(n)));
    const targetSet = new Set(target.d);

    for(let n=1;n<=25;n++){
      if(!prevUnion.has(n)){
        absentCt[n] += 1;
        if(targetSet.has(n)) comebackCt[n] += 1;
      }
    }
  }
  for(let n=1;n<=25;n++){
    comebackScore[n] = absentCt[n] ? (comebackCt[n] / absentCt[n]) : 0;
  }

  // ---------- √öltimos 4 concursos (motor ao vivo) ----------
  const concursos = (payloadShort?.concursos || [])
    .slice()
    .map(c=>({ ...c, dezenas: getDezenas(c) }))
    .sort((a,b)=>a.concurso-b.concurso);

  const last4 = concursos.slice(-4);
  const sets4 = last4.map(c=> new Set((c.dezenas||[]).map(toNum)));

  const lastDrawSet = sets4[3] || new Set();
  const allNums = Array.from({length:25},(_,i)=>i+1);

  // Presen√ßa por dezena nos 4 (vector + freq)
  const pres = {};
  for(const n of allNums){
    const vec = sets4.map(s=> s.has(n) ? 1 : 0);
    const freq = vec.reduce((a,b)=>a+b,0);
    pres[n] = { vec, freq, inLast: lastDrawSet.has(n) ? 1 : 0 };
  }

  // coocorr√™ncia de par nos 4 (0..4)
  function pairCooc(a,b){
    let ct=0;
    for(const s of sets4) if(s.has(a) && s.has(b)) ct++;
    return ct;
  }

  function blockOfLocal(n){ return blockOf(n); } // usa a mesma do sistema

  // ---------- Scoring (converg√™ncia latente agressiva) ----------
  // Ideia: premiar cobertura distribu√≠da + microblocos (pares 1x/2x) + 1 "gatilho" comeback por linha
  function scoreAddToLine(n, line, drawCounts, usedInLineFromLast){
    const p = pres[n];
    const isComeback = (p.freq===0);

    // trava: n√£o espelhar passado (limite de dezenas do √∫ltimo concurso por linha IN)
    if(line.__type === "IN" && p.inLast && usedInLineFromLast >= 2) return -99999;

    // trava: por linha, no m√°ximo 2 dezenas do mesmo concurso nos 4 anteriores
    // (for√ßa a distribui√ß√£o e evita "copiar um sorteio")
    for(let di=0; di<4; di++){
      if(p.vec[di] && (drawCounts[di]||0) >= 2) return -99999;
    }

    // cobertura: quanto mais concursos diferentes dentro da linha, melhor
    let covBefore = 0, covAfter = 0;
    for(let di=0; di<4; di++){
      if((drawCounts[di]||0) > 0) covBefore++;
      if((drawCounts[di]||0) + (p.vec[di] ? 1 : 0) > 0) covAfter++;
    }
    const coverageGain = (covAfter - covBefore);

    // microblocos: pares que aparecem 1x/2x contam; 3x/4x penaliza (espelho)
    let micro = 0;
    for(const m of (line.nums||[])){
      const co = pairCooc(n, m);
      if(co===1) micro += 2;
      else if(co===2) micro += 1;
      else if(co>=3) micro -= 3;
    }

    // estrutura: penaliza concentra√ß√£o de bloco
    const blk = blockOfLocal(n);
    const blkCount = (line.blocks?.[blk]||0);
    let struct = 0;
    if(blkCount >= 2) struct -= 2; // evita 3+ no mesmo bloco
    else if(blkCount === 0) struct += 1; // incentiva variedade

    // "gatilho do nada": se n√£o apareceu nos 4, usa comebackScore forte
    let comeback = 0;
    if(isComeback){
      // agressivo forte: valoriza muito "entrada do nada"
      comeback = 8 * comebackScore[n];
    }

    // rec√™ncia leve (n√£o dominar): se apareceu no √∫ltimo concurso, +0.5 (mas j√° travado por limite)
    let rec = 0;
    if(p.inLast && line.__type==="IN") rec += 0.5;

    // total incremental
    return (coverageGain*3) + micro + struct + comeback + rec;
  }

  function initLine(type){
    return { __type:type, nums:[], blocks:{A:0,B:0,C:0,D:0,E:0} };
  }

  function addNumToLine(n, line, drawCounts){
    line.nums.push(n);
    const b = blockOfLocal(n);
    line.blocks[b] = (line.blocks[b]||0) + 1;
    for(let di=0; di<4; di++){
      if(pres[n].vec[di]) drawCounts[di] = (drawCounts[di]||0) + 1;
    }
  }

  function buildINLine(available, forcedComeback){
    const line = initLine("IN");
    const drawCounts = [0,0,0,0];
    let usedFromLast = 0;
    let usedComeback = 0;

    for(let step=0; step<5; step++){
      let best = null;
      for(const n of available){
        const p = pres[n];
        const isComeback = (p.freq===0);

        // regra agressiva: 1 (e somente 1) comeback por linha IN, quando poss√≠vel
        if(forcedComeback && step===2){ // injeta no meio para n√£o virar bloco
          if(!isComeback) continue;
        }else{
          if(isComeback && usedComeback>=1) continue;
        }

        const sc = scoreAddToLine(n, line, drawCounts, usedFromLast);
        if(sc <= -9999) continue;

        // tie-break determin√≠stico: score desc, depois dezenas menores primeiro
        if(best===null || sc > best.sc || (sc===best.sc && n < best.n)){
          best = { n, sc, isComeback, inLast: p.inLast };
        }
      }

      // fallback interno (determin√≠stico): se n√£o achou com regra do forcedComeback, relaxa forcedComeback naquele passo
      if(best===null && forcedComeback && step===2){
        for(const n of available){
          const p = pres[n];
          const isComeback = (p.freq===0);
          if(isComeback && usedComeback>=1) continue;
          const sc = scoreAddToLine(n, line, drawCounts, usedFromLast);
          if(sc <= -9999) continue;
          if(best===null || sc > best.sc || (sc===best.sc && n < best.n)){
            best = { n, sc, isComeback, inLast: p.inLast };
          }
        }
      }

      if(best===null){
        // √∫ltimo recurso: pega o menor n√∫mero dispon√≠vel (n√£o quebra determinismo)
        const n = available.slice().sort((a,b)=>a-b)[0];
        best = { n, sc:0, isComeback:(pres[n].freq===0), inLast:pres[n].inLast };
      }

      addNumToLine(best.n, line, drawCounts);
      if(best.inLast) usedFromLast++;
      if(best.isComeback) usedComeback++;

      // remove do pool
      available.delete(best.n);
    }

    line.nums.sort((a,b)=>a-b);
    return line;
  }

  // ---------- Constru√ß√£o das linhas ----------
  const available = new Set(allNums);

  // IN1: √¢ncora latente (sem for√ßar comeback)
  const in1 = buildINLine(available, false);

  // IN2: transi√ß√£o (for√ßa 1 comeback se existir)
  const in2 = buildINLine(available, true);

  // IN3: refor√ßo (sem for√ßar, mas aceita 1 comeback se aparecer como melhor)
  const in3 = buildINLine(available, false);

  // OUT: anti-converg√™ncia (menos chance de convergir no pr√≥ximo)
  const remaining = Array.from(available).sort((a,b)=>a-b);

  function outScore(n){
    const p = pres[n];
    // se apareceu muito nos 4, n√£o √© bom OUT
    let s = 0;
    if(p.freq===0) s += (1 - comebackScore[n]) * 6; // quanto menor comeback, mais OUT
    if(p.freq===1) s += 2;
    if(p.freq>=2) s -= 2*p.freq;

    // penaliza se est√° no √∫ltimo concurso (tende a repetir)
    if(p.inLast) s -= 1;

    // evita OUT com microblocos fortes (co>=2 com outros restantes ser√° tratado na divis√£o)
    return s;
  }

  const remainingRanked = remaining
    .slice()
    .sort((a,b)=>{
      const sa = outScore(a), sb = outScore(b);
      if(sb!==sa) return sb-sa;
      return a-b;
    });

  const out1 = remainingRanked.slice(0,5).sort((a,b)=>a-b);
  const out2 = remainingRanked.slice(5,10).sort((a,b)=>a-b);

  // Linhas finais no padr√£o do m√≥dulo (IN/OUT alternado para manter compatibilidade visual)
  // Mant√©m IN nas posi√ß√µes 0,2,4 como no seu layout atual.
  const lines = [
    in1.nums.slice(),
    out1.slice(),
    in2.nums.slice(),
    out2.slice(),
    in3.nums.slice()
  ];

  // ---------- Mapa de letras (mant√©m padr√£o do sistema) ----------
  const lettersIN = "ABCDEFGHIJKLMNO".split("");
  const lettersOUT = "PQRSTUVWXY".split(""); // 10 letras
  const map = [];
  let idx=0;
  for(const l of [lines[0],lines[2],lines[4]]){
    for(const n of l){
      map.push({letter: lettersIN[idx], num:n, kind:"IN"});
      idx++;
    }
  }
  idx=0;
  for(const l of [lines[1],lines[3]]){
    for(const n of l){
      map.push({letter: lettersOUT[idx], num:n, kind:"OUT"});
      idx++;
    }
  }

  return { lines, map, mode:"15P_LATENTE_AGRESSIVO_FORTE" };
}

function gerarJogos15P(linhas){

  if(!Array.isArray(linhas) || linhas.length !== 5){
    return [];
  }

  const jogos = [];

  const combinacoes = [
    [0,1,2],
    [0,1,3],
    [0,1,4],
    [0,2,3],
    [0,2,4],
    [0,3,4],
    [1,2,3],
    [1,2,4],
    [1,3,4],
    [2,3,4]
  ];

  combinacoes.forEach(combo=>{
    const set = new Set();
    combo.forEach(idx=>{
      linhas[idx].forEach(n=>set.add(Number(n)));
    });
    jogos.push([...set].sort((a,b)=>a-b));
  });

  return jogos;
}

function renderBallsInline(nums){
  return nums.map(n=>`<div class="ball">${format2(n)}</div>`).join("");
}

function countGroupTogether(group, concursos){
  const gset = new Set(group.map(Number));
  let count = 0;
  for(const c of concursos){
    const setC = new Set((c.dezenas||[]).map(toNum));
    let ok = true;
    for(const n of gset){
      if(!setC.has(n)){ ok = false; break; }
    }
    if(ok) count++;
  }
  return count;
}

function bestSubgroupTogether(line, k, concursos){
  const arr = line.slice().map(Number).sort((a,b)=>a-b);

  const comb = [];
  function backtrack(start, pick){
    if(pick.length === k){ comb.push(pick.slice()); return; }
    for(let i=start;i<arr.length;i++){
      pick.push(arr[i]);
      backtrack(i+1, pick);
      pick.pop();
    }
  }
  backtrack(0, []);

  let best = { group:null, count:-1 };
  for(const g of comb){
    const ct = countGroupTogether(g, concursos);
    if(ct > best.count){
      best = { group:g, count:ct };
    }
  }
  return best;
}

function initUserLines15FromSystem(lines){
  linesSystem15 = lines.map(l=>l.slice());
  linesUser15 = lines.map(l=>l.slice());
  linesUser15[4] = [];   // ‚úÖ Linha 5 em branco
  activeLine15 = 4;
}

function setActiveLine15(i){ activeLine15=i; render15Editor(); }

function usedNumbersExceptLine(lineIdx){
  const used = new Set();
  for(let i=0;i<5;i++){
    if(i===lineIdx) continue;
    (linesUser15?.[i]||[]).forEach(n=>used.add(n));
  }
  return used;
}

function render15Editor(){
  const root = document.getElementById("editor15Area");
  if(!root || !linesUser15) return;

  const lineBtns = [1,2,3,4,5].map(i=>{
    return `<button class="lineBtn ${activeLine15===i-1?"on":""}" type="button" onclick="setActiveLine15(${i-1})">Linha ${i}</button>`;
  }).join("");

  const current = linesUser15[activeLine15] || [];
  const used = usedNumbersExceptLine(activeLine15);

  root.innerHTML = `
    <div class="box" style="margin-top:12px">
      <b>üß© Monte suas linhas (15P) ‚Äî manual</b>
      <div class="mini" style="margin-top:6px">
        Selecione uma linha e complete com <b>5 dezenas</b>. N√£o permitimos repeti√ß√£o entre linhas (mant√©m a l√≥gica dos 10 jogos).
      </div>

      <div class="lineTabs">${lineBtns}</div>

      <div class="mini" style="margin-top:10px"><b>Linha ${activeLine15+1}:</b></div>
      <div class="slotRow">
        ${[0,1,2,3,4].map(i=>`<div class="slot">${current[i] ? format2(current[i]) : "‚Äî"}</div>`).join("")}
      </div>

      <div class="pickGrid" id="pickGrid15">
        ${[...Array(25)].map((_,i)=>{
          const n=i+1;
          const sel = current.includes(n) ? " sel" : "";
          const lock = used.has(n) ? " lock" : "";
          return `<div class="pickCell${sel}${lock}" data-n="${n}">${format2(n)}</div>`;
        }).join("")}
      </div>

      <div class="row" style="margin-top:12px">
        <div class="col">
          <button class="btn btnGhost" type="button" onclick="linesUser15[activeLine15]=[];render15Editor()">Limpar linha</button>
        </div>
        <div class="col">
          <button class="btn btnPrimary" type="button" onclick="gerar15PComMinhasLinhas()">Gerar 10 jogos (minhas linhas)</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="col">
          <button class="btn btnGhost" type="button" onclick="initUserLines15FromSystem(linesSystem15);render15Editor();document.getElementById('user15Output').innerHTML=''">Resetar para linhas do sistema</button>
        </div>
        <div class="col">
          <button class="btn btnGhost" type="button" onclick="goView('view15p')">Ok</button>
        </div>
      </div>

      <div class="mini" style="margin-top:10px">
        Dica PRIME: em cada linha, tente manter <b>2/3 pares</b>, mix de frequ√™ncia e evitar 4+ no mesmo bloco.
      </div>
    </div>
  `;

  bindPickGrid("pickGrid15", (n)=>{
    if(used.has(n)) return;
    const line = linesUser15[activeLine15];
    const idx = line.indexOf(n);
    if(idx>=0) line.splice(idx,1);
    else{
      if(line.length>=5) return alert("Essa linha j√° tem 5 dezenas.");
      line.push(n); line.sort((a,b)=>a-b);
    }
    render15Editor();
  });
}

function allLinesComplete(lines){
  return lines && lines.length===5 && lines.every(l=>Array.isArray(l) && l.length===5);
}

function gerar15PComMinhasLinhas(){
  if(!allLinesComplete(linesUser15)){
    return alert("Complete as 5 linhas com 5 dezenas cada.");
  }

  linesSystem15 = linesUser15.map(l=>l.slice());

  const jogos = gerarJogos15P(linesSystem15);

  const jogosHtml = jogos.map((j, idx)=>`
    <div class="box">
      <b>Jogo ${idx+1}</b>
      <div class="numbers" style="justify-content:flex-start;margin-top:10px">${renderBallsInline(j)}</div>
    </div>
  `).join("");

  const linesTable = linesSystem15.map((l,idx)=>`
    <tr>
      <td><b>${idx+1}</b></td>
      <td class="mono">${l.map(format2).join(" - ")}</td>
    </tr>
  `).join("");

  const userOut = document.getElementById("user15Output");
  if(userOut) userOut.innerHTML = "";

  const p15 = document.getElementById("p15Area") || document;
  const boxes = Array.from(p15.querySelectorAll(".box"));
  const systemGamesBox = boxes.find(b=>{
    const bb = b.querySelector("b");
    return bb && /10 jogos do sistema/i.test(bb.textContent || "");
  });

  const systemLinesBox = boxes.find(b=>{
    const bb = b.querySelector("b");
    return bb && /Linhas 1 a 5/i.test(bb.textContent || "");
  });

  const manualPackHTML = `
    <b>üéØ 10 jogos (MANUAL ‚Äî substituiu o autom√°tico)</b>
    <div class="mini" style="margin-top:10px">
      Voc√™ est√° usando suas <b>5 linhas manuais</b> como base. Este m√©todo cobre todas as combina√ß√µes de 3 linhas entre 5 (10 jogos).
      <b style="text-transform:uppercase">Acertando 3 linhas completas, voc√™ forma 1 dos 10 jogos.</b>
    </div>
    <div class="grid" style="margin-top:12px">${jogosHtml}</div>
  `;

  const manualLinesHTML = `
    <b>üìå Linhas 1 a 5 (MANUAIS ‚Äî ativas)</b>
    <div class="mini" style="margin-top:6px">
      Estas s√£o as linhas que voc√™ montou manualmente e que foram usadas para gerar os 10 jogos abaixo.
    </div>
    <div style="margin-top:12px;overflow:auto">
      <table class="table">
        <thead><tr><th>Linha</th><th>Dezenas</th></tr></thead>
        <tbody>${linesTable}</tbody>
      </table>
    </div>
  `;

  if(systemGamesBox){
    systemGamesBox.innerHTML = manualPackHTML;
  }else{
    if(userOut){
      userOut.innerHTML = `
        <div class="box" style="margin-top:12px">${manualLinesHTML}</div>
        <div class="box" style="margin-top:12px">${manualPackHTML}</div>
      `;
    }
  }

  if(systemLinesBox){
    systemLinesBox.innerHTML = manualLinesHTML + `
      <div class="row" style="margin-top:10px">
        <div class="col">
          <button class="btn btnBlue" type="button" onclick="render15Editor()">‚úçÔ∏è Editar minhas linhas (manual)</button>
        </div>
        <div class="col">
          <button class="btn btnGhost" type="button" onclick="initUserLines15FromSystem(linesSystem15);render15Editor();">Continuar com estas linhas</button>
        </div>
      </div>
    `;
  }

  const explainBox = document.getElementById("p15ExplainBox");
  if(explainBox){
    explainBox.innerHTML = renderExplainBoxInner(linesSystem15);
  }

  alert("‚úÖ Manual substituiu o autom√°tico!");
}

function buildP15ExplainCtx(payload){
  try{
    const raw = (payload && Array.isArray(payload.concursos)) ? payload.concursos : [];

    const concursos = raw.map(c=>({
      dezenas: (c?.dezenas || c?.nums || c?.numeros || []).map(toNum).filter(n=>n>=1 && n<=25)
    }));

    const last = concursos.slice(-4);
    const toSet = (c)=> new Set((c?.dezenas||[]).map(toNum));
    const s1 = toSet(last[3] || last[last.length-1]); // √∫ltimo
    const s2 = toSet(last[2] || last[last.length-2]);
    const s3 = toSet(last[1] || last[last.length-3]);
    const s4 = toSet(last[0] || last[last.length-4]);

    const stats = calcCoocAndStats(concursos);

    return { s1, s2, s3, s4, concursos, stats, ok:true };
  }catch(e){
    return { ok:false, err:String(e?.message||e) };
  }
}
function classifyRG(ctx, n){
  const s1=ctx?.s1, s2=ctx?.s2, s3=ctx?.s3, s4=ctx?.s4;
  if(s1 && s1.has(n)) return "R";
  if(s2 && s2.has(n) && (!s1 || !s1.has(n))) return "G2";
  if(s3 && s3.has(n) && (!s2 || !s2.has(n)) && (!s1 || !s1.has(n))) return "G3";
  if(s4 && s4.has(n) && (!s3 || !s3.has(n)) && (!s2 || !s2.has(n)) && (!s1 || !s1.has(n))) return "G4";
  return "OUTROS";
}
function buildExplainRowsHTML(lines){
  const ctx = window._p15ExplainCtx;
  if(!ctx || !ctx.ok){
    return `<div class="mini" style="margin-top:8px">‚ö†Ô∏è N√£o foi poss√≠vel montar a explica√ß√£o (contexto insuficiente).</div>`;
  }
  const concursos = ctx.concursos || [];
  const stats = ctx.stats;

  const fmt1 = (v)=> (Number.isFinite(v)? v.toFixed(1) : "0.0");
  const fmt2d = (v)=> (Number.isFinite(v)? v.toFixed(2) : "0.00");

  function resumoReal(line){
    const base = line.slice().sort((a,b)=>a-b);
    const out = [];

    const c5 = countGroupTogetherInWindow(base, concursos);
    out.push(`5 juntas: <span class="mono">${base.map(format2).join("-")}</span> ‚Ä¢ <b>${c5}x</b>`);

    [4,3,2].forEach(k=>{
      const comb = combosK(base, k);
      const scored = comb.map(g=>({
        g,
        c: countGroupTogetherInWindow(g, concursos)
      })).sort((a,b)=> (b.c-a.c) || (a.g.join(",").localeCompare(b.g.join(","))));

      const top = scored.slice(0,2);
      top.forEach((x,idx)=>{
        out.push(`${k} juntas: <span class="mono">${x.g.map(format2).join("-")}</span> ‚Ä¢ <b>${x.c}x</b>`);
      });
    });

    return out.map(s=>`<div>${s}</div>`).join("");
  }

  function leastCommonPairs(line){
    if(!stats) return `<div class="mini">‚Äî</div>`;
    const g = line.slice().sort((a,b)=>a-b);
    const pairs = [];
    for(let i=0;i<g.length;i++){
      for(let j=i+1;j<g.length;j++){
        const a=g[i], b=g[j];
        const c = stats.co?.[a]?.[b] ?? 0;
        pairs.push({a,b,c});
      }
    }
    pairs.sort((x,y)=> (x.c-y.c) || (`${x.a}-${x.b}`.localeCompare(`${y.a}-${y.b}`)));
    return pairs.slice(0,3).map(p=>{
      return `<div>‚ö†Ô∏è <span class="mono">${format2(p.a)}-${format2(p.b)}</span> ‚Ä¢ sem sair juntas: <b>${p.c}x</b></div>`;
    }).join("");
  }

  function justificativa(idx, line){
    // idx √© 0-based: 0,1,2 = IN (converg√™ncia) | 3,4 = OUT (diverg√™ncia)
    if(idx<=2){
      return `Converg√™ncia (IN): linha montada a partir dos padr√µes treinados (3578‚Äì3614), priorizando dezenas que mostram sinais de \"andarem juntas\" quando comparamos os <b>√∫ltimos 4 concursos</b>. O objetivo √© capturar o bloco que tende a reaparecer em conjunto.`;
    }
    return `Diverg√™ncia (OUT): linha montada para reduzir coocorr√™ncia (tendem a \"n√£o vir juntas\"), funcionando como hedge estrutural. Isso aumenta a chance do cen√°rio \"2 linhas vazias\" acontecer e ainda assim voc√™ fechar 15 em um dos 10 jogos.`;
  }

  function metrics(line){
    if(!stats){
      return {forca:"0.0", lift:"0.00", co:"0.00", somaFreq:"0"};
    }
    const gs = groupStrength(line, stats);
    const gl = groupLiftAvg(line, stats);
    const gc = groupCoSum(line, stats);
    const sf = groupFreqSum(line, stats);

    return {
      forca: fmt1(gs.avg),
      lift: fmt2d(gl.avg),
      co: fmt2d(gc.avg),
      somaFreq: String(sf)
    };
  }

  return `<div class="p15CardsGrid">` + (lines||[]).map((line,idx)=>{
    const m = metrics(line||[]);
    const tag = (idx===4) ? "DIVERSA" : "PADR√ÉO";

    const bolas = (line||[]).slice().sort((a,b)=>a-b).map(n=>`<div class="p15-ball">${format2(n)}</div>`).join("");

    return `
      <div class="p15-card">
        <div class="p15-title">Linha ${idx+1} (${tag})</div>

        <div class="p15-metrics">
          <div class="p15-chip">For√ßa: ${m.forca}</div>
          <div class="p15-chip">Lift m√©dio: ${m.lift}</div>
          <div class="p15-chip">Co m√©dio: ${m.co}</div>
          <div class="p15-chip">Soma freq: ${m.somaFreq}</div>
        </div>

        <div class="p15-numbers">${bolas}</div>

        <div class="p15-section">
          <b>Por que se juntaram:</b> ${justificativa(idx,line||[])}
        </div>

        <div class="p15-section">
          ‚≠ê <b>Resumo real (juntas na janela):</b>
          <div style="margin-top:6px">${resumoReal(line||[])}</div>
          <div class="mini" style="margin-top:6px">As <b>5 juntas</b> √© raro, ent√£o olhe principalmente as melhores <b>4/3/2</b> que mais se repetem.</div>
        </div>

        <div class="p15-warning">
          <b>Combina√ß√µes menos comuns (2 dezenas):</b>
          <div style="margin-top:6px">${leastCommonPairs(line||[])}</div>
        </div>
      </div>
    `;
  }).join("") + `</div>`;
}

function renderExplainBoxInner(lines){
  return `
    <b>‚úÖ Explica√ß√£o por linha (padr√£o NOVO 15P)</b>
    <div class="mini" style="margin-top:8px">
      Mesmo <b>layout por linha</b> de antes (cards), por√©m com justificativas do <b>novo motor 15P</b>:
      <b>Linhas 1‚Äì3</b> = converg√™ncia (IN / ‚Äútendem a sair juntas‚Äù) ‚Ä¢ <b>Linhas 4‚Äì5</b> = diverg√™ncia (OUT / ‚Äútendem a n√£o sair juntas‚Äù).
    </div>
    ${buildExplainRowsHTML(lines||[])}
  `;
}

// =========================================================
// ‚úÖ NOVO MOTOR 15P (Padr√µes Fixos TREINADOS)
// - Treino (fixo): concursos 3578‚Äì3614 (lista interna)
// - Gera√ß√£o (fixo): SEMPRE √∫ltimos 4 concursos (sem escolha do usu√°rio)
// - Objetivo: 5 linhas de 5 dezenas (25 √∫nicas)
//     ‚Ä¢ 3 linhas "IN" (tendem a sair juntas)
//     ‚Ä¢ 2 linhas "OUT" (tendem a n√£o sair juntas)
// - Jogos: 10 combina√ß√µes (3 linhas entre 5)
// =========================================================

const __TRAIN_15P_DRAWS = [
  // 3614 .. 3578 (ordem n√£o importa para estat√≠stica)
  [2,4,5,6,9,10,11,12,14,15,16,17,20,23,25],
  [1,3,4,7,9,10,11,12,15,16,18,20,21,22,23],
  [4,6,8,9,11,14,15,16,17,18,19,20,21,22,25],
  [1,2,3,4,5,6,10,11,12,14,15,17,18,19,25],
  [1,3,5,7,8,10,13,14,17,20,21,22,23,24,25],
  [2,5,6,8,9,10,11,12,13,17,19,20,22,24,25],
  [2,5,6,8,9,11,14,16,17,18,19,20,22,23,25],
  [1,2,4,5,6,8,9,13,14,15,16,18,19,20,23],
  [2,3,6,7,9,11,12,14,15,17,19,20,21,23,24],
  [1,3,4,7,10,12,13,14,19,20,21,22,23,24,25],
  [1,2,3,6,7,8,11,13,15,16,19,21,22,23,24],
  [2,4,5,9,10,11,12,14,15,17,19,20,21,22,24],
  [1,2,3,4,5,6,8,9,15,18,19,20,22,23,24],
  [2,3,4,6,7,8,9,11,16,17,20,21,23,24,25],
  [3,4,5,6,7,8,9,11,12,16,17,20,21,22,25],
  [1,4,6,7,8,9,11,12,13,16,19,20,21,23,24],
  [1,3,4,5,6,7,8,9,11,16,18,21,22,23,24],
  [1,4,5,7,10,11,13,14,15,16,19,20,21,23,25],
  [1,2,3,4,5,6,7,8,14,15,16,18,20,21,22],
  [1,2,4,5,6,8,10,12,13,15,16,20,21,22,25],
  [1,2,4,5,7,8,9,11,14,15,18,20,21,23,24],
  [1,3,4,6,7,8,9,10,12,15,18,19,23,24,25],
  [1,4,5,6,7,9,12,13,17,18,20,21,22,23,25],
  [1,2,3,4,6,7,10,11,13,14,15,17,18,19,20],
  [4,6,8,10,11,12,13,15,16,17,19,20,21,22,23],
  [1,2,3,4,8,10,11,12,15,18,19,21,22,24,25],
  [3,5,7,8,9,11,14,15,16,17,19,21,22,23,24],
  [1,2,4,8,9,10,11,12,13,16,17,18,19,20,22],
  [1,2,6,10,11,12,13,14,15,17,18,21,22,24,25],
  [1,2,4,8,9,10,13,16,17,19,20,21,22,23,25],
  [1,2,4,7,8,9,13,15,16,17,18,20,21,23,25],
  [2,3,4,6,9,10,12,13,14,15,21,22,23,24,25],
  [2,5,6,7,8,9,10,11,12,13,16,18,23,24,25],
  [2,3,4,5,6,7,8,10,12,15,16,17,20,22,24],
  [1,4,5,6,8,9,12,13,15,16,19,20,21,23,25],
  [1,2,3,4,8,10,11,13,15,17,19,20,21,23,25],
  [2,3,4,5,6,7,9,10,14,17,19,20,22,23,24]
];

let __TRAIN15P_CACHE = null;

function __buildTrain15PStats(){
  if(__TRAIN15P_CACHE) return __TRAIN15P_CACHE;

  const freq = Array(26).fill(0);
  const co = Array.from({length:26}, ()=>Array(26).fill(0));

  (__TRAIN_15P_DRAWS||[]).forEach(draw=>{
    const nums = (draw||[]).slice().map(Number).filter(n=>n>=1&&n<=25);
    nums.forEach(a=> freq[a]++);
    for(let i=0;i<nums.length;i++){
      for(let j=i+1;j<nums.length;j++){
        const a=nums[i], b=nums[j];
        co[a][b]++; co[b][a]++;
      }
    }
  });

  // for√ßa de coocorr√™ncia por n√∫mero (somat√≥rio)
  const coh = Array(26).fill(0);
  for(let a=1;a<=25;a++){
    let s=0;
    for(let b=1;b<=25;b++) if(a!==b) s += co[a][b];
    coh[a]=s;
  }

  __TRAIN15P_CACHE = { freq, co, coh, n: (__TRAIN_15P_DRAWS||[]).length };
  return __TRAIN15P_CACHE;
}

function __getPrev4DrawsFromPayload(payload){
  const concursos = payload?.concursos || [];
  const draws = concursos
    .map(c=> getDezenas(c).slice().sort((a,b)=>a-b))
    .filter(a=>a.length===15);

  if(draws.length < 1){
    // fallback m√≠nimo: evita crash, mas N√ÉO usa motor antigo
    const z = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15];
    return [z,z,z,z];
  }

  const last = draws[draws.length-1];
  const prev4 = [last, last, last, last];
  for(let k=1; k<4 && (draws.length-1-k)>=0; k++){
    prev4[k] = draws[draws.length-1-k];
  }
  return prev4;
}

function __buildCoMatrixFromDraws(draws){
  const co = Array.from({length:26}, ()=>Array(26).fill(0));
  (draws||[]).forEach(d=>{
    const nums = (d||[]).slice().map(Number).filter(n=>n>=1&&n<=25);
    for(let i=0;i<nums.length;i++){
      for(let j=i+1;j<nums.length;j++){
        const a=nums[i], b=nums[j];
        co[a][b]++; co[b][a]++;
      }
    }
  });
  return co;
}

function __lineScoreWithSet(n, setArr, coTrain, coRecent){
  let s = 0;
  for(const m of setArr){
    if(m===n) continue;
    // treino vale 1, recente vale 2 (agressivo)
    s += (coTrain[n][m]||0) + 2*(coRecent[n][m]||0);
  }
  return s;
}

function __buildLineTogether(candidates, used, baseScore, coTrain, coRecent){
  const remain = candidates.filter(n=>!used.has(n));
  if(remain.length===0) return [];

  // seed: maior score geral
  remain.sort((a,b)=> (baseScore[b]||0)-(baseScore[a]||0) || a-b);
  const line = [remain[0]];
  used.add(remain[0]);

  while(line.length < 5){
    const pool = candidates.filter(n=>!used.has(n));
    if(pool.length===0) break;

    let best = pool[0];
    let bestS = -1e18;
    for(const n of pool){
      const s = __lineScoreWithSet(n, line, coTrain, coRecent) + (baseScore[n]||0)*0.35;
      if(s > bestS){
        bestS = s; best = n;
      }
    }
    line.push(best);
    used.add(best);
  }

  return line.slice().sort((a,b)=>a-b);
}

function __buildLineApart(candidates, used, coTrain, coRecent){
  const remain = candidates.filter(n=>!used.has(n));
  if(remain.length===0) return [];

  // seed: menor conex√£o m√©dia com os demais (queremos "n√£o sa√≠rem juntas")
  function avgConn(n, pool){
    let s=0, c=0;
    for(const m of pool){
      if(m===n) continue;
      s += (coTrain[n][m]||0) + 2*(coRecent[n][m]||0);
      c++;
    }
    return c? (s/c) : 0;
  }

  let pool0 = remain.slice();
  pool0.sort((a,b)=> avgConn(a,pool0)-avgConn(b,pool0) || a-b);
  const line = [pool0[0]];
  used.add(pool0[0]);

  while(line.length < 5){
    const pool = candidates.filter(n=>!used.has(n));
    if(pool.length===0) break;

    let best = pool[0];
    let bestS = 1e18;
    for(const n of pool){
      // minimizar conex√£o com a linha j√° formada
      let s=0;
      for(const m of line){
        s += (coTrain[n][m]||0) + 2*(coRecent[n][m]||0);
      }
      if(s < bestS){
        bestS = s; best = n;
      }
    }
    line.push(best);
    used.add(best);
  }

  return line.slice().sort((a,b)=>a-b);
}

function buildLines15P_TrainedFixed(prev4Draws){
  // =========================================================
  // ‚úÖ NOVO 15P (AGRESSIVO FORTE ‚Ä¢ CONVERG√äNCIA LATENTE)
  // - N√ÉO espelha o passado (evita blocos √≥bvios do √∫ltimo)
  // - Procura o "pr√©-encontro": cobertura 2-1-1-1 / 2-2-1,
  //   micro-pares fracos/m√©dios nos 4 anteriores e encaixe treinado.
  // - 3 linhas IN (latentes) + 2 linhas OUT (anti-converg√™ncia)
  // - Determin√≠stico (sem aleat√≥rio), base: √∫ltimos 4.
  // =========================================================

  const prev4 = (prev4Draws||[]).slice(0,4).map(d=>(d||[]).slice());
  const train = __buildTrain15PStats(); // {freq, co, coh}

  // presen√ßa nos 4 (para cobertura e travas anti-espelho)
  const inDraw = Array.from({length:26}, ()=>[0,0,0,0]);
  const countIn4 = Array(26).fill(0);
  for(let i=0;i<4;i++){
    const s = new Set(prev4[i]||[]);
    for(let n=1;n<=25;n++){
      if(s.has(n)){ inDraw[n][i]=1; countIn4[n]++; }
    }
  }
  const lastSet = new Set(prev4[0]||[]); // √∫ltimo concurso = prev4[0] no seu payload

  // coocorr√™ncia recente (0..4) e treino (mais longo)
  const coRecent = __buildCoMatrixFromDraws(prev4);
  const coTrain  = train.co;

  // peso de par "latente": preferimos 1‚Äì2 ocorr√™ncias (sinal), evitamos 3‚Äì4 (espelho)
  function pairLatentWeight(c){
    if(c<=0) return 0.35;   // sem cooc ‚Üí pode ser "do nada" (mas controlado)
    if(c===1) return 1.00;  // sinal forte (micro-encontro)
    if(c===2) return 0.70;  // ok
    if(c===3) return 0.20;  // espelhando
    return 0.00;            // 4 = sempre juntos (espelho)
  }

  // score individual (treino + leve b√¥nus por aus√™ncia no √∫ltimo)
  function sN(n){
    const f = (train.freq[n]||0);
    const coh = (train.coh[n]||0);
    const awayLast = lastSet.has(n) ? 0 : 0.65; // agressivo: favorece "virar" do √∫ltimo
    const away4 = (countIn4[n]===0) ? 0.45 : 0; // permite 1 "do nada" controlado
    return (1.00*f) + (0.18*coh) + awayLast + away4;
  }

  // calcula sinergia do candidato com uma linha parcial (latente)
  function marginalScore(n, line, perDrawCounts, cfg){
    if(line.includes(n)) return -1e9;

    // trava dura: IN n√£o pode puxar >2 do mesmo concurso
    for(let i=0;i<4;i++){
      if(inDraw[n][i]){
        if(perDrawCounts[i] >= cfg.maxPerDraw) return -1e9;
      }
    }
    // trava dura: IN n√£o pode puxar >cfg.maxLast do √∫ltimo
    if(lastSet.has(n) && perDrawCounts[0] >= cfg.maxLast) return -1e9;

    let micro = 0;
    for(const a of line){
      const cR = coRecent[a][n] || 0;
      const wR = pairLatentWeight(cR);
      const cT = coTrain[a][n] || 0;
      micro += (wR * (0.75 + 0.15*cT)); // treino d√° respaldo, mas recente manda
    }

    // cobertura: preferimos espalhar (ajuda pr√©-encontro)
    let covGain = 0;
    for(let i=0;i<4;i++){
      if(inDraw[n][i] && perDrawCounts[i]===0) covGain += 1.0;
    }

    // penaliza espelho: muitos do √∫ltimo e/ou muito "concentrado"
    const mirrorPenalty = (lastSet.has(n) ? 0.45 : 0) + (countIn4[n]>=3 ? 0.55 : 0);

    return (cfg.wN * sN(n)) + (cfg.wMicro * micro) + (cfg.wCov * covGain) - (cfg.wMirror * mirrorPenalty);
  }

  function pickBest(pool, line, perDrawCounts, cfg){
    let best = null;
    let bestScore = -1e18;
    for(const n of pool){
      const sc = marginalScore(n, line, perDrawCounts, cfg);
      if(sc > bestScore || (sc===bestScore && n < best)){
        best = n; bestScore = sc;
      }
    }
    return best;
  }

  function buildINLine(available, used, cfg){
    const line = [];
    const perDrawCounts = [0,0,0,0];

    // seed: melhor score individual (com travas)
    const pool = available.filter(n=>!used.has(n));
    pool.sort((a,b)=>{
      const da = sN(a), db = sN(b);
      if(db!==da) return db-da;
      return a-b;
    });

    // escolhe semente respeitando limites de origem
    let seed = null;
    for(const n of pool){
      // trava: n√£o iniciar com "espelho total"
      if(cfg.avoidPureLastSeed && lastSet.has(n) && countIn4[n]>=3) continue;
      // respeita limites por draw na semente
      let ok = true;
      for(let i=0;i<4;i++){
        if(inDraw[n][i] && perDrawCounts[i]>=cfg.maxPerDraw) ok=false;
      }
      if(ok && (!lastSet.has(n) || perDrawCounts[0] < cfg.maxLast)){
        seed = n; break;
      }
    }
    if(seed==null) seed = pool[0] || null;
    if(seed!=null){
      line.push(seed); used.add(seed);
      for(let i=0;i<4;i++) if(inDraw[seed][i]) perDrawCounts[i]++;
    }

    while(line.length < 5){
      const candPool = available.filter(n=>!used.has(n));
      const pick = pickBest(candPool, line, perDrawCounts, cfg);
      if(pick==null) break;
      line.push(pick); used.add(pick);
      for(let i=0;i<4;i++) if(inDraw[pick][i]) perDrawCounts[i]++;
    }
    return line.slice().sort((a,b)=>a-b);
  }

  function injectDoNada(line, used){
    // injeta 1 dezena "do nada" (n√£o apareceu nos 4), escolhida pelo treino (determin√≠stico)
    const pool = [];
    for(let n=1;n<=25;n++){
      if(used.has(n)) continue;
      if(countIn4[n]===0) pool.push(n);
    }
    if(pool.length===0) return line;
    pool.sort((a,b)=>{
      const da = sN(a), db = sN(b);
      if(db!==da) return db-da;
      return a-b;
    });
    const dn = pool[0];

    // substitui a pior dezena da linha em termos de "espelho"
    let worstIdx = 0;
    let worst = -1e18;
    for(let i=0;i<line.length;i++){
      const n = line[i];
      // pior = mais espelho (no √∫ltimo e presente em 3-4)
      const w = (lastSet.has(n)?1:0) + (countIn4[n]>=3?1:0);
      if(w > worst){ worst = w; worstIdx = i; }
    }
    used.delete(line[worstIdx]);
    line[worstIdx] = dn;
    used.add(dn);
    return line.slice().sort((a,b)=>a-b);
  }

  function buildOUTLine(used, cfg){
    // OUT = anti-converg√™ncia: minimiza micro-pares recentes + evita puxar do √∫ltimo
    const line = [];
    const perDrawCounts = [0,0,0,0];

    function outScore(n){
      // quanto menor, melhor
      let s = 0;
      for(const a of line){
        const cR = coRecent[a][n] || 0;
        s += (pairLatentWeight(cR) * 10); // penaliza qualquer sinal de encontro
        s += 0.15*(coTrain[a][n]||0);
      }
      // evita √∫ltimo no OUT (pra aumentar chance de ficar vazio)
      if(lastSet.has(n)) s += 2.0;
      // prefere n que apareceram muito nos 4 (pra OUT segurar e "ficar de fora")
      s -= 0.35*(countIn4[n]||0);
      return s;
    }

    while(line.length<5){
      let best=null, bestS=1e18;
      for(let n=1;n<=25;n++){
        if(used.has(n) || line.includes(n)) continue;

        // trava: OUT tamb√©m n√£o pode concentrar demais em um concurso
        let ok=true;
        for(let i=0;i<4;i++){
          if(inDraw[n][i] && perDrawCounts[i]>=cfg.maxPerDrawOut) ok=false;
        }
        if(!ok) continue;

        const sc = outScore(n);
        if(sc < bestS || (sc===bestS && n<best)){
          best=n; bestS=sc;
        }
      }
      if(best==null) break;
      line.push(best); used.add(best);
      for(let i=0;i<4;i++) if(inDraw[best][i]) perDrawCounts[i]++;
    }
    return line.slice().sort((a,b)=>a-b);
  }

  // pool total 1..25 (permite "do nada"), determin√≠stico
  const used = new Set();

  const inCfg1 = { wN:1.05, wMicro:1.30, wCov:0.80, wMirror:1.15, maxPerDraw:2, maxLast:2, avoidPureLastSeed:true };
  const inCfg2 = { wN:1.10, wMicro:1.00, wCov:1.35, wMirror:1.25, maxPerDraw:2, maxLast:2, avoidPureLastSeed:true }; // transi√ß√£o (cobertura)
  const inCfg3 = { wN:1.00, wMicro:1.10, wCov:1.05, wMirror:1.05, maxPerDraw:2, maxLast:2, avoidPureLastSeed:false };

  const line1 = buildINLine([...Array(25)].map((_,i)=>i+1), used, inCfg1);
  let line2 = buildINLine([...Array(25)].map((_,i)=>i+1), used, inCfg2);
  line2 = injectDoNada(line2, used); // for√ßa 1 "do nada" controlado
  const line3 = buildINLine([...Array(25)].map((_,i)=>i+1), used, inCfg3);

  const outCfg = { maxPerDrawOut:3 };
  const line4 = buildOUTLine(used, outCfg);
  const line5 = buildOUTLine(used, outCfg);

  // garantia: completa faltantes (caso extremo)
  const allUsed = new Set([...(line1||[]),...(line2||[]),...(line3||[]),...(line4||[]),...(line5||[])]);
  const remaining = [];
  for(let n=1;n<=25;n++) if(!allUsed.has(n)) remaining.push(n);

  function fillTo5(line){
    const a = (line||[]).slice();
    while(a.length<5){
      const n = remaining.shift();
      if(n==null) break;
      a.push(n);
    }
    return a.slice().sort((x,y)=>x-y);
  }

  const lines = [fillTo5(line1), fillTo5(line2), fillTo5(line3), fillTo5(line4), fillTo5(line5)];
  return { lines, mode:"LATENTE_AGRESSIVO_FORTE_V2" };
}


async function gerar15P(){
  const can15p = ((access.premium && access.addon15) || access.isAdmin);
  if(!can15p) return alert("üîí O recurso '15 pontos garantido' √© um EXTRA comprado separadamente (libera via claims).");

  // ‚úÖ FIXO: SEMPRE √∫ltimos 4 concursos (igual ao ELITE)
  const qtd = 4;

  try{
    await prepararContextoBase(qtd);
    const payload = lastPayload;

    // ‚úÖ contexto para explica√ß√µes (mesmo layout de antes)
    window._p15ExplainCtx = buildP15ExplainCtx(payload);

    setStatus(true,"15P: montando 5 linhas (treino fixo / base: √∫ltimos 4)‚Ä¶");
    setProgress(82);

    const prev4 = __getPrev4DrawsFromPayload(payload);
    const adv = buildLines15P_TrainedFixed(prev4);
    const lines = adv.lines;

    const jogos = gerarJogos15P(lines);

    setStatus(false,"");
    setProgress(0);

    initUserLines15FromSystem(lines);

    const lineMeta = lines.map((l,idx)=>{
      const kind = (idx<=2) ? "PREDIZ SAIR (IN)" : "PREDIZ N√ÉO SAIR (OUT)";
      const odds = l.filter(n=>n%2===1).length;
      const primes = l.filter(isPrime).length;
      const blocks = {A:0,B:0,C:0,D:0,E:0};
      l.forEach(n=>{ blocks[blockOf(n)] = (blocks[blockOf(n)]||0)+1; });
      return { idx: idx+1, kind, line:l, odds, primes, blocks };
    });

    const jogosHtml = jogos.map((j, idx)=>{
      return `
        <div class="box">
          <b>Jogo ${idx+1}</b>
          <div class="numbers" style="justify-content:flex-start;margin-top:10px">${renderBallsInline(j)}</div>
        </div>
      `;
    }).join("");

    document.getElementById("p15Area").innerHTML = `
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <div style="font-weight:1000;font-size:16px">‚úÖ 15 Pontos (Estrat√©gia) ‚Ä¢ 10 jogos</div>
          <div class="mini">Base fixa: <b>√∫ltimos 4 concursos</b> ‚Ä¢ Padr√µes: <b>treino fixo (3578‚Äì3614)</b></div>
          <div class="mini" style="margin-top:8px">
            üìå Regra do m√©todo: cobrimos todas as combina√ß√µes de <b>3 linhas entre 5</b> (10 jogos).
            <b style="text-transform:uppercase">Se voc√™ acertar as 3 linhas completas, voc√™ fecha 1 dos 10 jogos.</b>
          </div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btnGhost" type="button" onclick="verConcursos()">üìÖ Ver concursos</button>
          <button class="btn btnBlue" type="button" onclick="salvar15P()">üíæ Salvar 15P</button>
          <button class="btn btnGhost" type="button" onclick="carregar15P()">üìÇ Carregar 15P salvo</button>
        </div>
      </div>

      <div class="box" style="margin-top:12px">
        <b>üìå Linhas 1 a 5 (geradas pelo sistema)</b>
        <div class="mini" style="margin-top:6px">
          Motor: <b>NOVO 15P ‚Ä¢ LATENTE AGRESSIVO FORTE (v2)</b> ‚Ä¢ Base: <b>√∫ltimos 4</b> ‚Ä¢ Sem janela vari√°vel ‚Ä¢ Sem diversifica√ß√£o por usu√°rio.
        </div>
        <div style="margin-top:12px;overflow:auto">
          <table class="table">
            <thead>
              <tr>
                <th>Linha</th>
                <th>Tipo</th>
                <th>Dezenas</th>
                <th>√çmpares</th>
                <th>Primos</th>
                <th>Blocos (A‚ÄìE)</th>
              </tr>
            </thead>
            <tbody>
              ${lineMeta.map(m=>`
                <tr>
                  <td><b>${m.idx}</b></td>
                  <td>${String(m.kind).includes("IN") ? "PREDIZ SAIR (IN)" : "PREDIZ N√ÉO SAIR (OUT)"}</td>
                  <td class="mono">${m.line.map(format2).join(" - ")}</td>
                  <td><b>${m.odds}</b></td>
                  <td>${m.primes}</td>
                  <td class="mono">A${m.blocks.A}-B${m.blocks.B}-C${m.blocks.C}-D${m.blocks.D}-E${m.blocks.E}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      </div>

      
      <div class="box" id="p15ExplainBox" style="margin-top:12px">
        ${renderExplainBoxInner(lines)}
      </div>

<div class="box" style="margin-top:12px">
        <b>üéØ 10 jogos (combina√ß√µes das 5 linhas)</b>
        <div class="mini" style="margin-top:6px">Gerado automaticamente a partir das linhas (3 linhas por jogo).</div>
        <div style="margin-top:10px" class="grid2">${jogosHtml}</div>
      </div>
    `;

  }catch(e){
    console.error(e);
    setStatus(false,"");
    setProgress(0);
    alert("‚ö†Ô∏è Erro ao gerar 15P. Veja o console.");
  }
}

/* ===================== JOGO ELITE (6 jogos) ===================== */

let lastEliteGames = null;

const ELITE_TREINO_24 = [
  { concurso:3614, data:"14/02/2026", dezenas:[2,4,5,6,9,10,11,12,14,15,16,17,20,23,25] },
  { concurso:3613, data:"13/02/2026", dezenas:[1,3,4,7,9,10,11,12,15,16,18,20,21,22,23] },
  { concurso:3612, data:"12/02/2026", dezenas:[4,6,8,9,11,14,15,16,17,18,19,20,21,22,25] },
  { concurso:3611, data:"11/02/2026", dezenas:[1,2,3,4,5,6,10,11,12,14,15,17,18,19,25] },
  { concurso:3610, data:"10/02/2026", dezenas:[1,3,5,7,8,10,13,14,17,20,21,22,23,24,25] },
  { concurso:3609, data:"09/02/2026", dezenas:[2,5,6,8,9,10,11,12,13,17,19,20,22,24,25] },
  { concurso:3608, data:"07/02/2026", dezenas:[2,5,6,8,9,11,14,16,17,18,19,20,22,23,25] },
  { concurso:3607, data:"06/02/2026", dezenas:[1,2,4,5,6,8,9,13,14,15,16,18,19,20,23] },
  { concurso:3606, data:"05/02/2026", dezenas:[2,3,6,7,9,11,12,14,15,17,19,20,21,23,24] },
  { concurso:3605, data:"04/02/2026", dezenas:[1,3,4,7,10,12,13,14,19,20,21,22,23,24,25] },
  { concurso:3604, data:"03/02/2026", dezenas:[1,2,3,6,7,8,11,13,15,16,19,21,22,23,24] },
  { concurso:3603, data:"02/02/2026", dezenas:[2,4,5,9,10,11,12,14,15,17,19,20,21,22,24] },
  { concurso:3602, data:"31/01/2026", dezenas:[1,2,3,4,5,6,8,9,15,18,19,20,22,23,24] },
  { concurso:3601, data:"30/01/2026", dezenas:[2,3,4,6,7,8,9,11,16,17,20,21,23,24,25] },
  { concurso:3600, data:"29/01/2026", dezenas:[3,4,5,6,7,8,9,11,12,16,17,20,21,22,25] },
  { concurso:3599, data:"28/01/2026", dezenas:[1,4,6,7,8,9,11,12,13,16,19,20,21,23,24] },
  { concurso:3598, data:"27/01/2026", dezenas:[1,3,4,5,6,7,8,9,11,16,18,21,22,23,24] },
  { concurso:3597, data:"26/01/2026", dezenas:[1,4,5,7,10,11,13,14,15,16,19,20,21,23,25] },
  { concurso:3596, data:"24/01/2026", dezenas:[1,2,3,4,5,6,7,8,14,15,16,18,20,21,22] },
  { concurso:3595, data:"23/01/2026", dezenas:[1,2,4,5,6,8,10,12,13,15,16,20,21,22,25] },
  { concurso:3594, data:"22/01/2026", dezenas:[1,2,4,5,7,8,9,11,14,15,18,20,21,23,24] },
  { concurso:3593, data:"21/01/2026", dezenas:[1,3,4,6,7,8,9,10,12,15,18,19,23,24,25] },
  { concurso:3592, data:"20/01/2026", dezenas:[1,4,5,6,7,9,12,13,17,18,20,21,22,23,25] },
  { concurso:3591, data:"19/01/2026", dezenas:[1,2,3,4,6,7,10,11,13,14,15,17,18,19,20] }
];

// contexto extra (3587-3590) para "antes de 3591"
const ELITE_CTX_3587_3590 = [
  { concurso:3590, data:"17/01/2026", dezenas:[4,6,8,10,11,12,13,15,16,17,19,20,21,22,23] },
  { concurso:3589, data:"16/01/2026", dezenas:[1,2,3,4,8,10,11,12,15,18,19,21,22,24,25] },
  { concurso:3588, data:"15/01/2026", dezenas:[3,5,7,8,9,11,14,15,16,17,19,21,22,23,24] },
  { concurso:3587, data:"14/01/2026", dezenas:[1,2,4,8,9,10,11,12,13,16,17,18,19,20,22] }
];

function eliteFreqTreino(){
  const freq = {};
  for(let i=1;i<=25;i++) freq[i]=0;
  ELITE_TREINO_24.forEach(c=> c.dezenas.forEach(n=>{ freq[n]=(freq[n]||0)+1; }));
  return freq;
}

function allNums25(){ const a=[]; for(let i=1;i<=25;i++) a.push(i); return a; }

function pickDet(list, need, usedSet, seed){
  const arr = (list||[]).slice();
  if(!arr.length) return [];
  const out = [];
  let start = Math.abs(seed||0) % arr.length;
  for(let k=0; k<arr.length && out.length<need; k++){
    const v = arr[(start+k)%arr.length];
    if(!usedSet.has(v)){
      usedSet.add(v);
      out.push(v);
    }
  }
  return out;
}

function gameKey(nums){
  return sortNum(nums||[]).map(format2).join("-");
}

function buildEliteGamesFromPayload(payload){
  const concursos = payload?.concursos || [];
  if(concursos.length < 4) throw new Error("ELITE exige pelo menos 4 concursos carregados.");
  const last4 = concursos.slice(-4);

  const s1 = new Set((last4[3].dezenas||[]).map(toNum)); // √∫ltimo
  const s2 = new Set((last4[2].dezenas||[]).map(toNum));
  const s3 = new Set((last4[1].dezenas||[]).map(toNum));
  const s4 = new Set((last4[0].dezenas||[]).map(toNum));

  const R  = [...s1].sort((a,b)=>a-b);
  const G2 = [...s2].filter(n=>!s1.has(n)).sort((a,b)=>a-b);
  const G3 = [...s3].filter(n=>!s1.has(n) && !s2.has(n)).sort((a,b)=>a-b);
  const G4 = [...s4].filter(n=>!s1.has(n) && !s2.has(n) && !s3.has(n)).sort((a,b)=>a-b);

  const all = allNums25();
  const absentLast = all.filter(n=>!s1.has(n)).sort((a,b)=>a-b);
  const absent4 = all.filter(n=>!s1.has(n) && !s2.has(n) && !s3.has(n) && !s4.has(n)).sort((a,b)=>a-b);

  const freq = eliteFreqTreino();
  const hot = Object.keys(freq).map(k=>({n:Number(k), f:freq[k]}))
    .sort((a,b)=> b.f-a.f || a.n-b.n).map(x=>x.n);
  const cold = Object.keys(freq).map(k=>({n:Number(k), f:freq[k]}))
    .sort((a,b)=> a.f-b.f || a.n-b.n).map(x=>x.n);

  const seedBase = Number(payload?.latest?.concurso || payload?.ultimo || 0) || 0;

  const patterns = [
    { name:"ELITE 1", quota:{R:9,G2:3,G3:2,G4:1, HOT:0, COLD:0, OUT1:0, OUT4:0} },
    { name:"ELITE 2", quota:{R:8,G2:4,G3:2,G4:0, HOT:0, COLD:1, OUT1:0, OUT4:0} },
    { name:"ELITE 3", quota:{R:10,G2:2,G3:0,G4:2, HOT:1, COLD:0, OUT1:0, OUT4:0} },
    { name:"ELITE 4", quota:{R:7,G2:4,G3:3,G4:1, HOT:0, COLD:0, OUT1:0, OUT4:0} },
    { name:"ELITE 5", quota:{R:8,G2:0,G3:3,G4:2, HOT:0, COLD:0, OUT1:2, OUT4:0} },
    { name:"ELITE 6", quota:{R:9,G2:2,G3:1,G4:1, HOT:0, COLD:0, OUT1:0, OUT4:2} }
  ];

  const games = [];
  const seen = new Set();

  patterns.forEach((p, idx)=>{
    const used = new Set();
    const seed = seedBase + idx*37;

    const pickR  = pickDet(R,  p.quota.R||0,  used, seed+1);
    const pickG2 = pickDet(G2, p.quota.G2||0, used, seed+2);
    const pickG3 = pickDet(G3, p.quota.G3||0, used, seed+3);
    const pickG4 = pickDet(G4, p.quota.G4||0, used, seed+4);

    // HOT: prefer hot fora do √∫ltimo (para variar)
    const hotPool = hot.filter(n=>!s1.has(n));
    const pickHot = pickDet(hotPool, p.quota.HOT||0, used, seed+5);

    // COLD: prefer cold fora do √∫ltimo
    const coldPool = cold.filter(n=>!s1.has(n));
    const pickCold = pickDet(coldPool, p.quota.COLD||0, used, seed+6);

    // OUT1: ausentes do √∫ltimo (mas podem ter aparecido nos 4)
    const pickOut1 = pickDet(absentLast, p.quota.OUT1||0, used, seed+7);

    // OUT4: ausentes nos 4 √∫ltimos (bem agressivo pra ‚Äúvir do nada‚Äù)
    const pickOut4 = pickDet(absent4, p.quota.OUT4||0, used, seed+8);

    let nums = [...pickR, ...pickG2, ...pickG3, ...pickG4, ...pickHot, ...pickCold, ...pickOut1, ...pickOut4];

    // completa se faltar
    if(nums.length < 15){
      const pool = hot.concat(R).concat(G2).concat(G3).concat(G4).concat(absentLast);
      nums = nums.concat(pickDet(pool, 15-nums.length, used, seed+9));
    }

    nums = sortNum(nums).slice(0,15);

    // garante n√£o repetir jogos id√™nticos
    let key = gameKey(nums);
    if(seen.has(key)){
      // pequeno shift determin√≠stico
      const used2 = new Set();
      const alt = pickDet(hot.concat(R).concat(G2).concat(G3).concat(G4).concat(absentLast), 15, used2, seed+99);
      nums = sortNum(alt).slice(0,15);
      key = gameKey(nums);
    }
    seen.add(key);

    // mapa letras (A-O dentro / P-Y fora)
    const lettersIn = "ABCDEFGHIJKLMNO".split("");
    const lettersOut = "PQRSTUVWXYZ".split(""); // 10 letras
    const outNums = all.filter(n=>!nums.includes(n)).sort((a,b)=>a-b);

    const map = [];
    nums.forEach((n,i)=> map.push({ letter: lettersIn[i], num: n, kind:"IN" }));
    outNums.forEach((n,i)=> map.push({ letter: lettersOut[i], num: n, kind:"OUT" }));

    games.push({
      nome: p.name,
      dezenas: nums,
      meta: {
        R: pickR, G2: pickG2, G3: pickG3, G4: pickG4,
        OUT1: pickOut1, OUT4: pickOut4,
        hot: pickHot, cold: pickCold
      },
      map
    });
  });

  return {
    ok:true,
    games,
    ctx: {
      last4: last4.map(c=>({concurso:c.concurso, data:c.data, dezenas:(c.dezenas||[]).map(toNum)})),
      seedBase,
      groups: { R, G2, G3, G4, absentLast, absent4 }
    }
  };
}

function eliteResumoMeta(m){
  const chunks = [];
  function add(tag, arr){
    if(arr && arr.length) chunks.push(`<span class="mini"><b>${tag}:</b> ${arr.map(format2).join(" - ")}</span>`);
  }
  add("R", m.R);
  add("G2", m.G2);
  add("G3", m.G3);
  add("G4", m.G4);
  add("OUT(√∫ltimo)", m.OUT1);
  add("OUT(4)", m.OUT4);
  add("HOT", m.hot);
  add("COLD", m.cold);
  return chunks.join("<br/>");
}

async function gerarElite(silent=false){
  const canElite = ((access.premium && access.addonElite) || access.isAdmin);
  if(!canElite){
    if(!silent) alert("üîí O recurso 'JOGO ELITE' est√° dispon√≠vel somente no pacote COMBO.");
    return;
  }

  const area = document.getElementById("eliteArea");
  if(window.__eliteGenLock) return;
  window.__eliteGenLock = true;
  try{
    // ‚úÖ ELITE SEMPRE USA 4 (n√£o depende do seletor)
    const qtd = 4;
    await prepararContextoBase(qtd);

    const payload = lastPayload;
    const pack = buildEliteGamesFromPayload(payload);

    // ‚úÖ Diversifica√ß√£o por usu√°rio no ELITE (mant√©m motor, s√≥ remapeia dezenas determin√≠stico por usu√°rio)
    const __scopeKeyE = __diversifyScopeKey("ELITE", qtd, payload);
    const __permUserE = __getUserPerm(__scopeKeyE);

    if(pack && Array.isArray(pack.games)){
      pack.games = pack.games.map(g=>{
        const gg = Object.assign({}, g);
        gg.dezenas = __applyPermNums(gg.dezenas, __permUserE);
        gg.meta = __applyPermMeta(gg.meta, __permUserE);
        if(Array.isArray(gg.map)){
          gg.map = gg.map.map(it=> Object.assign({}, it, { num: remapPorPermutacao(Number(it.num), __permUserE) }));
        }
        return gg;
      });
    }
    if(pack?.ctx?.groups){
      const gr = Object.assign({}, pack.ctx.groups);
      Object.keys(gr).forEach(k=>{
        if(Array.isArray(gr[k])) gr[k] = gr[k].map(n=> remapPorPermutacao(Number(n), __permUserE)).sort((a,b)=>a-b);
      });
      pack.ctx.groups = gr;
    }

    lastEliteGames = pack;

    const w = payload ? { inicio: payload.inicio, ultimo: payload.ultimo, qtd: payload.concursos?.length || null } : null;
    const srcInfo = { source: payload?.source, mode: payload?.mode, window: w };

    let html = `
      <div class="box">
        <b>üìå Base ELITE:</b>
        <div class="mini" style="margin-top:6px">
          Sempre usando <b>√∫ltimos 4 concursos</b> para encaixe ‚Ä¢ √öltimo concurso carregado: <b>${payload?.latest?.concurso || payload?.ultimo || "‚Äî"}</b>
        </div>
        <div class="mini" style="margin-top:6px">
          Fonte: <b>${srcInfo.source || "‚Äî"}</b> ‚Ä¢ Modo: <b>${String(srcInfo.mode||"‚Äî").toUpperCase()}</b>
        </div>
      </div>
      <div class="hr"></div>
    `;

    (pack.games||[]).forEach((g, i)=>{

      function eliteMotivo(n, meta){
        const m = meta || {};
        const has = (arr)=> Array.isArray(arr) && arr.includes(n);

        if(has(m.R))   return "R ‚Ä¢ repeti√ß√£o do √∫ltimo concurso";
        if(has(m.G2))  return "G2 ‚Ä¢ veio do pen√∫ltimo (gap 2)";
        if(has(m.G3))  return "G3 ‚Ä¢ veio do antepen√∫ltimo (gap 3)";
        if(has(m.G4))  return "G4 ‚Ä¢ veio do 4¬∫ concurso (gap 4)";
        if(has(m.OUT1))return "OUT(√∫ltimo) ‚Ä¢ estava fora no √∫ltimo";
        if(has(m.OUT4))return "OUT(4) ‚Ä¢ ficou 4 concursos fora";
        if(has(m.hot)) return "HOT ‚Ä¢ alta frequ√™ncia no treino ELITE";
        if(has(m.cold))return "COLD ‚Ä¢ baixa frequ√™ncia (varia√ß√£o)";
        return "Encaixe do padr√£o ELITE";
      }

      const dezenas = (g.dezenas||[]).slice();
      const balls = dezenas.map(n=>`<div class="ball">${format2(n)}</div>`).join("");

      const _eliteOrder = (motivo)=>{
        const m = String(motivo||"");
        if(/^R/.test(m)) return 1;
        if(/^G2/.test(m)) return 2;
        if(/^G3/.test(m)) return 3;
        if(/^G4/.test(m)) return 4;
        if(/^HOT/.test(m)) return 5;
        if(/^COLD/.test(m)) return 6;
        if(/^OUT/.test(m)) return 7;
        return 9; // Encaixe / outros
      };

      // Agrupa dezenas pelo mesmo motivo para ficar compacto e bonito
      const groups = {};
      dezenas.forEach(n=>{
        const motivo = eliteMotivo(n, g.meta);
        if(!groups[motivo]) groups[motivo] = [];
        groups[motivo].push(n);
      });

      const expRows = Object.entries(groups)
        .sort((a,b)=> (_eliteOrder(a[0]) - _eliteOrder(b[0])) || (String(a[0]).localeCompare(String(b[0]))))
        .map(([motivo, nums])=>{
          const numsHtml = sortNum(nums).map(x=>`<span class="eliteMotivesNum">${format2(x)}</span>`).join("");
          return `
            <div class="eliteMotivesRow">
              <span class="eliteMotivesTag">${motivo}</span>
              <div class="eliteMotivesNums">${numsHtml}</div>
            </div>
          `;
        }).join("");

      html += `
        <div class="box" style="margin-top:12px">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
            <b>üíé ${g.nome}</b>
            <span class="badge premium">ELITE</span>
          </div>

          <div class="numbers" style="justify-content:flex-start;margin-top:10px">${balls}</div>

          <div class="eliteMotives">
            <div class="eliteMotivesHdr">
              <b>üìå Motivo (agrupado)</b>
              <span>mesmo motivo = dezenas juntas</span>
            </div>
            <div class="eliteMotivesGrid">
              ${expRows}
            </div>
          </div>
        </div>
      `;
    });

    if(area) area.innerHTML = html;

  }catch(e){
    console.log(e);
    if(area) area.innerHTML = `
      <div class="box">
        <b>‚ö†Ô∏è Erro</b>
        <div class="mini" style="margin-top:8px">${String(e?.message || e)}</div>
      </div>
    `;
  }finally{
    window.__eliteGenLock = false;
  }
}


function salvarElite(){
  const canElite = ((access.premium && access.addonElite) || access.isAdmin);
  if(!canElite) return alert("üîí O recurso 'JOGO ELITE' est√° dispon√≠vel somente no pacote COMBO.");
  if(!lastEliteGames?.games?.length){
    alert("Gere o JOGO ELITE primeiro.");
    return;
  }

  const jogos = lastEliteGames.games.map(g=>g.dezenas);
  salvarJogoNoStorage({
    slot: "JOGO ELITE (6)",
    tipo: "elite6",
    nome: "JOGO ELITE (6)",
    jogos: jogos,
    at: Date.now()
  });

  alert("‚úÖ ELITE salvo em JOGOS SALVOS: JOGO ELITE (6) (sobrescreve ao salvar de novo)");
}

/* ===================== /JOGO ELITE ===================== */

</script>

<script>

const KEY_JOGOS_SALVOS = "lotofacil_jogos_salvos";

let jogosSalvos = [];
let selectedSavedSlot = "Principal+Invertida+Tecnica";

try {
  jogosSalvos = JSON.parse(localStorage.getItem(KEY_JOGOS_SALVOS) || "[]");
  if (!Array.isArray(jogosSalvos)) jogosSalvos = [];
} catch (e) {
  jogosSalvos = [];
}

function salvarJogoNoStorage(obj) {
  if (obj && obj.slot) {
    const i = jogosSalvos.findIndex(x => x && x.slot === obj.slot);
    if (i >= 0) jogosSalvos[i] = obj;
    else jogosSalvos.push(obj);
  } else {
    jogosSalvos.push(obj);
  }

  localStorage.setItem(KEY_JOGOS_SALVOS, JSON.stringify(jogosSalvos));
}

function carregarJogosDoStorage() {
  try {
    const arr = JSON.parse(localStorage.getItem(KEY_JOGOS_SALVOS) || "[]");
    jogosSalvos = Array.isArray(arr) ? arr : [];
  } catch (e) {
    jogosSalvos = [];
  }
}

document.getElementById("btnEntrar").addEventListener("click", entrar);
document.getElementById("btnForgot").addEventListener("click", forgotPassword);

document.getElementById("btnComprar").addEventListener("click", comprarPremium);
document.getElementById("btnJaComprei").addEventListener("click", jaComprei);
document.getElementById("btnSair").addEventListener("click", sair);

document.getElementById("btnComprar15p").addEventListener("click", comprar15p);
document.getElementById("btnAtivar15p").addEventListener("click", jaComprei15p);

["btnHomePrincipal","btnHomeAnalise","btnHomeCreate","btnHomeInvertida","btnHomeTecnica","btnHomeElite","btnHome15p","btnHomeSaved"].forEach(id=>{
  const el = document.getElementById(id);
  if(el) bindCardKey(el);
});

document.getElementById("btnHomeSaved").onclick = ()=>{
  goView("viewSavedGames");
};

function checkSavedGames(){
  const qtd = Number(document.getElementById("savedCheckQtd").value);

  carregarJogosDoStorage();

  if(!jogosSalvos.length){
    alert("Nenhum jogo salvo ainda.");
    return;
  }

  const item = jogosSalvos.find(x => x && x.slot === selectedSavedSlot) || jogosSalvos[0];
  if(!item){
    alert("Selecione um jogo salvo.");
    return;
  }

  (async ()=>{
    try{
      const need = Math.max(qtd, qtdSelecionada()); // mant√©m compat√≠vel com o seletor da Home, sem limitar Jogos Salvos
      if(!lastPayload || !lastPayload.concursos || (lastPayload.concursos.length < qtd)){
        await prepararContextoBase(need);
      }

      const concursos = (lastPayload.concursos || []).slice(-qtd);
if(!concursos.length){
        alert("N√£o foi poss√≠vel carregar concursos para confer√™ncia.");
        return;
      }

      function hitsCount(gameNums, concursoDezenas){
        const set = new Set((concursoDezenas || []).map(toNum));
        return (gameNums || []).filter(n => set.has(Number(n))).length;
      }

      let html = `
        <div class="box" style="margin-top:10px">
          <b>üìå Conferindo:</b> <b>${item.nome || item.slot}</b>
          <div class="mini" style="margin-top:6px">Base: √∫ltimos <b>${qtd}</b> concursos</div>
        </div>
      `;

      if(item.tipo === "pack" && item.pack){
        const pack = item.pack;

        const principalRef = Array.isArray(pack.principal)
          ? pack.principal.slice().map(Number).sort((a,b)=>a-b)
          : null;

        const jogos = [
          { nome: "üéØ Principal (salvo)", nums: Array.isArray(pack.principal) ? pack.principal : null },
          { nome: "üîÑ Invertida (salva)", nums: Array.isArray(pack.invertida) ? pack.invertida : null },
          { nome: "üèÜ T√©cnica 1 (salva)", nums: Array.isArray(pack.tecnica1) ? pack.tecnica1 : null },
          { nome: "üèÜ T√©cnica 2 (salva)", nums: Array.isArray(pack.tecnica2) ? pack.tecnica2 : null }
        ].filter(x => Array.isArray(x.nums) && x.nums.length);

        if(!jogos.length){
          alert("O pacote salvo n√£o tem jogos v√°lidos.");
          return;
        }

        jogos.forEach(obj=>{
          const jogo = obj.nums.slice().map(Number).sort((a,b)=>a-b);

          let principalLine = "";
          if(obj.nome !== "üéØ Principal (salvo)" && Array.isArray(principalRef) && principalRef.length){
            principalLine = `
              <div class="mini" style="margin-top:6px">
                üéØ <b>Principal:</b> <span class="mono">${principalRef.map(format2).join(" - ")}</span>
              </div>
            `;
          }

          let linhasResultados = "";
          concursos.forEach(c=>{
            const hits = hitsCount(jogo, c.dezenas);
            const cls = (hits >= 11 && hits <= 15) ? `hit-${hits}` : "";
            linhasResultados += `
              <div class="mini ${cls}">
                Concurso <b>${c.concurso}</b> ‚Üí <b>${hits} acertos</b>
              </div>
            `;
          });

          html += `
            <div class="box" style="margin-top:10px">
              <b>${obj.nome}</b>
              ${principalLine}
              <div class="numbers" style="justify-content:flex-start;margin-top:8px">
                ${jogo.map(format2).join(" - ")}
              </div>
              <div style="margin-top:10px">${linhasResultados}</div>
            </div>
          `;
        });
      }
      else if(item.tipo === "15p" && item.payload){

  const lines = Array.isArray(item?.payload?.linesSystem15)
              ? item.payload.linesSystem15
              : (Array.isArray(item?.payload?.linesUser15)
                 ? item.payload.linesUser15
                 : null);

  if(!Array.isArray(lines) || lines.length !== 5){
    alert("Esse 15P salvo n√£o possui as 5 linhas.");
    return;
  }

  html += `
    <div class="box" style="margin-top:10px">
      <b>üìå Linhas 1 a 5 (do Extra 15P)</b>
      <div class="mini" style="margin-top:6px">
        Confer√™ncia por linha ‚Ä¢ Base: √∫ltimos <b>${qtd}</b> concursos
      </div>
    </div>
  `;

  concursos.forEach(c=>{

    html += `
      <div class="box" style="margin-top:10px">
        <b>Concurso ${c.concurso}</b>
    `;

    lines.forEach((linha, idx)=>{

      const sorteadas = new Set((c.dezenas || []).map(Number));
      const nums = linha.slice().map(Number).sort((a,b)=>a-b);

      let hits = 0;

      const linhaRender = nums.map(n=>{
        if(sorteadas.has(n)){
          hits++;
          return `<span style="color:#22c55e;font-weight:900">${format2(n)}</span>`;
        }
        return format2(n);
      }).join(" - ");

      html += `
        <div style="font-size:12px;margin-top:6px">
          <b>L${idx+1}</b> (${hits})
          <div style="margin-top:2px">${linhaRender}</div>
        </div>
      `;
    });

    html += `</div>`;
  });
}


      else if(item.tipo === "elite6" && Array.isArray(item.jogos)){
        const jogos = item.jogos;

        );
      }

      else{
        alert("Tipo de jogo salvo n√£o reconhecido.");
        return;
      }

      document.getElementById("savedGamesResult").innerHTML = html;

    }catch(e){
      console.log(e);
      alert("Erro ao conferir jogos salvos: " + (e?.message || e));
    }
  })();
}
function renderJogosSalvosAoAbrir(){
  carregarJogosDoStorage();

  const box = document.getElementById("savedPacksList");
  if(!box) return;

  if(!Array.isArray(jogosSalvos) || !jogosSalvos.length){
    box.innerHTML = '<div class="mini">Nenhum jogo salvo ainda.</div>';
    return;
  }

  const sorted = [...jogosSalvos].sort((a,b)=>{
    const ta = a?.at ? new Date(a.at).getTime() : 0;
    const tb = b?.at ? new Date(b.at).getTime() : 0;
    return tb - ta;
  });

  let html = "";
  sorted.forEach(item=>{
    const isOn = (item.slot === selectedSavedSlot);

    html += `
      <div class="box savedPack ${isOn ? "on" : ""}" style="margin-top:10px;cursor:pointer;border:1px solid ${isOn ? "rgba(250,204,21,.75)" : "rgba(255,255,255,.22)"};background:${isOn ? "rgba(250,204,21,.18)" : "rgba(255,255,255,.03)"};color:${isOn ? "#0b0b0b" : "#ffffff"}"
        onclick="selectedSavedSlot='${item.slot}'; renderJogosSalvosAoAbrir();">
        <b>üíæ ${item.nome || item.slot}</b><br/>
        <span class="mini">Salvo em: ${item.at ? new Date(item.at).toLocaleString("pt-BR") : "-"}</span>
        <div class="mini" style="margin-top:6px">${isOn ? "‚úÖ Selecionado para confer√™ncia" : "Toque para selecionar"}</div>
      </div>
    `;
  });

  box.innerHTML = html;
}

</script>

<script>

(function(){
  if(window.__MOTOR_FIXO_TREINO21_INSTALADO__) return;
  window.__MOTOR_FIXO_TREINO21_INSTALADO__ = true;

  const FIX_PATTERNS = {
    principal: { gap0: 9,  gap1: 3, gap2: 2, gap3p: 1 },
    invertida: { gap0: 10, gap1: 3, gap2: 1, gap3p: 1 },
    tecnica1:  { gap0: 8,  gap1: 4, gap2: 2, gap3p: 1 },
    tecnica2:  { gap0: 9,  gap1: 2, gap2: 3, gap3p: 1 } // 9 repetidas, mas mix diferente do Principal
  };

  function rng(seed){
    let t = (seed >>> 0) || 1;
    return function(){
      t += 0x6D2B79F5;
      let x = t;
      x = Math.imul(x ^ (x >>> 15), x | 1);
      x ^= x + Math.imul(x ^ (x >>> 7), x | 61);
      return ((x ^ (x >>> 14)) >>> 0) / 4294967296;
    };
  }
  function shuffle(arr, seed){
    const a = arr.slice();
    const r = rng(seed);
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(r()*(i+1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }
  function uniqSort15(nums){
    const set = new Set(nums.map(Number).filter(n=>n>=1 && n<=25));
    const arr = Array.from(set).sort((a,b)=>a-b);
    for(let n=1; arr.length<15 && n<=25; n++){
      if(!set.has(n)){ set.add(n); arr.push(n); }
    }
    return arr.slice(0,15).sort((a,b)=>a-b);
  }
  function sameArr(a,b){
    if(!Array.isArray(a)||!Array.isArray(b)) return false;
    if(a.length!==b.length) return false;
    for(let i=0;i<a.length;i++) if(Number(a[i])!==Number(b[i])) return false;
    return true;
  }
  function diffCount(a,b){
    const sa = new Set(a);
    let same=0;
    for(const x of b) if(sa.has(x)) same++;
    return 15 - same;
  }

  function qtdSelecionadaSafe(){
    try{ return (typeof qtdSelecionada==="function") ? qtdSelecionada() : 3; }catch(_){ return 3; }
  }
  function getConcursosDisponiveisSafe(){
    if(window.lastPayload && Array.isArray(window.lastPayload.concursos) && window.lastPayload.concursos.length){
      return window.lastPayload.concursos.slice();
    }
    return [];
  }
  function lastK(draws, k){
    const arr = draws.filter(d=>Array.isArray(d.dezenas) && d.dezenas.length>=15);
    const n = Math.max(1, Math.min(arr.length, k));
    return arr.slice(-n);
  }

  function buildPoolsFromWindow(windowDraws){
    const last = windowDraws[windowDraws.length-1]?.dezenas || [];
    const s0 = new Set(last.map(Number));
    const s1 = new Set((windowDraws[windowDraws.length-2]?.dezenas || []).map(Number));
    const s2 = new Set((windowDraws[windowDraws.length-3]?.dezenas || []).map(Number));
    const s3 = new Set((windowDraws[windowDraws.length-4]?.dezenas || []).map(Number));
    const s4 = new Set((windowDraws[windowDraws.length-5]?.dezenas || []).map(Number));
    const s5 = new Set((windowDraws[windowDraws.length-6]?.dezenas || []).map(Number));

    const gap0 = Array.from(s0);
    const gap1 = Array.from(s1).filter(n=>!s0.has(n));
    const gap2 = Array.from(s2).filter(n=>!s0.has(n) && !s1.has(n));
    const gap3p = [];
    for(let n=1;n<=25;n++){
      if(s0.has(n) || s1.has(n) || s2.has(n)) continue;
      if(s3.has(n) || s4.has(n) || s5.has(n)) gap3p.push(n);
    }
    const atrasadas = [];
    for(let n=1;n<=25;n++){
      if(s0.has(n)||s1.has(n)||s2.has(n)||s3.has(n)||s4.has(n)||s5.has(n)) continue;
      atrasadas.push(n);
    }
    return {gap0, gap1, gap2, gap3p, atrasadas};
  }

  function pickFrom(pool, k, seed){
    const a = shuffle(pool, seed);
    return a.slice(0, Math.max(0, k));
  }

  function buildGameFromPattern(name, pattern, windowDraws, forbidSet, seed){
    const pools = buildPoolsFromWindow(windowDraws);
    const motivos = [];

    function pickGap(label, pool, k, seedOffset){
      const picked = pickFrom(pool.filter(n=>!forbidSet.has(n)), k, seed + seedOffset);
      picked.forEach(n=>{
        motivos.push({dezena:n, texto:`${label} (padr√£o ${name})`});
        forbidSet.add(n);
      });
      return picked;
    }

    let game = [];
    game = game.concat(pickGap("Repetida (gap 0)", pools.gap0, pattern.gap0, 11));
    game = game.concat(pickGap("Gap 1", pools.gap1, pattern.gap1, 23));
    game = game.concat(pickGap("Gap 2", pools.gap2, pattern.gap2, 37));

    const need3 = pattern.gap3p;
    let g3 = pickGap("Gap 3+", pools.gap3p, need3, 51);
    if(g3.length < need3){
      const falta = need3 - g3.length;
      const extra = pickGap("Atrasada forte (6+)", pools.atrasadas, falta, 61);
      g3 = g3.concat(extra);
    }
    game = game.concat(g3);

    if(game.length < 15){
      const all = [];
      for(let n=1;n<=25;n++) if(!forbidSet.has(n)) all.push(n);
      const extra = pickFrom(all, 15-game.length, seed+77);
      extra.forEach(n=>{
        motivos.push({dezena:n, texto:`Completo do padr√£o ${name} (reserva)`});
        forbidSet.add(n);
      });
      game = game.concat(extra);
    }
    game = uniqSort15(game);

    return {jogo: game, motivos};
  }

  function enforceDifferent(games, minDiffs, seed){
    for(let i=0;i<games.length;i++){
      for(let j=0;j<i;j++){
        const min = minDiffs[games[i].id] && minDiffs[games[i].id][games[j].id] || 0;
        if(min<=0) continue;
        let tries = 0;
        while(diffCount(games[i].jogo, games[j].jogo) < min && tries < 25){
          tries++;
          const current = games[i].jogo.slice();
          const set = new Set(current);
          let candIn = null;
          for(let n=1;n<=25;n++){
            if(!set.has(n)){ candIn = n; break; }
          }
          if(candIn==null) break;
          const outIdx = (current.length-1) - (tries%3);
          const out = current[outIdx];
          current[outIdx] = candIn;
          games[i].jogo = uniqSort15(current);
          games[i].motivos.push({dezena:candIn, texto:"Ajuste anti-igualdade entre jogos"});
        }
      }
    }
  }


// >>> Instala o motor NOVO (Padr√µes Fixos) como gerador oficial
window.buildPack4JogosPreditivo = buildPack4JogosPreditivo;

})();
</script>

</body>
</html>
