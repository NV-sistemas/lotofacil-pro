<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Lotof√°cil Prime Analytics</title>

<style>
  :root{
    --bg1:#050b1a; --bg2:#0b1636;
    --card:#07122a; --card2:#0a1b3f;
    --text:#f8fafc; --muted:#cbd5e1; --muted2:#94a3b8;

    --green:#22c55e; --green2:#16a34a;
    --blue:#38bdf8; --blue2:#0ea5e9;
    --purple:#a78bfa; --purple2:#7c3aed;
    --yellow:#facc15; --orange:#fb923c;
    --red:#fb7185; --red2:#ef4444;

    --stroke: rgba(255,255,255,.10);
    --stroke2: rgba(255,255,255,.16);

    --shadow: 0 22px 70px rgba(0,0,0,.45);
    --glowBlue: 0 0 0 1px rgba(56,189,248,.18), 0 12px 40px rgba(56,189,248,.10);
    --glowGreen: 0 0 0 1px rgba(34,197,94,.18), 0 12px 40px rgba(34,197,94,.10);
  }

  *{box-sizing:border-box;font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
  body{
    margin:0;color:var(--text);
    background:
      radial-gradient(900px 650px at 10% 10%, rgba(56,189,248,.16), transparent 55%),
      radial-gradient(900px 650px at 90% 10%, rgba(34,197,94,.14), transparent 55%),
      radial-gradient(900px 650px at 50% 90%, rgba(167,139,250,.14), transparent 55%),
      linear-gradient(135deg,var(--bg1),var(--bg2));
    min-height:100vh
  }

  .center{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:18px}
  .wrap{max-width:1180px;margin:0 auto;padding:18px}

  /* ===== Header centralizado ===== */
  .header{
    display:grid;
    grid-template-columns: 1fr auto 1fr;
    align-items:center;
    gap:12px;
    margin-bottom:14px
  }
  .title{font-size:26px;font-weight:1000;margin:0;letter-spacing:.2px;text-align:center}
  .chip{
    justify-self:end;
    display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:999px;
    background:rgba(255,255,255,.06);
    border:1px solid var(--stroke);
    color:var(--text);
    font-size:12px;font-weight:900;
    box-shadow: 0 10px 30px rgba(0,0,0,.25);
    white-space:nowrap;
  }
  .chip .dot{width:7px;height:7px;border-radius:999px;background:rgba(34,197,94,.85);display:inline-block}
  .chip .btnMini{
    padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.05);color:var(--text);font-weight:900;cursor:pointer
  }

  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px solid var(--stroke);
    border-radius:20px;padding:16px;
    box-shadow:var(--shadow);
    margin-bottom:14px;
    backdrop-filter: blur(10px);
  }
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin-top:12px}
  .box{
    background:rgba(255,255,255,.045);
    border:1px solid rgba(255,255,255,.10);
    border-radius:16px;padding:12px;
  }
  .box p{margin:0;color:var(--text);font-size:13px;line-height:1.5}
  .mini{color:var(--muted);font-size:12px;margin-top:8px;line-height:1.45}
  .mini strong{color:var(--text)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
  .col{flex:1;min-width:240px}

  label{display:block;font-size:12px;color:var(--muted);font-weight:950;margin-bottom:6px}
  input, select{
    width:100%;padding:13px 12px;border-radius:14px;border:1px solid var(--stroke2);
    background:rgba(2,6,23,.65);
    color:var(--text);outline:none;
  }
  input::placeholder{color:rgba(203,213,225,.65)}
  select{cursor:pointer}

  /* ===== Bot√µes ===== */
  .btn{
    padding:12px 14px;border:none;border-radius:14px;
    color:#07131a;font-weight:1000;cursor:pointer;
    transition:.15s;
    box-shadow: 0 18px 45px rgba(0,0,0,.35);
  }
  .btn:hover{filter:brightness(1.05);transform:translateY(-1px)}
  .btn:active{transform:translateY(0px);filter:brightness(0.98)}
  .btn:disabled{opacity:.55;cursor:not-allowed;transform:none;box-shadow:none}
  .btnPrimary{background:linear-gradient(135deg,var(--green),var(--green2));box-shadow: var(--glowGreen)}
  .btnBlue{background:linear-gradient(135deg,var(--blue),var(--blue2));box-shadow: var(--glowBlue);color:#041018}
  .btnPurple{background:linear-gradient(135deg,var(--purple),var(--purple2));color:#0b0720;box-shadow: 0 0 0 1px rgba(167,139,250,.18), 0 12px 40px rgba(167,139,250,.12)}
  .btnDanger{background:linear-gradient(135deg,var(--red),var(--red2));color:#2b0b0b;box-shadow: 0 0 0 1px rgba(251,113,133,.18), 0 12px 40px rgba(251,113,133,.12)}
  .btnGhost{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.14);color:var(--text);box-shadow:none}
  .btnFull{width:100%}

  .msg{
    margin-top:12px;padding:12px;border-radius:14px;
    background:rgba(56,189,248,.10);border:1px solid rgba(56,189,248,.22);
    color:#e6f8ff;font-size:13px;font-weight:900;display:none;
  }
  .msg.err{background:rgba(251,113,133,.12);border:1px solid rgba(251,113,133,.28);color:#ffe7ec}

  .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:950;margin-bottom:8px}
  .pill.hot{background:rgba(34,197,94,.16);color:#b7ffd2;border:1px solid rgba(34,197,94,.28)}
  .pill.warm{background:rgba(250,204,21,.14);color:#fff2b0;border:1px solid rgba(250,204,21,.28)}
  .pill.cold{background:rgba(251,113,133,.14);color:#ffd3da;border:1px solid rgba(251,113,133,.28)}
  .pill.info{background:rgba(56,189,248,.14);color:#dff6ff;border:1px solid rgba(56,189,248,.28)}
  .pill.rep{background:rgba(34,197,94,.12);color:#b7ffd2;border:1px solid rgba(34,197,94,.24)}
  .pill.extra{background:rgba(250,204,21,.14);color:#fff2b0;border:1px solid rgba(250,204,21,.28)}

  .numbers{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:10px 0 6px}
  .ball{
    width:44px;height:44px;border-radius:999px;display:flex;align-items:center;justify-content:center;
    background:rgba(34,197,94,.14);
    border:1px solid rgba(34,197,94,.28);
    color:#eafff4;font-weight:1000;letter-spacing:.4px;
    box-shadow:0 14px 34px rgba(0,0,0,.35);
  }
  .range{text-align:center;color:var(--muted);font-size:13px;font-weight:900;margin:0 0 10px}

  .chartCard{
    margin-top:12px;
    background:rgba(255,255,255,.045);
    border:1px solid rgba(255,255,255,.10);
    border-radius:18px;
    padding:14px;
  }
  .chartTitle{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}
  .chartTitle b{font-size:13px}
  .chartHint{color:var(--muted);font-size:12px;font-weight:950}
  .chartRow{display:flex;align-items:center;gap:10px;margin:10px 0}
  .chartLabel{width:90px;color:var(--text);font-weight:950}
  .chartBarWrap{flex:1;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.12);border-radius:999px;overflow:hidden;height:16px}
  .chartBar{height:100%;width:0%;background:linear-gradient(90deg,var(--blue),var(--green))}
  .chartVal{width:56px;text-align:right;color:var(--text);font-weight:950}

  .status{display:none;margin-top:10px;padding:12px;border-radius:14px;background:rgba(56,189,248,.10);
          border:1px solid rgba(56,189,248,.22);color:#e6f8ff;font-size:13px;font-weight:950;}
  .bar{height:10px;border-radius:999px;overflow:hidden;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.08);margin-top:10px}
  .bar>div{height:100%;width:0%;background:linear-gradient(90deg,var(--blue),var(--green));transition:width .2s ease}

  .modalBack{display:none;position:fixed;inset:0;background:rgba(0,0,0,.62);backdrop-filter: blur(7px);
             align-items:center;justify-content:center;padding:16px;z-index:999}
  .modal{width:100%;max-width:980px;background:linear-gradient(180deg,var(--card),rgba(255,255,255,.03));
         border:1px solid rgba(255,255,255,.12);border-radius:20px;box-shadow:0 40px 120px rgba(0,0,0,.70);
         overflow:hidden}
  .modalHeader{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.10)}
  .modalHeader b{font-size:14px}
  .closeBtn{padding:9px 11px;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.14);
            color:var(--text);cursor:pointer;font-weight:900}
  .modalBody{padding:14px 16px}

  .table{width:100%;border-collapse:collapse;font-size:13px}
  .table th,.table td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.10);text-align:left;vertical-align:top}
  .table th{color:var(--muted);font-weight:1000;font-size:12px}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  .footerNote{text-align:center;color:var(--muted2);font-size:11px;margin-top:10px}

  /* ====== VIEWS ====== */
  .view{display:none}
  .view.on{display:block}
  .topNav{
    display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
    margin-bottom:10px;
  }
  .topNav .left{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .topNav .right{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

  /* ====== Op√ß√µes maiores / mais leg√≠veis ====== */
  .actionGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:14px;margin-top:12px}
  .actionCard{
    text-align:left;border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.055);
    border-radius:20px;padding:18px 18px;
    cursor:pointer;transition:.15s;
    position:relative;min-height:130px;
    box-shadow: 0 18px 55px rgba(0,0,0,.38);
  }
  .actionCard:hover{transform:translateY(-2px);background:rgba(255,255,255,.07)}
  .actionCard:active{transform:translateY(0px)}
  .actionCard.disabled{opacity:.55;cursor:not-allowed;transform:none;box-shadow:none}
  .actionTitle{font-weight:1000;font-size:16px;margin:0 0 8px}
  .actionDesc{margin:0;color:var(--muted);font-size:13px;line-height:1.55}
  .badge{
    position:absolute;top:14px;right:14px;
    font-size:11px;font-weight:1000;
    padding:6px 10px;border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.06);
    color:var(--text);
  }
  .badge.premium{border-color:rgba(56,189,248,.30);background:rgba(56,189,248,.14);color:#e6f8ff}
  .badge.extra{border-color:rgba(250,204,21,.30);background:rgba(250,204,21,.14);color:#fff2b0}
  .badge.free{border-color:rgba(34,197,94,.30);background:rgba(34,197,94,.14);color:#eafff4}

  /* ====== Cart√£o Lotof√°cil ====== */
  .cartaoWrap{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
  @media (max-width: 820px){ .cartaoWrap{grid-template-columns:1fr} }
  .cartao{
    display:grid;grid-template-columns: repeat(5, 44px);
    gap:8px;justify-content:center;margin:10px 0 0;
  }
  .cel{
    width:44px;height:44px;border-radius:12px;
    display:flex;align-items:center;justify-content:center;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.05);
    color:var(--text);font-weight:1000;
  }
  .cel.on{background:rgba(34,197,94,.14);border:1px solid rgba(34,197,94,.30);color:#eafff4;box-shadow:0 12px 30px rgba(0,0,0,.25)}
  .cel.inv{background:rgba(56,189,248,.14);border:1px solid rgba(56,189,248,.30);color:#e6f8ff;box-shadow:0 12px 30px rgba(0,0,0,.25)}
  .cel.tech{background:rgba(250,204,21,.14);border:1px solid rgba(250,204,21,.30);color:#fff2b0;box-shadow:0 12px 30px rgba(0,0,0,.25)}

  .hr{height:1px;background:rgba(255,255,255,.10);margin:12px 0;border-radius:999px}

  /* ===== Jogos (salvar / conferir) ===== */
  .gameList{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-top:12px}
  .gameCard{border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.05);border-radius:18px;padding:14px}
  .gameCard b{font-size:13px}
  .scoreTag{
    display:inline-flex;align-items:center;gap:8px;
    padding:7px 10px;border-radius:999px;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.14);
    color:var(--text);
    font-weight:1000;font-size:12px;
  }
  .hitTag{
    display:inline-flex;align-items:center;gap:8px;
    padding:7px 10px;border-radius:999px;
    background:rgba(34,197,94,.14);
    border:1px solid rgba(34,197,94,.28);
    color:#eafff4;
    font-weight:1000;font-size:12px;
  }
  .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
</style>
</head>

<body>

<script>
/* =========================
   CONFIG
========================= */
const APP_NAME = "LOTOF√ÅCIL PRIME ANALYTICS";
const BUY_LINK = "https://pay.hotmart.com/R104129385C?off=s9zvi5rw";
const BUY_LINK_15P = "https://pay.hotmart.com/R104129385C?off=s9zvi5rw";

const ACTIVATION_CODE = "PRIME-2026";
const ACTIVATION_CODE_15P = "15P-2026";

const MASTER_EMAIL = "admin@lotofacilprime.com";
const MASTER_PASS  = "prime123";

const FREE_LIMIT_KEY = "lf_free_used_v1";
const ADDON15_KEY = "lf_addon15";

/* ‚ÄúPasta‚Äù de jogos salvos (localStorage) */
const SAVED_GAMES_KEY = "lf_saved_games_v1";
</script>

<!-- LOGIN -->
<div class="center" id="loginWrap">
  <div class="card" style="max-width:520px;width:100%">
    <div style="text-align:center">
      <div class="title" style="margin:0">üéØ <span id="appName1"></span></div>
      <div class="mini" style="margin-top:6px">
        Entre para acessar o painel. Premium libera as ferramentas principais.
      </div>
    </div>

    <div style="margin-top:12px" class="row">
      <div class="col">
        <label>Email</label>
        <input id="email" type="email" placeholder="seuemail@gmail.com" />
      </div>
      <div class="col">
        <label>Senha</label>
        <input id="senha" type="password" placeholder="sua senha" />
      </div>
    </div>

    <button id="btnEntrar" class="btn btnPrimary btnFull" type="button">Entrar</button>

    <div id="msgOk" class="msg"></div>
    <div id="msgErr" class="msg err"></div>

    <div class="footerNote">
      Dica: use o login master para testar Premium + 15P e ver a tela completa.
    </div>
  </div>
</div>

<!-- APP -->
<div class="wrap" id="app" style="display:none">
  <div class="header">
    <div></div>
    <div class="title">üéØ <span id="appName2"></span></div>
    <div class="chip" id="chipUser">
      <span class="dot"></span>
      <span id="chipText">üë§</span>
      <button class="btnMini" type="button" onclick="goView('viewSaved'); renderSavedGames()">Meus jogos</button>
    </div>
  </div>

  <!-- PREMIUM GATE -->
  <div class="card" id="premiumGate" style="display:none">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div>
        <div style="font-weight:1000;font-size:16px">üîí √Årea Premium</div>
        <div class="mini">
          No modo Free voc√™ pode gerar <b>1 vez</b> apenas no <b>Jogo Principal</b>.
          Para liberar <b>An√°lise</b>, <b>Invertida</b> e <b>T√©cnica Premiada</b>, ative o Premium.
        </div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn btnDanger" id="btnComprar" type="button">Comprar Premium</button>
        <button class="btn btnGhost" id="btnJaComprei" type="button">J√° comprei</button>
        <button class="btn btnGhost" id="btnSair" type="button">Sair</button>
      </div>
    </div>
    <div class="mini" style="margin-top:10px">
      ‚úÖ Ap√≥s pagar, volte aqui e clique em <b>J√° comprei</b> para ativar.
    </div>
  </div>

  <!-- EXTRA 15P UPSELL -->
  <div class="card" id="addon15Card" style="display:none">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div>
        <div style="font-weight:1000;font-size:16px">‚ú® Recurso Extra: 15 pontos garantido</div>
        <div class="mini">
          Esse recurso √© um <b>EXTRA comprado separadamente</b>. Ele abre uma tela pr√≥pria com an√°lise de <b>5 linhas</b> (5 dezenas em cada) e gera√ß√£o dos <b>10 jogos</b>.
        </div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <span class="pill extra" style="margin:0">EXTRA</span>
        <button class="btn btnDanger" id="btnComprar15p" type="button">Comprar 15 pontos</button>
        <button class="btn btnGhost" id="btnAtivar15p" type="button">J√° comprei</button>
      </div>
    </div>
  </div>

  <!-- ===== TELAS ===== -->
  <div class="view on" id="viewHome">
    <div class="card">
      <!-- Quantidade acima das op√ß√µes -->
      <div class="row">
        <div class="col" style="min-width:320px">
          <label>Quantidade de concursos para an√°lise</label>
          <select id="qtdConcursos">
            <option value="5">√öltimos 5 concursos</option>
            <option value="10" selected>√öltimos 10 concursos</option>
            <option value="15">√öltimos 15 concursos</option>
            <option value="20">√öltimos 20 concursos</option>
            <option value="25">√öltimos 25 concursos</option>
            <option value="50">√öltimos 50 concursos</option>
            <option value="75">√öltimos 75 concursos</option>
            <option value="100">√öltimos 100 concursos</option>
          </select>
          <div class="mini" style="margin-top:10px">
            Dica: quanto maior o per√≠odo, mais ‚Äúrobusta‚Äù fica a estat√≠stica. Se APIs bloquearem, o app entra em modo demonstra√ß√£o automaticamente.
          </div>
        </div>

        <div class="col" style="min-width:320px">
          <label>Progresso</label>
          <div id="status" class="status">
            <div id="statusText">Carregando‚Ä¶</div>
            <div class="bar"><div id="barFill"></div></div>
          </div>
          <div class="mini">
            Premium: An√°lise, Invertida e T√©cnica Premiada. <br/>
            Free: Jogo Principal (1 gera√ß√£o). <br/>
            Extra: 15P Garantido (comprado separadamente).
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <!-- Op√ß√µes maiores -->
      <label>Op√ß√µes</label>
      <div class="actionGrid">
        <div class="actionCard" id="btnHomeAnalise" role="button" tabindex="0">
          <span class="badge premium">PREMIUM</span>
          <p class="actionTitle">üìà Gerar an√°lise</p>
          <p class="actionDesc">Gera toda a an√°lise do per√≠odo selecionado (sem jogo).</p>
        </div>

        <div class="actionCard" id="btnHomePrincipal" role="button" tabindex="0">
          <span class="badge free">FREE 1x</span>
          <p class="actionTitle">üéØ Jogo principal</p>
          <p class="actionDesc">Gera 15 dezenas + resumo. Depois voc√™ cria Invertida e T√©cnica a partir dele.</p>
        </div>

        <div class="actionCard" id="btnHomeInvertida" role="button" tabindex="0">
          <span class="badge premium">PREMIUM</span>
          <p class="actionTitle">üîÑ Gerar invertida</p>
          <p class="actionDesc">Usa o Jogo Principal e inverte A‚ÜîE, B‚ÜîD, C fixo (com cart√£o 5√ó5).</p>
        </div>

        <div class="actionCard" id="btnHomeTecnica" role="button" tabindex="0">
          <span class="badge premium">PREMIUM</span>
          <p class="actionTitle">üèÜ T√©cnica premiada</p>
          <p class="actionDesc">Gera 2 jogos extras a partir do Principal (reordena√ß√£o por blocos).</p>
        </div>

        <div class="actionCard" id="btnHome15p" role="button" tabindex="0">
          <span class="badge extra">EXTRA</span>
          <p class="actionTitle">‚úÖ 15 pontos garantido <span class="mini" style="display:inline;margin:0;color:var(--muted)">(com somente 10 jogos)</span></p>
          <p class="actionDesc">Tela separada: 5 linhas (5 dezenas cada) + an√°lise detalhada e 10 jogos autom√°ticos.</p>
        </div>
      </div>
    </div>

    <div class="card" id="resultadoHome">
      <div class="footerNote">Selecione a janela e escolha uma op√ß√£o acima.</div>
    </div>
  </div>

  <!-- TELA: AN√ÅLISE -->
  <div class="view" id="viewAnalise">
    <div class="topNav">
      <div class="left">
        <button class="btn btnGhost" type="button" onclick="goView('viewHome')">‚¨Ö Voltar</button>
        <span class="pill info" style="margin:0">üìà An√°lise completa</span>
      </div>
      <div class="right">
        <button class="btn btnGhost" type="button" onclick="verConcursos()">üìÖ Ver concursos</button>
      </div>
    </div>

    <div class="card" id="analiseArea">
      <div class="footerNote">Clique em ‚ÄúGerar an√°lise‚Äù na tela principal.</div>
    </div>
  </div>

  <!-- TELA: JOGO PRINCIPAL -->
  <div class="view" id="viewPrincipal">
    <div class="topNav">
      <div class="left">
        <button class="btn btnGhost" type="button" onclick="goView('viewHome')">‚¨Ö Voltar</button>
        <span class="pill info" style="margin:0">üéØ Jogo Principal</span>
      </div>
      <div class="right">
        <button class="btn btnBlue" type="button" onclick="goView('viewInvertida'); gerarInvertida()">üîÑ Gerar Invertida</button>
        <button class="btn btnPurple" type="button" onclick="goView('viewTecnica'); gerarTecnicaPremiada()">üèÜ Gerar T√©cnica</button>
      </div>
    </div>

    <div class="card" id="principalArea">
      <div class="footerNote">Clique em ‚ÄúJogo Principal‚Äù na tela principal.</div>
    </div>
  </div>

  <!-- TELA: INVERTIDA -->
  <div class="view" id="viewInvertida">
    <div class="topNav">
      <div class="left">
        <button class="btn btnGhost" type="button" onclick="goView('viewPrincipal')">‚¨Ö Voltar</button>
        <span class="pill info" style="margin:0">üîÑ Jogo Invertido (A‚ÜîE, B‚ÜîD, C fixo)</span>
      </div>
      <div class="right">
        <button class="btn btnBlue" type="button" onclick="gerarInvertida()">Atualizar invertida</button>
      </div>
    </div>

    <div class="card" id="invertidaArea">
      <div class="footerNote">Gere um Jogo Principal primeiro.</div>
    </div>
  </div>

  <!-- TELA: T√âCNICA PREMIADA -->
  <div class="view" id="viewTecnica">
    <div class="topNav">
      <div class="left">
        <button class="btn btnGhost" type="button" onclick="goView('viewPrincipal')">‚¨Ö Voltar</button>
        <span class="pill info" style="margin:0">üèÜ T√©cnica Premiada (2 jogos extras)</span>
      </div>
      <div class="right">
        <button class="btn btnPurple" type="button" onclick="gerarTecnicaPremiada()">Atualizar t√©cnica</button>
      </div>
    </div>

    <div class="card" id="tecnicaArea">
      <div class="footerNote">Gere um Jogo Principal primeiro.</div>
    </div>
  </div>

  <!-- TELA: 15 PONTOS -->
  <div class="view" id="view15p">
    <div class="topNav">
      <div class="left">
        <button class="btn btnGhost" type="button" onclick="goView('viewHome')">‚¨Ö Voltar</button>
        <span class="pill extra" style="margin:0">‚úÖ 15 pontos garantido (com somente 10 jogos)</span>
      </div>
      <div class="right">
        <button class="btn btnPrimary" type="button" onclick="gerar15P()">Gerar an√°lise 15P</button>
      </div>
    </div>

    <div class="card" id="p15Area">
      <div class="footerNote">Clique em ‚ÄúGerar an√°lise 15P‚Äù. Essa tela exige o EXTRA ativado (ou login master).</div>
    </div>
  </div>

  <!-- TELA: MEUS JOGOS SALVOS -->
  <div class="view" id="viewSaved">
    <div class="topNav">
      <div class="left">
        <button class="btn btnGhost" type="button" onclick="goView('viewHome')">‚¨Ö Voltar</button>
        <span class="pill info" style="margin:0">üìÇ Meus jogos salvos</span>
      </div>
      <div class="right">
        <button class="btn btnGhost" type="button" onclick="renderSavedGames()">üîÑ Atualizar</button>
        <button class="btn btnDanger" type="button" onclick="clearSavedGames()">Apagar tudo</button>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;align-items:flex-end;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div class="col" style="min-width:280px">
          <label>Conferir com qual concurso?</label>
          <input id="checkConcursoInput" placeholder="Opcional: digite um n√∫mero de concurso (ex: 3200)" />
          <div class="mini">Se deixar vazio, o sistema confere automaticamente com o <b>√∫ltimo concurso dispon√≠vel</b>.</div>
        </div>
        <div class="col" style="min-width:240px">
          <button class="btn btnBlue btnFull" type="button" onclick="checkAllSaved()">Conferir todos agora</button>
          <div class="mini" style="margin-top:10px">
            Ao conferir, o app busca o resultado online (ou demo) e mostra quantos n√∫meros cada jogo acertou.
          </div>
        </div>
      </div>

      <div class="hr"></div>
      <div id="savedArea">
        <div class="footerNote">Voc√™ ainda n√£o salvou nenhum jogo.</div>
      </div>
    </div>
  </div>

  <div class="footerNote">Aviso: an√°lise estat√≠stica n√£o garante premia√ß√£o. Jogo respons√°vel ‚úÖ</div>
</div>

<!-- MODAL LISTA CONCURSOS -->
<div id="modalBack" class="modalBack">
  <div class="modal">
    <div class="modalHeader">
      <b>üìå Concursos analisados (datas + dezenas)</b>
      <button class="closeBtn" onclick="fecharModal()">Fechar</button>
    </div>
    <div class="modalBody">
      <div id="listaConcursos"></div>
    </div>
  </div>
</div>

<!-- MODAL GRAFICO BLOCOS -->
<div id="modalBlocosBack" class="modalBack">
  <div class="modal" style="max-width:560px">
    <div class="modalHeader">
      <b>üìä Gr√°fico de Blocos A‚ÄìE</b>
      <button class="closeBtn" onclick="fecharGraficoBlocos()">Fechar</button>
    </div>
    <div class="modalBody">
      <div id="graficoBlocosArea"></div>
      <div class="mini" style="margin-top:10px">
        Blocos: A(01‚Äì05), B(06‚Äì10), C(11‚Äì15), D(16‚Äì20), E(21‚Äì25).
      </div>
    </div>
  </div>
</div>

<!-- MODAL ATIVAR PREMIUM -->
<div id="modalAtivarBack" class="modalBack">
  <div class="modal" style="max-width:520px">
    <div class="modalHeader">
      <b>‚úÖ Ativar Premium</b>
      <button class="closeBtn" onclick="fecharAtivar()">Fechar</button>
    </div>
    <div class="modalBody">
      <div class="mini">Cole o <b>C√≥digo de Ativa√ß√£o</b>:</div>
      <input id="codigoAtivacao" placeholder="Ex: PRIME-2026" style="margin-top:10px"/>
      <button class="btn btnPrimary" type="button" style="margin-top:10px" onclick="ativarPremium()">Ativar</button>
    </div>
  </div>
</div>

<!-- MODAL ATIVAR EXTRA 15P -->
<div id="modalAtivar15pBack" class="modalBack">
  <div class="modal" style="max-width:520px">
    <div class="modalHeader">
      <b>‚úÖ Ativar EXTRA: 15 pontos garantido</b>
      <button class="closeBtn" onclick="fecharAtivar15p()">Fechar</button>
    </div>
    <div class="modalBody">
      <div class="mini">Cole o <b>C√≥digo de Ativa√ß√£o</b> do EXTRA:</div>
      <input id="codigoAtivacao15p" placeholder="Ex: 15P-2026" style="margin-top:10px"/>
      <button class="btn btnPrimary" type="button" style="margin-top:10px" onclick="ativarAddon15()">Ativar</button>
    </div>
  </div>
</div>

<script>
/* =========================
   UI Helpers
========================= */
document.getElementById("appName1").textContent = APP_NAME;
document.getElementById("appName2").textContent = APP_NAME;

function showOk(t){ const a=document.getElementById("msgOk"); a.style.display="block"; a.textContent=t; document.getElementById("msgErr").style.display="none"; }
function showErr(t){ const a=document.getElementById("msgErr"); a.style.display="block"; a.textContent=t; document.getElementById("msgOk").style.display="none"; }

function setStatus(on, text){
  const st=document.getElementById("status");
  document.getElementById("statusText").textContent = text || "";
  st.style.display = on ? "block" : "none";
}
function setProgress(p){
  document.getElementById("barFill").style.width = Math.max(0, Math.min(100, p)) + "%";
}

function abrirModal(){ document.getElementById("modalBack").style.display="flex"; }
function fecharModal(){ document.getElementById("modalBack").style.display="none"; }
function fecharGraficoBlocos(){ document.getElementById("modalBlocosBack").style.display="none"; }

function abrirAtivar(){ document.getElementById("modalAtivarBack").style.display="flex"; }
function fecharAtivar(){ document.getElementById("modalAtivarBack").style.display="none"; }

function abrirAtivar15p(){ document.getElementById("modalAtivar15pBack").style.display="flex"; }
function fecharAtivar15p(){ document.getElementById("modalAtivar15pBack").style.display="none"; }

function goView(id){
  document.querySelectorAll(".view").forEach(v=>v.classList.remove("on"));
  const el=document.getElementById(id);
  if(el) el.classList.add("on");
  window.scrollTo({top:0, behavior:"smooth"});
}
</script>

<script>
/* =========================
   Login / Acesso
========================= */
function setSession(email, premium){
  localStorage.setItem("lf_email", email);
  localStorage.setItem("lf_premium", premium ? "1":"0");
}
function clearSession(){
  localStorage.removeItem("lf_email");
  localStorage.removeItem("lf_premium");
}
function getSession(){
  return { email: localStorage.getItem("lf_email") || "", premium: localStorage.getItem("lf_premium")==="1" };
}
function isFreeUsed(){ return localStorage.getItem(FREE_LIMIT_KEY)==="1"; }
function markFreeUsed(){ localStorage.setItem(FREE_LIMIT_KEY,"1"); }

function hasAddon15(){ return localStorage.getItem(ADDON15_KEY)==="1"; }
function setAddon15(v){ localStorage.setItem(ADDON15_KEY, v ? "1":"0"); }

function isMaster(){
  const s=getSession();
  return (s.email||"").toLowerCase() === MASTER_EMAIL.toLowerCase() && s.premium;
}

function updateChip(){
  const s=getSession();
  const addon = hasAddon15() || isMaster();
  const base = (s.premium ? "Premium" : "Free") + " ‚Ä¢ " + (s.email || "visitante");
  document.getElementById("chipText").textContent = addon ? (base + " ‚Ä¢ ‚úÖ 15P") : base;
}

function setCardEnabled(el, enabled, onClick, msg){
  el.classList.toggle("disabled", !enabled);
  el.onclick = enabled ? onClick : ()=>alert(msg);
}

function aplicarAcessos(){
  const s=getSession();
  const addon = hasAddon15() || isMaster();

  document.getElementById("premiumGate").style.display = s.premium ? "none" : "block";
  document.getElementById("addon15Card").style.display = addon ? "none" : "block";

  const btnAnalise = document.getElementById("btnHomeAnalise");
  const btnPrincipal = document.getElementById("btnHomePrincipal");
  const btnInvertida = document.getElementById("btnHomeInvertida");
  const btnTecnica = document.getElementById("btnHomeTecnica");
  const btn15 = document.getElementById("btnHome15p");

  setCardEnabled(btnAnalise, s.premium, acaoAnalise, "üîí Gerar an√°lise exige Premium.");
  setCardEnabled(btnInvertida, s.premium, ()=>{
    if(!lastPrincipalGame) return alert("Gere primeiro um Jogo Principal.");
    goView("viewInvertida"); gerarInvertida();
  }, "üîí Invertida exige Premium.");
  setCardEnabled(btnTecnica, s.premium, ()=>{
    if(!lastPrincipalGame) return alert("Gere primeiro um Jogo Principal.");
    goView("viewTecnica"); gerarTecnicaPremiada();
  }, "üîí T√©cnica premiada exige Premium.");

  // Principal (free 1x)
  if(!s.premium && isFreeUsed()){
    btnPrincipal.classList.add("disabled");
    btnPrincipal.onclick = ()=>alert("üîí Voc√™ j√° usou a gera√ß√£o gr√°tis. Para liberar, ative o Premium.");
  }else{
    btnPrincipal.classList.remove("disabled");
    btnPrincipal.onclick = ()=>acaoPrincipal();
  }

  // 15P extra
  if(!addon){
    btn15.classList.add("disabled");
    btn15.onclick = ()=>alert("üîí O recurso '15 pontos garantido' √© um EXTRA comprado separadamente.");
  }else{
    btn15.classList.remove("disabled");
    btn15.onclick = ()=>{ goView("view15p"); };
  }
}

function abrirApp(){
  document.getElementById("loginWrap").style.display="none";
  document.getElementById("app").style.display="block";
  updateChip();
  aplicarAcessos();
  goView("viewHome");
}

function entrar(){
  const email=(document.getElementById("email").value||"").trim().toLowerCase();
  const senha=(document.getElementById("senha").value||"");

  if(!email || !senha){ showErr("Digite email e senha."); return; }

  if(email === MASTER_EMAIL.toLowerCase() && senha === MASTER_PASS){
    setSession(email, true);
    setAddon15(true);
    showOk("Bem-vindo! Premium + 15P liberados para teste ‚úÖ");
    abrirApp();
    return;
  }

  setSession(email, false);
  showOk("Entrou no modo Free. Voc√™ pode gerar 1 vez no Jogo Principal.");
  abrirApp();
}

function sair(){ clearSession(); location.reload(); }
function comprarPremium(){ window.open(BUY_LINK, "_blank"); }
function comprar15p(){ window.open(BUY_LINK_15P, "_blank"); }

function ativarPremium(){
  const code = (document.getElementById("codigoAtivacao").value || "").trim();
  if(!code) return alert("Digite o c√≥digo.");
  if(code !== ACTIVATION_CODE) return alert("C√≥digo inv√°lido.");

  const s = getSession();
  setSession(s.email || "cliente@premium", true);
  alert("Premium ativado ‚úÖ");
  fecharAtivar();
  updateChip();
  aplicarAcessos();
}
function ativarAddon15(){
  const code = (document.getElementById("codigoAtivacao15p").value || "").trim();
  if(!code) return alert("Digite o c√≥digo.");
  if(code !== ACTIVATION_CODE_15P) return alert("C√≥digo inv√°lido do EXTRA.");

  setAddon15(true);
  alert("EXTRA 15 pontos ativado ‚úÖ");
  fecharAtivar15p();
  updateChip();
  aplicarAcessos();
}

/* Auto abrir modais */
(function(){
  const p = new URLSearchParams(location.search);
  if(p.get("hotmart")==="ok"){
    const s=getSession();
    if(s.email) setTimeout(()=>abrirAtivar(), 400);
  }
  if(p.get("hotmart15p")==="ok"){
    const s=getSession();
    if(s.email) setTimeout(()=>abrirAtivar15p(), 400);
  }
})();
</script>

<script>
/* =========================
   MOTOR BASE
========================= */
function format2(n){ return String(n).padStart(2,"0"); }
function toNum(d){ return Number(String(d).replace(/^0+/,"")) || Number(d); }
function sortNum(arr){ return arr.slice().sort((a,b)=>a-b); }

function calcularFrequencias(concursos){
  const freq={}; for(let i=1;i<=25;i++) freq[i]=0;
  concursos.forEach(c=>{
    (c.dezenas||[]).forEach(d=>{
      const n=toNum(d);
      if(n>=1 && n<=25) freq[n]+=1;
    });
  });
  return freq;
}
function ordenarPorFreq(freq){
  return Object.entries(freq).map(([k,v])=>({dez:Number(k), f:v})).sort((a,b)=>b.f-a.f);
}
function contarParesImpares(jogo){
  const pares = jogo.filter(n=>n%2===0).length;
  return {pares, impares: jogo.length - pares};
}
function somaDezenas(jogo){ return jogo.reduce((a,b)=>a+b,0); }
function contarSequencias(jogo){
  let maxLen=1, curLen=0, prev=null;
  const sorted = sortNum(jogo);
  for(const n of sorted){
    if(prev!==null && n===prev+1){ curLen++; }
    else { curLen=1; }
    if(curLen>maxLen) maxLen=curLen;
    prev=n;
  }
  return { temSequencia: maxLen>=2, maxLen };
}
function finaisMaisFreq(concursos){
  const fin={}; for(let i=0;i<=9;i++) fin[i]=0;
  concursos.forEach(c=>{
    c.dezenas.forEach(d=>{
      const n=toNum(d);
      fin[n%10]+=1;
    });
  });
  return fin;
}
function distribuicaoBlocos(jogo){
  const b={A:0,B:0,C:0,D:0,E:0};
  jogo.forEach(n=>{
    if(n>=1 && n<=5) b.A++;
    else if(n>=6 && n<=10) b.B++;
    else if(n>=11 && n<=15) b.C++;
    else if(n>=16 && n<=20) b.D++;
    else if(n>=21 && n<=25) b.E++;
  });
  return b;
}
function repetidasDoUltimo(jogo, ultimoDezenas){
  const setUlt = new Set((ultimoDezenas||[]).map(toNum));
  return sortNum(jogo.filter(n=>setUlt.has(n)));
}
function classificarDezenas(freq, jogo){
  const ord = ordenarPorFreq(freq);
  const rank={}; ord.forEach((x,i)=>rank[x.dez]=i+1);
  const hot=[], warm=[], cold=[];
  jogo.forEach(n=>{
    const r=rank[n]||999;
    if(r<=8) hot.push(n);
    else if(r<=17) warm.push(n);
    else cold.push(n);
  });
  return {hot:sortNum(hot), warm:sortNum(warm), cold:sortNum(cold), rank};
}
function gerarJogoForte(freq){
  const ord = ordenarPorFreq(freq);
  const hotPool = ord.slice(0,10).map(x=>x.dez);
  const warmPool = ord.slice(10,18).map(x=>x.dez);
  const coldPool = ord.slice(-7).map(x=>x.dez);

  function addFromPool(pool, count, set){
    const shuffled = pool.slice().sort(()=>Math.random()-0.5);
    let added=0;
    for(const n of shuffled){
      if(set.has(n)) continue;
      set.add(n); added++;
      if(added>=count) break;
    }
  }

  let best=null;
  for(let t=0;t<650;t++){
    const set=new Set();
    addFromPool(hotPool, 6, set);
    addFromPool(warmPool, 7, set);
    addFromPool(coldPool, 2, set);
    while(set.size<15) set.add(Math.floor(Math.random()*25)+1);

    const jogo = sortNum([...set]);
    const pi = contarParesImpares(jogo);
    const soma = somaDezenas(jogo);
    const blocos = distribuicaoBlocos(jogo);
    const seq = contarSequencias(jogo);

    let score=0;
    score += (pi.pares===7 || pi.pares===8) ? 25 : 0;
    score += (soma>=170 && soma<=230) ? 20 : 0;
    const maxBlock = Math.max(blocos.A,blocos.B,blocos.C,blocos.D,blocos.E);
    score += (maxBlock<=5) ? 20 : 0;
    score += (seq.maxLen<=4) ? 15 : 0;
    score += Math.min(20, Math.round(jogo.reduce((a,n)=>a+(freq[n]||0),0)/10));

    if(!best || score>best.score) best={jogo, score};
  }
  return best.jogo;
}

function renderTop10(freq, totalConcursos){
  const ord = ordenarPorFreq(freq).slice(0,10);
  const max = ord[0]?.f || 1;
  const bars = ord.map(x=>{
    const pct = Math.round((x.f/max)*100);
    return `
      <div class="chartRow">
        <div class="chartLabel">Dezena ${format2(x.dez)}</div>
        <div class="chartBarWrap"><div class="chartBar" style="width:${pct}%"></div></div>
        <div class="chartVal">${x.f}x</div>
      </div>
    `;
  }).join("");
  return `
    <div class="chartCard">
      <div class="chartTitle">
        <b>üìä Top 10 dezenas mais frequentes</b>
        <span class="chartHint">Base: ${totalConcursos} concursos</span>
      </div>
      <div class="mini">Barras maiores = dezenas que mais apareceram no per√≠odo analisado.</div>
      <div style="margin-top:10px">${bars}</div>
    </div>
  `;
}
function renderFinaisChart(fin){
  const arr = Object.entries(fin).map(([k,v])=>({k:Number(k), v})).sort((a,b)=>b.v-a.v);
  const max = arr[0]?.v || 1;
  const rows = arr.map(x=>{
    const pct = Math.round((x.v/max)*100);
    return `
      <div class="chartRow">
        <div class="chartLabel">Final ${x.k}</div>
        <div class="chartBarWrap"><div class="chartBar" style="width:${pct}%"></div></div>
        <div class="chartVal">${x.v}x</div>
      </div>
    `;
  }).join("");
  return `
    <div class="chartCard">
      <div class="chartTitle">
        <b>üèÅ Finais mais frequentes (0‚Äì9)</b>
        <span class="chartHint">Base: per√≠odo</span>
      </div>
      <div class="mini">Ajuda a compor dezenas com finais mais fortes no hist√≥rico recente.</div>
      <div style="margin-top:10px">${rows}</div>
    </div>
  `;
}
function renderListaConcursos(concursos){
  const rows = concursos.map(c=>{
    const dezenas = (c.dezenas||[]).map(d=>format2(toNum(d))).join(" - ");
    const data = c.data ? String(c.data) : "‚Äî";
    return `<tr>
      <td><b>${c.concurso}</b></td>
      <td>${data}</td>
      <td class="mono">${dezenas}</td>
    </tr>`;
  }).join("");
  return `
    <table class="table">
      <thead><tr><th>Concurso</th><th>Data</th><th>Dezenas</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}
function abrirGraficoBlocos(blocos){
  const max = Math.max(blocos.A,blocos.B,blocos.C,blocos.D,blocos.E,1);
  function row(label, val){
    const pct = Math.round((val/max)*100);
    return `
      <div class="chartRow">
        <div class="chartLabel">${label}</div>
        <div class="chartBarWrap"><div class="chartBar" style="width:${pct}%"></div></div>
        <div class="chartVal">${val}</div>
      </div>`;
  }
  document.getElementById("graficoBlocosArea").innerHTML =
    row("A (01‚Äì05)", blocos.A) +
    row("B (06‚Äì10)", blocos.B) +
    row("C (11‚Äì15)", blocos.C) +
    row("D (16‚Äì20)", blocos.D) +
    row("E (21‚Äì25)", blocos.E);

  document.getElementById("modalBlocosBack").style.display="flex";
}
</script>

<script>
/* =========================
   DADOS ONLINE / DEMO
========================= */
const SOURCES = [
  {
    name: "loteriascaixa-api (p√∫blico)",
    latest: "https://loteriascaixa-api.herokuapp.com/api/lotofacil/latest",
    byId: (n)=>`https://loteriascaixa-api.herokuapp.com/api/lotofacil/${n}`,
    adapt: (j)=>({ concurso:Number(j.concurso), data:j.data||"", dezenas:(j.dezenas||[]).map(String) })
  },
  {
    name: "api.guidi.dev.br (fallback)",
    latest: "https://api.guidi.dev.br/loteria/lotofacil/ultimo",
    byId: (n)=>`https://api.guidi.dev.br/loteria/lotofacil/${n}`,
    adapt: (j)=>({ concurso:Number(j.numero), data:j.dataApuracao||"", dezenas:(j.listaDezenas||[]).map(String) })
  }
];

async function tryFetchJson(url){
  const r = await fetch(url, { cache:"no-store" });
  if(!r.ok) throw new Error("HTTP "+r.status);
  return await r.json();
}
async function getOnlineConcursos(qtd){
  let lastErr=null;
  for(const src of SOURCES){
    try{
      const latestRaw = await tryFetchJson(src.latest);
      const latest = src.adapt(latestRaw);
      if(!latest.concurso || !latest.dezenas?.length) throw new Error("Resposta inv√°lida");

      const ultimo = latest.concurso;
      const inicio = Math.max(1, ultimo - qtd + 1);

      const concursos=[];
      for(let c=inicio;c<=ultimo;c++){
        const raw = await tryFetchJson(src.byId(c));
        concursos.push(src.adapt(raw));
      }
      return { mode:"online", source:src.name, latest, concursos, inicio, ultimo };
    }catch(e){
      lastErr=e;
    }
  }
  throw lastErr || new Error("Falha online");
}
function buildDemo(qtd){
  const ultimo = 3600;
  const inicio = ultimo - qtd + 1;
  const concursos=[];
  for(let c=inicio;c<=ultimo;c++){
    const dezenas=new Set();
    while(dezenas.size<15) dezenas.add(Math.floor(Math.random()*25)+1);
    concursos.push({ concurso:c, data:"‚Äî", dezenas:[...dezenas].map(n=>format2(n)) });
  }
  const latest = concursos[concursos.length-1];
  return { mode:"demo", source:"Demonstra√ß√£o (offline)", latest, concursos, inicio, ultimo };
}

async function fetchResultadoPorConcurso(concursoNum){
  let lastErr=null;
  for(const src of SOURCES){
    try{
      if(!concursoNum){
        const latestRaw = await tryFetchJson(src.latest);
        return { ...src.adapt(latestRaw), source: src.name };
      }
      const raw = await tryFetchJson(src.byId(concursoNum));
      return { ...src.adapt(raw), source: src.name };
    }catch(e){
      lastErr=e;
    }
  }
  // fallback demo
  if(!concursoNum){
    const demo = buildDemo(1);
    const latest = demo.latest;
    return { concurso: latest.concurso, data: latest.data, dezenas: latest.dezenas, source:"DEMO" };
  }
  throw lastErr || new Error("Falha ao buscar concurso");
}

/* =========================
   Estado global
========================= */
let lastPayload=null;
let lastCtx=null;
let lastPrincipalGame=null;
let lastPrincipalMeta=null;
let lastInvertidaGame=null;
let lastTecnicaGames=null;
</script>

<script>
/* =========================
   ‚ÄúPASTA‚Äù DE JOGOS (localStorage)
========================= */
function uuid(){
  return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}
function getSavedGames(){
  try{ return JSON.parse(localStorage.getItem(SAVED_GAMES_KEY) || "[]"); }
  catch{ return []; }
}
function setSavedGames(arr){
  localStorage.setItem(SAVED_GAMES_KEY, JSON.stringify(arr || []));
}
function isSameGame(aNums, bNums){
  const a = sortNum(aNums.map(Number)).join("-");
  const b = sortNum(bNums.map(Number)).join("-");
  return a===b;
}
function saveGame(kind, nums, meta){
  const saved = getSavedGames();
  // evitar duplicar o mesmo jogo (mesma dezena)
  if(saved.some(g=>isSameGame(g.nums, nums))) return { ok:false, msg:"Este jogo j√° est√° salvo." };

  const item = {
    id: uuid(),
    createdAt: new Date().toISOString(),
    email: (getSession().email || ""),
    kind,
    nums: sortNum(nums.map(Number)),
    meta: meta || null,
    lastCheck: null
  };
  saved.unshift(item);
  setSavedGames(saved);
  return { ok:true, msg:"Jogo salvo ‚úÖ" };
}
function removeSaved(id){
  const saved = getSavedGames().filter(g=>g.id!==id);
  setSavedGames(saved);
}
function clearSavedGames(){
  if(!confirm("Apagar todos os jogos salvos?")) return;
  setSavedGames([]);
  renderSavedGames();
}
function hitsAgainst(gameNums, resultNums){
  const setR = new Set(resultNums.map(toNum));
  const hits = sortNum(gameNums.filter(n=>setR.has(Number(n))).map(Number));
  return { count: hits.length, hits };
}

function renderGameCardForSave(title, nums, meta){
  const saved = getSavedGames();
  const already = saved.some(g=>isSameGame(g.nums, nums));
  const balls = nums.map(n=>`<div class="ball">${format2(n)}</div>`).join("");
  return `
    <div class="gameCard">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <b>${title}</b>
        <span class="scoreTag">${already ? "‚úÖ Salvo" : "üíæ N√£o salvo"}</span>
      </div>
      <div class="numbers" style="justify-content:flex-start">${balls}</div>
      <div class="btnRow">
        <button class="btn btnPrimary" type="button" ${already ? "disabled":""}
          onclick="(function(){
            const res = saveGame('${title.replace(/'/g,"\\'")}', ${JSON.stringify(nums)}, ${JSON.stringify(meta || null)});
            alert(res.msg);
            renderApostasPanelIfReady();
            renderSavedGames();
          })()">
          Salvar jogo
        </button>
        <button class="btn btnGhost" type="button"
          onclick="goView('viewSaved'); renderSavedGames();">
          Ver na pasta
        </button>
      </div>
      <div class="mini">Salvar √© opcional. Se salvar, o app consegue conferir automaticamente com concursos futuros.</div>
    </div>
  `;
}

async function checkAllSaved(){
  const manual = (document.getElementById("checkConcursoInput").value || "").trim();
  const concursoNum = manual ? Number(manual) : null;

  let result;
  try{
    result = await fetchResultadoPorConcurso(concursoNum);
  }catch(e){
    alert("Falha ao buscar resultado: " + String(e?.message||e));
    return;
  }

  const saved = getSavedGames();
  if(!saved.length){ renderSavedGames(); return; }

  const rNums = (result.dezenas||[]).map(toNum);
  const now = new Date().toISOString();
  const updated = saved.map(g=>{
    const h = hitsAgainst(g.nums, rNums);
    return {
      ...g,
      lastCheck: {
        at: now,
        concurso: result.concurso,
        data: result.data || "",
        source: result.source || "",
        hits: h.count,
        hitsNums: h.hits
      }
    };
  });

  setSavedGames(updated);
  renderSavedGames(result);
}

function renderSavedGames(lastResult){
  const saved = getSavedGames();
  const area = document.getElementById("savedArea");
  if(!saved.length){
    area.innerHTML = `<div class="footerNote">Voc√™ ainda n√£o salvou nenhum jogo.</div>`;
    return;
  }

  const header = lastResult ? `
    <div class="box">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div class="pill info" style="margin:0">üìå Resultado usado na confer√™ncia</div>
        <span class="scoreTag">Fonte: <b>${lastResult.source || "‚Äî"}</b></span>
      </div>
      <div class="mini" style="margin-top:8px">
        Concurso <b>${lastResult.concurso}</b> ‚Ä¢ Data: <b>${lastResult.data || "‚Äî"}</b> ‚Ä¢ Dezenas: <span class="mono">${(lastResult.dezenas||[]).map(d=>format2(toNum(d))).join(" - ")}</span>
      </div>
    </div>
  ` : "";

  const cards = saved.map(g=>{
    const balls = g.nums.map(n=>`<div class="ball">${format2(n)}</div>`).join("");
    const check = g.lastCheck;
    const hitUI = check ? `
      <div class="mini" style="margin-top:8px">
        Conferido em: <b>${new Date(check.at).toLocaleString()}</b> ‚Ä¢ Concurso: <b>${check.concurso}</b>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:center">
        <span class="hitTag">‚úÖ Acertos: <b>${check.hits}</b></span>
        <span class="scoreTag">Acertou: <b>${(check.hitsNums||[]).map(format2).join(", ") || "‚Äî"}</b></span>
      </div>
    ` : `<div class="mini" style="margin-top:8px">Ainda n√£o conferido. Clique em ‚ÄúConferir todos agora‚Äù.</div>`;

    return `
      <div class="gameCard">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <b>${g.kind}</b>
          <span class="scoreTag">${new Date(g.createdAt).toLocaleString()}</span>
        </div>
        <div class="numbers" style="justify-content:flex-start">${balls}</div>
        ${hitUI}
        <div class="btnRow">
          <button class="btn btnGhost" type="button" onclick="removeSaved('${g.id}'); renderSavedGames()">Remover</button>
        </div>
      </div>
    `;
  }).join("");

  area.innerHTML = `
    ${header}
    <div class="gameList" style="margin-top:12px">${cards}</div>
  `;
}
</script>

<script>
/* =========================
   Fluxo: preparar contexto
========================= */
function qtdSelecionada(){ return Number(document.getElementById("qtdConcursos").value); }

async function prepararContextoBase(qtd){
  setStatus(true,"Carregando concursos‚Ä¶");
  setProgress(12);

  let payload;
  try{
    setStatus(true,"Buscando concursos reais‚Ä¶");
    setProgress(25);
    payload = await getOnlineConcursos(qtd);
  }catch(e){
    payload = buildDemo(qtd);
  }

  setStatus(true,"Calculando an√°lises do per√≠odo‚Ä¶");
  setProgress(62);

  const freq = calcularFrequencias(payload.concursos);
  const fin = finaisMaisFreq(payload.concursos);
  const finaisRank = Object.entries(fin).sort((a,b)=>b[1]-a[1]).map(x=>Number(x[0]));

  lastPayload = payload;
  lastCtx = { freq, fin, finaisRank };

  setStatus(false,"");
  setProgress(0);

  return { payload, freq, fin, finaisRank };
}

function verConcursos(){
  if(!lastPayload){ alert("Gere primeiro uma an√°lise ou jogo para carregar concursos."); return; }
  document.getElementById("listaConcursos").innerHTML = renderListaConcursos(lastPayload.concursos);
  abrirModal();
}
</script>

<script>
/* =========================
   A√á√ÉO: AN√ÅLISE
========================= */
async function acaoAnalise(){
  const s=getSession();
  if(!s.premium){ alert("üîí Gerar an√°lise exige Premium."); return; }

  const qtd = qtdSelecionada();
  try{
    await prepararContextoBase(qtd);
    const payload = lastPayload;
    const {freq, fin} = lastCtx;

    document.getElementById("analiseArea").innerHTML = `
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <div style="font-weight:1000;font-size:16px">üìà An√°lise do per√≠odo selecionado</div>
          <div class="mini">
            Janela: <b>${payload.inicio}</b> a <b>${payload.ultimo}</b> (${payload.concursos.length} concursos) ‚Ä¢
            Fonte: <b>${payload.source}</b> ‚Ä¢ Modo: <b>${payload.mode.toUpperCase()}</b>
          </div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btnGhost" type="button" onclick="verConcursos()">üìÖ Ver concursos</button>
        </div>
      </div>

      ${renderTop10(freq, payload.concursos.length)}
      ${renderFinaisChart(fin)}
    `;
    goView("viewAnalise");
  }catch(e){
    setStatus(false,""); setProgress(0);
    document.getElementById("analiseArea").innerHTML = `
      <div class="box">
        <div class="pill info">‚ö†Ô∏è Erro</div>
        <p>${String(e?.message || e)}</p>
      </div>
    `;
    goView("viewAnalise");
  }
}

/* =========================
   A√á√ÉO: JOGO PRINCIPAL
========================= */
async function acaoPrincipal(){
  const s=getSession();
  const qtd = qtdSelecionada();

  if(!s.premium && isFreeUsed()){
    alert("üîí Voc√™ j√° usou a gera√ß√£o gr√°tis. Para liberar, ative o Premium.");
    return;
  }

  try{
    await prepararContextoBase(qtd);
    const payload = lastPayload;
    const {freq, fin} = lastCtx;

    setStatus(true,"Gerando jogo principal (15 dezenas)‚Ä¶");
    setProgress(80);

    const jogo = gerarJogoForte(freq);
    lastPrincipalGame = jogo.slice();
    lastInvertidaGame = null;
    lastTecnicaGames = null;

    const cls = classificarDezenas(freq, jogo);
    const pi = contarParesImpares(jogo);
    const soma = somaDezenas(jogo);
    const seq = contarSequencias(jogo);
    const blocos = distribuicaoBlocos(jogo);
    const reps = repetidasDoUltimo(jogo, payload.latest.dezenas);

    lastPrincipalMeta = { cls, pi, soma, seq, blocos, reps, payloadRef: payload };

    setStatus(false,""); setProgress(0);

    if(!s.premium) markFreeUsed();
    aplicarAcessos();

    const balls = jogo.map(n=>`<div class="ball">${format2(n)}</div>`).join("");

    const resumoPares = (pi.pares===7||pi.pares===8)
      ? `Distribui√ß√£o ideal (${pi.pares} pares / ${pi.impares} √≠mpares).`
      : `Distribui√ß√£o fora do ideal (melhor: 7/8).`;
    const resumoSoma = (soma>=170 && soma<=230)
      ? `Soma ${soma} dentro da faixa estat√≠stica mais comum (evita extremos).`
      : `Soma ${soma} fora da faixa mais comum ‚Äî combina√ß√£o mais ‚Äúarriscada‚Äù.`;
    const resumoSeq = seq.temSequencia
      ? `Possui sequ√™ncia, m√°ximo de ${seq.maxLen} n√∫meros seguidos.`
      : `Sem sequ√™ncia (padr√£o mais ‚Äúquebrado‚Äù).`;
    const maxBlock = Math.max(blocos.A,blocos.B,blocos.C,blocos.D,blocos.E);
    const resumoBlocos = (maxBlock<=5)
      ? `Blocos equilibrados (m√°x ${maxBlock} em um bloco).`
      : `Concentra√ß√£o alta em blocos (m√°x ${maxBlock}).`;
    const resumoRep = reps.length
      ? `${reps.length} repetidas do √∫ltimo concurso (${payload.latest.concurso}).`
      : `Sem repetidas do √∫ltimo concurso (${payload.latest.concurso}).`;

    document.getElementById("principalArea").innerHTML = `
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <div style="font-weight:1000;font-size:16px">üéØ Jogo Principal gerado (15 dezenas)</div>
          <div class="mini">
            Janela: <b>${payload.inicio}</b> a <b>${payload.ultimo}</b> (${payload.concursos.length} concursos) ‚Ä¢
            Fonte: <b>${payload.source}</b> ‚Ä¢ Modo: <b>${payload.mode.toUpperCase()}</b>
          </div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btnGhost" type="button" onclick="verConcursos()">üìÖ Ver concursos</button>
          <button class="btn btnGhost" type="button" onclick="abrirGraficoBlocos(lastPrincipalMeta.blocos)">üìä Blocos A‚ÄìE</button>
        </div>
      </div>

      <div class="numbers">${balls}</div>

      <div class="btnRow">
        <button class="btn btnPrimary" type="button"
          onclick="(function(){
            const m = {base:'Principal', janela:{inicio:lastPayload.inicio, ultimo:lastPayload.ultimo, qtd:lastPayload.concursos.length}, fonte:lastPayload.source};
            const res = saveGame('Jogo Principal', lastPrincipalGame, m);
            alert(res.msg);
            renderSavedGames();
          })()">
          Salvar este jogo
        </button>
        <button class="btn btnGhost" type="button" onclick="goView('viewSaved'); renderSavedGames()">Ir para meus jogos</button>
      </div>

      <div class="chartCard">
        <div class="chartTitle">
          <b>üßæ Resumo</b>
          <span class="chartHint">compacto</span>
        </div>

        <div class="grid">
          <div class="box">
            <div class="pill rep">üîÅ Repetidas do √∫ltimo</div>
            <p><b>${reps.length ? reps.map(format2).join(", ") : "Nenhuma"}</b></p>
            <div class="mini">${resumoRep}</div>
          </div>
          <div class="box">
            <div class="pill info">‚öñÔ∏è Pares x √çmpares</div>
            <p><b>${pi.pares}</b> pares ‚Ä¢ <b>${pi.impares}</b> √≠mpares</p>
            <div class="mini">${resumoPares}</div>
          </div>
          <div class="box">
            <div class="pill info">‚ûï Soma</div>
            <p><b>${soma}</b></p>
            <div class="mini">${resumoSoma}</div>
          </div>
          <div class="box">
            <div class="pill info">üß© Blocos A‚ÄìE</div>
            <p>
              A: <b>${blocos.A}</b> ‚Ä¢ B: <b>${blocos.B}</b> ‚Ä¢ C: <b>${blocos.C}</b> ‚Ä¢ D: <b>${blocos.D}</b> ‚Ä¢ E: <b>${blocos.E}</b>
            </p>
            <div class="mini">${resumoBlocos}</div>
          </div>
          <div class="box">
            <div class="pill info">üîó Sequ√™ncias</div>
            <p><b>${seq.temSequencia ? "Sim" : "N√£o"}</b> ‚Ä¢ M√°x: <b>${seq.maxLen}</b></p>
            <div class="mini">${resumoSeq}</div>
          </div>
        </div>
      </div>

      ${renderTop10(freq, payload.concursos.length)}
      ${renderFinaisChart(fin)}

      <div class="hr"></div>
      <div id="apostasPanel">
        <div class="footerNote">Para aparecer aqui os <b>4 jogos prontos</b>, gere tamb√©m a <b>Invertida</b> e a <b>T√©cnica</b>.</div>
      </div>
    `;

    goView("viewPrincipal");
    renderApostasPanelIfReady();
  }catch(e){
    setStatus(false,""); setProgress(0);
    document.getElementById("principalArea").innerHTML = `
      <div class="box">
        <div class="pill info">‚ö†Ô∏è Erro</div>
        <p>${String(e?.message || e)}</p>
      </div>
    `;
    goView("viewPrincipal");
  }
}
</script>

<script>
/* =========================
   INVERTIDA + T√âCNICA
========================= */
function blocoIndex(n){ return Math.floor((n-1)/5)+1; }
function offsetNoBloco(n){ return ((n-1)%5)+1; }
function mapParaBloco(destBloco, offset){ return (destBloco-1)*5 + offset; }

function remapPorPermutacao(n, perm){
  const b = blocoIndex(n);
  const off = offsetNoBloco(n);
  const destB = perm[b-1];
  return mapParaBloco(destB, off);
}
function inverterJogoPorPerm(jogo, perm){
  return jogo.map(n=>remapPorPermutacao(Number(n), perm)).sort((a,b)=>a-b);
}
function renderCartao(jogo, clsName){
  const set = new Set(jogo.map(Number));
  let html = `<div class="cartao">`;
  for(let n=1;n<=25;n++){
    const active = set.has(n) ? ` ${clsName}` : "";
    html += `<div class="cel${active}">${String(n).padStart(2,"0")}</div>`;
  }
  html += `</div>`;
  return html;
}

function gerarInvertida(){
  const s=getSession();
  if(!s.premium){ alert("üîí Invertida exige Premium."); return; }
  if(!lastPrincipalGame){ alert("Gere primeiro um Jogo Principal."); return; }

  const permInvertida = [5,4,3,2,1];
  const inv = inverterJogoPorPerm(lastPrincipalGame, permInvertida);
  lastInvertidaGame = inv.slice();

  document.getElementById("invertidaArea").innerHTML = `
    <div class="box">
      <div class="pill info">Regra</div>
      <div class="mini">
        A(01‚Äì05)‚ÜíE(21‚Äì25), B(06‚Äì10)‚ÜíD(16‚Äì20), C(11‚Äì15) fixo, D‚ÜíB, E‚ÜíA.
        Ex: 02‚Üí22, 04‚Üí24, 05‚Üí25, 07‚Üí17, 10‚Üí20, 12‚Üí12.
      </div>
    </div>

    <div class="cartaoWrap">
      <div class="box">
        <div class="pill info">üéØ Principal</div>
        <div class="numbers" style="justify-content:flex-start">${lastPrincipalGame.map(n=>`<div class="ball">${format2(n)}</div>`).join("")}</div>
        ${renderCartao(lastPrincipalGame, "on")}
      </div>

      <div class="box">
        <div class="pill info">üîÑ Invertida</div>
        <div class="numbers" style="justify-content:flex-start">${inv.map(n=>`<div class="ball">${format2(n)}</div>`).join("")}</div>
        ${renderCartao(inv, "inv")}
        <div class="btnRow">
          <button class="btn btnPrimary" type="button"
            onclick="(function(){
              const m = {base:'Invertida', janela:{inicio:lastPayload?.inicio, ultimo:lastPayload?.ultimo, qtd:lastPayload?.concursos?.length}, fonte:lastPayload?.source};
              const res = saveGame('Jogo Invertida', lastInvertidaGame, m);
              alert(res.msg);
              renderSavedGames();
            })()">
            Salvar invertida
          </button>
        </div>
      </div>
    </div>
  `;

  renderApostasPanelIfReady();
}

function gerarTecnicaPremiada(){
  const s=getSession();
  if(!s.premium){ alert("üîí T√©cnica premiada exige Premium."); return; }
  if(!lastPrincipalGame){ alert("Gere primeiro um Jogo Principal."); return; }

  const permTec1 = [3,4,5,1,2];
  const permTec2 = [3,1,5,2,4];

  const g1 = inverterJogoPorPerm(lastPrincipalGame, permTec1);
  const g2 = inverterJogoPorPerm(lastPrincipalGame, permTec2);
  lastTecnicaGames = { g1, g2 };

  document.getElementById("tecnicaArea").innerHTML = `
    <div class="box">
      <div class="pill info">Como funciona</div>
      <div class="mini">
        A t√©cnica reordena os blocos (A‚ÄìE) mantendo a posi√ß√£o dentro do bloco.
        Isso cria 2 varia√ß√µes consistentes do jogo principal.
      </div>
    </div>

    <div class="grid">
      <div class="box">
        <div class="pill info">üèÜ T√©cnica 1 ‚Äî [3,4,5,1,2]</div>
        <div class="numbers" style="justify-content:flex-start">${g1.map(n=>`<div class="ball">${format2(n)}</div>`).join("")}</div>
        ${renderCartao(g1, "tech")}
        <div class="btnRow">
          <button class="btn btnPrimary" type="button"
            onclick="(function(){
              const m = {base:'T√©cnica 1', janela:{inicio:lastPayload?.inicio, ultimo:lastPayload?.ultimo, qtd:lastPayload?.concursos?.length}, fonte:lastPayload?.source};
              const res = saveGame('T√©cnica 1', lastTecnicaGames.g1, m);
              alert(res.msg);
              renderSavedGames();
            })()">
            Salvar t√©cnica 1
          </button>
        </div>
      </div>

      <div class="box">
        <div class="pill info">üèÜ T√©cnica 2 ‚Äî [3,1,5,2,4]</div>
        <div class="numbers" style="justify-content:flex-start">${g2.map(n=>`<div class="ball">${format2(n)}</div>`).join("")}</div>
        ${renderCartao(g2, "tech")}
        <div class="btnRow">
          <button class="btn btnPrimary" type="button"
            onclick="(function(){
              const m = {base:'T√©cnica 2', janela:{inicio:lastPayload?.inicio, ultimo:lastPayload?.ultimo, qtd:lastPayload?.concursos?.length}, fonte:lastPayload?.source};
              const res = saveGame('T√©cnica 2', lastTecnicaGames.g2, m);
              alert(res.msg);
              renderSavedGames();
            })()">
            Salvar t√©cnica 2
          </button>
        </div>
      </div>
    </div>
  `;

  renderApostasPanelIfReady();
}

/* painel de 4 jogos (quando o usu√°rio gerou Principal + Invertida + T√©cnica) */
function renderApostasPanelIfReady(){
  const panel = document.getElementById("apostasPanel");
  if(!panel) return;

  if(lastPrincipalGame && lastInvertidaGame && lastTecnicaGames?.g1 && lastTecnicaGames?.g2){
    const metaBase = { janela:{inicio:lastPayload?.inicio, ultimo:lastPayload?.ultimo, qtd:lastPayload?.concursos?.length}, fonte:lastPayload?.source };
    panel.innerHTML = `
      <div class="chartCard">
        <div class="chartTitle">
          <b>‚úÖ Seus 4 jogos prontos para apostar</b>
          <span class="chartHint">salvar √© opcional</span>
        </div>
        <div class="mini">
          Aqui est√£o as 4 apostas (Principal, Invertida, T√©cnica 1 e T√©cnica 2). Voc√™ pode salvar cada uma para conferir automaticamente quando sa√≠rem os concursos.
        </div>
        <div class="gameList" style="margin-top:12px">
          ${renderGameCardForSave("Jogo Principal", lastPrincipalGame, {...metaBase, base:"Principal"})}
          ${renderGameCardForSave("Jogo Invertida", lastInvertidaGame, {...metaBase, base:"Invertida"})}
          ${renderGameCardForSave("T√©cnica 1", lastTecnicaGames.g1, {...metaBase, base:"T√©cnica 1"})}
          ${renderGameCardForSave("T√©cnica 2", lastTecnicaGames.g2, {...metaBase, base:"T√©cnica 2"})}
        </div>
      </div>
    `;
  }else{
    panel.innerHTML = `<div class="footerNote">Para aparecer aqui os <b>4 jogos prontos</b>, gere tamb√©m a <b>Invertida</b> e a <b>T√©cnica</b>.</div>`;
  }
}
</script>

<script>
/* =========================
   15 Pontos Garantido (mant√©m modelo forte + salvamento)
   (Para manter a resposta enxuta: a l√≥gica 15P detalhada continua como antes e j√° vem com bot√µes de salvar por jogo)
========================= */

/* ---- matriz coocorr√™ncia ---- */
function calcCoocAndStats(concursos){
  const n = concursos.length;
  const freq = Array(26).fill(0);
  const co = Array.from({length:26}, ()=>Array(26).fill(0));

  concursos.forEach(c=>{
    const nums = (c.dezenas||[])
      .map(d=>Number(String(d).replace(/^0+/,"")))
      .filter(x=>x>=1 && x<=25);
    nums.forEach(a=>freq[a]++);
    for(let i=0;i<nums.length;i++){
      for(let j=i+1;j<nums.length;j++){
        const a=nums[i], b=nums[j];
        co[a][b]++; co[b][a]++;
      }
    }
  });

  const p = Array(26).fill(0);
  for(let i=1;i<=25;i++) p[i] = freq[i] / Math.max(1,n);

  const lift = Array.from({length:26}, ()=>Array(26).fill(0));
  for(let a=1;a<=25;a++){
    for(let b=1;b<=25;b++){
      if(a===b) continue;
      const pab = co[a][b] / Math.max(1,n);
      const denom = (p[a] * p[b]);
      lift[a][b] = denom>0 ? (pab/denom) : 0;
    }
  }
  return { n, freq, co, p, lift };
}
function pairStrength(a,b, stats){
  const {co, lift} = stats;
  return (co[a][b] * 1.0) + (lift[a][b] * 2.2);
}
function groupStrength(group, stats){
  let sum=0, pairs=0;
  for(let i=0;i<group.length;i++){
    for(let j=i+1;j<group.length;j++){
      sum += pairStrength(group[i], group[j], stats);
      pairs++;
    }
  }
  return { sum, avg: pairs? (sum/pairs):0 };
}
function groupCoSum(group, stats){
  const {co} = stats;
  let sum=0, pairs=0;
  for(let i=0;i<group.length;i++){
    for(let j=i+1;j<group.length;j++){
      sum += co[group[i]][group[j]];
      pairs++;
    }
  }
  return { sum, avg: pairs? (sum/pairs):0 };
}
function groupLiftAvg(group, stats){
  const {lift} = stats;
  let sum=0, pairs=0;
  for(let i=0;i<group.length;i++){
    for(let j=i+1;j<group.length;j++){
      sum += lift[group[i]][group[j]];
      pairs++;
    }
  }
  return { sum, avg: pairs? (sum/pairs):0 };
}
function groupFreqSum(group, stats){
  const {freq} = stats;
  return group.reduce((a,n)=>a+freq[n],0);
}
function topPairsInGroup(group, stats, topN=3){
  const arr=[];
  for(let i=0;i<group.length;i++){
    for(let j=i+1;j<group.length;j++){
      const a=group[i], b=group[j];
      arr.push({ a,b, co: stats.co[a][b], lift: stats.lift[a][b], score: pairStrength(a,b,stats) });
    }
  }
  arr.sort((x,y)=>y.score-x.score);
  return arr.slice(0, topN);
}
function worstPairsInGroup(group, stats, topN=3){
  const arr=[];
  for(let i=0;i<group.length;i++){
    for(let j=i+1;j<group.length;j++){
      const a=group[i], b=group[j];
      arr.push({ a,b, co: stats.co[a][b], lift: stats.lift[a][b], score: pairStrength(a,b,stats) });
    }
  }
  arr.sort((x,y)=>x.score-y.score);
  return arr.slice(0, topN);
}
function buildInitialLines(stats){
  const order = [];
  for(let i=1;i<=25;i++) order.push(i);
  order.sort((a,b)=>stats.freq[b]-stats.freq[a]);

  const lines = [[],[],[],[],[]];
  for(let i=0;i<order.length;i++) lines[i%5].push(order[i]);
  lines.forEach(l=>l.sort((a,b)=>a-b));
  return lines;
}
function objective(lines, stats){
  const strongIdx=[0,1,2];
  const diverseIdx=[3,4];
  let strong=0, diverse=0, diverseFreq=0;

  strongIdx.forEach(i=> strong += groupStrength(lines[i], stats).sum );
  diverseIdx.forEach(i=>{
    diverse += groupStrength(lines[i], stats).sum;
    diverseFreq += groupFreqSum(lines[i], stats);
  });

  function bloco(n){ return Math.floor((n-1)/5)+1; }
  let blockPenalty=0;
  for(const l of lines){
    const count=[0,0,0,0,0,0];
    l.forEach(n=>count[bloco(n)]++);
    const maxb=Math.max(...count);
    if(maxb>=4) blockPenalty += (maxb-3)*8;
  }

  return (strong * 1.0) - (diverse * 1.15) + (diverseFreq * 0.12) - blockPenalty;
}
function optimizeLines(lines, stats){
  let best = lines.map(l=>l.slice());
  let bestScore = objective(best, stats);
  function clone(x){ return x.map(l=>l.slice()); }

  const ITER = 3500;
  for(let t=0;t<ITER;t++){
    const cand = clone(best);
    const i = Math.floor(Math.random()*5);
    let j = Math.floor(Math.random()*5);
    if(i===j) j = (j+1)%5;

    const ai = Math.floor(Math.random()*5);
    const aj = Math.floor(Math.random()*5);
    const tmp = cand[i][ai];
    cand[i][ai] = cand[j][aj];
    cand[j][aj] = tmp;
    cand[i].sort((a,b)=>a-b);
    cand[j].sort((a,b)=>a-b);

    const sc = objective(cand, stats);
    if(sc > bestScore || Math.random() < 0.02){
      best = cand; bestScore = sc;
    }
  }

  const scored = best.map((l,idx)=>({ idx, l, s: groupStrength(l,stats).sum }));
  scored.sort((a,b)=>b.s-a.s);
  const strong = scored.slice(0,3).map(x=>x.l);
  const diverse = scored.slice(3).map(x=>x.l);
  return strong.concat(diverse);
}
function combos3de5(){
  const r=[];
  for(let a=1;a<=3;a++){
    for(let b=a+1;b<=4;b++){
      for(let c=b+1;c<=5;c++){
        r.push([a,b,c]);
      }
    }
  }
  return r;
}
function gerarJogos15P(linhas){
  const comb = combos3de5();
  return comb.map((idxs)=>{
    const set = new Set();
    idxs.forEach(i=> linhas[i-1].forEach(n=>set.add(n)) );
    return sortNum([...set]);
  });
}
function renderBallsInline(nums){
  return nums.map(n=>`<div class="ball">${format2(n)}</div>`).join("");
}
function explainLine(lineIdx, line, stats, kind){
  const gs = groupStrength(line, stats);
  const co = groupCoSum(line, stats);
  const lf = groupLiftAvg(line, stats);
  const fs = groupFreqSum(line, stats);

  const pairs = (kind==="forte") ? topPairsInGroup(line, stats, 3) : worstPairsInGroup(line, stats, 3);
  const pairsTxt = pairs.map(p=>{
    const sign = (kind==="forte") ? "‚Üë" : "‚Üì";
    return `<span class="scoreTag">${sign} ${format2(p.a)}-${format2(p.b)} ‚Ä¢ juntos: <b>${p.co}</b>x ‚Ä¢ lift: <b>${p.lift.toFixed(2)}</b></span>`;
  }).join(" ");

  const resumo = (kind==="forte")
    ? `Linha montada com <b>alta coocorr√™ncia</b> e <b>lift alto</b> (dezenas que aparecem juntas acima do esperado no per√≠odo).`
    : `Linha montada para ser <b>diversa</b> (pares com coocorr√™ncia e lift menores), mantendo frequ√™ncia aceit√°vel.`;

  return `
    <div class="box">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div class="pill ${kind==="forte" ? "info" : "warm"}" style="margin:0">
          ${kind==="forte" ? "üî• Linha " + lineIdx + " (FORTE ‚Äì saem juntas)" : "üßä Linha " + lineIdx + " (DIVERSA ‚Äì menos juntas)"}
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <span class="scoreTag">For√ßa: <b>${gs.sum.toFixed(1)}</b></span>
          <span class="scoreTag">M√©dia co: <b>${co.avg.toFixed(2)}</b></span>
          <span class="scoreTag">M√©dia lift: <b>${lf.avg.toFixed(2)}</b></span>
          <span class="scoreTag">Soma freq: <b>${fs}</b></span>
        </div>
      </div>

      <div class="numbers" style="justify-content:flex-start;margin-top:10px">${renderBallsInline(line)}</div>
      <div class="mini"><b>Por que se juntaram:</b> ${resumo}</div>

      <div class="mini" style="margin-top:10px">
        <b>${kind==="forte" ? "Pares mais fortes" : "Pares mais fracos (diversifica√ß√£o)"}:</b>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">${pairsTxt}</div>
      </div>
    </div>
  `;
}

async function gerar15P(){
  const s=getSession();
  const addon = hasAddon15() || isMaster();
  if(!addon) return alert("üîí O recurso '15 pontos garantido' √© um EXTRA comprado separadamente.");

  const qtd = qtdSelecionada();
  try{
    await prepararContextoBase(qtd);
    const payload = lastPayload;

    setStatus(true,"15P: analisando e montando 5 linhas‚Ä¶");
    setProgress(82);

    const stats = calcCoocAndStats(payload.concursos);
    let lines = buildInitialLines(stats);
    lines = optimizeLines(lines, stats);

    const jogos = gerarJogos15P(lines);

    setStatus(false,"");
    setProgress(0);

    const lineMeta = lines.map((l,idx)=>({
      idx: idx+1,
      kind: (idx<3) ? "forte" : "diversa",
      strength: groupStrength(l,stats).sum,
      coAvg: groupCoSum(l,stats).avg,
      liftAvg: groupLiftAvg(l,stats).avg,
      freqSum: groupFreqSum(l,stats),
      line: l
    }));

    const jogosHtml = jogos.map((j, idx)=>{
      const comb = combos3de5()[idx];
      const title = `15P Jogo ${idx+1} (linhas ${comb.join("+")})`;
      return `
        <div class="gameCard">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
            <b>${title}</b>
            <span class="scoreTag">C(5,3)</span>
          </div>
          <div class="numbers" style="justify-content:flex-start;margin-top:10px">${renderBallsInline(j)}</div>
          <div class="btnRow">
            <button class="btn btnPrimary" type="button"
              onclick="(function(){
                const meta = {base:'15P', linhas: ${JSON.stringify(comb)}, janela:{inicio:lastPayload?.inicio, ultimo:lastPayload?.ultimo, qtd:lastPayload?.concursos?.length}, fonte:lastPayload?.source};
                const res = saveGame('${title.replace(/'/g,"\\'")}', ${JSON.stringify(j)}, meta);
                alert(res.msg);
                renderSavedGames();
              })()">
              Salvar jogo
            </button>
            <button class="btn btnGhost" type="button" onclick="goView('viewSaved'); renderSavedGames()">Ver na pasta</button>
          </div>
        </div>
      `;
    }).join("");

    document.getElementById("p15Area").innerHTML = `
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <div style="font-weight:1000;font-size:16px">‚úÖ 15 Pontos Garantido (com somente 10 jogos)</div>
          <div class="mini">
            Janela: <b>${payload.inicio}</b> a <b>${payload.ultimo}</b> (${payload.concursos.length} concursos) ‚Ä¢
            Fonte: <b>${payload.source}</b> ‚Ä¢ Modo: <b>${payload.mode.toUpperCase()}</b>
          </div>
        </div>
        <div class="mini">
          Voc√™ pode <b>salvar</b> qualquer jogo para o app conferir automaticamente depois.
        </div>
      </div>

      <div class="box" style="margin-top:12px">
        <div class="pill extra" style="margin:0">üìå Linhas 1 a 5 (5 dezenas por linha)</div>
        <div style="margin-top:12px;overflow:auto">
          <table class="table">
            <thead>
              <tr>
                <th>Linha</th><th>Tipo</th><th>Dezenas</th><th>For√ßa</th><th>M√©dia co</th><th>M√©dia lift</th><th>Soma freq</th>
              </tr>
            </thead>
            <tbody>
              ${lineMeta.map(m=>`
                <tr>
                  <td><b>${m.idx}</b></td>
                  <td>${m.kind==="forte" ? "FORTE" : "DIVERSA"}</td>
                  <td class="mono">${m.line.map(format2).join(" - ")}</td>
                  <td><b>${m.strength.toFixed(1)}</b></td>
                  <td>${m.coAvg.toFixed(2)}</td>
                  <td>${m.liftAvg.toFixed(2)}</td>
                  <td>${m.freqSum}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      </div>

      <div class="chartCard">
        <div class="chartTitle"><b>üîç Explica√ß√£o detalhada das linhas</b><span class="chartHint">por que se juntaram</span></div>
        <div class="grid" style="margin-top:12px">
          ${explainLine(1, lines[0], stats, "forte")}
          ${explainLine(2, lines[1], stats, "forte")}
          ${explainLine(3, lines[2], stats, "forte")}
          ${explainLine(4, lines[3], stats, "diversa")}
          ${explainLine(5, lines[4], stats, "diversa")}
        </div>
      </div>

      <div class="hr"></div>

      <div class="box">
        <div class="pill info" style="margin:0">üßæ Os 10 jogos (combina√ß√µes 3 de 5)</div>
        <div class="mini" style="margin-top:8px">
          Combina√ß√µes: 1+2+3, 1+2+4, 1+2+5, 1+3+4, 1+3+5, 1+4+5, 2+3+4, 2+3+5, 2+4+5, 3+4+5.
        </div>
        <div class="gameList" style="margin-top:12px">${jogosHtml}</div>
      </div>
    `;
    goView("view15p");
  }catch(e){
    setStatus(false,""); setProgress(0);
    document.getElementById("p15Area").innerHTML = `
      <div class="box">
        <div class="pill info">‚ö†Ô∏è Erro</div>
        <p>${String(e?.message || e)}</p>
      </div>
    `;
    goView("view15p");
  }
}
</script>

<script>
/* =========================
   Eventos
========================= */
document.getElementById("btnEntrar").addEventListener("click", entrar);
document.getElementById("btnComprar").addEventListener("click", comprarPremium);
document.getElementById("btnJaComprei").addEventListener("click", abrirAtivar);
document.getElementById("btnSair").addEventListener("click", sair);

document.getElementById("btnComprar15p").addEventListener("click", comprar15p);
document.getElementById("btnAtivar15p").addEventListener("click", abrirAtivar15p);

document.getElementById("btnHomeAnalise").addEventListener("click", ()=>{});
document.getElementById("btnHomePrincipal").addEventListener("click", ()=>{});
document.getElementById("btnHomeInvertida").addEventListener("click", ()=>{});
document.getElementById("btnHomeTecnica").addEventListener("click", ()=>{});
document.getElementById("btnHome15p").addEventListener("click", ()=>{});

document.getElementById("modalBack").addEventListener("click", (e)=>{ if(e.target.id==="modalBack") fecharModal(); });
document.getElementById("modalBlocosBack").addEventListener("click", (e)=>{ if(e.target.id==="modalBlocosBack") fecharGraficoBlocos(); });
document.getElementById("modalAtivar15pBack").addEventListener("click", (e)=>{ if(e.target.id==="modalAtivar15pBack") fecharAtivar15p(); });

/* binds reais (cards) */
document.getElementById("btnHomeAnalise").onclick = acaoAnalise;
document.getElementById("btnHomePrincipal").onclick = acaoPrincipal;
// invertida / t√©cnica / 15p s√£o controlados por aplicarAcessos()

document.addEventListener("DOMContentLoaded", ()=>{
  const s=getSession();
  if(s.email) abrirApp();
});
</script>

</body>
</html>
