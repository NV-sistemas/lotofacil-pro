<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Lotof√°cil Prime Analytics</title>

<style>
  :root{
    --bg1:#020617; --bg2:#0f172a;
    --card:#071023; --card2:#061028;
    --text:#e5e7eb; --muted:#94a3b8;
    --green:#22c55e; --green2:#16a34a;
    --yellow:#facc15; --blue:#38bdf8; --red:#fb7185;
  }
  *{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
  body{margin:0;color:var(--text);background:linear-gradient(135deg,var(--bg1),var(--bg2));min-height:100vh}

  .center{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:18px}
  .login{
    width:100%;max-width:420px;
    background:linear-gradient(180deg,var(--card),rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.06);
    border-radius:18px;padding:22px;
    box-shadow:0 30px 80px rgba(0,0,0,.55);
  }
  .brand{text-align:center;font-weight:900;letter-spacing:.5px;font-size:18px}
  .brand small{display:block;color:var(--muted);font-weight:600;margin-top:6px}

  input, select{
    width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.10);
    background:#020617;color:var(--text);outline:none;margin-top:12px;
  }

  button{
    width:100%;margin-top:12px;padding:13px 14px;border:none;border-radius:12px;
    background:linear-gradient(135deg,var(--green),var(--green2));
    color:#022c22;font-weight:900;cursor:pointer;transition:.15s;
  }
  button:hover{filter:brightness(1.05);transform:translateY(-1px)}
  button.secondary{background:transparent;border:1px solid rgba(255,255,255,.12);color:var(--text)}
  button.danger{background:linear-gradient(135deg,#fb7185,#ef4444);color:#2b0b0b}
  button:disabled{opacity:.55;cursor:not-allowed;transform:none}

  .msg{
    margin-top:12px;
    padding:12px;border-radius:14px;
    background:rgba(56,189,248,.08);
    border:1px solid rgba(56,189,248,.18);
    color:#cdefff;font-size:13px;font-weight:700;
    display:none;
  }
  .msg.err{
    background:rgba(251,113,133,.10);
    border:1px solid rgba(251,113,133,.25);
    color:#ffd3da;
  }

  #app{display:none;max-width:1100px;margin:0 auto;padding:18px}
  .header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:14px}
  .title{font-size:20px;font-weight:900;margin:0}
  .subtitle{margin:6px 0 0;color:var(--muted);font-size:13px;font-weight:600}
  .chip{
    display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:999px;
    background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.07);
    color:var(--muted);font-size:12px;font-weight:700;
  }

  .card{
    background:linear-gradient(180deg,var(--card2),rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.06);
    border-radius:18px;padding:16px;
    box-shadow:0 18px 50px rgba(0,0,0,.35);
    margin-bottom:14px;
  }
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
  label{display:block;font-size:12px;color:var(--muted);font-weight:800;margin-bottom:6px}
  .col{flex:1;min-width:240px}

  .status{
    display:none;margin-top:10px;padding:12px;border-radius:14px;
    background:rgba(56,189,248,.08);border:1px solid rgba(56,189,248,.18);
    color:#cdefff;font-size:13px;font-weight:700;
  }
  .bar{height:10px;border-radius:999px;overflow:hidden;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.06);margin-top:10px}
  .bar>div{height:100%;width:0%;background:linear-gradient(90deg,var(--blue),var(--green));transition:width .2s ease}

  .numbers{text-align:center;color:var(--green);font-weight:900;letter-spacing:1px;font-size:18px;margin:10px 0 4px}
  .range{text-align:center;color:var(--muted);font-size:13px;font-weight:700;margin:0 0 10px}

  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin-top:10px}
  .box{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:12px}
  .box p{margin:0;color:var(--text);font-size:13px;line-height:1.45}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:900;margin-bottom:8px}
  .pill.hot{background:rgba(34,197,94,.15);color:var(--green);border:1px solid rgba(34,197,94,.25)}
  .pill.warm{background:rgba(250,204,21,.12);color:var(--yellow);border:1px solid rgba(250,204,21,.25)}
  .pill.cold{background:rgba(251,113,133,.12);color:var(--red);border:1px solid rgba(251,113,133,.25)}
  .pill.info{background:rgba(56,189,248,.10);color:var(--blue);border:1px solid rgba(56,189,248,.22)}
  .pill.rep{background:rgba(34,197,94,.10);color:#7CFFB0;border:1px solid rgba(34,197,94,.20)}
  .mini{color:var(--muted);font-size:12px;margin-top:8px;line-height:1.4}
  .footerNote{text-align:center;color:var(--muted);font-size:11px;margin-top:10px}

  .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}
  .actions button{width:auto;min-width:240px}

  .chartCard{
    margin-top:12px;
    background:rgba(255,255,255,.03);
    border:1px solid rgba(255,255,255,.08);
    border-radius:16px;
    padding:14px;
  }
  .chartTitle{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}
  .chartTitle b{font-size:13px}
  .chartHint{color:var(--muted);font-size:12px;font-weight:800}
  .chartRow{display:flex;align-items:center;gap:10px;margin:10px 0}
  .chartLabel{width:70px;color:var(--text);font-weight:900}
  .chartBarWrap{flex:1;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10);border-radius:999px;overflow:hidden;height:16px}
  .chartBar{height:100%;width:0%;background:linear-gradient(90deg,var(--blue),var(--green))}
  .chartVal{width:56px;text-align:right;color:var(--text);font-weight:900}

  /* Modais */
  .modalBack{display:none;position:fixed;inset:0;background:rgba(0,0,0,.60);backdrop-filter: blur(6px);align-items:center;justify-content:center;padding:16px;z-index:999}
  .modal{width:100%;max-width:900px;background:linear-gradient(180deg,var(--card),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.10);border-radius:18px;box-shadow:0 40px 120px rgba(0,0,0,.65);overflow:hidden}
  .modalHeader{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08)}
  .modalHeader b{font-size:14px}
  .closeBtn{width:auto;min-width:auto;padding:8px 10px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,.14);color:var(--text);cursor:pointer}
  .modalBody{padding:14px 16px}

  .table{width:100%;border-collapse:collapse;font-size:13px}
  .table th,.table td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;vertical-align:top}
  .table th{color:var(--muted);font-weight:900;font-size:12px}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="center" id="loginWrap">
  <div class="login">
    <div class="brand">üéØ LOTOF√ÅCIL PRIME ANALYTICS
      <small>Sistema avan√ßado de an√°lise estat√≠stica</small>
    </div>

    <input id="email" type="email" placeholder="Email" />
    <input id="senha" type="password" placeholder="Senha (m√≠n. 6)" />

    <button id="btnEntrar" type="button">Entrar / Criar conta</button>
    <button id="btnSairLogin" class="secondary" type="button" style="display:none">Sair</button>

    <div id="msgOk" class="msg"></div>
    <div id="msgErr" class="msg err"></div>

    <div class="footerNote">
      Dica: se o email n√£o existir, o sistema cria automaticamente.
    </div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="header">
    <div>
      <div class="title">üéØ LOTOF√ÅCIL PRIME ANALYTICS</div>
      <div class="subtitle">Escolha a janela de concursos e gere um jogo com explica√ß√µes completas.</div>
    </div>
    <div class="chip" id="chipUser">üë§ N√£o logado</div>
  </div>

  <div class="card" id="premiumGate" style="display:none">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div>
        <div style="font-weight:900;font-size:16px">üîí √Årea Premium</div>
        <div class="mini">Para gerar an√°lises reais e jogos avan√ßados, ative o Premium.</div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="danger" id="btnComprar" type="button">Comprar Premium</button>
        <button class="secondary" id="btnSair" type="button" style="width:auto;min-width:auto;padding:10px 12px;border-radius:10px">Sair</button>
      </div>
    </div>
    <div class="mini" style="margin-top:10px">
      Se voc√™ for o dono, eu te mostro como ativar seu Premium em 2 cliques.
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div class="col">
        <label>Quantidade de concursos para an√°lise</label>
        <select id="qtdConcursos">
          <option value="5">√öltimos 5 concursos</option>
          <option value="10" selected>√öltimos 10 concursos</option>
          <option value="15">√öltimos 15 concursos</option>
          <option value="20">√öltimos 20 concursos</option>
          <option value="25">√öltimos 25 concursos</option>
          <option value="50">√öltimos 50 concursos</option>
          <option value="75">√öltimos 75 concursos</option>
          <option value="100">√öltimos 100 concursos</option>
        </select>
      </div>

      <div class="col">
        <label>Gerar jogo com base nos concursos reais</label>
        <button id="btnGerar" type="button">üìä Gerar Jogo + An√°lise</button>
        <button id="btnLimpar" class="secondary" type="button">üßπ Limpar cache (se der erro)</button>
      </div>
    </div>

    <div id="status" class="status">
      <div id="statusText">Carregando‚Ä¶</div>
      <div class="bar"><div id="barFill"></div></div>
    </div>
  </div>

  <div class="card" id="resultado">
    <div class="footerNote">Selecione a quantidade de concursos e clique em ‚ÄúGerar‚Äù.</div>
  </div>

  <div class="footerNote">Aviso: an√°lise estat√≠stica n√£o garante premia√ß√£o. Jogo respons√°vel ‚úÖ</div>
</div>

<!-- MODAL LISTA -->
<div id="modalBack" class="modalBack">
  <div class="modal">
    <div class="modalHeader">
      <b>üìå Concursos analisados (com datas e dezenas)</b>
      <button class="closeBtn" onclick="fecharModal()">Fechar</button>
    </div>
    <div class="modalBody">
      <div id="listaConcursos"></div>
    </div>
  </div>
</div>

<!-- MODAL GRAFICO BLOCOS -->
<div id="modalBlocosBack" class="modalBack">
  <div class="modal" style="max-width:520px">
    <div class="modalHeader">
      <b>üìä Gr√°fico de Blocos (A‚ÄìE)</b>
      <button class="closeBtn" onclick="fecharGraficoBlocos()">Fechar</button>
    </div>
    <div class="modalBody">
      <div id="graficoBlocosArea"></div>
      <div class="mini" style="margin-top:10px">
        Interpreta√ß√£o: quantas dezenas do seu jogo ca√≠ram em cada faixa.
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   MUDE AQUI (1 linha)
========================= */
const API_BASE = "https://shy-silence-06b9.nvtranspelogistica.workers.dev"; // <-- TROQUE PELO SEU WORKER

/* =========================
   API helpers
========================= */
async function apiPost(path, data, extraHeaders={}){
  const r = await fetch(API_BASE + path, {
    method:"POST",
    headers:{ "Content-Type":"application/json", ...extraHeaders },
    body: JSON.stringify(data || {})
  });
  const j = await r.json().catch(()=> ({}));
  if(!r.ok) throw new Error(j?.error || ("HTTP " + r.status));
  return j;
}
async function apiGet(path, extraHeaders={}){
  const r = await fetch(API_BASE + path, { headers:{ ...extraHeaders } });
  const j = await r.json().catch(()=> ({}));
  if(!r.ok) throw new Error(j?.error || ("HTTP " + r.status));
  return j;
}

/* =========================
   UI msg
========================= */
function showOk(text){
  const el=document.getElementById("msgOk");
  el.style.display="block"; el.textContent=text;
  document.getElementById("msgErr").style.display="none";
}
function showErr(text){
  const el=document.getElementById("msgErr");
  el.style.display="block"; el.textContent=text;
  document.getElementById("msgOk").style.display="none";
}
function clearMsgs(){
  document.getElementById("msgOk").style.display="none";
  document.getElementById("msgErr").style.display="none";
}

/* =========================
   Sess√£o
========================= */
function setSession(email, premium){
  localStorage.setItem("lf_email", email);
  localStorage.setItem("lf_premium", premium ? "1":"0");
}
function clearSession(){
  localStorage.removeItem("lf_email");
  localStorage.removeItem("lf_premium");
}
function getSession(){
  return {
    email: localStorage.getItem("lf_email") || "",
    premium: localStorage.getItem("lf_premium")==="1"
  };
}

/* =========================
   Login real (register+login)
========================= */
async function entrarOuCriar(){
  clearMsgs();
  const email = (document.getElementById("email").value || "").trim().toLowerCase();
  const senha = (document.getElementById("senha").value || "");
  if(!email || !senha || senha.length < 6){
    showErr("Digite email e senha (m√≠nimo 6 caracteres).");
    return;
  }

  const btn = document.getElementById("btnEntrar");
  btn.disabled = true;

  try{
    // 1) tenta login
    let res;
    try{
      res = await apiPost("/login", { email, password: senha });
      // ok
      showOk("Login realizado ‚úÖ");
    }catch(e){
      // 2) se falhar, cria conta e tenta login de novo
      await apiPost("/register", { email, password: senha });
      res = await apiPost("/login", { email, password: senha });
      showOk("Conta criada e login realizado ‚úÖ");
    }

    setSession(res.email, !!res.premium);
    abrirApp();

  }catch(e){
    showErr("Erro: " + (e.message || e));
  }finally{
    btn.disabled = false;
  }
}

function abrirApp(){
  const s = getSession();
  if(!s.email){
    document.getElementById("loginWrap").style.display="flex";
    document.getElementById("app").style.display="none";
    return;
  }
  document.getElementById("loginWrap").style.display="none";
  document.getElementById("app").style.display="block";

  document.getElementById("chipUser").textContent =
    (s.premium ? "üëë Premium: " : "üë§ Free: ") + s.email;

  // Bloqueio premium
  document.getElementById("premiumGate").style.display = s.premium ? "none" : "block";
  document.getElementById("btnGerar").disabled = !s.premium;
}

function sair(){
  clearSession();
  clearMsgs();
  document.getElementById("loginWrap").style.display="flex";
  document.getElementById("app").style.display="none";
}

/* =========================
   Comprar premium (por enquanto s√≥ aviso)
========================= */
function comprarPremium(){
  alert("Comprar Premium: aqui voc√™ vai colocar o link da sua p√°gina de venda (Kiwify/Hotmart).");
}

/* =========================
   SEU SISTEMA (concursos, an√°lises)
   (mantive tudo do seu app; s√≥ troquei o login/premium)
========================= */
function setStatus(on, text){
  const st = document.getElementById("status");
  document.getElementById("statusText").textContent = text || "";
  st.style.display = on ? "block" : "none";
}
function setProgress(pct){
  document.getElementById("barFill").style.width = Math.max(0, Math.min(100, pct)) + "%";
}

function abrirModal(){ document.getElementById("modalBack").style.display = "flex"; }
function fecharModal(){ document.getElementById("modalBack").style.display = "none"; }
function fecharGraficoBlocos(){ document.getElementById("modalBlocosBack").style.display = "none"; }

function cacheKey(providerIdx, concurso){ return `lf_${providerIdx}_${concurso}`; }
function saveCache(providerIdx, concurso, data){
  try{ localStorage.setItem(cacheKey(providerIdx, concurso), JSON.stringify({ts: Date.now(), data})); }catch(e){}
}
function loadCache(providerIdx, concurso){
  try{
    const raw = localStorage.getItem(cacheKey(providerIdx, concurso));
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(!obj?.ts || (Date.now() - obj.ts) > (48*60*60*1000)) return null;
    return obj.data || null;
  }catch(e){ return null; }
}
function limparCache(){
  const keys = [];
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(k && k.startsWith("lf_")) keys.push(k);
  }
  keys.forEach(k => localStorage.removeItem(k));
  alert("Cache limpo! Agora tente gerar novamente.");
}

const WORKER_PROXY = API_BASE; // usa o mesmo worker (tem proxy tamb√©m)

async function fetchJsonViaWorker(url){
  const proxied = `${WORKER_PROXY}/?url=${encodeURIComponent(url)}`;
  const r = await fetch(proxied, { cache: "no-store" });
  if(!r.ok) throw new Error("HTTP " + r.status);
  return await r.json();
}

const PROVIDERS = [
  {
    name: "loteriascaixa-api (Heroku)",
    latestUrl: () => "https://loteriascaixa-api.herokuapp.com/api/lotofacil/latest",
    concursoUrl: (n) => `https://loteriascaixa-api.herokuapp.com/api/lotofacil/${n}`,
    adapt: (json) => ({ concurso: Number(json.concurso), data: json.data || "", dezenas: (json.dezenas || []).map(String) })
  },
  {
    name: "api.guidi.dev.br (fallback)",
    latestUrl: () => "https://api.guidi.dev.br/loteria/lotofacil/ultimo",
    concursoUrl: (n) => `https://api.guidi.dev.br/loteria/lotofacil/${n}`,
    adapt: (json) => ({ concurso: Number(json.numero), data: json.dataApuracao || "", dezenas: (json.listaDezenas || []).map(String) })
  }
];

async function getLatestWithFallback(){
  let lastErr = null;
  for(let i=0;i<PROVIDERS.length;i++){
    try{
      const p = PROVIDERS[i];
      const raw = await fetchJsonViaWorker(p.latestUrl());
      const data = p.adapt(raw);
      if(!data.concurso || !Array.isArray(data.dezenas) || data.dezenas.length < 10) throw new Error("Resposta inv√°lida");
      return { providerIdx: i, providerName: p.name, latest: data };
    }catch(e){
      lastErr = e;
    }
  }
  throw lastErr || new Error("Falha ao buscar latest");
}

async function getConcurso(providerIdx, concurso){
  const cached = loadCache(providerIdx, concurso);
  if(cached) return cached;
  const p = PROVIDERS[providerIdx];
  const raw = await fetchJsonViaWorker(p.concursoUrl(concurso));
  const data = p.adapt(raw);
  saveCache(providerIdx, concurso, data);
  return data;
}

async function fetchRange(providerIdx, inicio, fim, onProgress){
  const total = (fim - inicio + 1);
  const concurrency = 8;
  const results = new Array(total);
  let next = inicio;
  let done = 0;

  async function worker(){
    while(next <= fim){
      const c = next; next++;
      const idx = c - inicio;
      const data = await getConcurso(providerIdx, c);
      results[idx] = data;
      done++;
      if(onProgress) onProgress(done, total);
    }
  }
  const workers = [];
  for(let i=0;i<concurrency;i++) workers.push(worker());
  await Promise.all(workers);
  return results;
}

function toNum(d){ return Number(String(d).replace(/^0+/,"")) || Number(d); }
function calcularFrequencias(concursos){
  const freq = {};
  for(let i=1;i<=25;i++) freq[i] = 0;
  concursos.forEach(c=>{
    (c.dezenas||[]).forEach(d=>{
      const n = toNum(d);
      if(n>=1 && n<=25) freq[n] += 1;
    });
  });
  return freq;
}
function ordenarPorFreq(freq){
  return Object.entries(freq).map(([k,v])=>({dez:Number(k), f:v})).sort((a,b)=>b.f-a.f);
}
function sortNum(a){ return a.slice().sort((x,y)=>x-y); }

function gerarJogoPorFreq(freq){
  const ord = ordenarPorFreq(freq);
  const quentesTop = sortNum(ord.slice(0,6).map(x=>x.dez));
  const friasBot   = sortNum(ord.slice(-4).map(x=>x.dez));
  const meioPool   = ord.slice(6,-4).map(x=>x.dez);

  const set = new Set([...quentesTop, ...friasBot]);
  for(const n of meioPool){
    if(set.size>=15) break;
    set.add(n);
  }
  while(set.size<15) set.add(Math.floor(Math.random()*25)+1);
  return sortNum(Array.from(set));
}
function classificarDezenas(freq, jogo){
  const ord = ordenarPorFreq(freq);
  const rank = {};
  ord.forEach((x,i)=> rank[x.dez]=i+1);
  const hot=[], warm=[], cold=[];
  jogo.forEach(n=>{
    const r = rank[n]||999;
    if(r<=8) hot.push(n);
    else if(r<=17) warm.push(n);
    else cold.push(n);
  });
  return {hot:sortNum(hot), warm:sortNum(warm), cold:sortNum(cold)};
}
function contarParesImpares(jogo){
  const pares = jogo.filter(n=>n%2===0).length;
  return {pares, impares: jogo.length - pares};
}
function somaDezenas(jogo){ return jogo.reduce((a,b)=>a+b,0); }

/* Blocos A‚ÄìE */
function distribuicaoBlocos(jogo){
  const b={A:0,B:0,C:0,D:0,E:0};
  jogo.forEach(n=>{
    if(n>=1 && n<=5) b.A++;
    else if(n>=6 && n<=10) b.B++;
    else if(n>=11 && n<=15) b.C++;
    else if(n>=16 && n<=20) b.D++;
    else b.E++;
  });
  return b;
}

function format2(n){ return String(n).padStart(2,"0"); }
function repetidasDoUltimo(jogo, ultimoDezenas){
  const setUlt = new Set(ultimoDezenas.map(toNum));
  const reps = jogo.filter(n => setUlt.has(n));
  return sortNum(reps);
}

function renderListaConcursos(concursos){
  const rows = concursos.map(c=>{
    const dezenas = (c.dezenas||[]).map(d=>format2(toNum(d))).join(" - ");
    const data = c.data ? String(c.data) : "‚Äî";
    return `<tr>
      <td><b>${c.concurso}</b></td>
      <td>${data}</td>
      <td class="mono">${dezenas}</td>
    </tr>`;
  }).join("");

  return `
    <table class="table">
      <thead><tr><th>Concurso</th><th>Data</th><th>Dezenas</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

function renderTop10(freq, totalConcursos){
  const ord = ordenarPorFreq(freq).slice(0,10);
  const max = ord[0]?.f || 1;

  const bars = ord.map(x=>{
    const pct = Math.round((x.f/max)*100);
    return `
      <div class="chartRow">
        <div class="chartLabel">${format2(x.dez)}</div>
        <div class="chartBarWrap"><div class="chartBar" style="width:${pct}%"></div></div>
        <div class="chartVal">${x.f}x</div>
      </div>
    `;
  }).join("");

  return `
    <div class="chartCard">
      <div class="chartTitle">
        <b>üìä Top 10 dezenas mais frequentes</b>
        <span class="chartHint">Base: ${totalConcursos} concursos</span>
      </div>
      <div class="mini">Quanto maior a barra, mais vezes a dezena apareceu no per√≠odo analisado.</div>
      <div style="margin-top:10px">${bars}</div>
    </div>
  `;
}

function abrirGraficoBlocos(){
  if(!lastContext || !lastContext._blocos) return;
  const b = lastContext._blocos;
  const max = Math.max(b.A,b.B,b.C,b.D,b.E,1);

  function row(label, val){
    const pct = Math.round((val/max)*100);
    return `
      <div class="chartRow">
        <div class="chartLabel">${label}</div>
        <div class="chartBarWrap"><div class="chartBar" style="width:${pct}%"></div></div>
        <div class="chartVal">${val}</div>
      </div>
    `;
  }

  document.getElementById("graficoBlocosArea").innerHTML =
    row("A (01‚Äì05)", b.A) +
    row("B (06‚Äì10)", b.B) +
    row("C (11‚Äì15)", b.C) +
    row("D (16‚Äì20)", b.D) +
    row("E (21‚Äì25)", b.E);

  document.getElementById("modalBlocosBack").style.display = "flex";
}

let lastContext = null;

async function gerarAnalise(){
  const s = getSession();
  if(!s.premium){
    alert("üîí Esta fun√ß√£o √© Premium. Clique em Comprar Premium.");
    return;
  }

  const qtd = Number(document.getElementById("qtdConcursos").value);
  const btn = document.getElementById("btnGerar");

  try{
    btn.disabled = true;
    setStatus(true, "Buscando o √∫ltimo concurso (fallback autom√°tico)‚Ä¶");
    setProgress(6);

    const { providerIdx, providerName, latest } = await getLatestWithFallback();
    const ultimo = latest.concurso;
    const inicio = ultimo - qtd + 1;
    if(inicio < 1) throw new Error("Intervalo inv√°lido.");

    setStatus(true, `Baixando concursos ${inicio} a ${ultimo}‚Ä¶`);
    setProgress(10);

    const concursos = await fetchRange(providerIdx, inicio, ultimo, (done, total)=>{
      const pct = 10 + Math.round((done/total)*80);
      setProgress(pct);
      setStatus(true, `Baixando concursos ${inicio} a ${ultimo}‚Ä¶ (${done}/${total})`);
    });

    setStatus(true, "Calculando frequ√™ncias e gerando jogo‚Ä¶");
    setProgress(94);

    const freq = calcularFrequencias(concursos);
    const jogo = gerarJogoPorFreq(freq);
    const cls = classificarDezenas(freq, jogo);
    const pi = contarParesImpares(jogo);
    const soma = somaDezenas(jogo);
    const blocos = distribuicaoBlocos(jogo);
    const reps = repetidasDoUltimo(jogo, latest.dezenas || []);

    setStatus(false, "");
    setProgress(0);

    lastContext = { providerName, inicio, ultimo, qtd, concursos, freq, latest, _blocos: blocos };

    const numerosFmt = jogo.map(format2).join(" - ");

    document.getElementById("resultado").innerHTML = `
      <div class="numbers">${numerosFmt}</div>
      <div class="range">üìå An√°lise dos concursos <b>${inicio}</b> a <b>${ultimo}</b> (${qtd} concursos)</div>

      <div class="actions">
        <button class="secondary" type="button" onclick="abrirDetalhes()">üìÖ Ver concursos analisados (lista + datas)</button>
      </div>

      <div class="grid">
        <div class="box">
          <div class="pill.rep">üîÅ Repetidas do √∫ltimo concurso (${latest.concurso})</div>
          <p><b class="highlightRep">${reps.length ? reps.map(format2).join(", ") : "Nenhuma repetida"}</b></p>
          <div class="mini">Quais dezenas do seu jogo j√° sa√≠ram no √∫ltimo concurso real.</div>
        </div>

        <div class="box">
          <div class="pill hot">üî• Quentes</div>
          <p><b>${cls.hot.map(format2).join(", ") || "‚Äî"}</b></p>
          <div class="mini">Mais frequentes no per√≠odo.</div>
        </div>

        <div class="box">
          <div class="pill warm">üå°Ô∏è Mornas</div>
          <p><b>${cls.warm.map(format2).join(", ") || "‚Äî"}</b></p>
          <div class="mini">Estabilidade para equilibrar.</div>
        </div>

        <div class="box">
          <div class="pill cold">‚ùÑÔ∏è Frias</div>
          <p><b>${cls.cold.map(format2).join(", ") || "‚Äî"}</b></p>
          <div class="mini">Diversifica√ß√£o.</div>
        </div>

        <div class="box">
          <div class="pill info">‚öñÔ∏è Pares x √çmpares</div>
          <p><b>${pi.pares}</b> pares ‚Ä¢ <b>${pi.impares}</b> √≠mpares</p>
          <div class="mini">Evita extremos.</div>
        </div>

        <div class="box">
          <div class="pill info">‚ûï Soma total</div>
          <p><b>${soma}</b></p>
          <div class="mini">Ajuda a evitar combina√ß√µes fora do padr√£o.</div>
        </div>

        <div class="box">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
            <div class="pill info">üß© Blocos (A‚ÄìE)</div>
            <button class="secondary" type="button" style="width:auto;min-width:auto;padding:8px 10px;border-radius:10px"
              onclick="abrirGraficoBlocos()">
              üìä Ver gr√°fico
            </button>
          </div>
          <p>
            A(01‚Äì05): <b>${blocos.A}</b> ‚Ä¢
            B(06‚Äì10): <b>${blocos.B}</b> ‚Ä¢
            C(11‚Äì15): <b>${blocos.C}</b> ‚Ä¢
            D(16‚Äì20): <b>${blocos.D}</b> ‚Ä¢
            E(21‚Äì25): <b>${blocos.E}</b>
          </p>
          <div class="mini">Cobertura por faixas do volante.</div>
        </div>

        <div class="box">
          <div class="pill info">üîé Transpar√™ncia</div>
          <p>Fonte: <b>${providerName}</b></p>
          <div class="mini">Fallback autom√°tico se uma API cair.</div>
        </div>
      </div>

      ${renderTop10(freq, qtd)}
    `;

  }catch(e){
    setStatus(false,"");
    setProgress(0);
    document.getElementById("resultado").innerHTML = `
      <h3 style="text-align:center;">‚ö†Ô∏è Erro ao buscar concursos reais</h3>
      <div class="box">
        <div class="pill info">Detalhe</div>
        <p>${String(e?.message || e)}</p>
        <div class="mini">Tente novamente em alguns segundos.</div>
      </div>
    `;
  }finally{
    btn.disabled = false;
  }
}

function abrirDetalhes(){
  if(!lastContext) return;
  document.getElementById("listaConcursos").innerHTML = renderListaConcursos(lastContext.concursos);
  abrirModal();
}

/* EVENTS */
document.addEventListener("DOMContentLoaded", ()=>{
  // Se j√° tinha sess√£o, abre direto
  const s = getSession();
  if(s.email) abrirApp();

  document.getElementById("btnEntrar").addEventListener("click", entrarOuCriar);
  document.getElementById("btnGerar").addEventListener("click", gerarAnalise);
  document.getElementById("btnLimpar").addEventListener("click", limparCache);

  document.getElementById("btnComprar").addEventListener("click", comprarPremium);
  document.getElementById("btnSair").addEventListener("click", sair);

  document.getElementById("modalBack").addEventListener("click", (e)=>{
    if(e.target.id === "modalBack") fecharModal();
  });
  document.getElementById("modalBlocosBack").addEventListener("click", (e)=>{
    if(e.target.id === "modalBlocosBack") fecharGraficoBlocos();
  });
});
</script>

</body>
</html>
